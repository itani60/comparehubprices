import{r as d,f as bn,a as Et,R as e,l as yn,g as Nn,b as Cn,m as kn,s as wn,c as gt,d as Sn,e as In,h as Tn,i as Bn,u as An,j as bt,k as xn,n as Dn,o as yt,p as Ln}from"./realtimeClient-Co7KOFh8.js";const me={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Mn=[],Pn={},Nt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function Rn(){if(typeof document>"u")return null;const t=Ct("standard_session_id"),s=Ct("standard_csrf_token");return!t||!s?null:{sessionId:t,sessionCsrf:s}}function Un(){typeof document>"u"||(kt("standard_session_id"),kt("standard_csrf_token"))}function Ct(t){var s,r;if(!t||typeof document>"u")return"";try{const v=`; ${document.cookie}`.split(`; ${t}=`);if(v.length!==2)return"";const h=((r=(s=v.pop())==null?void 0:s.split(";").shift())==null?void 0:r.trim())||"";if(!h)return"";try{return decodeURIComponent(h).trim()}catch{return h}}catch{return""}}function kt(t){var r;const s=typeof window<"u"&&((r=window.location)==null?void 0:r.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Lax${s}`}function On(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||"");return{conversationId:(t.get("conversationId")||"").trim(),recipientId:(t.get("recipientId")||"").trim(),recipientName:(t.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function $n(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function de(t){if(!t)return"";const s=t.split(" ").filter(Boolean),r=s[0]?s[0][0]:"",i=s.length>1?s[s.length-1][0]:"";return(r+i).toUpperCase()}function J(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function q(t){return!!(t&&(t.blocked||t.blockedByOther))}function St(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function It(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Ke(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Tt(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Bt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function wt(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function Fn(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const r=new Date,i=new Date;return i.setDate(r.getDate()-1),wt(s,r)?"Today":wt(s,i)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function _n(t){const s=[];let r="";return t.forEach(i=>{const v=i.timestamp.slice(0,10);v!==r&&(s.push({type:"day",id:`day-${v}`,label:Fn(i.timestamp)}),r=v),s.push({type:"message",id:i.id,message:i})}),s}function Vn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function jn(t,s){if(!s)return t;const r=Vn(s);return t.split(new RegExp(`(${r})`,"ig")).map((v,h)=>v.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:h,className:"msg-highlight"},v):e.createElement("span",{key:h},v))}function At(t,s,r){d.useEffect(()=>{if(!r)return;const i=v=>{!t.current||t.current.contains(v.target)||s()};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[t,s,r])}function U({children:t,size:s=20,className:r}){return e.createElement("svg",{className:r,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const Hn=t=>e.createElement(U,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),xt=t=>e.createElement(U,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Dt=t=>e.createElement(U,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),zn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),Kn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),Yn=t=>e.createElement(U,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),Wn=t=>e.createElement(U,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),qn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),Zn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),Qn=t=>e.createElement(U,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),Gn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),se=t=>e.createElement(U,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Jn=t=>e.createElement(U,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),Xn=t=>e.createElement(U,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),Lt=t=>e.createElement(U,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function We({ariaLabel:t,items:s}){const[r,i]=d.useState(!1),v=d.useRef(null);return At(v,()=>i(!1),r),e.createElement("div",{className:"menu-wrap",ref:v},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":r,onClick:()=>i(h=>!h),type:"button"},e.createElement(Hn,null)),r?e.createElement("div",{className:"dropdown",role:"menu"},s.map(h=>e.createElement("button",{key:h.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{i(!1),h.onSelect()}},h.label))):null)}function ea({status:t}){if(!t)return null;if(t==="sent")return e.createElement(Yn,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(Wn,{className:s})}function ta({open:t,title:s,message:r,confirmLabel:i,onConfirm:v,onCancel:h}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,r),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:h},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:v},i)))):null}function na({open:t,onClose:s,reasons:r,value:i,onChange:v,details:h,onDetailsChange:f,onSubmit:b,targetName:A}){const[k,y]=d.useState(!1),Z=d.useRef(null),L=r.find(m=>m.value===i);return At(Z,()=>y(!1),k),d.useEffect(()=>{t||y(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",A||"this chat","."),e.createElement("div",{className:`report-select${k?" active":""}`,ref:Z},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>y(m=>!m),"aria-haspopup":"listbox","aria-expanded":k},e.createElement("span",null,L?L.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},r.map(m=>e.createElement("button",{key:m.value,type:"button",className:`report-select__option${i===m.value?" selected":""}`,onClick:()=>{v(m.value),y(!1)},role:"option","aria-selected":i===m.value},m.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:h,onChange:m=>f(m.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:b,disabled:!i},"Report")))):null}function aa({chat:t,onClose:s,onDelete:r,onBlock:i,onReport:v}){if(!t)return null;const h=!!t.blockedByOther,f=J(t),b=t.name?t.name.split(" ").filter(Boolean):[],A=b[0]||"",k=b.slice(1).join(" "),y=h?"-":t.firstName||A||"-",Z=h?"-":t.lastName||k||"-",L=h?"-":t.suburb||"-",m=h?"-":t.city||"-",M=h?"-":t.province||"-",g=h?"-":t.accountSince||"-",P=h?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(Dt,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:t.color}},q(t)?e.createElement(se,{className:"avatar-blocked-icon",size:18}):de(f)),e.createElement("div",null,e.createElement("h3",null,f))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",y),e.createElement("p",null,"Family name: ",Z),e.createElement("p",null,"Suburb: ",L),e.createElement("p",null,"City: ",m),e.createElement("p",null,"Province: ",M),e.createElement("p",null,"Account since: ",g),e.createElement("p",null,"Account type: ",P)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:r},e.createElement(Xn,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:i},e.createElement(se,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:v},e.createElement(Gn,null),"Report"))))))}function Te({title:t,subtitle:s,children:r}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},r))}function sa({currentUser:t}){const s={...me,...t&&typeof t=="object"?t:{}},r=s.name||"User";return e.createElement(Te,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},de(r)),e.createElement("div",null,e.createElement("h3",null,r),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function la({chats:t,onOpenChat:s,onUnarchive:r}){return e.createElement(Te,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(i=>{const v=J(i);return e.createElement("div",{key:i.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:i.color}},q(i)?e.createElement(se,{className:"avatar-blocked-icon",size:16}):de(i.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},v),e.createElement("div",{className:"section-item-sub"},i.lastMessage?i.lastMessage:"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,It(i.archivedAt||i.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(i.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>r(i.id)},"Unarchive"))))})))}function ra({chats:t,onUnblock:s}){return e.createElement(Te,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color}},e.createElement(se,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,It(r.blockedAt||r.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(r.id)},"Unblock"))))))}function oa({reports:t,onOpenReport:s}){return e.createElement(Te,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color||"#3b82f6"}},de(r.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name),e.createElement("div",{className:"section-item-sub"},r.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Bt(r.status)}`},Tt(r.status)),e.createElement("span",null,Ke(r.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(r)},"View report"))))))}function ca({open:t,report:s,onClose:r}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:r,"aria-label":"Close report details"},e.createElement(Lt,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Bt(s.status)}`},Tt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Ke(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Ke(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Ye({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function ia(){const t=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((r,i)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((r,i)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function ma({chats:t,searchValue:s,onSearchChange:r,activeChatId:i,onOpenChat:v,onChatAction:h}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(xt,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:f=>r(f.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Ye,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(f=>{const b=J(f);return e.createElement("div",{key:f.id,className:`chat-item ${i===f.id?"active":""}`,onClick:()=>v(f.id),onKeyDown:A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),v(f.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${b}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:f.color}},q(f)?e.createElement(se,{className:"avatar-blocked-icon",size:16}):de(f.name)),f.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},b),e.createElement("span",{className:"chat-time"},St(f.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},f.lastMessage?f.lastMessage:"No messages yet"),f.unread>0?e.createElement("span",{className:"chat-unread"},f.unread):null)),e.createElement("div",{className:"chat-actions",onClick:A=>A.stopPropagation(),onKeyDown:A=>A.stopPropagation()},e.createElement(We,{ariaLabel:`More options for ${b}`,items:[{label:"Delete chat",onSelect:()=>h(f.id,"delete")},{label:"Report",onSelect:()=>h(f.id,"report")},{label:"Archive",onSelect:()=>h(f.id,"archive")}]})))})))}function da({message:t,query:s,onPreviewImage:r}){const i=t.sender==="me",v=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",h=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",f=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",b=!!t.attachmentIsImage||h.startsWith("image/"),A=!!t.attachmentIsVideo||h.startsWith("video/"),k=typeof t.text=="string"&&t.text.trim().length>0,y={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:k?"8px":"0"};return e.createElement("div",{className:`message-row ${i?"me":"them"}`},e.createElement("div",{className:`message-bubble ${i?"outgoing":"incoming"}`},v?e.createElement("div",{className:"message-attachment"},b?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{r&&r(t)},"aria-label":`Preview ${f}`},e.createElement("img",{src:v,alt:f,loading:"lazy",style:y})):A?e.createElement("video",{controls:!0,preload:"metadata",style:y},e.createElement("source",{src:v,type:h||void 0})):e.createElement("a",{href:v,target:"_blank",rel:"noreferrer"},"Open attachment")):null,k?e.createElement("div",{className:"message-text"},jn(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,St(t.timestamp)),i?e.createElement(ea,{status:t.status}):null)))}function ua({preview:t,onClose:s,onSave:r,onReport:i}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Lt,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:r},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:i},"Report Photo"))):null}function fa(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function pa(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,r)=>e.createElement("div",{key:r,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function ha({value:t,onChange:s,onSend:r,onAttach:i,inputRef:v,disabled:h=!1}){d.useEffect(()=>{const b=v==null?void 0:v.current;b&&(b.style.height="auto",b.style.height=`${Math.min(b.scrollHeight,120)}px`)},[t,v]);const f=b=>{b.key==="Enter"&&!b.shiftKey&&(b.preventDefault(),!h&&t.trim()&&r())};return e.createElement("div",{className:"composer"},e.createElement("div",{className:"composer-actions"},e.createElement("button",{className:"icon-btn",type:"button",onClick:i,"aria-label":"Attach",disabled:h},e.createElement(Kn,null))),e.createElement("textarea",{ref:v,rows:1,value:t,onChange:b=>s(b.target.value),onKeyDown:f,placeholder:h?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:h}),e.createElement("button",{className:"send-btn",type:"button",onClick:r,disabled:h||!t.trim(),"aria-label":"Send message"},e.createElement(zn,null)))}function va({chat:t,groupedMessages:s,searchValue:r,showSearch:i,onToggleSearch:v,onSearchChange:h,onBack:f,onSend:b,composerValue:A,onComposerChange:k,onAttach:y,composerRef:Z,typing:L,conversationLoading:m,messageListRef:M,matchCount:g,onMenuAction:P,attachmentPreview:le,onOpenAttachmentPreview:ve,onCloseAttachmentPreview:X,onSaveAttachmentPreview:ee,onReportAttachmentPreview:Be}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Ye,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(le)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(ua,{preview:le,onClose:X,onSave:ee,onReport:Be}));const re=J(t),te=!!t.launchPending,ue=te?[{label:"Close chat",onSelect:()=>P("close")}]:[{label:"View profile",onSelect:()=>P("profile")},{label:"Close chat",onSelect:()=>P("close")},{label:"Delete chat",onSelect:()=>P("delete")},{label:"Block",onSelect:()=>P("block")},{label:"Report",onSelect:()=>P("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:f,"aria-label":"Back to chats"},e.createElement(Dt,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},q(t)?e.createElement(se,{className:"avatar-blocked-icon",size:16}):de(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},re),e.createElement("div",{className:"conversation-status"},te?e.createElement("span",null,"Start conversation"):L?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(We,{ariaLabel:"Conversation menu",items:ue}))),i?e.createElement("div",{className:"conversation-search"},e.createElement(xt,{className:"search-icon"}),e.createElement("input",{type:"search",value:r,onChange:j=>h(j.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),r?e.createElement("span",{className:"search-count"},g," match",g===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:M},m?e.createElement(pa,null):s.length===0?e.createElement(Ye,{title:r?"No matches":"No messages yet",subtitle:r?"Try a different phrase.":"Send a message to start the chat."}):s.map(j=>j.type==="day"?e.createElement("div",{key:j.id,className:"day-separator"},j.label):e.createElement(da,{key:j.id,message:j.message,query:r.trim(),onPreviewImage:ve})),L&&!r&&!m?e.createElement(fa,null):null,!m&&q(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(ha,{value:A,onChange:k,onSend:b,onAttach:y,inputRef:Z,disabled:q(t)}))}function Ea({activeKey:t,onSelect:s}){const r=[{key:"home",label:"Home",icon:qn},{key:"archive",label:"Archive",icon:Qn},{key:"chats",label:"Chats",icon:Zn},{key:"block",label:"Block",icon:se},{key:"profile",label:"My Profile",icon:Jn}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},r.map(i=>{const v=i.icon;return e.createElement("button",{key:i.key,className:`nav-btn ${t===i.key?"active":""}`,type:"button",onClick:()=>s(i.key),"aria-label":i.label},e.createElement("span",{className:"icon-box"},e.createElement(v,null)),e.createElement("span",null,i.label))}))}function ga({currentUser:t=me,initialChats:s=Mn,initialMessages:r=Pn}){const i={...me,...t&&typeof t=="object"?t:{}},v=Array.isArray(s)?s:[],h=r&&typeof r=="object"?r:{},f=d.useMemo(()=>On(),[]),b=!!(f.conversationId||f.recipientId),A=d.useRef(!b),[k,y]=d.useState(v),[Z,L]=d.useState(h),[m,M]=d.useState(null),[g,P]=d.useState(f.recipientId?{id:f.recipientId,name:f.recipientName||"Business"}:null),[le,ve]=d.useState(""),[X,ee]=d.useState(""),[Be,re]=d.useState(!1),[te,ue]=d.useState(""),[j,fe]=d.useState(!1),[qe,Ze]=d.useState(!1),[H,Qe]=d.useState(null),[Ge,Ee]=d.useState([]),[Ae,xe]=d.useState([]),[De,Je]=d.useState(!1),[Q,Le]=d.useState(null),[Mt,Me]=d.useState(!1),[ge,be]=d.useState(""),[Xe,ye]=d.useState(""),[oe,Pe]=d.useState(null),[V,Re]=d.useState(null),[ya,et]=d.useState(null),[tt,nt]=d.useState(!1),[Pt,Ne]=d.useState(null),[Ce,Ue]=d.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[Rt,at]=d.useState(i),[ce,st]=d.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[$,ke]=d.useState("chats"),lt=d.useRef(null),Ut=d.useRef(null),Oe=d.useRef(null),pe=d.useRef(null),ne=d.useRef(null),G=d.useRef(null),R=d.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),x=Ce.sessionId,D=Ce.sessionCsrf,O=Ce.userId,$e=Ce.realtimeToken,S=!!(x&&D&&O),I=k.find(n=>n.id===m)||null,Ot=d.useMemo(()=>$n(g),[g]),F=I||Ot,$t=d.useMemo(()=>k.filter(n=>n.archived),[k]),Ft=d.useMemo(()=>{const n=new Map;return Ge.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[Ge]),Fe=d.useMemo(()=>k.filter(n=>!n.archived),[k]),_t=d.useMemo(()=>{const n=le.trim().toLowerCase();return n?Fe.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):Fe},[Fe,le]),we=m?Z[m]||[]:[],_e=d.useMemo(()=>{const n=X.trim().toLowerCase();return n?we.filter(a=>a.text.toLowerCase().includes(n)):we},[we,X]),Vt=d.useMemo(()=>_n(_e),[_e]),jt=!!(m&&Pt===m),rt=()=>{G.current&&(window.clearTimeout(G.current),G.current=null),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null)},Se=async(n,{force:a=!1}={})=>{const l=ne.current;if(!l||!O)return;const o=!!n,c=Date.now(),p=R.current;if(!(!a&&p.lastValue===o&&c-p.lastSentAt<600)){p.lastValue=o,p.lastSentAt=c;try{await l.send({type:"broadcast",event:"typing",payload:{isTyping:o,userId:String(O)}})}catch{}}};d.useEffect(()=>{let n=!1;return(async()=>{if(!m||!O||!$e||!S){fe(!1);return}try{const l=await Nn();if(!l||n)return;l.realtime.setAuth($e);const o=ne.current;if(o)try{await o.unsubscribe()}catch{}ne.current=null,rt(),R.current.lastValue=!1;const c=l.channel(`conversation:${m}`,{config:{presence:{key:`chat:${String(O)}`}}});c.on("broadcast",{event:"typing"},({payload:p})=>{const N=String((p==null?void 0:p.userId)||"");if(!N||N===String(O))return;const E=!!(p!=null&&p.isTyping);fe(E),G.current&&(window.clearTimeout(G.current),G.current=null),E&&(G.current=window.setTimeout(()=>{fe(!1),G.current=null},3e3))}),c.subscribe(async p=>{if(!(n||p!=="SUBSCRIBED"))try{await c.track({userId:String(O),at:new Date().toISOString()})}catch{}}),ne.current=c}catch{n||fe(!1)}})(),()=>{n=!0;const l=ne.current;if(ne.current=null,l)try{l.unsubscribe()}catch{}rt(),R.current.lastValue=!1,fe(!1)}},[m,S,O,$e]),d.useEffect(()=>{if(!m||!O||!ne.current)return;const n=te.trim().length>0,a=Date.now(),l=R.current;n!==l.lastValue&&a-l.lastSentAt>600&&Se(n,{force:!0}),l.idleTimer&&(window.clearTimeout(l.idleTimer),l.idleTimer=null),n&&(l.idleTimer=window.setTimeout(()=>{R.current.idleTimer=null,Se(!1,{force:!0})},2e3))},[te,m,O]),d.useEffect(()=>{if(!m||X.trim())return;const n=lt.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[m,we.length,j,X]),d.useEffect(()=>{Re(null)},[m]),d.useEffect(()=>()=>{pe.current&&clearTimeout(pe.current)},[]),d.useEffect(()=>{(!m||!S)&&Ne(null)},[m,S]);const u=n=>{et(n),pe.current&&clearTimeout(pe.current),pe.current=setTimeout(()=>et(null),2400)},ot=(n,a={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const l=!!(a!=null&&a.silent);return Ue({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),M(null),P(null),l||u("Session missing or expired. Please log in again."),!0},Ht=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",l=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",o=!!n.attachmentIsImage||l.startsWith("image/");if(!a||!o)return;const c=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";Re({url:a,name:c,messageId:typeof n.id=="string"?n.id:""})},zt=()=>{Re(null)},Kt=async()=>{if(!(V!=null&&V.url))return;const n=V.name||"photo";try{const a=await fetch(V.url);if(!a.ok)throw new Error("download_failed");const l=await a.blob(),o=window.URL.createObjectURL(l),c=document.createElement("a");c.href=o,c.download=n,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(o),u("Image saved.")}catch{const a=document.createElement("a");a.href=V.url,a.target="_blank",a.rel="noreferrer",a.click(),u("Could not save directly. Opened image in a new tab.")}},Yt=()=>{if(!I){u("No chat selected.");return}Pe(I),be(""),ye(V!=null&&V.name?`Photo attachment: ${V.name}`:"Photo attachment"),Me(!0)};d.useEffect(()=>{if(!m||!S)return;let n=!1;Ne(m);const a=async({silent:o=!1}={})=>{try{const{messages:c,chatPatch:p}=await Cn({sessionId:x,sessionCsrf:D,conversationId:m,currentUserId:O});if(n)return;L(N=>({...N,[m]:c})),y(N=>N.map(E=>E.id===m?{...E,...p||{},unread:0}:E));try{await kn({sessionId:x,sessionCsrf:D,conversationId:m})}catch{}}catch(c){if(!n&&ot(c))return;!n&&!o&&u((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{n||Ne(c=>c===m?null:c)}};a();const l=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(l)}},[m,S,x,D,O]);const Wt=n=>{n&&(Le(n),Je(!0))},ct=()=>{Je(!1),Le(null)},Ve=n=>{n&&(Pe(n),be(""),ye(""),Me(!0))},it=()=>{Me(!1),Pe(null),be(""),ye("")},qt=async()=>{var o;if(!oe||!ge)return;if(!S){u("Session missing or expired. Please log in again.");return}const n=((o=Nt.find(c=>c.value===ge))==null?void 0:o.label)||ge,a=Xe.trim(),l=a?`${n} - ${a}`:n;try{await Sn({sessionId:x,sessionCsrf:D,conversationId:oe.id,recipientId:oe.otherPartyId,reason:l});try{const c=await Et({sessionId:x,sessionCsrf:D});xe(c)}catch{}it(),u("Report sent.")}catch(c){u((c==null?void 0:c.message)||"Failed to submit report.")}},ae=({title:n,message:a,confirmLabel:l,onConfirm:o})=>{st({open:!0,title:n,message:a,confirmLabel:l,onConfirm:o})},W=()=>{st(n=>({...n,open:!1}))},Zt=async(n,a,l={})=>{const o=!!(l!=null&&l.silent);if(tt)return!1;const c=n.trim(),p=a.trim();if(!c||!p)return o||u("Session credentials missing. Please log in again."),!1;nt(!0);try{const N=await Tn({sessionId:c,sessionCsrf:p}),{chats:E,blockedAccounts:C,reports:w,currentUser:B}=await Bn({sessionId:c,sessionCsrf:p});Ue({sessionId:c,sessionCsrf:p,userId:N.userId,realtimeToken:N.token||""}),at(B?{...me,...B}:{...me,...i}),y(E),Ee(C),L({}),xe(w);let T=null,ie=null;if(!A.current){if(f.conversationId){const z=E.find(K=>K.id===f.conversationId);z&&(T=z.id)}if(!T&&f.recipientId){const z=E.find(K=>K.otherPartyId===f.recipientId);z?T=z.id:ie={id:f.recipientId,name:f.recipientName||"Business"}}A.current=!0}return P(ie),M(T),ve(""),ee(""),re(!1),ke("chats"),!o&&E.length===0?u("Connected. No chats found."):o||u(`Connected. Loaded ${E.length} chat${E.length===1?"":"s"}.`),!0}catch(N){const E=ot(N,{silent:o});return!o&&!E&&u((N==null?void 0:N.message)||"Failed to restore your session."),!1}finally{nt(!1)}};d.useEffect(()=>{let n=!1;return(async()=>{if(S)return;const l=Rn();if(!l){n||u("Session missing or expired. Please log in again.");return}await Zt(l.sessionId,l.sessionCsrf,{silent:!0})||n||u("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const mt=async(n,a={})=>{a.unarchive&&!await pt(n,{clearActive:!1,toast:!0})||(M(n),P(null),S&&Ne(n),y(l=>l.map(o=>o.id===n?{...o,unread:0}:o)),re(!1),ee(""))},dt=(n,a,l)=>{L(o=>{const c=o[n]||[];return{...o,[n]:c.map(p=>p.id===a?{...p,status:l}:p)}})},Qt=async()=>{const n=te.trim(),a=m||"",l=a?"":(g==null?void 0:g.id)||"",o=(I==null?void 0:I.name)||(g==null?void 0:g.name)||f.recipientName||"Business",c=(I==null?void 0:I.color)||"#3b82f6";if(!n||!!!(a||l))return;if(q(F)){u(F!=null&&F.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(S){try{const E=await wn({sessionId:x,sessionCsrf:D,conversationId:a||void 0,recipientId:l||void 0,content:n}),C=gt(E==null?void 0:E.data,O),w=(typeof C.chatId=="string"?C.chatId.trim():"")||a;if(!w)throw new Error("Failed to resolve conversation ID.");L(B=>({...B,[w]:[...B[w]||[],C]})),ue(""),y(B=>{const T=C.timestamp||new Date().toISOString();if(!B.find(_=>_.id===w))return[{id:w,name:o,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:C.text||n,lastTime:T,unread:0,online:!1,presence:"offline",color:c,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:l||(g==null?void 0:g.id)||""},...B];const z=B.map(_=>_.id===w?{..._,lastMessage:C.text||n,lastTime:C.timestamp||T,unread:0}:_),K=z.find(_=>_.id===w),Ie=z.filter(_=>_.id!==w);return K?[K,...Ie]:z}),M(w),P(null),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null),R.current.lastValue=!1,Se(!1,{force:!0})}catch(E){u((E==null?void 0:E.message)||"Failed to send message.")}return}if(!a){u("Session missing or expired. Please log in again.");return}const N={id:`m-${Date.now()}`,chatId:a,sender:"me",text:n,timestamp:new Date().toISOString(),status:"sent"};L(E=>({...E,[a]:[...E[a]||[],N]})),ue(""),y(E=>{const C=E.map(T=>T.id===a?{...T,lastMessage:n,lastTime:N.timestamp,unread:0}:T),w=C.find(T=>T.id===a),B=C.filter(T=>T.id!==a);return w?[w,...B]:C}),setTimeout(()=>dt(a,N.id,"delivered"),900),setTimeout(()=>dt(a,N.id,"read"),2e3),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null),R.current.lastValue=!1,Se(!1,{force:!0})},Gt=()=>{if(!m&&!(g!=null&&g.id)){u("Select a chat first.");return}if(!S){u("Session missing or expired. Please log in again.");return}if(q(F)){u(F!=null&&F.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}Oe.current&&Oe.current.click()},Jt=async n=>{var E;const a=n.target,l=(E=a==null?void 0:a.files)==null?void 0:E[0];if(a&&(a.value=""),!l)return;if(!m&&!(g!=null&&g.id)){u("Select a chat first.");return}if(!S){u("Session missing or expired. Please log in again.");return}if(q(F)){u(F!=null&&F.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const o=m||"",c=o?"":(g==null?void 0:g.id)||"",p=(I==null?void 0:I.name)||(g==null?void 0:g.name)||f.recipientName||"Business",N=(I==null?void 0:I.color)||"#3b82f6";try{const C=await In({sessionId:x,sessionCsrf:D,conversationId:o||void 0,recipientId:c||void 0,file:l}),w=gt(C==null?void 0:C.data,O),B=(typeof w.chatId=="string"?w.chatId.trim():"")||o;if(!B)throw new Error("Failed to resolve conversation ID.");L(T=>({...T,[B]:[...T[B]||[],w]})),y(T=>{const ie=w.timestamp||new Date().toISOString();if(!T.find(Y=>Y.id===B))return[{id:B,name:p,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:w.text||l.name,lastTime:ie,unread:0,online:!1,presence:"offline",color:N,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:c||(g==null?void 0:g.id)||""},...T];const K=T.map(Y=>Y.id===B?{...Y,lastMessage:w.text||l.name,lastTime:w.timestamp||ie,unread:0}:Y),Ie=K.find(Y=>Y.id===B),_=K.filter(Y=>Y.id!==B);return Ie?[Ie,..._]:K}),M(B),P(null),u("Attachment sent.")}catch(C){u((C==null?void 0:C.message)||"Failed to send attachment.")}},Xt=n=>{L(a=>({...a,[n]:[]})),y(a=>a.map(l=>l.id===n?{...l,lastMessage:"No messages yet",lastTime:"",unread:0}:l))},en=()=>{if(m){Xt(m),u("Cleared current chat.");return}const n={};k.forEach(a=>{n[a.id]=[]}),L(n),y(a=>a.map(l=>({...l,lastMessage:"No messages yet",lastTime:"",unread:0}))),u("Cleared all chats.")},je=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(y(l=>l.filter(o=>!a.has(o.id))),L(l=>{const o={...l};return a.forEach(c=>{delete o[c]}),o}),m&&a.has(m)&&M(null))},He=async(n,a={})=>{const l=typeof n=="string"?n.trim():"";if(!l)return!1;const o=a.toast!==!1;if(S)try{await yt({sessionId:x,sessionCsrf:D,conversationId:l})}catch(c){return u((c==null?void 0:c.message)||"Failed to delete chat."),!1}return je([l]),o&&u("Chat deleted."),!0},tn=async()=>{const n=k.map(o=>o.id).filter(Boolean);if(n.length===0)return u("No chats to delete."),!1;if(!S)return je(n),u("All chats deleted."),!0;const a=[];for(const o of n)try{await yt({sessionId:x,sessionCsrf:D,conversationId:o}),a.push(o)}catch{}a.length>0&&je(a);const l=n.length-a.length;return a.length===0?(u("Failed to delete chats."),!1):l===0?(u("All chats deleted."),!0):(u(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${l} failed.`),!1)},nn=async()=>{if(m){await He(m);return}await tn()},an=(n,a)=>{const l=k.find(E=>E.id===n),o=(l==null?void 0:l.otherPartyId)||n;if(!o)return;const c=a||new Date().toISOString(),p=(l==null?void 0:l.name)||"Unknown",N=(l==null?void 0:l.color)||"#3b82f6";Ee(E=>{const C=E.filter(w=>w.id!==o);return[{id:o,name:p,blockedAt:c,color:N},...C]})},ut=({accountId:n,conversationId:a=""})=>{const l=typeof n=="string"?n.trim():"",o=typeof a=="string"?a.trim():"";y(c=>c.map(p=>{const N=!!o&&p.id===o,E=!!l&&p.otherPartyId===l;if(!N&&!E)return p;const C=!!p.blockedByOther;return{...p,blocked:!1,blockedByMe:!1,hasBlockingRelationship:C,blockedAt:void 0}})),l&&Ee(c=>c.filter(p=>p.id!==l))},ft=async n=>{if(!n)return!1;if(S)try{await Dn({sessionId:x,sessionCsrf:D,conversationId:n})}catch(l){return u((l==null?void 0:l.message)||"Failed to block account."),!1}const a=new Date().toISOString();return y(l=>l.map(o=>o.id===n?{...o,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:o)),an(n,a),m===n&&M(null),u("Chat blocked."),!0},sn=async n=>{if(!n)return!1;const a=k.find(o=>o.id===n),l=(a==null?void 0:a.otherPartyId)||"";if(S)try{await bt({sessionId:x,sessionCsrf:D,conversationId:n||void 0,recipientId:l||void 0})}catch(o){return u((o==null?void 0:o.message)||"Failed to unblock account."),!1}return ut({accountId:l,conversationId:n}),u("Account unblocked."),!0},ln=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const l=k.find(c=>c.otherPartyId===a),o=(l==null?void 0:l.id)||"";if(S)try{await bt({sessionId:x,sessionCsrf:D,conversationId:o||void 0,recipientId:a})}catch(c){return u((c==null?void 0:c.message)||"Failed to unblock account."),!1}return ut({accountId:a,conversationId:o}),u("Account unblocked."),!0},rn=async(n,a={})=>{if(!n)return!1;const l=a.clearActive!==!1,o=a.toast!==!1;if(S)try{await xn({sessionId:x,sessionCsrf:D,conversationId:n})}catch(c){return u((c==null?void 0:c.message)||"Failed to archive chat."),!1}return y(c=>c.map(p=>p.id===n?{...p,archived:!0,archivedAt:new Date().toISOString()}:p)),l&&m===n&&M(null),o&&u("Chat archived."),!0},pt=async(n,a={})=>{if(!n)return!1;const l=a.clearActive===!0,o=a.toast!==!1;if(S)try{await An({sessionId:x,sessionCsrf:D,conversationId:n})}catch(c){return u((c==null?void 0:c.message)||"Failed to restore chat."),!1}return y(c=>c.map(p=>p.id===n?{...p,archived:!1,archivedAt:void 0}:p)),l&&m===n&&M(null),o&&u("Chat restored from archive."),!0},ht=n=>{if(n==="profile"){if(!m){u("No chat selected.");return}const a=k.find(l=>l.id===m)||null;Qe(a),Ze(!0);return}if(n==="close"){M(null),P(null),re(!1),ee(""),u("Chat closed.");return}if(n==="block"){if(!m)return;const a=k.find(o=>o.id===m),l=(a==null?void 0:a.id)||m;ae({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{W(),await ft(l)}});return}if(n==="delete"){const a=I?`Delete chat with ${J(I)}?`:"Delete all chats?";ae({title:a,message:I?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),nn()}});return}if(n==="clear"){const a=I?`Clear chat with ${I.name}?`:"Clear all chats?";ae({title:a,message:I?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{W(),en()}});return}n==="report"&&Ve(I)},on=n=>{ht(n)},cn=(n,a)=>{const l=k.find(o=>o.id===n);if(l){if(a==="delete"){ae({title:`Delete chat with ${J(l)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),He(n)}});return}if(a==="report"){Ve(l);return}if(a==="archive"){rn(n,{clearActive:!0,toast:!0});return}}},mn=()=>{re(n=>{const a=!n;return a||ee(""),a})},ze=()=>{Ze(!1),Qe(null)},dn=()=>{H&&ae({title:`Delete chat with ${J(H)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),(async()=>await He(H.id)&&ze())()}})},un=()=>{if(!H)return;const n=H.id,a=!!H.blocked,l=J(H);ae({title:a?`Unblock ${l}?`:`Block ${l}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{W(),(a?await sn(n):await ft(n))&&ze()}})},fn=()=>{H&&Ve(H)},pn=n=>{if(n==="home"){ke(n),window.location.href="homepage.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&M(null),ke(n);const a=n.charAt(0).toUpperCase()+n.slice(1);u(`${a} selected.`)},hn=n=>{pt(n,{clearActive:!1,toast:!0})},vn=n=>{ln(n)},En=[{label:"Delete chats",onSelect:()=>ht("delete")},{label:"Reports",onSelect:()=>ke("reports")},{label:"Logout",onSelect:()=>ae({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{W(),Un(),Ue({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),at({...me,...i}),u("Logged out.")}})}],he=!!(m||g!=null&&g.id||qe),vt=he||$==="archive"||$==="block"||$==="profile"||$==="reports",gn=tt;return d.useEffect(()=>{if(!S||$!=="block")return;let n=!1;return(async()=>{try{const a=await bn({sessionId:x,sessionCsrf:D});n||Ee(a)}catch{}})(),()=>{n=!0}},[S,$,x,D]),d.useEffect(()=>{if(!S||$!=="reports")return;let n=!1;return(async()=>{try{const a=await Et({sessionId:x,sessionCsrf:D});n||xe(a)}catch{}})(),()=>{n=!0}},[S,$,x,D]),d.useEffect(()=>{if(!De||!(Q!=null&&Q.id))return;const n=Ae.find(a=>a.id===Q.id);if(!n){ct();return}Le(n)},[De,Q==null?void 0:Q.id,Ae]),e.createElement("div",{className:`chp-app${he?" chat-only":""}${vt&&!he?" no-header":""}`},vt?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:yn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(We,{ariaLabel:"App menu",items:En}))),e.createElement("main",{className:"chp-main","data-view":he?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},$==="archive"?e.createElement(la,{chats:$t,onOpenChat:mt,onUnarchive:hn}):$==="block"?e.createElement(ra,{chats:Ft,onUnblock:vn}):$==="profile"?e.createElement(sa,{currentUser:Rt}):$==="reports"?e.createElement(oa,{reports:Ae,onOpenReport:Wt}):e.createElement(ma,{chats:_t,searchValue:le,onSearchChange:ve,activeChatId:m,onOpenChat:mt,onChatAction:cn})),e.createElement("section",{className:"chp-pane chp-convo-pane"},qe?e.createElement(aa,{chat:H,onClose:ze,onDelete:dn,onBlock:un,onReport:fn}):e.createElement(va,{chat:F,groupedMessages:Vt,searchValue:X,showSearch:Be,onToggleSearch:mn,onSearchChange:ee,onBack:()=>{M(null),P(null)},onSend:Qt,composerValue:te,onComposerChange:ue,onAttach:Gt,composerRef:Ut,typing:j,conversationLoading:jt,messageListRef:lt,matchCount:_e.length,onMenuAction:on,attachmentPreview:V,onOpenAttachmentPreview:Ht,onCloseAttachmentPreview:zt,onSaveAttachmentPreview:Kt,onReportAttachmentPreview:Yt}))),he?null:e.createElement(Ea,{activeKey:$,onSelect:pn}),gn?e.createElement(ia,null):null,e.createElement(ca,{open:De,report:Q,onClose:ct}),e.createElement(na,{open:Mt,onClose:it,reasons:Nt,value:ge,onChange:be,details:Xe,onDetailsChange:ye,onSubmit:qt,targetName:oe==null?void 0:oe.name}),e.createElement(ta,{open:ce.open,title:ce.title,message:ce.message,confirmLabel:ce.confirmLabel,onConfirm:()=>{ce.onConfirm?ce.onConfirm():W()},onCancel:W}),e.createElement("input",{ref:Oe,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:Jt,style:{display:"none"}}))}const ba=Ln(document.getElementById("root"));ba.render(e.createElement(e.StrictMode,null,e.createElement(ga,null)));
