import{r as d,f as Tn,a as Ct,R as e,l as Bn,g as xn,b as An,m as Mn,s as Dn,c as wt,d as Rn,e as Pn,h as Ln,i as jn,u as Un,j as St,k as On,n as $n,o as It,p as Fn}from"./realtimeClient-DbOXVEZR.js";const fe={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},_n=[],Vn={},Tt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}],Mt=[{id:"recent",name:"Recent",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',emojis:["ğŸ˜‚","â¤ï¸","ğŸ‘","ğŸ”¥","ğŸ˜Š","ğŸ™","ğŸ¥º","ğŸ¤£"]},{id:"smileys",name:"Smileys & Emotion",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ˜‰","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ˜’","ğŸ˜”","ğŸ™","ğŸ˜¢","ğŸ˜­","ğŸ˜ ","ğŸ˜¡","ğŸ˜³","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ¤—","ğŸ¤”","ğŸ™„","ğŸ¤­","ğŸ¤¯","ğŸ¥´","ğŸ¤ "]},{id:"people",name:"People & Body",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v10"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>',emojis:["ğŸ‘‹","ğŸ¤š","âœ‹","ğŸ‘Œ","âœŒï¸","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","ğŸ‘","ğŸ‘","ğŸ‘Š","ğŸ‘","ğŸ™Œ","ğŸ™","âœï¸","ğŸ’ª","ğŸ§ ","ğŸ‘€","ğŸ‘¶","ğŸ‘¦","ğŸ‘§","ğŸ‘¨","ğŸ‘©","ğŸ‘´","ğŸ‘µ","ğŸ‘®"]},{id:"nature",name:"Animals & Nature",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>',emojis:["ğŸ¶","ğŸ±","ğŸ­","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ§","ğŸ¦†","ğŸŠ","ğŸ¢","ğŸ³","ğŸŸ","ğŸ™","ğŸ’","ğŸŒ¸","ğŸŒ¹","ğŸŒº","ğŸŒ»","ğŸŒ·","ğŸŒ±","ğŸŒ²","ğŸŒ´","ğŸ"]},{id:"food",name:"Food & Drink",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20"></path><path d="M15 3v10"></path><path d="M15 17v5"></path><path d="M15 3c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M15 17c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M9 3v10"></path><path d="M9 17v5"></path><path d="M9 3c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M9 17c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path></svg>',emojis:["ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥•","ğŸ„","ğŸ","ğŸ¥–","ğŸ§€","ğŸ”","ğŸŸ","ğŸ•","ğŸŒ­","ğŸŒ®","ğŸŒ¯","ğŸ³","ğŸš","ğŸ","ğŸ£","ğŸ¦","ğŸ©","â˜•"]},{id:"travel",name:"Travel & Places",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',emojis:["ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš“","ğŸš‘","ğŸš’","ğŸšš","ğŸš²","âœˆï¸","ğŸš€","â›µ","ğŸš¢","â›½","ğŸš§","ğŸ—ºï¸","ğŸ—½","ğŸ°","ğŸ¡","ğŸ–ï¸","ğŸ ","ğŸ¢","ğŸ¥","ğŸª","ğŸ­","ğŸŒ†","ğŸŒƒ","ğŸŒ","ğŸŒŒ","ğŸŒˆ"]},{id:"symbols",name:"Symbols",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12h2"></path><path d="M12 11v2"></path><circle cx="12" cy="12" r="10"></circle></svg>',emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’—","ğŸ’–","âœï¸","â˜ªï¸","ğŸ”¯","â™ˆ","â™‰","â™“","âŒ","â­•","â›”","ğŸ’¯","â—","â“","â€¼ï¸","âš ï¸","âœ…","â™»ï¸","ğŸ’¤","â™¿"]}];function Hn(){if(typeof document>"u")return null;const t=Bt("standard_session_id"),s=Bt("standard_csrf_token");return!t||!s?null:{sessionId:t,sessionCsrf:s}}function zn(){typeof document>"u"||(xt("standard_session_id"),xt("standard_csrf_token"))}function Bt(t){if(!t||typeof document>"u")return"";try{const s=String(document.cookie||"");if(!s)return"";const r=s.split(";");let c="";for(const p of r){const h=p.indexOf("=");if(h<=0||p.slice(0,h).trim()!==t)continue;const I=p.slice(h+1).trim();if(I)try{c=decodeURIComponent(I).trim()}catch{c=I.trim()}}return c}catch{return""}}function xt(t){var r;const s=typeof window<"u"&&((r=window.location)==null?void 0:r.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Lax${s}`}function Kn(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||"");return{conversationId:(t.get("conversationId")||"").trim(),recipientId:(t.get("recipientId")||"").trim(),recipientName:(t.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function Yn(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function he(t){if(!t)return"";const s=t.split(" ").filter(Boolean),r=s[0]?s[0][0]:"",c=s.length>1?s[s.length-1][0]:"";return(r+c).toUpperCase()}function ee(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function q(t){return!!(t&&(t.blocked||t.blockedByOther))}function Dt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Rt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Qe(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Pt(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Lt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function At(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function Zn(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const r=new Date,c=new Date;return c.setDate(r.getDate()-1),At(s,r)?"Today":At(s,c)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Wn(t){const s=[];let r="";return t.forEach(c=>{const p=c.timestamp.slice(0,10);p!==r&&(s.push({type:"day",id:`day-${p}`,label:Zn(c.timestamp)}),r=p),s.push({type:"message",id:c.id,message:c})}),s}function qn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Qn(t,s){if(!s)return t;const r=qn(s);return t.split(new RegExp(`(${r})`,"ig")).map((p,h)=>p.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:h,className:"msg-highlight"},p):e.createElement("span",{key:h},p))}function Gn(t,s,r){const c=(r==null?void 0:r.selectionStart)??t.length,p=(r==null?void 0:r.selectionEnd)??c;return{nextValue:t.slice(0,c)+s+t.slice(p),caret:c+s.length}}function Je(t,s,r){d.useEffect(()=>{if(!r)return;const c=p=>{!t.current||t.current.contains(p.target)||s()};return document.addEventListener("mousedown",c),document.addEventListener("touchstart",c),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("touchstart",c)}},[t,s,r])}function L({children:t,size:s=20,className:r}){return e.createElement("svg",{className:r,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const Jn=t=>e.createElement(L,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),jt=t=>e.createElement(L,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Ut=t=>e.createElement(L,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),Xn=t=>e.createElement(L,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),ea=t=>e.createElement(L,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),ta=t=>e.createElement(L,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),na=t=>e.createElement(L,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),aa=t=>e.createElement(L,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),sa=t=>e.createElement(L,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),la=t=>e.createElement(L,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),ra=t=>e.createElement(L,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),oa=t=>e.createElement(L,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),le=t=>e.createElement(L,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),ca=t=>e.createElement(L,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),ia=t=>e.createElement(L,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),Ot=t=>e.createElement(L,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function Xe({ariaLabel:t,items:s}){const[r,c]=d.useState(!1),p=d.useRef(null);return Je(p,()=>c(!1),r),e.createElement("div",{className:"menu-wrap",ref:p},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":r,onClick:()=>c(h=>!h),type:"button"},e.createElement(Jn,null)),r?e.createElement("div",{className:"dropdown",role:"menu"},s.map(h=>e.createElement("button",{key:h.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{c(!1),h.onSelect()}},h.label))):null)}function ma({status:t}){if(!t)return null;if(t==="sent")return e.createElement(na,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(aa,{className:s})}function da({open:t,title:s,message:r,confirmLabel:c,onConfirm:p,onCancel:h}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,r),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:h},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:p},c)))):null}function ua({open:t,onClose:s,reasons:r,value:c,onChange:p,details:h,onDetailsChange:u,onSubmit:I,targetName:y}){const[N,k]=d.useState(!1),H=d.useRef(null),E=r.find(i=>i.value===c);return Je(H,()=>k(!1),N),d.useEffect(()=>{t||k(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",y||"this chat","."),e.createElement("div",{className:`report-select${N?" active":""}`,ref:H},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>k(i=>!i),"aria-haspopup":"listbox","aria-expanded":N},e.createElement("span",null,E?E.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},r.map(i=>e.createElement("button",{key:i.value,type:"button",className:`report-select__option${c===i.value?" selected":""}`,onClick:()=>{p(i.value),k(!1)},role:"option","aria-selected":c===i.value},i.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:h,onChange:i=>u(i.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:I,disabled:!c},"Report")))):null}function fa({chat:t,onClose:s,onDelete:r,onBlock:c,onReport:p}){if(!t)return null;const h=!!t.blockedByOther,u=ee(t),I=t.name?t.name.split(" ").filter(Boolean):[],y=I[0]||"",N=I.slice(1).join(" "),k=h?"-":t.firstName||y||"-",H=h?"-":t.lastName||N||"-",E=h?"-":t.suburb||"-",i=h?"-":t.city||"-",A=h?"-":t.province||"-",g=h?"-":t.accountSince||"-",_=h?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(Ut,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:t.color}},q(t)?e.createElement(le,{className:"avatar-blocked-icon",size:18}):he(u)),e.createElement("div",null,e.createElement("h3",null,u))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",k),e.createElement("p",null,"Family name: ",H),e.createElement("p",null,"Suburb: ",E),e.createElement("p",null,"City: ",i),e.createElement("p",null,"Province: ",A),e.createElement("p",null,"Account since: ",g),e.createElement("p",null,"Account type: ",_)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:r},e.createElement(ia,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:c},e.createElement(le,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:p},e.createElement(oa,null),"Report"))))))}function Me({title:t,subtitle:s,children:r}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},r))}function ha({currentUser:t}){const s={...fe,...t&&typeof t=="object"?t:{}},r=s.name||"User";return e.createElement(Me,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},he(r)),e.createElement("div",null,e.createElement("h3",null,r),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function pa({chats:t,onOpenChat:s,onUnarchive:r}){return e.createElement(Me,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(c=>{const p=ee(c);return e.createElement("div",{key:c.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:c.color}},q(c)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(c.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},p),e.createElement("div",{className:"section-item-sub"},c.lastMessage?c.lastMessage:"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,Rt(c.archivedAt||c.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(c.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>r(c.id)},"Unarchive"))))})))}function va({chats:t,onUnblock:s}){return e.createElement(Me,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color}},e.createElement(le,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,Rt(r.blockedAt||r.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(r.id)},"Unblock"))))))}function Ea({reports:t,onOpenReport:s}){return e.createElement(Me,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color||"#3b82f6"}},he(r.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name),e.createElement("div",{className:"section-item-sub"},r.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Lt(r.status)}`},Pt(r.status)),e.createElement("span",null,Qe(r.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(r)},"View report"))))))}function ga({open:t,report:s,onClose:r}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:r,"aria-label":"Close report details"},e.createElement(Ot,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Lt(s.status)}`},Pt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Qe(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Qe(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Ge({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function ba(){const t=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((r,c)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:c},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((r,c)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:c},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function ya({chats:t,searchValue:s,onSearchChange:r,activeChatId:c,onOpenChat:p,onChatAction:h}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(jt,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:u=>r(u.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Ge,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(u=>{const I=ee(u);return e.createElement("div",{key:u.id,className:`chat-item ${c===u.id?"active":""}`,onClick:()=>p(u.id),onKeyDown:y=>{(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),p(u.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${I}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:u.color}},q(u)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(u.name)),u.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},I),e.createElement("span",{className:"chat-time"},Dt(u.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},u.lastMessage?u.lastMessage:"No messages yet"),u.unread>0?e.createElement("span",{className:"chat-unread"},u.unread):null)),e.createElement("div",{className:"chat-actions",onClick:y=>y.stopPropagation(),onKeyDown:y=>y.stopPropagation()},e.createElement(Xe,{ariaLabel:`More options for ${I}`,items:[{label:"Delete chat",onSelect:()=>h(u.id,"delete")},{label:"Report",onSelect:()=>h(u.id,"report")},{label:"Archive",onSelect:()=>h(u.id,"archive")}]})))})))}function Na({message:t,query:s,onPreviewImage:r}){const c=t.sender==="me",p=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",h=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",u=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",I=!!t.attachmentIsImage||h.startsWith("image/"),y=!!t.attachmentIsVideo||h.startsWith("video/"),N=typeof t.text=="string"&&t.text.trim().length>0,k={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:N?"8px":"0"};return e.createElement("div",{className:`message-row ${c?"me":"them"}`},e.createElement("div",{className:`message-bubble ${c?"outgoing":"incoming"}`},p?e.createElement("div",{className:"message-attachment"},I?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{r&&r(t)},"aria-label":`Preview ${u}`},e.createElement("img",{src:p,alt:u,loading:"lazy",style:k})):y?e.createElement("video",{controls:!0,preload:"metadata",style:k},e.createElement("source",{src:p,type:h||void 0})):e.createElement("a",{href:p,target:"_blank",rel:"noreferrer"},"Open attachment")):null,N?e.createElement("div",{className:"message-text"},Qn(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Dt(t.timestamp)),c?e.createElement(ma,{status:t.status}):null)))}function ka({preview:t,onClose:s,onSave:r,onReport:c}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Ot,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:r},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:c},"Report Photo"))):null}function Ca(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function wa(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,r)=>e.createElement("div",{key:r,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function Sa({value:t,onChange:s,onSend:r,onEmoji:c,onAttach:p,inputRef:h,disabled:u=!1}){d.useEffect(()=>{const y=h==null?void 0:h.current;y&&(y.style.height="auto",y.style.height=`${Math.min(y.scrollHeight,120)}px`)},[t,h]);const I=y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),!u&&t.trim()&&r())};return e.createElement("div",{className:"composer"},e.createElement("div",{className:"composer-actions"},e.createElement("button",{className:"icon-btn",type:"button",onClick:c,"aria-label":"Emoji",disabled:u},e.createElement(ea,null)),e.createElement("button",{className:"icon-btn",type:"button",onClick:p,"aria-label":"Attach",disabled:u},e.createElement(ta,null))),e.createElement("textarea",{ref:h,rows:1,value:t,onChange:y=>s(y.target.value),onKeyDown:I,placeholder:u?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:u}),e.createElement("button",{className:"send-btn",type:"button",onClick:r,disabled:u||!t.trim(),"aria-label":"Send message"},e.createElement(Xn,null)))}function Ia({open:t,recents:s,onSelect:r,onClose:c}){const[p,h]=d.useState("recent"),u=d.useRef(null),I=d.useRef(null),y=d.useRef({});Je(I,c,t);const N=d.useMemo(()=>Mt.map(E=>E.id==="recent"?{...E,emojis:s}:E),[s]);d.useEffect(()=>{var i;if(!t)return;const E=((i=N[0])==null?void 0:i.id)||"recent";h(E),u.current&&(u.current.scrollTop=0)},[t,N]);const k=()=>{const E=u.current;if(!E)return;let i=p;N.forEach(A=>{const g=y.current[A.id];g&&E.scrollTop>=g.offsetTop-40&&(i=A.id)}),i!==p&&h(i)},H=E=>{const i=y.current[E];i&&(i.scrollIntoView({behavior:"smooth",block:"start"}),h(E))};return t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker fade-in",ref:I},e.createElement("div",{className:"picker-header"},e.createElement("div",{className:"category-tabs",role:"tablist"},N.map(E=>e.createElement("button",{key:E.id,type:"button",className:`category-tab ${p===E.id?"active":""}`,onClick:()=>H(E.id),"aria-label":E.name,"aria-pressed":p===E.id,dangerouslySetInnerHTML:{__html:E.icon}})))),e.createElement("div",{className:"emoji-list",onScroll:k,ref:u},N.length===0?e.createElement("div",{className:"emoji-empty"},"No emojis found."):N.map(E=>e.createElement("div",{key:E.id,className:"category-section",ref:i=>{y.current[E.id]=i}},e.createElement("div",{className:"category-title"},E.name),e.createElement("div",{className:"emoji-grid"},E.emojis.map((i,A)=>e.createElement("button",{key:`${E.id}-${A}`,type:"button",className:"emoji-item",onClick:()=>r(i),"aria-label":"Emoji"},i)))))))):null}function Ta({chat:t,groupedMessages:s,searchValue:r,showSearch:c,onToggleSearch:p,onSearchChange:h,onBack:u,onSend:I,composerValue:y,onComposerChange:N,onEmoji:k,onAttach:H,emojiOpen:E,emojiRecents:i,onEmojiSelect:A,onEmojiClose:g,composerRef:_,typing:re,conversationLoading:oe,messageListRef:te,matchCount:Q,onMenuAction:G,attachmentPreview:ne,onOpenAttachmentPreview:ce,onCloseAttachmentPreview:ie,onSaveAttachmentPreview:De,onReportAttachmentPreview:pe}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Ge,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(ne)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(ka,{preview:ne,onClose:ie,onSave:De,onReport:pe}));const Re=ee(t),be=!!t.launchPending,ye=be?[{label:"Close chat",onSelect:()=>G("close")}]:[{label:"View profile",onSelect:()=>G("profile")},{label:"Close chat",onSelect:()=>G("close")},{label:"Delete chat",onSelect:()=>G("delete")},{label:"Block",onSelect:()=>G("block")},{label:"Report",onSelect:()=>G("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:u,"aria-label":"Back to chats"},e.createElement(Ut,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},q(t)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},Re),e.createElement("div",{className:"conversation-status"},be?e.createElement("span",null,"Start conversation"):re?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(Xe,{ariaLabel:"Conversation menu",items:ye}))),c?e.createElement("div",{className:"conversation-search"},e.createElement(jt,{className:"search-icon"}),e.createElement("input",{type:"search",value:r,onChange:U=>h(U.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),r?e.createElement("span",{className:"search-count"},Q," match",Q===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:te},oe?e.createElement(wa,null):s.length===0?e.createElement(Ge,{title:r?"No matches":"No messages yet",subtitle:r?"Try a different phrase.":"Send a message to start the chat."}):s.map(U=>U.type==="day"?e.createElement("div",{key:U.id,className:"day-separator"},U.label):e.createElement(Na,{key:U.id,message:U.message,query:r.trim(),onPreviewImage:ce})),re&&!r&&!oe?e.createElement(Ca,null):null,!oe&&q(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(Sa,{value:y,onChange:N,onSend:I,onEmoji:k,onAttach:H,inputRef:_,disabled:q(t)}),e.createElement(Ia,{open:E,recents:i,onSelect:A,onClose:g}))}function Ba({activeKey:t,onSelect:s}){const r=[{key:"home",label:"Home",icon:sa},{key:"archive",label:"Archive",icon:ra},{key:"chats",label:"Chats",icon:la},{key:"block",label:"Block",icon:le},{key:"profile",label:"My Profile",icon:ca}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},r.map(c=>{const p=c.icon;return e.createElement("button",{key:c.key,className:`nav-btn ${t===c.key?"active":""}`,type:"button",onClick:()=>s(c.key),"aria-label":c.label},e.createElement("span",{className:"icon-box"},e.createElement(p,null)),e.createElement("span",null,c.label))}))}function xa({currentUser:t=fe,initialChats:s=_n,initialMessages:r=Vn}){const c={...fe,...t&&typeof t=="object"?t:{}},p=Array.isArray(s)?s:[],h=r&&typeof r=="object"?r:{},u=d.useMemo(()=>Kn(),[]),I=!!(u.conversationId||u.recipientId),y=d.useRef(!I),[N,k]=d.useState(p),[H,E]=d.useState(h),[i,A]=d.useState(null),[g,_]=d.useState(u.recipientId?{id:u.recipientId,name:u.recipientName||"Business"}:null),[re,oe]=d.useState(""),[te,Q]=d.useState(""),[G,ne]=d.useState(!1),[ce,ie]=d.useState(""),[De,pe]=d.useState(!1),[Re,be]=d.useState(()=>{var n;return((n=Mt[0])==null?void 0:n.emojis)||[]}),[ye,U]=d.useState(!1),[et,tt]=d.useState(!1),[z,nt]=d.useState(null),[at,Ne]=d.useState([]),[Pe,Le]=d.useState([]),[je,st]=d.useState(!1),[J,Ue]=d.useState(null),[$t,Oe]=d.useState(!1),[ke,Ce]=d.useState(""),[lt,we]=d.useState(""),[me,$e]=d.useState(null),[V,Fe]=d.useState(null),[Ma,rt]=d.useState(null),[ot,ct]=d.useState(!1),[Ft,Se]=d.useState(null),[Ie,_e]=d.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[_t,it]=d.useState(c),[de,mt]=d.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[O,Te]=d.useState("chats"),dt=d.useRef(null),ve=d.useRef(null),Ve=d.useRef(null),Ee=d.useRef(null),ae=d.useRef(null),X=d.useRef(null),P=d.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),D=Ie.sessionId,R=Ie.sessionCsrf,j=Ie.userId,He=Ie.realtimeToken,T=!!(D&&R&&j),B=N.find(n=>n.id===i)||null,Vt=d.useMemo(()=>Yn(g),[g]),$=B||Vt,Ht=d.useMemo(()=>N.filter(n=>n.archived),[N]),zt=d.useMemo(()=>{const n=new Map;return at.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[at]),ze=d.useMemo(()=>N.filter(n=>!n.archived),[N]),Kt=d.useMemo(()=>{const n=re.trim().toLowerCase();return n?ze.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):ze},[ze,re]),Be=i?H[i]||[]:[],Ke=d.useMemo(()=>{const n=te.trim().toLowerCase();return n?Be.filter(a=>a.text.toLowerCase().includes(n)):Be},[Be,te]),Yt=d.useMemo(()=>Wn(Ke),[Ke]),Zt=!!(i&&Ft===i),ut=()=>{X.current&&(window.clearTimeout(X.current),X.current=null),P.current.idleTimer&&(window.clearTimeout(P.current.idleTimer),P.current.idleTimer=null)},xe=async(n,{force:a=!1}={})=>{const l=ae.current;if(!l||!j)return;const o=!!n,m=Date.now(),v=P.current;if(!(!a&&v.lastValue===o&&m-v.lastSentAt<600)){v.lastValue=o,v.lastSentAt=m;try{await l.send({type:"broadcast",event:"typing",payload:{isTyping:o,userId:String(j)}})}catch{}}};d.useEffect(()=>{let n=!1;return(async()=>{if(!i||!j||!He||!T){U(!1);return}try{const l=await xn();if(!l||n)return;l.realtime.setAuth(He);const o=ae.current;if(o)try{await o.unsubscribe()}catch{}ae.current=null,ut(),P.current.lastValue=!1;const m=l.channel(`conversation:${i}`,{config:{presence:{key:`chat:${String(j)}`}}});m.on("broadcast",{event:"typing"},({payload:v})=>{const C=String((v==null?void 0:v.userId)||"");if(!C||C===String(j))return;const b=!!(v!=null&&v.isTyping);U(b),X.current&&(window.clearTimeout(X.current),X.current=null),b&&(X.current=window.setTimeout(()=>{U(!1),X.current=null},3e3))}),m.subscribe(async v=>{if(!(n||v!=="SUBSCRIBED"))try{await m.track({userId:String(j),at:new Date().toISOString()})}catch{}}),ae.current=m}catch{n||U(!1)}})(),()=>{n=!0;const l=ae.current;if(ae.current=null,l)try{l.unsubscribe()}catch{}ut(),P.current.lastValue=!1,U(!1)}},[i,T,j,He]),d.useEffect(()=>{if(!i||!j||!ae.current)return;const n=ce.trim().length>0,a=Date.now(),l=P.current;n!==l.lastValue&&a-l.lastSentAt>600&&xe(n,{force:!0}),l.idleTimer&&(window.clearTimeout(l.idleTimer),l.idleTimer=null),n&&(l.idleTimer=window.setTimeout(()=>{P.current.idleTimer=null,xe(!1,{force:!0})},2e3))},[ce,i,j]),d.useEffect(()=>{if(!i||te.trim())return;const n=dt.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[i,Be.length,ye,te]),d.useEffect(()=>{i||pe(!1)},[i]),d.useEffect(()=>{Fe(null)},[i]),d.useEffect(()=>()=>{Ee.current&&clearTimeout(Ee.current)},[]),d.useEffect(()=>{(!i||!T)&&Se(null)},[i,T]);const f=n=>{rt(n),Ee.current&&clearTimeout(Ee.current),Ee.current=setTimeout(()=>rt(null),2400)},ft=(n,a={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const l=!!(a!=null&&a.silent);return _e({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),A(null),_(null),l||f("Session missing or expired. Please log in again."),!0},Wt=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",l=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",o=!!n.attachmentIsImage||l.startsWith("image/");if(!a||!o)return;const m=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";Fe({url:a,name:m,messageId:typeof n.id=="string"?n.id:""})},qt=()=>{Fe(null)},Qt=async()=>{if(!(V!=null&&V.url))return;const n=V.name||"photo";try{const a=await fetch(V.url);if(!a.ok)throw new Error("download_failed");const l=await a.blob(),o=window.URL.createObjectURL(l),m=document.createElement("a");m.href=o,m.download=n,document.body.appendChild(m),m.click(),m.remove(),window.URL.revokeObjectURL(o),f("Image saved.")}catch{const a=document.createElement("a");a.href=V.url,a.target="_blank",a.rel="noreferrer",a.click(),f("Could not save directly. Opened image in a new tab.")}},Gt=()=>{if(!B){f("No chat selected.");return}$e(B),Ce(""),we(V!=null&&V.name?`Photo attachment: ${V.name}`:"Photo attachment"),Oe(!0)};d.useEffect(()=>{if(!i||!T)return;let n=!1;Se(i);const a=async({silent:o=!1}={})=>{try{const{messages:m,chatPatch:v}=await An({sessionId:D,sessionCsrf:R,conversationId:i,currentUserId:j});if(n)return;E(C=>({...C,[i]:m})),k(C=>C.map(b=>b.id===i?{...b,...v||{},unread:0}:b));try{await Mn({sessionId:D,sessionCsrf:R,conversationId:i})}catch{}}catch(m){if(!n&&ft(m))return;!n&&!o&&f((m==null?void 0:m.message)||"Failed to load chat messages.")}finally{n||Se(m=>m===i?null:m)}};a();const l=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(l)}},[i,T,D,R,j]);const Jt=n=>{n&&(Ue(n),st(!0))},ht=()=>{st(!1),Ue(null)},Ye=n=>{n&&($e(n),Ce(""),we(""),Oe(!0))},pt=()=>{Oe(!1),$e(null),Ce(""),we("")},Xt=async()=>{var o;if(!me||!ke)return;if(!T){f("Session missing or expired. Please log in again.");return}const n=((o=Tt.find(m=>m.value===ke))==null?void 0:o.label)||ke,a=lt.trim(),l=a?`${n} - ${a}`:n;try{await Rn({sessionId:D,sessionCsrf:R,conversationId:me.id,recipientId:me.otherPartyId,reason:l});try{const m=await Ct({sessionId:D,sessionCsrf:R});Le(m)}catch{}pt(),f("Report sent.")}catch(m){f((m==null?void 0:m.message)||"Failed to submit report.")}},se=({title:n,message:a,confirmLabel:l,onConfirm:o})=>{mt({open:!0,title:n,message:a,confirmLabel:l,onConfirm:o})},W=()=>{mt(n=>({...n,open:!1}))},en=async(n,a,l={})=>{const o=!!(l!=null&&l.silent);if(ot)return!1;const m=n.trim(),v=a.trim();if(!m||!v)return o||f("Session credentials missing. Please log in again."),!1;ct(!0);try{const C=await Ln({sessionId:m,sessionCsrf:v}),{chats:b,blockedAccounts:w,reports:S,currentUser:M}=await jn({sessionId:m,sessionCsrf:v});_e({sessionId:m,sessionCsrf:v,userId:C.userId,realtimeToken:C.token||""}),it(M?{...fe,...M}:{...fe,...c}),k(b),Ne(w),E({}),Le(S);let x=null,ue=null;if(!y.current){if(u.conversationId){const K=b.find(Y=>Y.id===u.conversationId);K&&(x=K.id)}if(!x&&u.recipientId){const K=b.find(Y=>Y.otherPartyId===u.recipientId);K?x=K.id:ue={id:u.recipientId,name:u.recipientName||"Business"}}y.current=!0}return _(ue),A(x),oe(""),Q(""),ne(!1),Te("chats"),!o&&b.length===0?f("Connected. No chats found."):o||f(`Connected. Loaded ${b.length} chat${b.length===1?"":"s"}.`),!0}catch(C){const b=ft(C,{silent:o});return!o&&!b&&f((C==null?void 0:C.message)||"Failed to restore your session."),!1}finally{ct(!1)}};d.useEffect(()=>{let n=!1;return(async()=>{if(T)return;const l=Hn();if(!l){n||f("Session missing or expired. Please log in again.");return}await en(l.sessionId,l.sessionCsrf,{silent:!0})||n||f("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const vt=async(n,a={})=>{a.unarchive&&!await yt(n,{clearActive:!1,toast:!0})||(A(n),_(null),T&&Se(n),k(l=>l.map(o=>o.id===n?{...o,unread:0}:o)),ne(!1),Q(""))},Et=(n,a,l)=>{E(o=>{const m=o[n]||[];return{...o,[n]:m.map(v=>v.id===a?{...v,status:l}:v)}})},tn=async()=>{const n=ce.trim(),a=i||"",l=a?"":(g==null?void 0:g.id)||"",o=(B==null?void 0:B.name)||(g==null?void 0:g.name)||u.recipientName||"Business",m=(B==null?void 0:B.color)||"#3b82f6";if(!n||!!!(a||l))return;if(q($)){f($!=null&&$.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(T){try{const b=await Dn({sessionId:D,sessionCsrf:R,conversationId:a||void 0,recipientId:l||void 0,content:n}),w=wt(b==null?void 0:b.data,j),S=(typeof w.chatId=="string"?w.chatId.trim():"")||a;if(!S)throw new Error("Failed to resolve conversation ID.");E(M=>({...M,[S]:[...M[S]||[],w]})),ie(""),k(M=>{const x=w.timestamp||new Date().toISOString();if(!M.find(F=>F.id===S))return[{id:S,name:o,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:w.text||n,lastTime:x,unread:0,online:!1,presence:"offline",color:m,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:l||(g==null?void 0:g.id)||""},...M];const K=M.map(F=>F.id===S?{...F,lastMessage:w.text||n,lastTime:w.timestamp||x,unread:0}:F),Y=K.find(F=>F.id===S),Ae=K.filter(F=>F.id!==S);return Y?[Y,...Ae]:K}),A(S),_(null),P.current.idleTimer&&(window.clearTimeout(P.current.idleTimer),P.current.idleTimer=null),P.current.lastValue=!1,xe(!1,{force:!0})}catch(b){f((b==null?void 0:b.message)||"Failed to send message.")}return}if(!a){f("Session missing or expired. Please log in again.");return}const C={id:`m-${Date.now()}`,chatId:a,sender:"me",text:n,timestamp:new Date().toISOString(),status:"sent"};E(b=>({...b,[a]:[...b[a]||[],C]})),ie(""),k(b=>{const w=b.map(x=>x.id===a?{...x,lastMessage:n,lastTime:C.timestamp,unread:0}:x),S=w.find(x=>x.id===a),M=w.filter(x=>x.id!==a);return S?[S,...M]:w}),setTimeout(()=>Et(a,C.id,"delivered"),900),setTimeout(()=>Et(a,C.id,"read"),2e3),P.current.idleTimer&&(window.clearTimeout(P.current.idleTimer),P.current.idleTimer=null),P.current.lastValue=!1,xe(!1,{force:!0})},nn=()=>{if(!i&&!(g!=null&&g.id)){f("Select a chat to add emojis.");return}pe(n=>!n)},an=()=>{pe(!1)},sn=n=>{n&&(be(a=>[n,...a.filter(l=>l!==n)].slice(0,24)),ie(a=>{const{nextValue:l,caret:o}=Gn(a,n,ve.current);return requestAnimationFrame(()=>{ve.current&&(ve.current.focus(),ve.current.setSelectionRange(o,o))}),l}))},ln=()=>{if(!i&&!(g!=null&&g.id)){f("Select a chat first.");return}if(!T){f("Session missing or expired. Please log in again.");return}if(q($)){f($!=null&&$.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}Ve.current&&Ve.current.click()},rn=async n=>{var b;const a=n.target,l=(b=a==null?void 0:a.files)==null?void 0:b[0];if(a&&(a.value=""),!l)return;if(!i&&!(g!=null&&g.id)){f("Select a chat first.");return}if(!T){f("Session missing or expired. Please log in again.");return}if(q($)){f($!=null&&$.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const o=i||"",m=o?"":(g==null?void 0:g.id)||"",v=(B==null?void 0:B.name)||(g==null?void 0:g.name)||u.recipientName||"Business",C=(B==null?void 0:B.color)||"#3b82f6";try{const w=await Pn({sessionId:D,sessionCsrf:R,conversationId:o||void 0,recipientId:m||void 0,file:l}),S=wt(w==null?void 0:w.data,j),M=(typeof S.chatId=="string"?S.chatId.trim():"")||o;if(!M)throw new Error("Failed to resolve conversation ID.");E(x=>({...x,[M]:[...x[M]||[],S]})),k(x=>{const ue=S.timestamp||new Date().toISOString();if(!x.find(Z=>Z.id===M))return[{id:M,name:v,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:S.text||l.name,lastTime:ue,unread:0,online:!1,presence:"offline",color:C,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:m||(g==null?void 0:g.id)||""},...x];const Y=x.map(Z=>Z.id===M?{...Z,lastMessage:S.text||l.name,lastTime:S.timestamp||ue,unread:0}:Z),Ae=Y.find(Z=>Z.id===M),F=Y.filter(Z=>Z.id!==M);return Ae?[Ae,...F]:Y}),A(M),_(null),f("Attachment sent.")}catch(w){f((w==null?void 0:w.message)||"Failed to send attachment.")}},on=n=>{E(a=>({...a,[n]:[]})),k(a=>a.map(l=>l.id===n?{...l,lastMessage:"No messages yet",lastTime:"",unread:0}:l))},cn=()=>{if(i){on(i),f("Cleared current chat.");return}const n={};N.forEach(a=>{n[a.id]=[]}),E(n),k(a=>a.map(l=>({...l,lastMessage:"No messages yet",lastTime:"",unread:0}))),f("Cleared all chats.")},Ze=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(k(l=>l.filter(o=>!a.has(o.id))),E(l=>{const o={...l};return a.forEach(m=>{delete o[m]}),o}),i&&a.has(i)&&A(null))},We=async(n,a={})=>{const l=typeof n=="string"?n.trim():"";if(!l)return!1;const o=a.toast!==!1;if(T)try{await It({sessionId:D,sessionCsrf:R,conversationId:l})}catch(m){return f((m==null?void 0:m.message)||"Failed to delete chat."),!1}return Ze([l]),o&&f("Chat deleted."),!0},mn=async()=>{const n=N.map(o=>o.id).filter(Boolean);if(n.length===0)return f("No chats to delete."),!1;if(!T)return Ze(n),f("All chats deleted."),!0;const a=[];for(const o of n)try{await It({sessionId:D,sessionCsrf:R,conversationId:o}),a.push(o)}catch{}a.length>0&&Ze(a);const l=n.length-a.length;return a.length===0?(f("Failed to delete chats."),!1):l===0?(f("All chats deleted."),!0):(f(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${l} failed.`),!1)},dn=async()=>{if(i){await We(i);return}await mn()},un=(n,a)=>{const l=N.find(b=>b.id===n),o=(l==null?void 0:l.otherPartyId)||n;if(!o)return;const m=a||new Date().toISOString(),v=(l==null?void 0:l.name)||"Unknown",C=(l==null?void 0:l.color)||"#3b82f6";Ne(b=>{const w=b.filter(S=>S.id!==o);return[{id:o,name:v,blockedAt:m,color:C},...w]})},gt=({accountId:n,conversationId:a=""})=>{const l=typeof n=="string"?n.trim():"",o=typeof a=="string"?a.trim():"";k(m=>m.map(v=>{const C=!!o&&v.id===o,b=!!l&&v.otherPartyId===l;if(!C&&!b)return v;const w=!!v.blockedByOther;return{...v,blocked:!1,blockedByMe:!1,hasBlockingRelationship:w,blockedAt:void 0}})),l&&Ne(m=>m.filter(v=>v.id!==l))},bt=async n=>{if(!n)return!1;if(T)try{await $n({sessionId:D,sessionCsrf:R,conversationId:n})}catch(l){return f((l==null?void 0:l.message)||"Failed to block account."),!1}const a=new Date().toISOString();return k(l=>l.map(o=>o.id===n?{...o,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:o)),un(n,a),i===n&&A(null),f("Chat blocked."),!0},fn=async n=>{if(!n)return!1;const a=N.find(o=>o.id===n),l=(a==null?void 0:a.otherPartyId)||"";if(T)try{await St({sessionId:D,sessionCsrf:R,conversationId:n||void 0,recipientId:l||void 0})}catch(o){return f((o==null?void 0:o.message)||"Failed to unblock account."),!1}return gt({accountId:l,conversationId:n}),f("Account unblocked."),!0},hn=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const l=N.find(m=>m.otherPartyId===a),o=(l==null?void 0:l.id)||"";if(T)try{await St({sessionId:D,sessionCsrf:R,conversationId:o||void 0,recipientId:a})}catch(m){return f((m==null?void 0:m.message)||"Failed to unblock account."),!1}return gt({accountId:a,conversationId:o}),f("Account unblocked."),!0},pn=async(n,a={})=>{if(!n)return!1;const l=a.clearActive!==!1,o=a.toast!==!1;if(T)try{await On({sessionId:D,sessionCsrf:R,conversationId:n})}catch(m){return f((m==null?void 0:m.message)||"Failed to archive chat."),!1}return k(m=>m.map(v=>v.id===n?{...v,archived:!0,archivedAt:new Date().toISOString()}:v)),l&&i===n&&A(null),o&&f("Chat archived."),!0},yt=async(n,a={})=>{if(!n)return!1;const l=a.clearActive===!0,o=a.toast!==!1;if(T)try{await Un({sessionId:D,sessionCsrf:R,conversationId:n})}catch(m){return f((m==null?void 0:m.message)||"Failed to restore chat."),!1}return k(m=>m.map(v=>v.id===n?{...v,archived:!1,archivedAt:void 0}:v)),l&&i===n&&A(null),o&&f("Chat restored from archive."),!0},Nt=n=>{if(n==="profile"){if(!i){f("No chat selected.");return}const a=N.find(l=>l.id===i)||null;nt(a),tt(!0);return}if(n==="close"){A(null),_(null),ne(!1),Q(""),f("Chat closed.");return}if(n==="block"){if(!i)return;const a=N.find(o=>o.id===i),l=(a==null?void 0:a.id)||i;se({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{W(),await bt(l)}});return}if(n==="delete"){const a=B?`Delete chat with ${ee(B)}?`:"Delete all chats?";se({title:a,message:B?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),dn()}});return}if(n==="clear"){const a=B?`Clear chat with ${B.name}?`:"Clear all chats?";se({title:a,message:B?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{W(),cn()}});return}n==="report"&&Ye(B)},vn=n=>{Nt(n)},En=(n,a)=>{const l=N.find(o=>o.id===n);if(l){if(a==="delete"){se({title:`Delete chat with ${ee(l)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),We(n)}});return}if(a==="report"){Ye(l);return}if(a==="archive"){pn(n,{clearActive:!0,toast:!0});return}}},gn=()=>{ne(n=>{const a=!n;return a||Q(""),a})},qe=()=>{tt(!1),nt(null)},bn=()=>{z&&se({title:`Delete chat with ${ee(z)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{W(),(async()=>await We(z.id)&&qe())()}})},yn=()=>{if(!z)return;const n=z.id,a=!!z.blocked,l=ee(z);se({title:a?`Unblock ${l}?`:`Block ${l}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{W(),(a?await fn(n):await bt(n))&&qe()}})},Nn=()=>{z&&Ye(z)},kn=n=>{if(n==="home"){Te(n),window.location.href="homepage.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&A(null),Te(n);const a=n.charAt(0).toUpperCase()+n.slice(1);f(`${a} selected.`)},Cn=n=>{yt(n,{clearActive:!1,toast:!0})},wn=n=>{hn(n)},Sn=[{label:"Delete chats",onSelect:()=>Nt("delete")},{label:"Reports",onSelect:()=>Te("reports")},{label:"Logout",onSelect:()=>se({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{W(),zn(),_e({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),it({...fe,...c}),f("Logged out.")}})}],ge=!!(i||g!=null&&g.id||et),kt=ge||O==="archive"||O==="block"||O==="profile"||O==="reports",In=ot;return d.useEffect(()=>{if(!T||O!=="block")return;let n=!1;return(async()=>{try{const a=await Tn({sessionId:D,sessionCsrf:R});n||Ne(a)}catch{}})(),()=>{n=!0}},[T,O,D,R]),d.useEffect(()=>{if(!T||O!=="reports")return;let n=!1;return(async()=>{try{const a=await Ct({sessionId:D,sessionCsrf:R});n||Le(a)}catch{}})(),()=>{n=!0}},[T,O,D,R]),d.useEffect(()=>{if(!je||!(J!=null&&J.id))return;const n=Pe.find(a=>a.id===J.id);if(!n){ht();return}Ue(n)},[je,J==null?void 0:J.id,Pe]),e.createElement("div",{className:`chp-app${ge?" chat-only":""}${kt&&!ge?" no-header":""}`},kt?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:Bn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(Xe,{ariaLabel:"App menu",items:Sn}))),e.createElement("main",{className:"chp-main","data-view":ge?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},O==="archive"?e.createElement(pa,{chats:Ht,onOpenChat:vt,onUnarchive:Cn}):O==="block"?e.createElement(va,{chats:zt,onUnblock:wn}):O==="profile"?e.createElement(ha,{currentUser:_t}):O==="reports"?e.createElement(Ea,{reports:Pe,onOpenReport:Jt}):e.createElement(ya,{chats:Kt,searchValue:re,onSearchChange:oe,activeChatId:i,onOpenChat:vt,onChatAction:En})),e.createElement("section",{className:"chp-pane chp-convo-pane"},et?e.createElement(fa,{chat:z,onClose:qe,onDelete:bn,onBlock:yn,onReport:Nn}):e.createElement(Ta,{chat:$,groupedMessages:Yt,searchValue:te,showSearch:G,onToggleSearch:gn,onSearchChange:Q,onBack:()=>{A(null),_(null)},onSend:tn,composerValue:ce,onComposerChange:ie,onEmoji:nn,onAttach:ln,emojiOpen:De,emojiRecents:Re,onEmojiSelect:sn,onEmojiClose:an,composerRef:ve,typing:ye,conversationLoading:Zt,messageListRef:dt,matchCount:Ke.length,onMenuAction:vn,attachmentPreview:V,onOpenAttachmentPreview:Wt,onCloseAttachmentPreview:qt,onSaveAttachmentPreview:Qt,onReportAttachmentPreview:Gt}))),ge?null:e.createElement(Ba,{activeKey:O,onSelect:kn}),In?e.createElement(ba,null):null,e.createElement(ga,{open:je,report:J,onClose:ht}),e.createElement(ua,{open:$t,onClose:pt,reasons:Tt,value:ke,onChange:Ce,details:lt,onDetailsChange:we,onSubmit:Xt,targetName:me==null?void 0:me.name}),e.createElement(da,{open:de.open,title:de.title,message:de.message,confirmLabel:de.confirmLabel,onConfirm:()=>{de.onConfirm?de.onConfirm():W()},onCancel:W}),e.createElement("input",{ref:Ve,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:rn,style:{display:"none"}}))}const Aa=Fn(document.getElementById("root"));Aa.render(e.createElement(e.StrictMode,null,e.createElement(xa,null)));
