import{r as i,f as Sa,a as It,R as e,l as Ia,g as Ta,b as Aa,m as Ba,s as xa,c as Tt,j as At,n as Da,d as Ra,e as Pa,h as La,i as Ma,k as Oa,u as Ua,o as Bt,p as $a}from"./realtimeClient-Co7KOFh8.js";const se={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Fa=[],_a={},xt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function Va(){if(typeof document>"u")return null;const a=Rt("standard_session_id"),s=Rt("standard_csrf_token");return!a||!s?null:{sessionId:a,sessionCsrf:s}}function Dt(){typeof document>"u"||(Pt("standard_session_id"),Pt("standard_csrf_token"))}function Rt(a){var s,r;if(!a||typeof document>"u")return"";try{const h=`; ${document.cookie}`.split(`; ${a}=`);if(h.length!==2)return"";const v=((r=(s=h.pop())==null?void 0:s.split(";").shift())==null?void 0:r.trim())||"";if(!v)return"";try{return decodeURIComponent(v).trim()}catch{return v}}catch{return""}}function Pt(a){var r;const s=typeof window<"u"&&((r=window.location)==null?void 0:r.protocol)==="https:"?"; Secure":"";document.cookie=`${a}=; path=/; max-age=0; SameSite=Lax${s}`}function ja(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const a=new URLSearchParams(window.location.search||"");return{conversationId:(a.get("conversationId")||"").trim(),recipientId:(a.get("recipientId")||"").trim(),recipientName:(a.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function za(a){return a!=null&&a.id?{id:"",name:String(a.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:a.id,launchPending:!0}:null}function ue(a){if(!a)return"";const s=a.split(" ").filter(Boolean),r=s[0]?s[0][0]:"",m=s.length>1?s[s.length-1][0]:"";return(r+m).toUpperCase()}function me(a){return!a||typeof a!="object"||a.blockedByOther?"User unavailable":a.name||"Unknown"}function ee(a){return!!(a&&(a.blocked||a.blockedByOther))}function Mt(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Ha(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Ze(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Ot(a){const s=String(a||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Ut(a){const s=String(a||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function Lt(a,s){return a.getFullYear()===s.getFullYear()&&a.getMonth()===s.getMonth()&&a.getDate()===s.getDate()}function Ya(a){const s=new Date(a);if(Number.isNaN(s.getTime()))return"";const r=new Date,m=new Date;return m.setDate(r.getDate()-1),Lt(s,r)?"Today":Lt(s,m)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Wa(a){const s=[];let r="";return a.forEach(m=>{const h=m.timestamp.slice(0,10);h!==r&&(s.push({type:"day",id:`day-${h}`,label:Ya(m.timestamp)}),r=h),s.push({type:"message",id:m.id,message:m})}),s}function Ka(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function qa(a,s){if(!s)return a;const r=Ka(s);return a.split(new RegExp(`(${r})`,"ig")).map((h,v)=>h.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:v,className:"msg-highlight"},h):e.createElement("span",{key:v},h))}function $t(a,s,r){i.useEffect(()=>{if(!r)return;const m=h=>{!a.current||a.current.contains(h.target)||s()};return document.addEventListener("mousedown",m),document.addEventListener("touchstart",m),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("touchstart",m)}},[a,s,r])}function O({children:a,size:s=20,className:r}){return e.createElement("svg",{className:r,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},a)}const Za=a=>e.createElement(O,{...a},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Ft=a=>e.createElement(O,{...a},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Qa=a=>e.createElement(O,{...a},e.createElement("rect",{x:"5",y:"11",width:"14",height:"9",rx:"2"}),e.createElement("path",{d:"M8 11V8a4 4 0 0 1 8 0v3"})),Ga=a=>e.createElement(O,{...a},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),Ja=a=>e.createElement(O,{...a},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),Xa=a=>e.createElement(O,{...a},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),en=a=>e.createElement(O,{...a},e.createElement("polyline",{points:"5 12 9 16 19 6"})),tn=a=>e.createElement(O,{...a},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),an=a=>e.createElement(O,{...a},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),nn=a=>e.createElement(O,{...a},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),_t=a=>e.createElement(O,{...a},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),de=a=>e.createElement(O,{...a},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),sn=a=>e.createElement(O,{...a},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),Vt=a=>e.createElement(O,{...a},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),ln=a=>e.createElement(O,{...a},e.createElement("path",{d:"M9 4h-4v16h4"}),e.createElement("path",{d:"M16 12H7"}),e.createElement("path",{d:"M13 9l3 3-3 3"})),Ae=a=>e.createElement(O,{...a},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function jt({ariaLabel:a,items:s}){const[r,m]=i.useState(!1),h=i.useRef(null);return $t(h,()=>m(!1),r),e.createElement("div",{className:"menu-wrap",ref:h},e.createElement("button",{className:"icon-btn","aria-label":a,"aria-haspopup":"menu","aria-expanded":r,onClick:()=>m(v=>!v),type:"button"},e.createElement(Za,null)),r?e.createElement("div",{className:"dropdown",role:"menu"},s.map(v=>e.createElement("button",{key:v.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{m(!1),v.onSelect()}},v.label))):null)}function rn({status:a}){if(!a)return null;if(a==="sent")return e.createElement(en,{className:"status-icon"});const s=a==="read"?"status-icon read":"status-icon";return e.createElement(tn,{className:s})}function cn({open:a,title:s,message:r,confirmLabel:m,onConfirm:h,onCancel:v}){return a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,r),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:v},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},m)))):null}function on({open:a,title:s,message:r,confirmLabel:m="Delete",onConfirm:h,onCancel:v}){return a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,r),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:v},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},m)))):null}function mn({open:a,onClose:s,currentUser:r}){if(!a)return null;const m={...se,...r&&typeof r=="object"?r:{}},h=m.name||"User";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Profile panel"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Ae,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#2f9e8f"}},ue(h)),e.createElement("div",null,e.createElement("h3",null,h))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",m.firstName||"-"),e.createElement("p",null,"Family name: ",m.lastName||"-"),e.createElement("p",null,"Suburb: ",m.suburb||"-"),e.createElement("p",null,"City: ",m.city||"-"),e.createElement("p",null,"Province: ",m.province||"-"),e.createElement("p",null,"Account since: ",m.accountSince||"-"))))}function dn({open:a,onClose:s,chat:r,onDelete:m,onBlock:h,onReport:v}){if(!a||!r)return null;const g=!!r.blockedByOther,R=me(r),U=r.name?r.name.split(" ").filter(Boolean):[],p=U[0]||"",B=U.slice(1).join(" "),N=g?"-":r.firstName||p||"-",I=g?"-":r.lastName||B||"-",L=g?"-":r.suburb||"-",$=g?"-":r.city||"-",d=g?"-":r.province||"-",P=g?"-":r.accountSince||"-",b=g?"-":r.accountType||"Standard";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Chat profile"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Chat Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Ae,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:r.color}},ee(r)?e.createElement(de,{className:"avatar-blocked-icon",size:18}):ue(R)),e.createElement("div",null,e.createElement("h3",null,R))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",N),e.createElement("p",null,"Family name: ",I),e.createElement("p",null,"Suburb: ",L),e.createElement("p",null,"City: ",$),e.createElement("p",null,"Province: ",d),e.createElement("p",null,"Account since: ",P),e.createElement("p",null,"Account type: ",b)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:m},e.createElement(Vt,null),"Delete"),g?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:h},e.createElement(de,null),r.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:v},e.createElement(_t,null),"Report"))))))}function Qe({title:a,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,a),e.createElement("p",null,s))}function un(){const a=Array.from({length:7}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay desktop",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-desktop-shell"},e.createElement("aside",{className:"chat-loading-desktop-sidebar"},e.createElement("div",{className:"chat-loading-desktop-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})),e.createElement("div",{className:"chat-loading-desktop-search"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-search-box"})),e.createElement("div",{className:"chat-loading-desktop-list"},a.map((r,m)=>e.createElement("div",{className:"chat-loading-desktop-thread",key:m},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-time"}))))),e.createElement("section",{className:"chat-loading-desktop-chat"},e.createElement("div",{className:"chat-loading-desktop-chat-header"},e.createElement("div",{className:"chat-loading-desktop-chat-user"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}))),e.createElement("div",{className:"chat-loading-desktop-chat-actions"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}))),e.createElement("div",{className:"chat-loading-desktop-messages"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-day"}),s.map((r,m)=>e.createElement("div",{className:`chat-loading-desktop-bubble-row ${m%2?"me":"them"}`,key:m},e.createElement("div",{className:"chat-loading-desktop-bubble"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-meta"}))))),e.createElement("div",{className:"chat-loading-desktop-composer"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-input"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})))))}function Ge({title:a,subtitle:s,children:r}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,a),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},r))}function fn({currentUser:a}){const s={...se,...a&&typeof a=="object"?a:{}},r=s.name||"User";return e.createElement(Ge,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-card"},e.createElement("div",{className:"profile-card-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#0f766e"}},ue(r)),e.createElement("div",null,e.createElement("h3",null,r))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function pn({chats:a,onUnblock:s}){return e.createElement(Ge,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},a.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},a.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color}},e.createElement(de,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,Ha(r.blockedAt||r.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(r.id)},"Unblock"))))))}function hn({reports:a,onOpenReport:s}){return e.createElement(Ge,{title:"Reports",subtitle:"Reports you submitted."},a.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},a.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color||"#3b5bdb"}},ue(r.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name),e.createElement("div",{className:"section-item-sub"},r.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Ut(r.status)}`},Ot(r.status)),e.createElement("span",null,Ze(r.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(r)},"View report"))))))}function vn({open:a,report:s,onClose:r}){return!a||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:r,"aria-label":"Close report details"},e.createElement(Ae,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Ut(s.status)}`},Ot(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Ze(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Ze(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function En({open:a,onClose:s,reasons:r,value:m,onChange:h,details:v,onDetailsChange:g,onSubmit:R,targetName:U}){const[p,B]=i.useState(!1),N=i.useRef(null),I=r.find(L=>L.value===m);return $t(N,()=>B(!1),p),i.useEffect(()=>{a||B(!1)},[a]),a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",U||"this chat","."),e.createElement("div",{className:`report-select${p?" active":""}`,ref:N},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>B(L=>!L),"aria-haspopup":"listbox","aria-expanded":p},e.createElement("span",null,I?I.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},r.map(L=>e.createElement("button",{key:L.value,type:"button",className:`report-select__option${m===L.value?" selected":""}`,onClick:()=>{h(L.value),B(!1)},role:"option","aria-selected":m===L.value},L.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:v,onChange:L=>g(L.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:R,disabled:!m},"Report")))):null}function gn({chats:a,searchValue:s,onSearchChange:r,activeChatId:m,onOpenChat:h,onMenuAction:v,emptyTitle:g="No chats yet",emptySubtitle:R="Start a new chat to compare prices.",showSearch:U=!0}){return e.createElement("div",{className:"chat-list-screen"},U?e.createElement("div",{className:"search-bar"},e.createElement(Ft,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:p=>r(p.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})):null,e.createElement("div",{className:"chat-list",role:"list"},a.length===0?e.createElement(Qe,{title:g,subtitle:R}):a.map(p=>{const B=me(p),N=[{label:p.archived?"Unarchive chat":"Archive chat",onSelect:()=>v(p.id,p.archived?"unarchive":"archive")},{label:"Delete chat",onSelect:()=>v(p.id,"delete")},{label:"Report",onSelect:()=>v(p.id,"report")}];return e.createElement("div",{key:p.id,className:`chat-item ${m===p.id?"active":""}`,role:"listitem"},e.createElement("button",{className:"chat-open",onClick:()=>h(p.id),type:"button","aria-label":`Open chat with ${B}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:p.color}},ee(p)?e.createElement(de,{className:"avatar-blocked-icon",size:16}):ue(p.name)),p.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},B),e.createElement("span",{className:"chat-time"},Mt(p.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},p.lastMessage?p.lastMessage:"No messages yet"),e.createElement("span",{className:"chat-flags"},p.unread>0?e.createElement("span",{className:"chat-unread"},p.unread):null)))),e.createElement(jt,{ariaLabel:"Chat options",items:N}))})))}function bn({message:a,query:s,onPreviewImage:r}){const m=a.sender==="me",h=typeof a.attachmentUrl=="string"?a.attachmentUrl:"",v=typeof a.attachmentType=="string"?a.attachmentType.toLowerCase():"",g=typeof a.attachmentName=="string"&&a.attachmentName?a.attachmentName:"Attachment",R=!!a.attachmentIsImage||v.startsWith("image/"),U=!!a.attachmentIsVideo||v.startsWith("video/"),p=typeof a.text=="string"&&a.text.trim().length>0,B={width:"100%",maxWidth:"260px",borderRadius:"10px",display:"block",marginBottom:p?"8px":"0"};return e.createElement("div",{className:`message-row ${m?"me":"them"}`},e.createElement("div",{className:`message-bubble ${m?"outgoing":"incoming"}`},h?e.createElement("div",{className:"message-attachment"},R?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{r&&r(a)},"aria-label":`Preview ${g}`},e.createElement("img",{src:h,alt:g,loading:"lazy",style:B})):U?e.createElement("video",{controls:!0,preload:"metadata",style:B},e.createElement("source",{src:h,type:v||void 0})):e.createElement("a",{href:h,target:"_blank",rel:"noreferrer"},"Open attachment")):null,p?e.createElement("div",{className:"message-text"},qa(a.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Mt(a.timestamp)),m?e.createElement(rn,{status:a.status}):null)))}function yn({preview:a,onClose:s,onSave:r,onReport:m}){return a?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Ae,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:a.url,alt:a.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},a.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:r},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:m},"Report Photo"))):null}function Nn(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function kn(){const a=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},a.map((s,r)=>e.createElement("div",{key:r,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function Cn({value:a,onChange:s,onSend:r,onAttach:m,inputRef:h,disabled:v=!1}){const g=R=>{R.key==="Enter"&&!R.shiftKey&&(R.preventDefault(),!v&&a.trim()&&r())};return e.createElement("div",{className:"composer"},e.createElement("div",{className:"composer-actions"},e.createElement("button",{className:"icon-btn",type:"button",onClick:m,"aria-label":"Attach",disabled:v},e.createElement(Xa,null))),e.createElement("textarea",{ref:h,rows:1,value:a,onChange:R=>s(R.target.value),onKeyDown:g,placeholder:v?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:v}),e.createElement("button",{className:"send-btn",type:"button",onClick:r,disabled:v||!a.trim(),"aria-label":"Send message"},e.createElement(Ja,null)))}function wn({chat:a,groupedMessages:s,searchValue:r,showSearch:m,onToggleSearch:h,onSearchChange:v,onSend:g,composerValue:R,onComposerChange:U,onAttach:p,composerRef:B,typing:N,conversationLoading:I,messageListRef:L,matchCount:$,onMenuAction:d,attachmentPreview:P,onOpenAttachmentPreview:b,onCloseAttachmentPreview:Z,onSaveAttachmentPreview:te,onReportAttachmentPreview:ve}){if(!a)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Qe,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(P)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(yn,{preview:P,onClose:Z,onSave:te,onReport:ve}));const ae=me(a),Q=!!a.launchPending,Be=Q?[{label:"Close chat",onSelect:()=>d("close")}]:[{label:"View profile",onSelect:()=>d("profile")},{label:"Close chat",onSelect:()=>d("close")},{label:"Delete chat",onSelect:()=>d("delete")},{label:"Block",onSelect:()=>d("block")},{label:"Report",onSelect:()=>d("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:a.color}},ee(a)?e.createElement(de,{className:"avatar-blocked-icon",size:16}):ue(a.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},ae),e.createElement("div",{className:"conversation-status"},Q?e.createElement("span",null,"Start conversation"):N?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,a.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,a.online?"online":a.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(jt,{ariaLabel:"Conversation menu",items:Be}))),m?e.createElement("div",{className:"conversation-search"},e.createElement(Ft,{className:"search-icon"}),e.createElement("input",{type:"search",value:r,onChange:V=>v(V.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),r?e.createElement("span",{className:"search-count"},$," match",$===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:L},e.createElement("div",{className:"security-banner"},e.createElement(Qa,null),e.createElement("div",null,"Messages are end-to-end encrypted. No one outside of this chat can read or listen to them.")),I?e.createElement(kn,null):s.length===0?e.createElement(Qe,{title:r?"No matches":"No messages yet",subtitle:r?"Try a different phrase.":"Send a message to start the chat."}):s.map(V=>V.type==="day"?e.createElement("div",{key:V.id,className:"day-separator"},V.label):e.createElement(bn,{key:V.id,message:V.message,query:r.trim(),onPreviewImage:b})),N&&!r&&!I?e.createElement(Nn,null):null,!I&&ee(a)?e.createElement("div",{className:"blocked-notice",role:"note"},a.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(Cn,{value:R,onChange:U,onSend:g,onAttach:p,inputRef:B,disabled:ee(a)}))}function Sn({currentUser:a=se,initialChats:s=Fa,initialMessages:r=_a}){const m={...se,...a&&typeof a=="object"?a:{}},h=Array.isArray(s)?s:[],v=r&&typeof r=="object"?r:{},g=i.useMemo(()=>ja(),[]),R=!!(g.conversationId||g.recipientId),U=i.useRef(!R),[p,B]=i.useState("chats"),[N,I]=i.useState(h),[L,$]=i.useState(v),[d,P]=i.useState(null),[b,Z]=i.useState(g.recipientId?{id:g.recipientId,name:g.recipientName||"Business"}:null),[te,ve]=i.useState(""),[ae,Q]=i.useState(""),[Be,V]=i.useState(!1),[Ee,xe]=i.useState(""),[Je,fe]=i.useState(!1),[zt,Ht]=i.useState(!1),[Tn,Xe]=i.useState(null),[et,De]=i.useState(!1),[Yt,tt]=i.useState(!1),[Y,at]=i.useState(null),[nt,ge]=i.useState([]),[Re,Pe]=i.useState([]),[Le,st]=i.useState(!1),[G,Me]=i.useState(null),[Wt,Oe]=i.useState(!1),[be,ye]=i.useState(""),[lt,Ne]=i.useState(""),[le,Ue]=i.useState(null),[j,$e]=i.useState(null),[rt,ct]=i.useState(!1),[Kt,ke]=i.useState(null),[Ce,Fe]=i.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[ot,it]=i.useState(m),[re,mt]=i.useState({open:!1,title:"",message:"",confirmLabel:"Delete",onConfirm:null}),[ce,dt]=i.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),ut=i.useRef(null),qt=i.useRef(null),_e=i.useRef(null),pe=i.useRef(null),ne=i.useRef(null),J=i.useRef(null),M=i.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),x=Ce.sessionId,D=Ce.sessionCsrf,F=Ce.userId,Ve=Ce.realtimeToken,S=!!(x&&D&&F),y=N.find(t=>t.id===d)||null,Zt=i.useMemo(()=>za(b),[b]),_=y||Zt,we=i.useMemo(()=>N.filter(t=>!t.archived),[N]),he=i.useMemo(()=>N.filter(t=>t.archived),[N]),Qt=i.useMemo(()=>{const t=new Map;return nt.forEach(n=>{n!=null&&n.id&&t.set(n.id,{id:n.id,name:n.name||"Unknown",blockedAt:n.blockedAt||"",color:n.color||"#3b82f6"})}),Array.from(t.values())},[nt]),Gt=i.useMemo(()=>{const t=te.trim().toLowerCase();return t?he.filter(n=>n.name.toLowerCase().includes(t)||(n.lastMessage||"").toLowerCase().includes(t)):he},[he,te]),Jt=i.useMemo(()=>{const t=te.trim().toLowerCase();return t?we.filter(n=>n.name.toLowerCase().includes(t)||(n.lastMessage||"").toLowerCase().includes(t)):we},[we,te]),Se=d?L[d]||[]:[],je=i.useMemo(()=>{const t=ae.trim().toLowerCase();return t?Se.filter(n=>n.text.toLowerCase().includes(t)):Se},[Se,ae]),Xt=i.useMemo(()=>Wa(je),[je]),ea=!!(d&&Kt===d),ft=()=>{J.current&&(window.clearTimeout(J.current),J.current=null),M.current.idleTimer&&(window.clearTimeout(M.current.idleTimer),M.current.idleTimer=null)},Ie=async(t,{force:n=!1}={})=>{const l=ne.current;if(!l||!F)return;const c=!!t,o=Date.now(),f=M.current;if(!(!n&&f.lastValue===c&&o-f.lastSentAt<600)){f.lastValue=c,f.lastSentAt=o;try{await l.send({type:"broadcast",event:"typing",payload:{isTyping:c,userId:String(F)}})}catch{}}};i.useEffect(()=>{let t=!1;return(async()=>{if(!d||!F||!Ve||!S){fe(!1);return}try{const l=await Ta();if(!l||t)return;l.realtime.setAuth(Ve);const c=ne.current;if(c)try{await c.unsubscribe()}catch{}ne.current=null,ft(),M.current.lastValue=!1;const o=l.channel(`conversation:${d}`,{config:{presence:{key:`chat:${String(F)}`}}});o.on("broadcast",{event:"typing"},({payload:f})=>{const k=String((f==null?void 0:f.userId)||"");if(!k||k===String(F))return;const E=!!(f!=null&&f.isTyping);fe(E),J.current&&(window.clearTimeout(J.current),J.current=null),E&&(J.current=window.setTimeout(()=>{fe(!1),J.current=null},3e3))}),o.subscribe(async f=>{if(!(t||f!=="SUBSCRIBED"))try{await o.track({userId:String(F),at:new Date().toISOString()})}catch{}}),ne.current=o}catch{t||fe(!1)}})(),()=>{t=!0;const l=ne.current;if(ne.current=null,l)try{l.unsubscribe()}catch{}ft(),M.current.lastValue=!1,fe(!1)}},[d,S,F,Ve]),i.useEffect(()=>{if(!d||!F||!ne.current)return;const t=Ee.trim().length>0,n=Date.now(),l=M.current;t!==l.lastValue&&n-l.lastSentAt>600&&Ie(t,{force:!0}),l.idleTimer&&(window.clearTimeout(l.idleTimer),l.idleTimer=null),t&&(l.idleTimer=window.setTimeout(()=>{M.current.idleTimer=null,Ie(!1,{force:!0})},2e3))},[Ee,d,F]),i.useEffect(()=>{if(!d||ae.trim())return;const t=ut.current;t&&requestAnimationFrame(()=>{t.scrollTo({top:t.scrollHeight,behavior:"smooth"})})},[d,Se.length,Je,ae]),i.useEffect(()=>{$e(null)},[d]),i.useEffect(()=>{(!d||!S)&&ke(null)},[d,S]),i.useEffect(()=>()=>{pe.current&&clearTimeout(pe.current)},[]);const u=t=>{Xe(t),pe.current&&clearTimeout(pe.current),pe.current=setTimeout(()=>Xe(null),2400)},pt=(t,n={})=>{if(Number(t==null?void 0:t.status)!==401)return!1;const l=!!(n!=null&&n.silent);return Dt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),P(null),Z(null),l||u("Session missing or expired. Please log in again."),!0},ta=t=>{if(!t||typeof t!="object")return;const n=typeof t.attachmentUrl=="string"?t.attachmentUrl.trim():"",l=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",c=!!t.attachmentIsImage||l.startsWith("image/");if(!n||!c)return;const o=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"photo";$e({url:n,name:o,messageId:typeof t.id=="string"?t.id:""})},aa=()=>{$e(null)},na=async()=>{if(!(j!=null&&j.url))return;const t=j.name||"photo";try{const n=await fetch(j.url);if(!n.ok)throw new Error("download_failed");const l=await n.blob(),c=window.URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=t,document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(c),u("Image saved.")}catch{const n=document.createElement("a");n.href=j.url,n.target="_blank",n.rel="noreferrer",n.click(),u("Could not save directly. Opened image in a new tab.")}},sa=()=>{if(!y){u("No chat selected.");return}Ue(y),ye(""),Ne(j!=null&&j.name?`Photo attachment: ${j.name}`:"Photo attachment"),Oe(!0)};i.useEffect(()=>{if(!d||!S)return;let t=!1;ke(d);const n=async({silent:c=!1}={})=>{try{const{messages:o,chatPatch:f}=await Aa({sessionId:x,sessionCsrf:D,conversationId:d,currentUserId:F});if(t)return;$(k=>({...k,[d]:o})),I(k=>k.map(E=>E.id===d?{...E,...f||{},unread:0}:E));try{await Ba({sessionId:x,sessionCsrf:D,conversationId:d})}catch{}}catch(o){if(!t&&pt(o))return;!t&&!c&&u((o==null?void 0:o.message)||"Failed to load chat messages.")}finally{t||ke(o=>o===d?null:o)}};n();const l=window.setInterval(()=>{n({silent:!0})},5e3);return()=>{t=!0,window.clearInterval(l)}},[d,S,x,D,F]);const la=t=>{if(!t){u("No chat selected.");return}at(t),tt(!0)},ze=()=>{tt(!1),at(null)},ra=(t,n)=>{const l=N.find(E=>E.id===t),c=(l==null?void 0:l.otherPartyId)||t;if(!c)return;const o=n||new Date().toISOString(),f=(l==null?void 0:l.name)||"Unknown",k=(l==null?void 0:l.color)||"#3b82f6";ge(E=>{const C=E.filter(w=>w.id!==c);return[{id:c,name:f,blockedAt:o,color:k},...C]})},ht=({accountId:t,conversationId:n=""})=>{const l=typeof t=="string"?t.trim():"",c=typeof n=="string"?n.trim():"";I(o=>o.map(f=>{const k=!!c&&f.id===c,E=!!l&&f.otherPartyId===l;if(!k&&!E)return f;const C=!!f.blockedByOther;return{...f,blocked:!1,blockedByMe:!1,hasBlockingRelationship:C,blockedAt:void 0}})),l&&ge(o=>o.filter(f=>f.id!==l))},vt=async t=>{if(!t)return!1;if(S)try{await Da({sessionId:x,sessionCsrf:D,conversationId:t})}catch(l){return u((l==null?void 0:l.message)||"Failed to block account."),!1}const n=new Date().toISOString();return I(l=>l.map(c=>c.id===t?{...c,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:n}:c)),ra(t,n),d===t&&P(null),u("Chat blocked."),!0},ca=async t=>{if(!t)return!1;const n=N.find(c=>c.id===t),l=(n==null?void 0:n.otherPartyId)||"";if(S)try{await At({sessionId:x,sessionCsrf:D,conversationId:t||void 0,recipientId:l||void 0})}catch(c){return u((c==null?void 0:c.message)||"Failed to unblock account."),!1}return ht({accountId:l,conversationId:t}),u("Account unblocked."),!0},oa=async t=>{const n=typeof t=="string"?t.trim():"";if(!n)return!1;const l=N.find(o=>o.otherPartyId===n),c=(l==null?void 0:l.id)||"";if(S)try{await At({sessionId:x,sessionCsrf:D,conversationId:c||void 0,recipientId:n})}catch(o){return u((o==null?void 0:o.message)||"Failed to unblock account."),!1}return ht({accountId:n,conversationId:c}),u("Account unblocked."),!0},ia=async(t,n={})=>{if(!t)return!1;const l=n.clearActive!==!1,c=n.toast!==!1;if(S)try{await Oa({sessionId:x,sessionCsrf:D,conversationId:t})}catch(o){return u((o==null?void 0:o.message)||"Failed to archive chat."),!1}return I(o=>o.map(f=>f.id===t?{...f,archived:!0,archivedAt:new Date().toISOString()}:f)),l&&d===t&&P(null),c&&u("Chat archived."),!0},Et=async(t,n={})=>{if(!t)return!1;const l=n.clearActive===!0,c=n.toast!==!1;if(S)try{await Ua({sessionId:x,sessionCsrf:D,conversationId:t})}catch(o){return u((o==null?void 0:o.message)||"Failed to restore chat."),!1}return I(o=>o.map(f=>f.id===t?{...f,archived:!1,archivedAt:void 0}:f)),l&&d===t&&P(null),c&&u("Chat restored from archive."),!0},ma=t=>{t&&(Me(t),st(!0))},gt=()=>{st(!1),Me(null)},He=t=>{t&&(Ue(t),ye(""),Ne(""),Oe(!0))},bt=()=>{Oe(!1),Ue(null),ye(""),Ne("")},da=async()=>{var c;if(!le||!be)return;if(!S){u("Session missing or expired. Please log in again.");return}const t=((c=xt.find(o=>o.value===be))==null?void 0:c.label)||be,n=lt.trim(),l=n?`${t} - ${n}`:t;try{await Ra({sessionId:x,sessionCsrf:D,conversationId:le.id,recipientId:le.otherPartyId,reason:l});try{const o=await It({sessionId:x,sessionCsrf:D});Pe(o)}catch{}bt(),u("Report sent.")}catch(o){u((o==null?void 0:o.message)||"Failed to submit report.")}},ua=({title:t,message:n,confirmLabel:l,onConfirm:c})=>{dt({open:!0,title:t,message:n,confirmLabel:l,onConfirm:c})},Ye=()=>{dt(t=>({...t,open:!1}))},fa=async(t,n,l={})=>{const c=!!(l!=null&&l.silent);if(rt)return!1;const o=t.trim(),f=n.trim();if(!o||!f)return c||u("Session credentials missing. Please log in again."),!1;ct(!0);try{const k=await La({sessionId:o,sessionCsrf:f}),{chats:E,blockedAccounts:C,reports:w,currentUser:A}=await Ma({sessionId:o,sessionCsrf:f});Fe({sessionId:o,sessionCsrf:f,userId:k.userId,realtimeToken:k.token||""}),it(A?{...se,...A}:{...se,...m}),I(E),ge(C),$({}),Pe(w);let T=null,ie=null;if(!U.current){if(g.conversationId){const W=E.find(K=>K.id===g.conversationId);W&&(T=W.id)}if(!T&&g.recipientId){const W=E.find(K=>K.otherPartyId===g.recipientId);W?T=W.id:ie={id:g.recipientId,name:g.recipientName||"Business"}}U.current=!0}return Z(ie),P(T),De(!1),ve(""),Q(""),V(!1),B("chats"),!c&&E.length===0?u("Connected. No chats found."):c||u(`Connected. Loaded ${E.length} chat${E.length===1?"":"s"}.`),!0}catch(k){const E=pt(k,{silent:c});return!c&&!E&&u((k==null?void 0:k.message)||"Failed to restore your session."),!1}finally{ct(!1)}};i.useEffect(()=>{let t=!1;return(async()=>{if(S)return;const l=Va();if(!l){t||u("Session missing or expired. Please log in again.");return}await fa(l.sessionId,l.sessionCsrf,{silent:!0})||t||u("Session missing or expired. Please log in again.")})(),()=>{t=!0}},[]);const oe=({title:t,message:n,confirmLabel:l="Delete",onConfirm:c})=>{mt({open:!0,title:t,message:n,confirmLabel:l,onConfirm:c})},X=()=>{mt(t=>({...t,open:!1}))},pa=async(t,n={})=>{n.unarchive&&!await Et(t,{clearActive:!1,toast:!0})||(P(t),Z(null),S&&ke(t),De(!1),n.keepSection||B("chats"),I(l=>l.map(c=>c.id===t?{...c,unread:0}:c)),V(!1),Q(""))},yt=(t,n,l)=>{$(c=>{const o=c[t]||[];return{...c,[t]:o.map(f=>f.id===n?{...f,status:l}:f)}})},ha=async()=>{const t=Ee.trim(),n=d||"",l=n?"":(b==null?void 0:b.id)||"",c=(y==null?void 0:y.name)||(b==null?void 0:b.name)||g.recipientName||"Business",o=(y==null?void 0:y.color)||"#3b82f6";if(!t||!!!(n||l))return;if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(S){try{const E=await xa({sessionId:x,sessionCsrf:D,conversationId:n||void 0,recipientId:l||void 0,content:t}),C=Tt(E==null?void 0:E.data,F),w=(typeof C.chatId=="string"?C.chatId.trim():"")||n;if(!w)throw new Error("Failed to resolve conversation ID.");$(A=>({...A,[w]:[...A[w]||[],C]})),xe(""),I(A=>{const T=C.timestamp||new Date().toISOString();if(!A.find(z=>z.id===w))return[{id:w,name:c,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:C.text||t,lastTime:T,unread:0,online:!1,presence:"offline",color:o,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:l||(b==null?void 0:b.id)||""},...A];const W=A.map(z=>z.id===w?{...z,lastMessage:C.text||t,lastTime:C.timestamp||T,unread:0}:z),K=W.find(z=>z.id===w),Te=W.filter(z=>z.id!==w);return K?[K,...Te]:W}),P(w),Z(null),M.current.idleTimer&&(window.clearTimeout(M.current.idleTimer),M.current.idleTimer=null),M.current.lastValue=!1,Ie(!1,{force:!0})}catch(E){u((E==null?void 0:E.message)||"Failed to send message.")}return}if(!n){u("Session missing or expired. Please log in again.");return}const k={id:`m-${Date.now()}`,chatId:n,sender:"me",text:t,timestamp:new Date().toISOString(),status:"sent"};$(E=>({...E,[n]:[...E[n]||[],k]})),xe(""),I(E=>{const C=E.map(T=>T.id===n?{...T,lastMessage:t,lastTime:k.timestamp,unread:0}:T),w=C.find(T=>T.id===n),A=C.filter(T=>T.id!==n);return w?[w,...A]:C}),setTimeout(()=>yt(n,k.id,"delivered"),900),setTimeout(()=>yt(n,k.id,"read"),2e3),M.current.idleTimer&&(window.clearTimeout(M.current.idleTimer),M.current.idleTimer=null),M.current.lastValue=!1,Ie(!1,{force:!0})},va=()=>{if(!d&&!(b!=null&&b.id)){u("Select a chat first.");return}if(!S){u("Session missing or expired. Please log in again.");return}if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}_e.current&&_e.current.click()},Ea=async t=>{var E;const n=t.target,l=(E=n==null?void 0:n.files)==null?void 0:E[0];if(n&&(n.value=""),!l)return;if(!d&&!(b!=null&&b.id)){u("Select a chat first.");return}if(!S){u("Session missing or expired. Please log in again.");return}if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const c=d||"",o=c?"":(b==null?void 0:b.id)||"",f=(y==null?void 0:y.name)||(b==null?void 0:b.name)||g.recipientName||"Business",k=(y==null?void 0:y.color)||"#3b82f6";try{const C=await Pa({sessionId:x,sessionCsrf:D,conversationId:c||void 0,recipientId:o||void 0,file:l}),w=Tt(C==null?void 0:C.data,F),A=(typeof w.chatId=="string"?w.chatId.trim():"")||c;if(!A)throw new Error("Failed to resolve conversation ID.");$(T=>({...T,[A]:[...T[A]||[],w]})),I(T=>{const ie=w.timestamp||new Date().toISOString();if(!T.find(q=>q.id===A))return[{id:A,name:f,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:w.text||l.name,lastTime:ie,unread:0,online:!1,presence:"offline",color:k,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:o||(b==null?void 0:b.id)||""},...T];const K=T.map(q=>q.id===A?{...q,lastMessage:w.text||l.name,lastTime:w.timestamp||ie,unread:0}:q),Te=K.find(q=>q.id===A),z=K.filter(q=>q.id!==A);return Te?[Te,...z]:K}),P(A),Z(null),u("Attachment sent.")}catch(C){u((C==null?void 0:C.message)||"Failed to send attachment.")}},We=t=>{if(!Array.isArray(t)||t.length===0)return;const n=new Set(t.filter(Boolean));n.size&&(I(l=>l.filter(c=>!n.has(c.id))),$(l=>{const c={...l};return n.forEach(o=>{delete c[o]}),c}),d&&n.has(d)&&P(null))},Ke=async(t,n={})=>{const l=typeof t=="string"?t.trim():"";if(!l)return!1;const c=n.toast!==!1;if(S)try{await Bt({sessionId:x,sessionCsrf:D,conversationId:l})}catch(o){return u((o==null?void 0:o.message)||"Failed to delete chat."),!1}return We([l]),c&&u("Chat deleted."),!0},Nt=async()=>{const t=N.map(c=>c.id).filter(Boolean);if(t.length===0)return u("No chats to delete."),!1;if(!S)return We(t),u("All chats deleted."),!0;const n=[];for(const c of t)try{await Bt({sessionId:x,sessionCsrf:D,conversationId:c}),n.push(c)}catch{}n.length>0&&We(n);const l=t.length-n.length;return n.length===0?(u("Failed to delete chats."),!1):l===0?(u("All chats deleted."),!0):(u(`Deleted ${n.length} chat${n.length===1?"":"s"}. ${l} failed.`),!1)},ga=t=>{$(n=>({...n,[t]:[]})),I(n=>n.map(l=>l.id===t?{...l,lastMessage:"No messages yet",lastTime:"",unread:0}:l))},ba=()=>{if(d){ga(d),u("Cleared current chat.");return}const t={};N.forEach(n=>{t[n.id]=[]}),$(t),I(n=>n.map(l=>({...l,lastMessage:"No messages yet",lastTime:"",unread:0}))),u("Cleared all chats.")},ya=t=>{if(t==="profile"){y&&la(y);return}if(t==="close"){P(null),Z(null),De(!0),V(!1),Q(""),u("Chat closed.");return}if(t==="block"){if(!y)return;vt(y.id);return}if(t==="delete"){oe(y?{title:`Delete chat with ${me(y)}?`,message:"This removes the chat from your list.",onConfirm:()=>{X(),Ke(y.id)}}:{title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),Nt()}});return}if(t==="clear"){const n=y?`Clear chat with ${y.name}?`:"Clear all chats?";ua({title:n,message:y?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{Ye(),ba()}});return}t==="report"&&y&&He(y)},Na=()=>{V(t=>{const n=!t;return n||Q(""),n})},ka=async(t,n)=>{if(n==="archive"){await ia(t,{clearActive:!0,toast:!0});return}if(n==="unarchive"){await Et(t,{clearActive:H,toast:!0});return}if(n==="delete"){const l=N.find(c=>c.id===t);oe({title:l?`Delete chat with ${me(l)}?`:"Delete chat?",message:"This removes the chat from your list.",onConfirm:()=>{X(),Ke(t)}});return}if(n==="report"){const l=N.find(c=>c.id===t);He(l)}},Ca=t=>{oa(t)},H=p==="archive",kt=p==="block",Ct=p==="profile",wt=p==="reports",qe=!!j,St=qe||Ct||kt||wt,wa=rt;return i.useEffect(()=>{if(!H||et)return;if(he.length===0){P(null);return}const t=N.find(n=>n.id===d);t&&!t.archived&&P(null)},[H,he,N,d,et]),i.useEffect(()=>{if(H)return;const t=N.find(n=>n.id===d);t&&t.archived&&P(null)},[H,N,d,we]),i.useEffect(()=>{if(!S||p!=="block")return;let t=!1;return(async()=>{try{const n=await Sa({sessionId:x,sessionCsrf:D});t||ge(n)}catch{}})(),()=>{t=!0}},[S,p,x,D]),i.useEffect(()=>{if(!S||p!=="reports")return;let t=!1;return(async()=>{try{const n=await It({sessionId:x,sessionCsrf:D});t||Pe(n)}catch{}})(),()=>{t=!0}},[S,p,x,D]),i.useEffect(()=>{if(!Le||!(G!=null&&G.id))return;const t=Re.find(n=>n.id===G.id);if(!t){gt();return}Me(t)},[Le,G==null?void 0:G.id,Re]),e.createElement("div",{className:"desktop-stage"},e.createElement("div",{className:"desktop-window"},e.createElement("div",{className:`desktop-content chp-desktop${qe?" preview-only":St?" section-only":""}`},qe?null:e.createElement("aside",{className:"icon-rail"},e.createElement("nav",{className:"rail-nav","aria-label":"Primary"},[{key:"home",label:"Home",icon:an},{key:"chats",label:"Chats",icon:Ga},{key:"archive",label:"Archive",icon:nn},{key:"block",label:"Block",icon:de},{key:"reports",label:"Reports",icon:_t},{key:"profile",label:"Profile",icon:sn}].map(t=>{const n=t.icon;return e.createElement("button",{key:t.key,className:`rail-btn ${p===t.key?"active":""}`,type:"button",onClick:()=>{if(B(t.key),t.key==="home"){window.location.href="homepage.html";return}},"aria-label":t.label},e.createElement("span",{className:"rail-icon"},e.createElement(n,null)),e.createElement("span",null,t.label))})),e.createElement("div",{className:"rail-footer"},e.createElement("button",{className:`rail-btn danger ${p==="logout"?"active":""}`,type:"button",onClick:()=>{B("logout"),oe({title:"Log out?",message:"Are you sure you want to log out?",confirmLabel:"Log out",onConfirm:()=>{X(),Dt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),it({...se,...m}),u("Logged out.")}})},"aria-label":"Logout"},e.createElement("span",{className:"rail-icon"},e.createElement(ln,null)),e.createElement("span",null,"Logout")))),St?null:e.createElement("aside",{className:"sidebar"},H?e.createElement(e.Fragment,null,e.createElement("div",{className:"archive-heading"},e.createElement("h2",null,"Achieved Chats")),e.createElement("div",{className:"archive-description muted"},"Archived conversations stored here.")):e.createElement("div",{className:"sidebar-header"},e.createElement("div",{className:"sidebar-title"},e.createElement("div",{className:"sidebar-brand"},e.createElement("img",{src:Ia,alt:"CompareHubPrices"}))),e.createElement("div",{className:"sidebar-actions-row"},e.createElement("button",{className:"icon-btn",type:"button","aria-label":"Delete all chats",onClick:()=>{oe({title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),Nt()}})}},e.createElement(Vt,null)))),e.createElement(gn,{chats:H?Gt:Jt,searchValue:te,onSearchChange:ve,activeChatId:d,onOpenChat:t=>pa(t,{keepSection:H}),onMenuAction:ka,emptyTitle:H?"No archived chats":void 0,emptySubtitle:H?"Archived conversations will appear here.":void 0,showSearch:!H})),e.createElement("section",{className:"chat-panel"},Ct?e.createElement(fn,{currentUser:ot}):kt?e.createElement(pn,{chats:Qt,onUnblock:Ca}):wt?e.createElement(hn,{reports:Re,onOpenReport:ma}):e.createElement(wn,{chat:_,groupedMessages:Xt,searchValue:ae,showSearch:Be,onToggleSearch:Na,onSearchChange:Q,onSend:ha,composerValue:Ee,onComposerChange:xe,onAttach:va,composerRef:qt,typing:Je,conversationLoading:ea,messageListRef:ut,matchCount:je.length,onMenuAction:ya,attachmentPreview:j,onOpenAttachmentPreview:ta,onCloseAttachmentPreview:aa,onSaveAttachmentPreview:na,onReportAttachmentPreview:sa})))),wa?e.createElement(un,null):null,e.createElement(mn,{open:zt,onClose:()=>Ht(!1),currentUser:ot}),e.createElement(dn,{open:Yt,onClose:ze,chat:Y,onDelete:()=>{Y&&oe({title:`Delete chat with ${me(Y)}?`,message:"This removes the chat from your list.",onConfirm:async()=>{X(),await Ke(Y.id)&&ze()}})},onBlock:()=>{(async()=>{if(!Y)return;(Y.blocked?await ca(Y.id):await vt(Y.id))&&ze()})()},onReport:()=>{Y&&He(Y)}}),e.createElement(vn,{open:Le,report:G,onClose:gt}),e.createElement(En,{open:Wt,onClose:bt,reasons:xt,value:be,onChange:ye,details:lt,onDetailsChange:Ne,onSubmit:da,targetName:le==null?void 0:le.name}),e.createElement(on,{open:re.open,title:re.title,message:re.message,confirmLabel:re.confirmLabel,onConfirm:()=>{re.onConfirm?re.onConfirm():X()},onCancel:X}),e.createElement(cn,{open:ce.open,title:ce.title,message:ce.message,confirmLabel:ce.confirmLabel,onConfirm:()=>{ce.onConfirm?ce.onConfirm():Ye()},onCancel:Ye}),e.createElement("input",{ref:_e,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:Ea,style:{display:"none"}}))}const In=$a(document.getElementById("root"));In.render(e.createElement(e.StrictMode,null,e.createElement(Sn,null)));
