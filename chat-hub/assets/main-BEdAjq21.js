import{$ as Fn,r as m,f as Wn,a as It,R as e,l as zn,g as Hn,b as Yn,m as Gn,s as Kn,c as Tt,d as qn,e as Xn,p as Ot,h as Zn,i as Jn,u as Qn,j as At,k as ea,n as ta,o as na,q as _t,t as aa,v as Bt,w as sa}from"./64-CpkMNxDP.js";typeof window<"u"&&!window.__comparehubEmojiMartInit&&(Fn({data:_t}),window.__comparehubEmojiMartInit=!0);const he={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",image:"",suburb:"",village:"",town:"",province:"",accountSince:"",accountType:"",isVerified:!1,verificationStatus:""},ra=[],la={},xt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function oa(){if(typeof document>"u")return null;const t=Pt("standard_session_id"),a=Pt("standard_csrf_token");return!t||!a?null:{sessionId:t,sessionCsrf:a}}function ca(t,a){var f;if(typeof document>"u"||!t||!a)return;const l=typeof window<"u"&&((f=window.location)==null?void 0:f.protocol)==="https:"?"; Secure":"",o=12*60*60;document.cookie=`standard_session_id=${encodeURIComponent(t)}; path=/; max-age=${o}; SameSite=Strict${l}`,document.cookie=`standard_csrf_token=${encodeURIComponent(a)}; path=/; max-age=${o}; SameSite=Strict${l}`}function Lt(){typeof document>"u"||(Mt("standard_session_id"),Mt("standard_csrf_token"))}function Pt(t){if(!t||typeof document>"u")return"";try{const a=String(document.cookie||"");if(!a)return"";const l=a.split(";");let o="";for(const f of l){const h=f.indexOf("=");if(h<=0||f.slice(0,h).trim()!==t)continue;const I=f.slice(h+1).trim();if(I)try{o=decodeURIComponent(I).trim()}catch{o=I.trim()}}return o}catch{return""}}function Mt(t){var l;const a=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Strict${a}`}const ia=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,ma=200;function Rt(t){return typeof t=="string"&&ia.test(t)}function da(t){if(typeof t!="string")return"";const a=t.trim().slice(0,ma);return Ot.sanitize(a,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function ua(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||""),a=(t.get("conversationId")||"").trim(),l=(t.get("recipientId")||"").trim(),o=(t.get("recipientName")||"").trim();return{conversationId:a&&Rt(a)?a:"",recipientId:l&&Rt(l)?l:"",recipientName:da(o)}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function fa(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",image:"",isVerified:!1,verificationStatus:"",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function pa(t){if(!t)return"";const a=t.split(" ").filter(Boolean),l=a[0]?a[0][0]:"",o=a.length>1?a[a.length-1][0]:"";return(l+o).toUpperCase()}function ne(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function Ut(t){const a=String((t==null?void 0:t.suburb)||"").trim(),l=String((t==null?void 0:t.village)||"").trim();return a?{label:"Suburb",value:a}:l?{label:"Village",value:l}:{label:"Suburb/Village",value:"-"}}function V(t){return!!(t&&(t.blocked||t.blockedByOther))}function ge(t){return String((t==null?void 0:t.accountType)||(t==null?void 0:t.type)||"").toLowerCase()==="business"}function le({name:t,image:a,color:l,blocked:o,size:f="",showVerified:h=!1}){const u=["avatar",f].filter(Boolean).join(" "),I=f==="large"?14:f==="small"?10:12;return e.createElement("div",{className:u,style:{backgroundColor:l}},o?e.createElement(et,{className:"avatar-blocked-icon",size:f==="large"?18:16}):a?e.createElement("img",{src:a,alt:t?`${t} logo`:"Avatar",loading:"lazy"}):pa(t),h?e.createElement("span",{className:"verified-badge",title:"Verified business","aria-label":"Verified business"},e.createElement(Yt,{size:I})):null)}function Vt(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function jt(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleDateString([],{month:"short",day:"numeric"})}function Ze(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Ft(t){const a=String(t||"").trim();return a?a.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Wt(t){const a=String(t||"").trim().toLowerCase();return a==="resolved"||a==="closed"||a==="complete"||a==="completed"||a==="done"?"success":a==="rejected"||a==="dismissed"||a==="denied"?"danger":a==="open"||a==="pending"||a==="in_review"||a==="in review"||a==="under_review"||a==="under review"?"warning":""}function Dt(t,a){return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}function ha(t){const a=new Date(t);if(Number.isNaN(a.getTime()))return"";const l=new Date,o=new Date;return o.setDate(l.getDate()-1),Dt(a,l)?"Today":Dt(a,o)?"Yesterday":a.toLocaleDateString([],{month:"short",day:"numeric"})}function va(t){const a=[];let l="";return t.forEach(o=>{const f=o.timestamp.slice(0,10);f!==l&&(a.push({type:"day",id:`day-${f}`,label:ha(o.timestamp)}),l=f),a.push({type:"message",id:o.id,message:o})}),a}function ga(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const $t=typeof Intl<"u"&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"grapheme"}):null;function Ea(t){return t?$t?Array.from($t.segment(t),({segment:a})=>a):Array.from(t):[]}function ba(t){return t?new RegExp("^\\p{Regional_Indicator}{2}$","u").test(t)||/[0-9#*]\uFE0F?\u20E3/u.test(t)?!0:new RegExp("\\p{Extended_Pictographic}","u").test(t):!1}function ya(t){return typeof t!="string"?"":Ot.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function ve(t,a){const l=ya(t);return Ea(l).map((o,f)=>ba(o)?e.createElement("em-emoji",{key:`${a}-emoji-${f}`,native:o,set:"apple",size:"1.05em"}):e.createElement(e.Fragment,{key:`${a}-text-${f}`},o))}function Na(t,a){if(!a)return ve(t,"msg");const l=ga(a);return t.split(new RegExp(`(${l})`,"ig")).map((f,h)=>f.toLowerCase()===a.toLowerCase()?e.createElement("mark",{key:h,className:"msg-highlight"},ve(f,`mark-${h}`)):e.createElement(e.Fragment,{key:h},ve(f,`part-${h}`)))}function ka(t,a,l){const o=(l==null?void 0:l.selectionStart)??t.length,f=(l==null?void 0:l.selectionEnd)??o;return{nextValue:t.slice(0,o)+a+t.slice(f),caret:o+a.length}}function Qe(t,a,l){m.useEffect(()=>{if(!l)return;const o=f=>{!t.current||t.current.contains(f.target)||a()};return document.addEventListener("mousedown",o),document.addEventListener("touchstart",o),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("touchstart",o)}},[t,a,l])}function $({children:t,size:a=20,className:l}){return e.createElement("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const wa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),zt=t=>e.createElement($,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Ht=t=>e.createElement($,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),Ca=t=>e.createElement($,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),Sa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),Ia=t=>e.createElement($,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),Yt=t=>e.createElement($,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),Ta=t=>e.createElement($,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),Aa=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),Ba=t=>e.createElement($,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),xa=t=>e.createElement($,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),La=t=>e.createElement($,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),et=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Pa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),Ma=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),Gt=t=>e.createElement($,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function tt({ariaLabel:t,items:a}){const[l,o]=m.useState(!1),f=m.useRef(null);return Qe(f,()=>o(!1),l),e.createElement("div",{className:"menu-wrap",ref:f},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>o(h=>!h),type:"button"},e.createElement(wa,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},a.map(h=>e.createElement("button",{key:h.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{o(!1),h.onSelect()}},h.label))):null)}function Ra({status:t}){if(!t)return null;if(t==="sent")return e.createElement(Yt,{className:"status-icon"});const a=t==="read"?"status-icon read":"status-icon";return e.createElement(Ta,{className:a})}function Da({open:t,title:a,message:l,confirmLabel:o,onConfirm:f,onCancel:h}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":a},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,a),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:h},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:f},o)))):null}function $a({open:t,onClose:a,reasons:l,value:o,onChange:f,details:h,onDetailsChange:u,onSubmit:I,targetName:B}){const[C,g]=m.useState(!1),Z=m.useRef(null),M=l.find(d=>d.value===o);return Qe(Z,()=>g(!1),C),m.useEffect(()=>{t||g(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",B||"this chat","."),e.createElement("div",{className:`report-select${C?" active":""}`,ref:Z},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>g(d=>!d),"aria-haspopup":"listbox","aria-expanded":C},e.createElement("span",null,M?M.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(d=>e.createElement("button",{key:d.value,type:"button",className:`report-select__option${o===d.value?" selected":""}`,onClick:()=>{f(d.value),g(!1)},role:"option","aria-selected":o===d.value},d.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:h,onChange:d=>u(d.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:a},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:I,disabled:!o},"Report")))):null}function Oa({chat:t,onClose:a,onDelete:l,onBlock:o,onReport:f}){if(!t)return null;const h=!!t.blockedByOther,u=ne(t),I=t.name?t.name.split(" ").filter(Boolean):[],B=I[0]||"",C=I.slice(1).join(" "),g=h?"-":t.firstName||B||"-",Z=h?"-":t.lastName||C||"-",M=h?"":t.suburb||"",d=h?"":t.village||"",R=Ut({suburb:M,village:d}),b=h?"-":t.town||"-",j=h?"-":t.province||"-",K=h?"-":t.accountSince||"-",oe=h?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:a,type:"button"},e.createElement(Ht,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},le({name:u,image:t.image,color:t.color,size:"large",blocked:V(t),showVerified:ge(t)&&t.isVerified&&!V(t)}),e.createElement("div",null,e.createElement("h3",null,u))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",g),e.createElement("p",null,"Family name: ",Z),e.createElement("p",null,R.label,": ",R.value),e.createElement("p",null,"Town: ",b),e.createElement("p",null,"Province: ",j),e.createElement("p",null,"Account since: ",K),e.createElement("p",null,"Account type: ",oe)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:l},e.createElement(Ma,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:o},e.createElement(et,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:f},e.createElement(La,null),"Report"))))))}function Me({title:t,subtitle:a,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),a?e.createElement("p",{className:"muted"},a):null)),e.createElement("div",{className:"section-card"},l))}function _a({currentUser:t}){const a={...he,...t&&typeof t=="object"?t:{}},l=a.name||"User",o=Ut(a);return e.createElement(Me,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},le({name:l,image:a.image,color:"#3b82f6",size:"large",blocked:!1,showVerified:ge(a)&&a.isVerified}),e.createElement("div",null,e.createElement("h3",null,l),e.createElement("p",{className:"muted"},a.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,a.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",a.firstName||"-"),e.createElement("p",null,"Family name: ",a.lastName||"-"),e.createElement("p",null,o.label,": ",o.value),e.createElement("p",null,"Town: ",a.town||"-"),e.createElement("p",null,"Province: ",a.province||"-"),e.createElement("p",null,"Account since: ",a.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile",onClick:()=>{window.location.href="my_account_information.html"}},"Manage Profile"))))}function Ua({chats:t,onOpenChat:a,onUnarchive:l}){return e.createElement(Me,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(o=>{const f=ne(o);return e.createElement("div",{key:o.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},le({name:f,image:o.image,color:o.color,blocked:V(o),showVerified:ge(o)&&o.isVerified&&!V(o)}),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},f),e.createElement("div",{className:"section-item-sub"},o.lastMessage?ve(o.lastMessage,`archived-last-${o.id}`):"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,jt(o.archivedAt||o.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>a(o.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>l(o.id)},"Unarchive"))))})))}function Va({chats:t,onUnblock:a}){return e.createElement(Me,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},le({name:l.name,image:l.image,color:l.color,blocked:!0,showVerified:!1}),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,jt(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>a(l.id)},"Unblock"))))))}function ja({reports:t,onOpenReport:a}){return e.createElement(Me,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},le({name:l.name,image:l.image,color:l.color||"#3b82f6",blocked:!1,showVerified:ge(l)&&l.isVerified}),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Wt(l.status)}`},Ft(l.status)),e.createElement("span",null,Ze(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>a(l)},"View report"))))))}function Fa({open:t,report:a,onClose:l}){return!t||!a?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(Gt,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},a.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Wt(a.status)}`},Ft(a.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Ze(a.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Ze(a.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},a.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},a.adminReply||"No admin reply yet."))))}function Je({title:t,subtitle:a}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,a))}function Wa(){const t=Array.from({length:6}),a=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((l,o)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:o},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},a.map((l,o)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:o},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function za({chats:t,searchValue:a,onSearchChange:l,activeChatId:o,onOpenChat:f,onChatAction:h}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(zt,{className:"search-icon"}),e.createElement("input",{type:"search",value:a,onChange:u=>l(u.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Je,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(u=>{const I=ne(u);return e.createElement("div",{key:u.id,className:`chat-item ${o===u.id?"active":""}`,onClick:()=>f(u.id),onKeyDown:B=>{(B.key==="Enter"||B.key===" ")&&(B.preventDefault(),f(u.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${I}`},e.createElement("div",{className:"chat-avatar"},le({name:I,image:u.image,color:u.color,blocked:V(u),showVerified:ge(u)&&u.isVerified&&!V(u)}),u.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},I),e.createElement("span",{className:"chat-time"},Vt(u.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},u.lastMessage?ve(u.lastMessage,`chat-last-${u.id}`):"No messages yet"),u.unread>0?e.createElement("span",{className:"chat-unread"},u.unread):null)),e.createElement("div",{className:"chat-actions",onClick:B=>B.stopPropagation(),onKeyDown:B=>B.stopPropagation()},e.createElement(tt,{ariaLabel:`More options for ${I}`,items:[{label:"Delete chat",onSelect:()=>h(u.id,"delete")},{label:"Report",onSelect:()=>h(u.id,"report")},{label:"Archive",onSelect:()=>h(u.id,"archive")}]})))})))}function Ha({message:t,query:a,onPreviewImage:l}){const o=t.sender==="me",f=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",h=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",u=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",I=!!t.attachmentIsImage||h.startsWith("image/"),B=!!t.attachmentIsVideo||h.startsWith("video/"),C=typeof t.text=="string"&&t.text.trim().length>0,g={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:C?"8px":"0"};return e.createElement("div",{className:`message-row ${o?"me":"them"}`},e.createElement("div",{className:`message-bubble ${o?"outgoing":"incoming"}`},f?e.createElement("div",{className:"message-attachment"},I?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${u}`},e.createElement("img",{src:f,alt:u,loading:"lazy",style:g})):B?e.createElement("video",{controls:!0,preload:"metadata",style:g},e.createElement("source",{src:f,type:h||void 0})):e.createElement("a",{href:f,target:"_blank",rel:"noreferrer"},"Open attachment")):null,C?e.createElement("div",{className:"message-text"},Na(t.text,a)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Vt(t.timestamp)),o?e.createElement(Ra,{status:t.status}):null)))}function Ya({preview:t,onClose:a,onSave:l,onReport:o}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:a,"aria-label":"Close preview"},e.createElement(Gt,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:o},"Report Photo"))):null}function Ga(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function Ka(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((a,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${a?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function qa({value:t,onChange:a,onSend:l,onEmoji:o,onAttach:f,inputRef:h,disabled:u=!1,emojiActive:I=!1}){const B=u?"Unblock to send messages":"Type a message";m.useEffect(()=>{const g=h==null?void 0:h.current;g&&(g.style.height="auto",g.style.height=`${Math.min(g.scrollHeight,120)}px`)},[t,h]);const C=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),!u&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${I?" emoji-toggle-active":""}`,type:"button",onClick:o,"aria-label":"Emoji",disabled:u},e.createElement(Sa,null)),e.createElement("div",{className:"composer-input-wrap"},e.createElement("div",{className:`composer-render ${t?"has-value":""}`,"aria-hidden":"true"},t?ve(t,"composer-input"):null),e.createElement("textarea",{ref:h,className:`composer-input-native ${t?"has-value":""}`,rows:1,value:t,onChange:g=>a(g.target.value),onKeyDown:C,placeholder:B,"aria-label":"Message input",disabled:u})),e.createElement("button",{className:"icon-btn",type:"button",onClick:f,"aria-label":"Attach",disabled:u},e.createElement(Ia,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:u||!t.trim(),"aria-label":"Send message"},e.createElement(Ca,null)))}function Xa({open:t,onSelect:a,onClose:l}){const o=m.useRef(null);return Qe(o,l,t),t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:o},e.createElement(ta,{data:_t,onEmojiSelect:a,theme:"light",set:"apple",getSpritesheetURL:()=>na,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiSize:30,emojiButtonSize:46,emojiButtonRadius:"8px"}))):null}function Za({chat:t,groupedMessages:a,searchValue:l,showSearch:o,onToggleSearch:f,onSearchChange:h,onBack:u,onSend:I,composerValue:B,onComposerChange:C,onEmoji:g,onAttach:Z,emojiOpen:M,onEmojiSelect:d,onEmojiClose:R,composerRef:b,typing:j,conversationLoading:K,messageListRef:oe,matchCount:J,onMenuAction:F,attachmentPreview:ke,onOpenAttachmentPreview:ce,onCloseAttachmentPreview:ie,onSaveAttachmentPreview:me,onReportAttachmentPreview:Re}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Je,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(ke)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(Ya,{preview:ke,onClose:ie,onSave:me,onReport:Re}));const de=ne(t),Ee=!!t.launchPending,ae=Ee?[{label:"Close chat",onSelect:()=>F("close")}]:[{label:"View profile",onSelect:()=>F("profile")},{label:"Close chat",onSelect:()=>F("close")},{label:"Delete chat",onSelect:()=>F("delete")},{label:"Block",onSelect:()=>F("block")},{label:"Report",onSelect:()=>F("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:u,"aria-label":"Back to chats"},e.createElement(Ht,null)),e.createElement("div",{className:"conversation-title"},le({name:de,image:t.image,color:t.color,blocked:V(t),showVerified:ge(t)&&t.isVerified&&!V(t)}),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},de),e.createElement("div",{className:"conversation-status"},Ee?e.createElement("span",null,"Start conversation"):j?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(tt,{ariaLabel:"Conversation menu",items:ae}))),o?e.createElement("div",{className:"conversation-search"},e.createElement(zt,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:H=>h(H.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},J," match",J===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:oe},K?e.createElement(Ka,null):a.length===0?e.createElement(Je,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):a.map(H=>H.type==="day"?e.createElement("div",{key:H.id,className:"day-separator"},H.label):e.createElement(Ha,{key:H.id,message:H.message,query:l.trim(),onPreviewImage:ce})),j&&!l&&!K?e.createElement(Ga,null):null,!K&&V(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(qa,{value:B,onChange:C,onSend:I,onEmoji:g,onAttach:Z,inputRef:b,disabled:V(t),emojiActive:M}),e.createElement(Xa,{open:M,onSelect:d,onClose:R}))}function Ja({activeKey:t,onSelect:a}){const l=[{key:"home",label:"Home",icon:Aa},{key:"archive",label:"Archive",icon:xa},{key:"chats",label:"Chats",icon:Ba},{key:"block",label:"Block",icon:et},{key:"profile",label:"My Profile",icon:Pa}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},l.map(o=>{const f=o.icon;return e.createElement("button",{key:o.key,className:`nav-btn ${t===o.key?"active":""}`,type:"button",onClick:()=>a(o.key),"aria-label":o.label},e.createElement("span",{className:"icon-box"},e.createElement(f,null)),e.createElement("span",null,o.label))}))}function Qa({currentUser:t=he,initialChats:a=ra,initialMessages:l=la}){const o={...he,...t&&typeof t=="object"?t:{}},f=Array.isArray(a)?a:[],h=l&&typeof l=="object"?l:{},u=m.useMemo(()=>ua(),[]),I=!!(u.conversationId||u.recipientId),B=m.useRef(!I),[C,g]=m.useState(f),[Z,M]=m.useState(h),[d,R]=m.useState(null),[b,j]=m.useState(u.recipientId?{id:u.recipientId,name:u.recipientName||"Business"}:null),[K,oe]=m.useState(""),[J,F]=m.useState(""),[ke,ce]=m.useState(!1),[ie,me]=m.useState(""),[Re,de]=m.useState(!1),[Ee,ae]=m.useState(!1),[H,nt]=m.useState(!1),[Y,at]=m.useState(null),[st,we]=m.useState([]),[De,$e]=m.useState([]),[Oe,rt]=m.useState(!1),[Q,_e]=m.useState(null),[Kt,Ue]=m.useState(!1),[Ce,Se]=m.useState(""),[lt,Ie]=m.useState(""),[ue,Ve]=m.useState(null),[z,je]=m.useState(null),[ts,ot]=m.useState(null),[ct,it]=m.useState(!1),[qt,Te]=m.useState(null),[Ae,Fe]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[Xt,mt]=m.useState(o),[fe,dt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[_,Be]=m.useState("chats"),ut=m.useRef(null),be=m.useRef(null),We=m.useRef(null),ye=m.useRef(null),se=m.useRef(null),ee=m.useRef(null),D=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),ft=m.useRef(0),L=Ae.sessionId,P=Ae.sessionCsrf,O=Ae.userId,ze=Ae.realtimeToken,T=!!(L&&P&&O),A=C.find(n=>n.id===d)||null,Zt=m.useMemo(()=>fa(b),[b]),U=A||Zt,Jt=m.useMemo(()=>C.filter(n=>n.archived),[C]),Qt=m.useMemo(()=>{const n=new Map;return st.forEach(s=>{s!=null&&s.id&&n.set(s.id,{id:s.id,name:s.name||"Unknown",blockedAt:s.blockedAt||"",color:s.color||"#3b82f6"})}),Array.from(n.values())},[st]),He=m.useMemo(()=>C.filter(n=>!n.archived),[C]),en=m.useMemo(()=>{const n=K.trim().toLowerCase();return n?He.filter(s=>s.name.toLowerCase().includes(n)||(s.lastMessage||"").toLowerCase().includes(n)):He},[He,K]),xe=d?Z[d]||[]:[],Ye=m.useMemo(()=>{const n=J.trim().toLowerCase();return n?xe.filter(s=>s.text.toLowerCase().includes(n)):xe},[xe,J]),tn=m.useMemo(()=>va(Ye),[Ye]),nn=!!(d&&qt===d),pt=()=>{ee.current&&(window.clearTimeout(ee.current),ee.current=null),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null)},Le=async n=>{const s=se.current;if(!s||!O)return;const r=!!n,i=Date.now(),c=D.current;if(!(c.lastValue===r&&i-c.lastSentAt<600)){c.lastValue=r,c.lastSentAt=i;try{await s.send({type:"broadcast",event:"typing",payload:{isTyping:r,userId:String(O)}})}catch{}}};m.useEffect(()=>{let n=!1;return(async()=>{if(!d||!O||!ze||!T){ae(!1);return}try{const r=await Hn();if(!r||n)return;r.realtime.setAuth(ze);const i=se.current;if(i)try{await i.unsubscribe()}catch{}se.current=null,pt(),D.current.lastValue=!1;const c=r.channel(`conversation:${d}`,{config:{presence:{key:`chat:${String(O)}`}}}),v=()=>{try{const k=typeof c.presenceState=="function"?c.presenceState():{};let N=!1;for(const w of Object.values(k||{})){const E=Array.isArray(w)?w:[w];for(const y of E){const S=String((y==null?void 0:y.userId)||(y==null?void 0:y.user_id)||"");if(S&&S!==String(O)){N=!0;break}}if(N)break}g(w=>w.map(E=>E.id!==d||E.hasBlockingRelationship||E.blockedByOther?E:N?{...E,online:!0,presence:"online"}:{...E,online:!1}))}catch{}};c.on("presence",{event:"sync"},v),c.on("presence",{event:"join"},v),c.on("presence",{event:"leave"},v),c.on("broadcast",{event:"typing"},({payload:k})=>{const N=String((k==null?void 0:k.userId)||"");if(!N||N===String(O))return;const w=!!(k!=null&&k.isTyping);ae(w),ee.current&&(window.clearTimeout(ee.current),ee.current=null),w&&(ee.current=window.setTimeout(()=>{ae(!1),ee.current=null},3e3))}),se.current=c,c.subscribe(async(k,N)=>{if(!n&&k==="SUBSCRIBED")try{await c.track({userId:String(O),at:new Date().toISOString()}),v()}catch{}})}catch{n||ae(!1)}})(),()=>{n=!0;const r=se.current;if(se.current=null,r)try{r.unsubscribe()}catch{}pt(),D.current.lastValue=!1,ae(!1)}},[d,T,O,ze]),m.useEffect(()=>{if(!d||!O||!se.current)return;const n=ie.trim().length>0,s=Date.now(),r=D.current;n!==r.lastValue&&s-r.lastSentAt>600&&Le(n),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{D.current.idleTimer=null,Le(!1)},2e3))},[ie,d,O]),m.useEffect(()=>{if(!d||J.trim())return;const n=ut.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[d,xe.length,Ee,J]),m.useEffect(()=>{d||de(!1)},[d]),m.useEffect(()=>{je(null)},[d]),m.useEffect(()=>()=>{ye.current&&clearTimeout(ye.current)},[]),m.useEffect(()=>{(!d||!T)&&Te(null)},[d,T]);const p=n=>{ot(n),ye.current&&clearTimeout(ye.current),ye.current=setTimeout(()=>ot(null),2400)},ht=(n,s={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const r=!!(s!=null&&s.silent);return Lt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),R(null),j(null),r||p("Session missing or expired. Please log in again."),!0},an=n=>{if(!n||typeof n!="object")return;const s=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",i=!!n.attachmentIsImage||r.startsWith("image/");if(!s||!i)return;const c=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";je({url:s,name:c,messageId:typeof n.id=="string"?n.id:""})},sn=()=>{je(null)},rn=async()=>{if(!(z!=null&&z.url))return;const n=z.name||"photo";try{const s=await fetch(z.url);if(!s.ok)throw new Error("download_failed");const r=await s.blob(),i=window.URL.createObjectURL(r),c=document.createElement("a");c.href=i,c.download=n,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(i),p("Image saved.")}catch{const s=document.createElement("a");s.href=z.url,s.target="_blank",s.rel="noreferrer",s.click(),p("Could not save directly. Opened image in a new tab.")}},ln=()=>{if(!A){p("No chat selected.");return}Ve(A),Se(""),Ie(z!=null&&z.name?`Photo attachment: ${z.name}`:"Photo attachment"),Ue(!0)};m.useEffect(()=>{if(!d||!T)return;let n=!1;Te(d);const s=async({silent:i=!1}={})=>{try{const{messages:c,chatPatch:v}=await Yn({sessionId:L,sessionCsrf:P,conversationId:d,currentUserId:O});if(n)return;M(k=>{const N=k[d]||[],w=new Set(c.map(y=>y.id)),E=N.filter(y=>y.id&&y.id.startsWith("m-")&&!w.has(y.id));return{...k,[d]:[...c,...E]}}),g(k=>k.map(N=>N.id===d?{...N,...v||{},unread:0}:N));try{await Gn({sessionId:L,sessionCsrf:P,conversationId:d})}catch{}}catch(c){if(!n&&ht(c))return;!n&&!i&&p((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{n||Te(c=>c===d?null:c)}};s();const r=window.setInterval(()=>{s({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[d,T,L,P,O]);const on=n=>{n&&(_e(n),rt(!0))},vt=()=>{rt(!1),_e(null)},Ge=n=>{n&&(Ve(n),Se(""),Ie(""),Ue(!0))},gt=()=>{Ue(!1),Ve(null),Se(""),Ie("")},cn=async()=>{var i;if(!ue||!Ce)return;if(!T){p("Session missing or expired. Please log in again.");return}const n=((i=xt.find(c=>c.value===Ce))==null?void 0:i.label)||Ce,s=lt.trim(),r=s?`${n} - ${s}`:n;try{await qn({sessionId:L,sessionCsrf:P,conversationId:ue.id,recipientId:ue.otherPartyId,reason:r});try{const c=await It({sessionId:L,sessionCsrf:P});$e(c)}catch{}gt(),p("Report sent.")}catch(c){p((c==null?void 0:c.message)||"Failed to submit report.")}},re=({title:n,message:s,confirmLabel:r,onConfirm:i})=>{dt({open:!0,title:n,message:s,confirmLabel:r,onConfirm:i})},q=()=>{dt(n=>({...n,open:!1}))},mn=async(n,s,r={})=>{const i=!!(r!=null&&r.silent);if(ct)return!1;const c=n.trim(),v=s.trim();if(!c||!v)return i||p("Session credentials missing. Please log in again."),!1;it(!0);try{const k=await Zn({sessionId:c,sessionCsrf:v}),{chats:N,blockedAccounts:w,reports:E,currentUser:y}=await Jn({sessionId:c,sessionCsrf:v});Fe({sessionId:c,sessionCsrf:v,userId:k.userId,realtimeToken:k.token||""}),mt(y?{...he,...y}:{...he,...o}),ca(c,v),g(N),we(w),M({}),$e(E);let S=null,x=null;if(!B.current){if(u.conversationId){const X=N.find(te=>te.id===u.conversationId);X&&(S=X.id)}if(!S&&u.recipientId){const X=N.find(te=>te.otherPartyId===u.recipientId);X?S=X.id:x={id:u.recipientId,name:u.recipientName||"Business"}}B.current=!0}return j(x),R(S),oe(""),F(""),ce(!1),Be("chats"),!i&&N.length===0?p("Connected. No chats found."):i||p(`Connected. Loaded ${N.length} chat${N.length===1?"":"s"}.`),!0}catch(k){const N=ht(k,{silent:i});return!i&&!N&&p((k==null?void 0:k.message)||"Failed to restore your session."),!1}finally{it(!1)}};m.useEffect(()=>{let n=!1;return(async()=>{if(T)return;const r=oa();if(!r){n||p("Session missing or expired. Please log in again.");return}await mn(r.sessionId,r.sessionCsrf,{silent:!0})||n||p("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const Et=async(n,s={})=>{s.unarchive&&!await wt(n,{clearActive:!1,toast:!0})||(R(n),j(null),T&&Te(n),g(r=>r.map(i=>i.id===n?{...i,unread:0}:i)),ce(!1),F(""))},bt=(n,s,r)=>{M(i=>{const c=i[n]||[];return{...i,[n]:c.map(v=>v.id===s?{...v,status:r}:v)}})},dn=1e3,un=async()=>{const n=Date.now();if(n-ft.current<dn){p("Please wait before sending another message.");return}const s=ie.trim(),r=d||"",i=r?"":(b==null?void 0:b.id)||"",c=(A==null?void 0:A.name)||(b==null?void 0:b.name)||u.recipientName||"Business",v=(A==null?void 0:A.color)||"#3b82f6";if(!s||!!!(r||i))return;if(ft.current=n,V(U)){p(U!=null&&U.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(T){try{const w=await Kn({sessionId:L,sessionCsrf:P,conversationId:r||void 0,recipientId:i||void 0,content:s}),E=Tt(w==null?void 0:w.data,O),y=(typeof E.chatId=="string"?E.chatId.trim():"")||r;if(!y)throw new Error("Failed to resolve conversation ID.");M(S=>({...S,[y]:[...S[y]||[],E]})),me(""),g(S=>{const x=E.timestamp||new Date().toISOString();if(!S.find(W=>W.id===y))return[{id:y,name:c,firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:E.text||s,lastTime:x,unread:0,online:!1,presence:"",color:v,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:i||(b==null?void 0:b.id)||""},...S];const te=S.map(W=>W.id===y?{...W,lastMessage:E.text||s,lastTime:E.timestamp||x,unread:0}:W),pe=te.find(W=>W.id===y),Pe=te.filter(W=>W.id!==y);return pe?[pe,...Pe]:te}),R(y),j(null),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null),D.current.lastValue=!1,Le(!1)}catch(w){p((w==null?void 0:w.message)||"Failed to send message.")}return}if(!r){p("Session missing or expired. Please log in again.");return}const N={id:`m-${Date.now()}`,chatId:r,sender:"me",text:s,timestamp:new Date().toISOString(),status:"sent"};M(w=>({...w,[r]:[...w[r]||[],N]})),me(""),g(w=>{const E=w.map(x=>x.id===r?{...x,lastMessage:s,lastTime:N.timestamp,unread:0}:x),y=E.find(x=>x.id===r),S=E.filter(x=>x.id!==r);return y?[y,...S]:E}),setTimeout(()=>bt(r,N.id,"delivered"),900),setTimeout(()=>bt(r,N.id,"read"),2e3),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null),D.current.lastValue=!1,Le(!1)},fn=()=>{if(!d&&!(b!=null&&b.id)){p("Select a chat to add emojis.");return}de(n=>!n)},pn=()=>{de(!1)},hn=n=>{var r,i;const s=(n==null?void 0:n.native)??((i=(r=n==null?void 0:n.skins)==null?void 0:r[0])==null?void 0:i.native)??"";s&&me(c=>{const{nextValue:v,caret:k}=ka(c,s,be.current);return requestAnimationFrame(()=>{be.current&&document.activeElement===be.current&&be.current.setSelectionRange(k,k)}),v})},vn=()=>{if(!d&&!(b!=null&&b.id)){p("Select a chat first.");return}if(!T){p("Session missing or expired. Please log in again.");return}if(V(U)){p(U!=null&&U.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}We.current&&We.current.click()},gn=new Set(["image/png","image/jpeg","image/webp"]),En=new Set(["video/mp4","video/webm","video/quicktime","video/x-m4v"]),bn=new Set(["application/pdf"]),yt=10*1024*1024,yn=15*1024*1024;function Nn(n){const s=(n.type||"").toLowerCase(),r=(n.name||"").toLowerCase();return gn.has(s)||/\.(png|jpe?g|webp)$/.test(r)?{ok:!0,maxBytes:yt,label:"images"}:En.has(s)||/\.(mp4|webm|mov|m4v)$/.test(r)?{ok:!0,maxBytes:yn,label:"videos"}:bn.has(s)||r.endsWith(".pdf")?{ok:!0,maxBytes:yt,label:"documents"}:{ok:!1,maxBytes:0,label:""}}const kn=async n=>{var w;const s=n.target,r=(w=s==null?void 0:s.files)==null?void 0:w[0];if(s&&(s.value=""),!r)return;const i=Nn(r);if(!i.ok){p("Unsupported file type. Allowed: PNG, JPEG, WEBP, PDF, MP4, WEBM, MOV.");return}if(r.size>i.maxBytes){const E=Math.round(i.maxBytes/1048576);p(`File too large. Maximum ${E}MB for ${i.label}.`);return}if(!d&&!(b!=null&&b.id)){p("Select a chat first.");return}if(!T){p("Session missing or expired. Please log in again.");return}if(V(U)){p(U!=null&&U.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const c=d||"",v=c?"":(b==null?void 0:b.id)||"",k=(A==null?void 0:A.name)||(b==null?void 0:b.name)||u.recipientName||"Business",N=(A==null?void 0:A.color)||"#3b82f6";try{const E=await Xn({sessionId:L,sessionCsrf:P,conversationId:c||void 0,recipientId:v||void 0,file:r}),y=Tt(E==null?void 0:E.data,O),S=(typeof y.chatId=="string"?y.chatId.trim():"")||c;if(!S)throw new Error("Failed to resolve conversation ID.");M(x=>({...x,[S]:[...x[S]||[],y]})),g(x=>{const X=y.timestamp||new Date().toISOString();if(!x.find(G=>G.id===S))return[{id:S,name:k,firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:y.text||r.name,lastTime:X,unread:0,online:!1,presence:"",color:N,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:v||(b==null?void 0:b.id)||""},...x];const pe=x.map(G=>G.id===S?{...G,lastMessage:y.text||r.name,lastTime:y.timestamp||X,unread:0}:G),Pe=pe.find(G=>G.id===S),W=pe.filter(G=>G.id!==S);return Pe?[Pe,...W]:pe}),R(S),j(null),p("Attachment sent.")}catch(E){p((E==null?void 0:E.message)||"Failed to send attachment.")}},wn=n=>{M(s=>({...s,[n]:[]})),g(s=>s.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},Cn=()=>{if(d){wn(d),p("Cleared current chat.");return}const n={};C.forEach(s=>{n[s.id]=[]}),M(n),g(s=>s.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),p("Cleared all chats.")},Ke=n=>{if(!Array.isArray(n)||n.length===0)return;const s=new Set(n.filter(Boolean));s.size&&(g(r=>r.filter(i=>!s.has(i.id))),M(r=>{const i={...r};return s.forEach(c=>{delete i[c]}),i}),d&&s.has(d)&&R(null))},qe=async(n,s={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const i=s.toast!==!1;if(T)try{await Bt({sessionId:L,sessionCsrf:P,conversationId:r})}catch(c){return p((c==null?void 0:c.message)||"Failed to delete chat."),!1}return Ke([r]),i&&p("Chat deleted."),!0},Sn=async()=>{const n=C.map(i=>i.id).filter(Boolean);if(n.length===0)return p("No chats to delete."),!1;if(!T)return Ke(n),p("All chats deleted."),!0;const s=[];for(const i of n)try{await Bt({sessionId:L,sessionCsrf:P,conversationId:i}),s.push(i)}catch{}s.length>0&&Ke(s);const r=n.length-s.length;return s.length===0?(p("Failed to delete chats."),!1):r===0?(p("All chats deleted."),!0):(p(`Deleted ${s.length} chat${s.length===1?"":"s"}. ${r} failed.`),!1)},In=async()=>{if(d){await qe(d);return}await Sn()},Tn=(n,s)=>{const r=C.find(N=>N.id===n),i=(r==null?void 0:r.otherPartyId)||n;if(!i)return;const c=s||new Date().toISOString(),v=(r==null?void 0:r.name)||"Unknown",k=(r==null?void 0:r.color)||"#3b82f6";we(N=>{const w=N.filter(E=>E.id!==i);return[{id:i,name:v,blockedAt:c,color:k},...w]})},Nt=({accountId:n,conversationId:s=""})=>{const r=typeof n=="string"?n.trim():"",i=typeof s=="string"?s.trim():"";g(c=>c.map(v=>{const k=!!i&&v.id===i,N=!!r&&v.otherPartyId===r;if(!k&&!N)return v;const w=!!v.blockedByOther;return{...v,blocked:!1,blockedByMe:!1,hasBlockingRelationship:w,blockedAt:void 0}})),r&&we(c=>c.filter(v=>v.id!==r))},kt=async n=>{if(!n)return!1;if(T)try{await aa({sessionId:L,sessionCsrf:P,conversationId:n})}catch(r){return p((r==null?void 0:r.message)||"Failed to block account."),!1}const s=new Date().toISOString();return g(r=>r.map(i=>i.id===n?{...i,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:s}:i)),Tn(n,s),d===n&&R(null),p("Chat blocked."),!0},An=async n=>{if(!n)return!1;const s=C.find(i=>i.id===n),r=(s==null?void 0:s.otherPartyId)||"";if(T)try{await At({sessionId:L,sessionCsrf:P,conversationId:n||void 0,recipientId:r||void 0})}catch(i){return p((i==null?void 0:i.message)||"Failed to unblock account."),!1}return Nt({accountId:r,conversationId:n}),p("Account unblocked."),!0},Bn=async n=>{const s=typeof n=="string"?n.trim():"";if(!s)return!1;const r=C.find(c=>c.otherPartyId===s),i=(r==null?void 0:r.id)||"";if(T)try{await At({sessionId:L,sessionCsrf:P,conversationId:i||void 0,recipientId:s})}catch(c){return p((c==null?void 0:c.message)||"Failed to unblock account."),!1}return Nt({accountId:s,conversationId:i}),p("Account unblocked."),!0},xn=async(n,s={})=>{if(!n)return!1;const r=s.clearActive!==!1,i=s.toast!==!1;if(T)try{await ea({sessionId:L,sessionCsrf:P,conversationId:n})}catch(c){return p((c==null?void 0:c.message)||"Failed to archive chat."),!1}return g(c=>c.map(v=>v.id===n?{...v,archived:!0,archivedAt:new Date().toISOString()}:v)),r&&d===n&&R(null),i&&p("Chat archived."),!0},wt=async(n,s={})=>{if(!n)return!1;const r=s.clearActive===!0,i=s.toast!==!1;if(T)try{await Qn({sessionId:L,sessionCsrf:P,conversationId:n})}catch(c){return p((c==null?void 0:c.message)||"Failed to restore chat."),!1}return g(c=>c.map(v=>v.id===n?{...v,archived:!1,archivedAt:void 0}:v)),r&&d===n&&R(null),i&&p("Chat restored from archive."),!0},Ct=n=>{if(n==="profile"){if(!d){p("No chat selected.");return}const s=C.find(r=>r.id===d)||null;at(s),nt(!0);return}if(n==="close"){R(null),j(null),ce(!1),F(""),p("Chat closed.");return}if(n==="block"){if(!d)return;const s=C.find(i=>i.id===d),r=(s==null?void 0:s.id)||d;re({title:s?`Block ${s.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{q(),await kt(r)}});return}if(n==="delete"){const s=A?`Delete chat with ${ne(A)}?`:"Delete all chats?";re({title:s,message:A?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),In()}});return}if(n==="clear"){const s=A?`Clear chat with ${A.name}?`:"Clear all chats?";re({title:s,message:A?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{q(),Cn()}});return}n==="report"&&Ge(A)},Ln=n=>{Ct(n)},Pn=(n,s)=>{const r=C.find(i=>i.id===n);if(r){if(s==="delete"){re({title:`Delete chat with ${ne(r)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),qe(n)}});return}if(s==="report"){Ge(r);return}if(s==="archive"){xn(n,{clearActive:!0,toast:!0});return}}},Mn=()=>{ce(n=>{const s=!n;return s||F(""),s})},Xe=()=>{nt(!1),at(null)},Rn=()=>{Y&&re({title:`Delete chat with ${ne(Y)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),(async()=>await qe(Y.id)&&Xe())()}})},Dn=()=>{if(!Y)return;const n=Y.id,s=!!Y.blocked,r=ne(Y);re({title:s?`Unblock ${r}?`:`Block ${r}?`,message:s?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:s?"Unblock":"Block",onConfirm:async()=>{q(),(s?await An(n):await kt(n))&&Xe()}})},$n=()=>{Y&&Ge(Y)},On=n=>{if(n==="home"){Be(n),window.location.href="home_main.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&R(null),Be(n);const s=n.charAt(0).toUpperCase()+n.slice(1);p(`${s} selected.`)},_n=n=>{wt(n,{clearActive:!1,toast:!0})},Un=n=>{Bn(n)},Vn=[{label:"Delete chats",onSelect:()=>Ct("delete")},{label:"Reports",onSelect:()=>Be("reports")},{label:"Logout",onSelect:()=>re({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{q(),Lt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),mt({...he,...o}),p("Logged out.")}})}],Ne=!!(d||b!=null&&b.id||H),St=Ne||_==="archive"||_==="block"||_==="profile"||_==="reports",jn=ct;return m.useEffect(()=>{if(!T||_!=="block")return;let n=!1;return(async()=>{try{const s=await Wn({sessionId:L,sessionCsrf:P});n||we(s)}catch{}})(),()=>{n=!0}},[T,_,L,P]),m.useEffect(()=>{if(!T||_!=="reports")return;let n=!1;return(async()=>{try{const s=await It({sessionId:L,sessionCsrf:P});n||$e(s)}catch{}})(),()=>{n=!0}},[T,_,L,P]),m.useEffect(()=>{if(!Oe||!(Q!=null&&Q.id))return;const n=De.find(s=>s.id===Q.id);if(!n){vt();return}_e(n)},[Oe,Q==null?void 0:Q.id,De]),e.createElement("div",{className:`chp-app${Ne?" chat-only":""}${St&&!Ne?" no-header":""}`},St?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:zn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(tt,{ariaLabel:"App menu",items:Vn}))),e.createElement("main",{className:"chp-main","data-view":Ne?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},_==="archive"?e.createElement(Ua,{chats:Jt,onOpenChat:Et,onUnarchive:_n}):_==="block"?e.createElement(Va,{chats:Qt,onUnblock:Un}):_==="profile"?e.createElement(_a,{currentUser:Xt}):_==="reports"?e.createElement(ja,{reports:De,onOpenReport:on}):e.createElement(za,{chats:en,searchValue:K,onSearchChange:oe,activeChatId:d,onOpenChat:Et,onChatAction:Pn})),e.createElement("section",{className:"chp-pane chp-convo-pane"},H?e.createElement(Oa,{chat:Y,onClose:Xe,onDelete:Rn,onBlock:Dn,onReport:$n}):e.createElement(Za,{chat:U,groupedMessages:tn,searchValue:J,showSearch:ke,onToggleSearch:Mn,onSearchChange:F,onBack:()=>{R(null),j(null)},onSend:un,composerValue:ie,onComposerChange:me,onEmoji:fn,onAttach:vn,emojiOpen:Re,onEmojiSelect:hn,onEmojiClose:pn,composerRef:be,typing:Ee,conversationLoading:nn,messageListRef:ut,matchCount:Ye.length,onMenuAction:Ln,attachmentPreview:z,onOpenAttachmentPreview:an,onCloseAttachmentPreview:sn,onSaveAttachmentPreview:rn,onReportAttachmentPreview:ln}))),Ne?null:e.createElement(Ja,{activeKey:_,onSelect:On}),jn?e.createElement(Wa,null):null,e.createElement(Fa,{open:Oe,report:Q,onClose:vt}),e.createElement($a,{open:Kt,onClose:gt,reasons:xt,value:Ce,onChange:Se,details:lt,onDetailsChange:Ie,onSubmit:cn,targetName:ue==null?void 0:ue.name}),e.createElement(Da,{open:fe.open,title:fe.title,message:fe.message,confirmLabel:fe.confirmLabel,onConfirm:()=>{fe.onConfirm?fe.onConfirm():q()},onCancel:q}),e.createElement("input",{ref:We,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:kn,style:{display:"none"}}))}const es=sa(document.getElementById("root"));es.render(e.createElement(e.StrictMode,null,e.createElement(Qa,null)));
