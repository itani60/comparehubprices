import{r as m,h as Ra,i as Da,f as La,a as Rt,R as e,l as Ma,g as Oa,b as Ua,m as $a,s as Fa,c as Dt,j as Lt,p as _a,d as Va,e as ja,k as Ha,u as Wa,q as Mt,$ as za,n as Ya,o as qa,t as Ka}from"./64-BRpcbTOt.js";const le={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Za=[],Ja={},Ot=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function Qa(){if(typeof document>"u")return null;const a=$t("standard_session_id"),s=$t("standard_csrf_token");return console.log("[ChatDebug] readPersistedChatSession:",{hasSessionId:!!a,sessionIdPreview:a?a.slice(0,8)+"...":"(empty)",hasCsrf:!!s,csrfPreview:s?s.slice(0,8)+"...":"(empty)",allCookies:document.cookie?document.cookie.split(";").map(l=>l.trim().split("=")[0]):[]}),!a||!s?null:{sessionId:a,sessionCsrf:s}}function Ga(a,s){var h,E;if(console.log("[ChatDebug] persistChatSession called:",{hasSessionId:!!a,hasCsrf:!!s,protocol:typeof window<"u"?(h=window.location)==null?void 0:h.protocol:"unknown"}),typeof document>"u"||!a||!s)return;const l=typeof window<"u"&&((E=window.location)==null?void 0:E.protocol)==="https:"?"; Secure":"",i=12*60*60;document.cookie=`standard_session_id=${encodeURIComponent(a)}; path=/; max-age=${i}; SameSite=Lax${l}`,document.cookie=`standard_csrf_token=${encodeURIComponent(s)}; path=/; max-age=${i}; SameSite=Lax${l}`,console.log("[ChatDebug] persistChatSession done. Cookie names now:",document.cookie.split(";").map(v=>v.trim().split("=")[0]))}function Ut(){typeof document>"u"||(Ft("standard_session_id"),Ft("standard_csrf_token"))}function $t(a){if(!a||typeof document>"u")return"";try{const s=String(document.cookie||"");if(!s)return"";const l=s.split(";");let i="";for(const h of l){const E=h.indexOf("=");if(E<=0||h.slice(0,E).trim()!==a)continue;const D=h.slice(E+1).trim();if(D)try{i=decodeURIComponent(D).trim()}catch{i=D.trim()}}return i}catch{return""}}function Ft(a){var l;const s=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${a}=; path=/; max-age=0; SameSite=Lax${s}`}function Xa(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const a=new URLSearchParams(window.location.search||"");return{conversationId:(a.get("conversationId")||"").trim(),recipientId:(a.get("recipientId")||"").trim(),recipientName:(a.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function en(a){return a!=null&&a.id?{id:"",name:String(a.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:a.id,launchPending:!0}:null}function he(a){if(!a)return"";const s=a.split(" ").filter(Boolean),l=s[0]?s[0][0]:"",i=s.length>1?s[s.length-1][0]:"";return(l+i).toUpperCase()}function fe(a){return!a||typeof a!="object"||a.blockedByOther?"User unavailable":a.name||"Unknown"}function ee(a){return!!(a&&(a.blocked||a.blockedByOther))}function Vt(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function tn(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function et(a){if(!a)return"";const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function jt(a){const s=String(a||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Ht(a){const s=String(a||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function _t(a,s){return a.getFullYear()===s.getFullYear()&&a.getMonth()===s.getMonth()&&a.getDate()===s.getDate()}function an(a){const s=new Date(a);if(Number.isNaN(s.getTime()))return"";const l=new Date,i=new Date;return i.setDate(l.getDate()-1),_t(s,l)?"Today":_t(s,i)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function nn(a){const s=[];let l="";return a.forEach(i=>{const h=i.timestamp.slice(0,10);h!==l&&(s.push({type:"day",id:`day-${h}`,label:an(i.timestamp)}),l=h),s.push({type:"message",id:i.id,message:i})}),s}function sn(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ln(a,s){if(!s)return a;const l=sn(s);return a.split(new RegExp(`(${l})`,"ig")).map((h,E)=>h.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:E,className:"msg-highlight"},h):e.createElement("span",{key:E},h))}function rn(a,s,l){const i=(l==null?void 0:l.selectionStart)??a.length,h=(l==null?void 0:l.selectionEnd)??i;return{nextValue:a.slice(0,i)+s+a.slice(h),caret:i+s.length}}function at(a,s,l){m.useEffect(()=>{if(!l)return;const i=h=>{!a.current||a.current.contains(h.target)||s()};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[a,s,l])}function M({children:a,size:s=20,className:l}){return e.createElement("svg",{className:l,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},a)}const on=a=>e.createElement(M,{...a},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Wt=a=>e.createElement(M,{...a},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),cn=a=>e.createElement(M,{...a},e.createElement("rect",{x:"5",y:"11",width:"14",height:"9",rx:"2"}),e.createElement("path",{d:"M8 11V8a4 4 0 0 1 8 0v3"})),mn=a=>e.createElement(M,{...a},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),dn=a=>e.createElement(M,{...a},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),un=a=>e.createElement(M,{...a},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),fn=a=>e.createElement(M,{...a},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),pn=a=>e.createElement(M,{...a},e.createElement("polyline",{points:"5 12 9 16 19 6"})),hn=a=>e.createElement(M,{...a},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),vn=a=>e.createElement(M,{...a},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),gn=a=>e.createElement(M,{...a},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),zt=a=>e.createElement(M,{...a},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),pe=a=>e.createElement(M,{...a},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),En=a=>e.createElement(M,{...a},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),Yt=a=>e.createElement(M,{...a},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),bn=a=>e.createElement(M,{...a},e.createElement("path",{d:"M9 4h-4v16h4"}),e.createElement("path",{d:"M16 12H7"}),e.createElement("path",{d:"M13 9l3 3-3 3"})),Pe=a=>e.createElement(M,{...a},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function qt({ariaLabel:a,items:s}){const[l,i]=m.useState(!1),h=m.useRef(null);return at(h,()=>i(!1),l),e.createElement("div",{className:"menu-wrap",ref:h},e.createElement("button",{className:"icon-btn","aria-label":a,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>i(E=>!E),type:"button"},e.createElement(on,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},s.map(E=>e.createElement("button",{key:E.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{i(!1),E.onSelect()}},E.label))):null)}function yn({status:a}){if(!a)return null;if(a==="sent")return e.createElement(pn,{className:"status-icon"});const s=a==="read"?"status-icon read":"status-icon";return e.createElement(hn,{className:s})}function Nn({open:a,title:s,message:l,confirmLabel:i,onConfirm:h,onCancel:E}){return a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:E},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},i)))):null}function kn({open:a,title:s,message:l,confirmLabel:i="Delete",onConfirm:h,onCancel:E}){return a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:E},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},i)))):null}function Cn({open:a,onClose:s,currentUser:l}){if(!a)return null;const i={...le,...l&&typeof l=="object"?l:{}},h=i.name||"User";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Profile panel"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Pe,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#2f9e8f"}},he(h)),e.createElement("div",null,e.createElement("h3",null,h))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",i.firstName||"-"),e.createElement("p",null,"Family name: ",i.lastName||"-"),e.createElement("p",null,"Suburb: ",i.suburb||"-"),e.createElement("p",null,"City: ",i.city||"-"),e.createElement("p",null,"Province: ",i.province||"-"),e.createElement("p",null,"Account since: ",i.accountSince||"-"))))}function Sn({open:a,onClose:s,chat:l,onDelete:i,onBlock:h,onReport:E}){if(!a||!l)return null;const v=!!l.blockedByOther,D=fe(l),O=l.name?l.name.split(" ").filter(Boolean):[],u=O[0]||"",x=O.slice(1).join(" "),S=v?"-":l.firstName||u||"-",A=v?"-":l.lastName||x||"-",L=v?"-":l.suburb||"-",F=v?"-":l.city||"-",f=v?"-":l.province||"-",B=v?"-":l.accountSince||"-",b=v?"-":l.accountType||"Standard";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Chat profile"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Chat Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Pe,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:l.color}},ee(l)?e.createElement(pe,{className:"avatar-blocked-icon",size:18}):he(D)),e.createElement("div",null,e.createElement("h3",null,D))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",S),e.createElement("p",null,"Family name: ",A),e.createElement("p",null,"Suburb: ",L),e.createElement("p",null,"City: ",F),e.createElement("p",null,"Province: ",f),e.createElement("p",null,"Account since: ",B),e.createElement("p",null,"Account type: ",b)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:i},e.createElement(Yt,null),"Delete"),v?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:h},e.createElement(pe,null),l.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:E},e.createElement(zt,null),"Report"))))))}function tt({title:a,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,a),e.createElement("p",null,s))}function wn(){const a=Array.from({length:7}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay desktop",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-desktop-shell"},e.createElement("aside",{className:"chat-loading-desktop-sidebar"},e.createElement("div",{className:"chat-loading-desktop-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})),e.createElement("div",{className:"chat-loading-desktop-search"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-search-box"})),e.createElement("div",{className:"chat-loading-desktop-list"},a.map((l,i)=>e.createElement("div",{className:"chat-loading-desktop-thread",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-time"}))))),e.createElement("section",{className:"chat-loading-desktop-chat"},e.createElement("div",{className:"chat-loading-desktop-chat-header"},e.createElement("div",{className:"chat-loading-desktop-chat-user"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}))),e.createElement("div",{className:"chat-loading-desktop-chat-actions"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}))),e.createElement("div",{className:"chat-loading-desktop-messages"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-day"}),s.map((l,i)=>e.createElement("div",{className:`chat-loading-desktop-bubble-row ${i%2?"me":"them"}`,key:i},e.createElement("div",{className:"chat-loading-desktop-bubble"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-meta"}))))),e.createElement("div",{className:"chat-loading-desktop-composer"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-input"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})))))}function nt({title:a,subtitle:s,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,a),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},l))}function In({currentUser:a}){const s={...le,...a&&typeof a=="object"?a:{}},l=s.name||"User";return e.createElement(nt,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-card"},e.createElement("div",{className:"profile-card-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#0f766e"}},he(l)),e.createElement("div",null,e.createElement("h3",null,l))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function Tn({chats:a,onUnblock:s}){return e.createElement(nt,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},a.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},a.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(pe,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,tn(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l.id)},"Unblock"))))))}function An({reports:a,onOpenReport:s}){return e.createElement(nt,{title:"Reports",subtitle:"Reports you submitted."},a.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},a.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b5bdb"}},he(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Ht(l.status)}`},jt(l.status)),e.createElement("span",null,et(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l)},"View report"))))))}function xn({open:a,report:s,onClose:l}){return!a||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(Pe,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Ht(s.status)}`},jt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},et(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},et(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Bn({open:a,onClose:s,reasons:l,value:i,onChange:h,details:E,onDetailsChange:v,onSubmit:D,targetName:O}){const[u,x]=m.useState(!1),S=m.useRef(null),A=l.find(L=>L.value===i);return at(S,()=>x(!1),u),m.useEffect(()=>{a||x(!1)},[a]),a?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",O||"this chat","."),e.createElement("div",{className:`report-select${u?" active":""}`,ref:S},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>x(L=>!L),"aria-haspopup":"listbox","aria-expanded":u},e.createElement("span",null,A?A.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(L=>e.createElement("button",{key:L.value,type:"button",className:`report-select__option${i===L.value?" selected":""}`,onClick:()=>{h(L.value),x(!1)},role:"option","aria-selected":i===L.value},L.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:E,onChange:L=>v(L.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:D,disabled:!i},"Report")))):null}function Pn({chats:a,searchValue:s,onSearchChange:l,activeChatId:i,onOpenChat:h,onMenuAction:E,emptyTitle:v="No chats yet",emptySubtitle:D="Start a new chat to compare prices.",showSearch:O=!0}){return e.createElement("div",{className:"chat-list-screen"},O?e.createElement("div",{className:"search-bar"},e.createElement(Wt,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:u=>l(u.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})):null,e.createElement("div",{className:"chat-list",role:"list"},a.length===0?e.createElement(tt,{title:v,subtitle:D}):a.map(u=>{const x=fe(u),S=[{label:u.archived?"Unarchive chat":"Archive chat",onSelect:()=>E(u.id,u.archived?"unarchive":"archive")},{label:"Delete chat",onSelect:()=>E(u.id,"delete")},{label:"Report",onSelect:()=>E(u.id,"report")}];return e.createElement("div",{key:u.id,className:`chat-item ${i===u.id?"active":""}`,role:"listitem"},e.createElement("button",{className:"chat-open",onClick:()=>h(u.id),type:"button","aria-label":`Open chat with ${x}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:u.color}},ee(u)?e.createElement(pe,{className:"avatar-blocked-icon",size:16}):he(u.name)),u.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},x),e.createElement("span",{className:"chat-time"},Vt(u.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},u.lastMessage?u.lastMessage:"No messages yet"),e.createElement("span",{className:"chat-flags"},u.unread>0?e.createElement("span",{className:"chat-unread"},u.unread):null)))),e.createElement(qt,{ariaLabel:"Chat options",items:S}))})))}function Rn({message:a,query:s,onPreviewImage:l}){const i=a.sender==="me",h=typeof a.attachmentUrl=="string"?a.attachmentUrl:"",E=typeof a.attachmentType=="string"?a.attachmentType.toLowerCase():"",v=typeof a.attachmentName=="string"&&a.attachmentName?a.attachmentName:"Attachment",D=!!a.attachmentIsImage||E.startsWith("image/"),O=!!a.attachmentIsVideo||E.startsWith("video/"),u=typeof a.text=="string"&&a.text.trim().length>0,x={width:"100%",maxWidth:"260px",borderRadius:"10px",display:"block",marginBottom:u?"8px":"0"};return e.createElement("div",{className:`message-row ${i?"me":"them"}`},e.createElement("div",{className:`message-bubble ${i?"outgoing":"incoming"}`},h?e.createElement("div",{className:"message-attachment"},D?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(a)},"aria-label":`Preview ${v}`},e.createElement("img",{src:h,alt:v,loading:"lazy",style:x})):O?e.createElement("video",{controls:!0,preload:"metadata",style:x},e.createElement("source",{src:h,type:E||void 0})):e.createElement("a",{href:h,target:"_blank",rel:"noreferrer"},"Open attachment")):null,u?e.createElement("div",{className:"message-text"},ln(a.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Vt(a.timestamp)),i?e.createElement(yn,{status:a.status}):null)))}function Dn({preview:a,onClose:s,onSave:l,onReport:i}){return a?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Pe,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:a.url,alt:a.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},a.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:i},"Report Photo"))):null}function Ln(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function Mn(){const a=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},a.map((s,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function On({value:a,onChange:s,onSend:l,onEmoji:i,onAttach:h,inputRef:E,disabled:v=!1,emojiActive:D=!1}){const O=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),!v&&a.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${D?" emoji-toggle-active":""}`,type:"button",onClick:i,"aria-label":"Emoji",disabled:v},e.createElement(un,null)),e.createElement("textarea",{ref:E,rows:1,value:a,onChange:u=>s(u.target.value),onKeyDown:O,placeholder:v?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:v}),e.createElement("button",{className:"icon-btn",type:"button",onClick:h,"aria-label":"Attach",disabled:v},e.createElement(fn,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:v||!a.trim(),"aria-label":"Send message"},e.createElement(dn,null)))}function Un({open:a,onSelect:s,onClose:l}){const i=m.useRef(null);return at(i,l,a),a?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:i},e.createElement(za,{data:qa,onEmojiSelect:s,theme:"light",set:"apple",getSpritesheetURL:()=>Ya,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiButtonRadius:"8px"}))):null}function $n({chat:a,groupedMessages:s,searchValue:l,showSearch:i,onToggleSearch:h,onSearchChange:E,onSend:v,composerValue:D,onComposerChange:O,onEmoji:u,onAttach:x,emojiOpen:S,onEmojiSelect:A,onEmojiClose:L,composerRef:F,typing:f,conversationLoading:B,messageListRef:b,matchCount:J,onMenuAction:V,attachmentPreview:ve,onOpenAttachmentPreview:te,onCloseAttachmentPreview:ae,onSaveAttachmentPreview:Re,onReportAttachmentPreview:re}){if(!a)return e.createElement("div",{className:"conversation empty-view"},e.createElement(tt,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(ve)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(Dn,{preview:ve,onClose:ae,onSave:Re,onReport:re}));const oe=fe(a),ne=!!a.launchPending,De=ne?[{label:"Close chat",onSelect:()=>V("close")}]:[{label:"View profile",onSelect:()=>V("profile")},{label:"Close chat",onSelect:()=>V("close")},{label:"Delete chat",onSelect:()=>V("delete")},{label:"Block",onSelect:()=>V("block")},{label:"Report",onSelect:()=>V("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:a.color}},ee(a)?e.createElement(pe,{className:"avatar-blocked-icon",size:16}):he(a.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},oe),e.createElement("div",{className:"conversation-status"},ne?e.createElement("span",null,"Start conversation"):f?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,a.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,a.online?"online":a.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(qt,{ariaLabel:"Conversation menu",items:De}))),i?e.createElement("div",{className:"conversation-search"},e.createElement(Wt,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:W=>E(W.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},J," match",J===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:b},e.createElement("div",{className:"security-banner"},e.createElement(cn,null),e.createElement("div",null,"Messages are end-to-end encrypted. No one outside of this chat can read or listen to them.")),B?e.createElement(Mn,null):s.length===0?e.createElement(tt,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):s.map(W=>W.type==="day"?e.createElement("div",{key:W.id,className:"day-separator"},W.label):e.createElement(Rn,{key:W.id,message:W.message,query:l.trim(),onPreviewImage:te})),f&&!l&&!B?e.createElement(Ln,null):null,!B&&ee(a)?e.createElement("div",{className:"blocked-notice",role:"note"},a.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(On,{value:D,onChange:O,onSend:v,onEmoji:u,onAttach:x,inputRef:F,disabled:ee(a),emojiActive:S}),e.createElement(Un,{open:S,onSelect:A,onClose:L}))}function Fn({currentUser:a=le,initialChats:s=Za,initialMessages:l=Ja}){const i={...le,...a&&typeof a=="object"?a:{}},h=Array.isArray(s)?s:[],E=l&&typeof l=="object"?l:{},v=m.useMemo(()=>Xa(),[]),D=!!(v.conversationId||v.recipientId),O=m.useRef(!D),[u,x]=m.useState("chats"),[S,A]=m.useState(h),[L,F]=m.useState(E),[f,B]=m.useState(null),[b,J]=m.useState(v.recipientId?{id:v.recipientId,name:v.recipientName||"Business"}:null),[V,ve]=m.useState(""),[te,ae]=m.useState(""),[Re,re]=m.useState(!1),[oe,ne]=m.useState(""),[De,W]=m.useState(!1),[st,ge]=m.useState(!1),[Kt,Zt]=m.useState(!1),[Vn,lt]=m.useState(null),[rt,Le]=m.useState(!1),[Jt,ot]=m.useState(!1),[Y,ct]=m.useState(null),[it,Ne]=m.useState([]),[Me,Oe]=m.useState([]),[Ue,mt]=m.useState(!1),[Q,$e]=m.useState(null),[Qt,Fe]=m.useState(!1),[ke,Ce]=m.useState(""),[dt,Se]=m.useState(""),[ce,_e]=m.useState(null),[j,Ve]=m.useState(null),[je,ut]=m.useState(!1),[Gt,we]=m.useState(null),[Ie,He]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[ft,pt]=m.useState(i),[ie,ht]=m.useState({open:!1,title:"",message:"",confirmLabel:"Delete",onConfirm:null}),[me,vt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),gt=m.useRef(null),Ee=m.useRef(null),We=m.useRef(null),be=m.useRef(null),se=m.useRef(null),G=m.useRef(null),U=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),ze=m.useRef(!1),Et=m.useRef(null),P=Ie.sessionId,R=Ie.sessionCsrf,$=Ie.userId,Ye=Ie.realtimeToken,I=!!(P&&R&&$),N=S.find(t=>t.id===f)||null,Xt=m.useMemo(()=>en(b),[b]),_=N||Xt,Te=m.useMemo(()=>S.filter(t=>!t.archived),[S]),ye=m.useMemo(()=>S.filter(t=>t.archived),[S]),ea=m.useMemo(()=>{const t=new Map;return it.forEach(n=>{n!=null&&n.id&&t.set(n.id,{id:n.id,name:n.name||"Unknown",blockedAt:n.blockedAt||"",color:n.color||"#3b82f6"})}),Array.from(t.values())},[it]),ta=m.useMemo(()=>{const t=V.trim().toLowerCase();return t?ye.filter(n=>n.name.toLowerCase().includes(t)||(n.lastMessage||"").toLowerCase().includes(t)):ye},[ye,V]),aa=m.useMemo(()=>{const t=V.trim().toLowerCase();return t?Te.filter(n=>n.name.toLowerCase().includes(t)||(n.lastMessage||"").toLowerCase().includes(t)):Te},[Te,V]),Ae=f?L[f]||[]:[],qe=m.useMemo(()=>{const t=te.trim().toLowerCase();return t?Ae.filter(n=>n.text.toLowerCase().includes(t)):Ae},[Ae,te]),na=m.useMemo(()=>nn(qe),[qe]),sa=!!(f&&Gt===f),bt=()=>{G.current&&(window.clearTimeout(G.current),G.current=null),U.current.idleTimer&&(window.clearTimeout(U.current.idleTimer),U.current.idleTimer=null)},xe=async(t,{force:n=!1}={})=>{const r=se.current;if(!r||!$)return;const o=!!t,c=Date.now(),p=U.current;if(!(!n&&p.lastValue===o&&c-p.lastSentAt<600)){p.lastValue=o,p.lastSentAt=c;try{await r.send({type:"broadcast",event:"typing",payload:{isTyping:o,userId:String($)}})}catch{}}};m.useEffect(()=>{let t=!1;return(async()=>{if(!f||!$||!Ye||!I){ge(!1);return}try{const r=await Oa();if(!r||t)return;r.realtime.setAuth(Ye);const o=se.current;if(o)try{await o.unsubscribe()}catch{}se.current=null,bt(),U.current.lastValue=!1;const c=r.channel(`conversation:${f}`,{config:{presence:{key:`chat:${String($)}`}}});c.on("broadcast",{event:"typing"},({payload:p})=>{const y=String((p==null?void 0:p.userId)||"");if(!y||y===String($))return;const g=!!(p!=null&&p.isTyping);ge(g),G.current&&(window.clearTimeout(G.current),G.current=null),g&&(G.current=window.setTimeout(()=>{ge(!1),G.current=null},3e3))}),c.subscribe(async p=>{if(!(t||p!=="SUBSCRIBED"))try{await c.track({userId:String($),at:new Date().toISOString()})}catch{}}),se.current=c}catch{t||ge(!1)}})(),()=>{t=!0;const r=se.current;if(se.current=null,r)try{r.unsubscribe()}catch{}bt(),U.current.lastValue=!1,ge(!1)}},[f,I,$,Ye]),m.useEffect(()=>{if(!f||!$||!se.current)return;const t=oe.trim().length>0,n=Date.now(),r=U.current;t!==r.lastValue&&n-r.lastSentAt>600&&xe(t,{force:!0}),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),t&&(r.idleTimer=window.setTimeout(()=>{U.current.idleTimer=null,xe(!1,{force:!0})},2e3))},[oe,f,$]),m.useEffect(()=>{if(!f||te.trim())return;const t=gt.current;t&&requestAnimationFrame(()=>{t.scrollTo({top:t.scrollHeight,behavior:"smooth"})})},[f,Ae.length,st,te]),m.useEffect(()=>{f||W(!1)},[f]),m.useEffect(()=>{Ve(null)},[f]),m.useEffect(()=>{(!f||!I)&&we(null)},[f,I]),m.useEffect(()=>()=>{be.current&&clearTimeout(be.current)},[]);const d=t=>{lt(t),be.current&&clearTimeout(be.current),be.current=setTimeout(()=>lt(null),2400)},yt=(t,n={})=>{if(Number(t==null?void 0:t.status)!==401)return!1;const r=!!(n!=null&&n.silent);return Ut(),He({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),B(null),J(null),r||d("Session missing or expired. Please log in again."),!0},la=t=>{if(!t||typeof t!="object")return;const n=typeof t.attachmentUrl=="string"?t.attachmentUrl.trim():"",r=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",o=!!t.attachmentIsImage||r.startsWith("image/");if(!n||!o)return;const c=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"photo";Ve({url:n,name:c,messageId:typeof t.id=="string"?t.id:""})},ra=()=>{Ve(null)},oa=async()=>{if(!(j!=null&&j.url))return;const t=j.name||"photo";try{const n=await fetch(j.url);if(!n.ok)throw new Error("download_failed");const r=await n.blob(),o=window.URL.createObjectURL(r),c=document.createElement("a");c.href=o,c.download=t,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(o),d("Image saved.")}catch{const n=document.createElement("a");n.href=j.url,n.target="_blank",n.rel="noreferrer",n.click(),d("Could not save directly. Opened image in a new tab.")}},ca=()=>{if(!N){d("No chat selected.");return}_e(N),Ce(""),Se(j!=null&&j.name?`Photo attachment: ${j.name}`:"Photo attachment"),Fe(!0)};m.useEffect(()=>{if(!f||!I)return;let t=!1;we(f);const n=async({silent:o=!1}={})=>{try{const{messages:c,chatPatch:p}=await Ua({sessionId:P,sessionCsrf:R,conversationId:f,currentUserId:$});if(t)return;F(y=>{const g=y[f]||[],k=new Set(c.map(C=>C.id)),w=g.filter(C=>C.id&&C.id.startsWith("m-")&&!k.has(C.id));return{...y,[f]:[...c,...w]}}),A(y=>y.map(g=>g.id===f?{...g,...p||{},unread:0}:g));try{await $a({sessionId:P,sessionCsrf:R,conversationId:f})}catch{}}catch(c){if(!t&&yt(c))return;!t&&!o&&d((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{t||we(c=>c===f?null:c)}};n();const r=window.setInterval(()=>{n({silent:!0})},5e3);return()=>{t=!0,window.clearInterval(r)}},[f,I,P,R,$]);const ia=t=>{if(!t){d("No chat selected.");return}ct(t),ot(!0)},Ke=()=>{ot(!1),ct(null)},ma=(t,n)=>{const r=S.find(g=>g.id===t),o=(r==null?void 0:r.otherPartyId)||t;if(!o)return;const c=n||new Date().toISOString(),p=(r==null?void 0:r.name)||"Unknown",y=(r==null?void 0:r.color)||"#3b82f6";Ne(g=>{const k=g.filter(w=>w.id!==o);return[{id:o,name:p,blockedAt:c,color:y},...k]})},Nt=({accountId:t,conversationId:n=""})=>{const r=typeof t=="string"?t.trim():"",o=typeof n=="string"?n.trim():"";A(c=>c.map(p=>{const y=!!o&&p.id===o,g=!!r&&p.otherPartyId===r;if(!y&&!g)return p;const k=!!p.blockedByOther;return{...p,blocked:!1,blockedByMe:!1,hasBlockingRelationship:k,blockedAt:void 0}})),r&&Ne(c=>c.filter(p=>p.id!==r))},kt=async t=>{if(!t)return!1;if(I)try{await _a({sessionId:P,sessionCsrf:R,conversationId:t})}catch(r){return d((r==null?void 0:r.message)||"Failed to block account."),!1}const n=new Date().toISOString();return A(r=>r.map(o=>o.id===t?{...o,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:n}:o)),ma(t,n),f===t&&B(null),d("Chat blocked."),!0},da=async t=>{if(!t)return!1;const n=S.find(o=>o.id===t),r=(n==null?void 0:n.otherPartyId)||"";if(I)try{await Lt({sessionId:P,sessionCsrf:R,conversationId:t||void 0,recipientId:r||void 0})}catch(o){return d((o==null?void 0:o.message)||"Failed to unblock account."),!1}return Nt({accountId:r,conversationId:t}),d("Account unblocked."),!0},ua=async t=>{const n=typeof t=="string"?t.trim():"";if(!n)return!1;const r=S.find(c=>c.otherPartyId===n),o=(r==null?void 0:r.id)||"";if(I)try{await Lt({sessionId:P,sessionCsrf:R,conversationId:o||void 0,recipientId:n})}catch(c){return d((c==null?void 0:c.message)||"Failed to unblock account."),!1}return Nt({accountId:n,conversationId:o}),d("Account unblocked."),!0},fa=async(t,n={})=>{if(!t)return!1;const r=n.clearActive!==!1,o=n.toast!==!1;if(I)try{await Ha({sessionId:P,sessionCsrf:R,conversationId:t})}catch(c){return d((c==null?void 0:c.message)||"Failed to archive chat."),!1}return A(c=>c.map(p=>p.id===t?{...p,archived:!0,archivedAt:new Date().toISOString()}:p)),r&&f===t&&B(null),o&&d("Chat archived."),!0},Ct=async(t,n={})=>{if(!t)return!1;const r=n.clearActive===!0,o=n.toast!==!1;if(I)try{await Wa({sessionId:P,sessionCsrf:R,conversationId:t})}catch(c){return d((c==null?void 0:c.message)||"Failed to restore chat."),!1}return A(c=>c.map(p=>p.id===t?{...p,archived:!1,archivedAt:void 0}:p)),r&&f===t&&B(null),o&&d("Chat restored from archive."),!0},pa=t=>{t&&($e(t),mt(!0))},St=()=>{mt(!1),$e(null)},Ze=t=>{t&&(_e(t),Ce(""),Se(""),Fe(!0))},wt=()=>{Fe(!1),_e(null),Ce(""),Se("")},ha=async()=>{var o;if(!ce||!ke)return;if(!I){d("Session missing or expired. Please log in again.");return}const t=((o=Ot.find(c=>c.value===ke))==null?void 0:o.label)||ke,n=dt.trim(),r=n?`${t} - ${n}`:t;try{await Va({sessionId:P,sessionCsrf:R,conversationId:ce.id,recipientId:ce.otherPartyId,reason:r});try{const c=await Rt({sessionId:P,sessionCsrf:R});Oe(c)}catch{}wt(),d("Report sent.")}catch(c){d((c==null?void 0:c.message)||"Failed to submit report.")}},va=({title:t,message:n,confirmLabel:r,onConfirm:o})=>{vt({open:!0,title:t,message:n,confirmLabel:r,onConfirm:o})},Je=()=>{vt(t=>({...t,open:!1}))},ga=m.useCallback(async(t,n,r={})=>{const o=!!(r!=null&&r.silent);if(je)return!1;const c=t.trim(),p=n.trim();if(!c||!p)return o||d("Session credentials missing. Please log in again."),!1;ut(!0);try{const y=await Ra({sessionId:c,sessionCsrf:p}),{chats:g,blockedAccounts:k,reports:w,currentUser:C}=await Da({sessionId:c,sessionCsrf:p});He({sessionId:c,sessionCsrf:p,userId:y.userId,realtimeToken:y.token||""}),pt(C?{...le,...C}:{...le,...i}),Ga(c,p),A(g),Ne(k),F({}),Oe(w);let T=null,ue=null;if(!O.current){if(v.conversationId){const q=g.find(K=>K.id===v.conversationId);q&&(T=q.id)}if(!T&&v.recipientId){const q=g.find(K=>K.otherPartyId===v.recipientId);q?T=q.id:ue={id:v.recipientId,name:v.recipientName||"Business"}}O.current=!0}return J(ue),B(T),Le(!1),ve(""),ae(""),re(!1),x("chats"),!o&&g.length===0?d("Connected. No chats found."):o||d(`Connected. Loaded ${g.length} chat${g.length===1?"":"s"}.`),!0}catch(y){const g=yt(y,{silent:o});return!o&&!g&&d((y==null?void 0:y.message)||"Failed to restore your session."),!1}finally{ut(!1)}},[je,i,v]);Et.current=ga,m.useEffect(()=>{let t=!1;return console.log("[ChatDebug] Session restore effect running..."),(async()=>{const r=Qa();if(console.log("[ChatDebug] Session restore - persisted result:",r?"FOUND":"NOT FOUND"),!r){console.warn("[ChatDebug] No session cookies found. Possible causes:",`
  1. User never logged in`,`
  2. Cookies were cleared`,`
  3. Cookies set on different domain/path`,`
  4. Cookies are HttpOnly (can't read via JS)`),t||d("Session missing or expired. Please log in again.");return}console.log("[ChatDebug] Attempting connectWithSession...");const o=Et.current;if(!o)return;const c=await o(r.sessionId,r.sessionCsrf,{silent:!0});console.log("[ChatDebug] connectWithSession result:",c?"SUCCESS":"FAILED"),c||t||d("Session missing or expired. Please log in again.")})(),()=>{t=!0}},[]);const de=({title:t,message:n,confirmLabel:r="Delete",onConfirm:o})=>{ht({open:!0,title:t,message:n,confirmLabel:r,onConfirm:o})},X=()=>{ht(t=>({...t,open:!1}))},Ea=async(t,n={})=>{n.unarchive&&!await Ct(t,{clearActive:!1,toast:!0})||(B(t),J(null),I&&we(t),Le(!1),n.keepSection||x("chats"),A(r=>r.map(o=>o.id===t?{...o,unread:0}:o)),re(!1),ae(""))},It=(t,n,r)=>{F(o=>{const c=o[t]||[];return{...o,[t]:c.map(p=>p.id===n?{...p,status:r}:p)}})},ba=async()=>{const t=oe.trim(),n=f||"",r=n?"":(b==null?void 0:b.id)||"",o=(N==null?void 0:N.name)||(b==null?void 0:b.name)||v.recipientName||"Business",c=(N==null?void 0:N.color)||"#3b82f6";if(!t||!!!(n||r))return;if(ee(_)){d(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(!n&&ze.current){d("Please wait, sending previous message...");return}if(I){n||(ze.current=!0);try{const g=await Fa({sessionId:P,sessionCsrf:R,conversationId:n||void 0,recipientId:r||void 0,content:t}),k=Dt(g==null?void 0:g.data,$),w=(typeof k.chatId=="string"?k.chatId.trim():"")||n;if(!w)throw new Error("Failed to resolve conversation ID.");F(C=>({...C,[w]:[...C[w]||[],k]})),ne(""),A(C=>{const T=k.timestamp||new Date().toISOString();if(!C.find(H=>H.id===w))return[{id:w,name:o,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:k.text||t,lastTime:T,unread:0,online:!1,presence:"offline",color:c,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:r||(b==null?void 0:b.id)||""},...C];const q=C.map(H=>H.id===w?{...H,lastMessage:k.text||t,lastTime:k.timestamp||T,unread:0}:H),K=q.find(H=>H.id===w),Be=q.filter(H=>H.id!==w);return K?[K,...Be]:q}),B(w),J(null),U.current.idleTimer&&(window.clearTimeout(U.current.idleTimer),U.current.idleTimer=null),U.current.lastValue=!1,xe(!1,{force:!0})}catch(g){d((g==null?void 0:g.message)||"Failed to send message.")}finally{ze.current=!1}return}if(!n){d("Session missing or expired. Please log in again.");return}const y={id:`m-${Date.now()}`,chatId:n,sender:"me",text:t,timestamp:new Date().toISOString(),status:"sent"};F(g=>({...g,[n]:[...g[n]||[],y]})),ne(""),A(g=>{const k=g.map(T=>T.id===n?{...T,lastMessage:t,lastTime:y.timestamp,unread:0}:T),w=k.find(T=>T.id===n),C=k.filter(T=>T.id!==n);return w?[w,...C]:k}),setTimeout(()=>It(n,y.id,"delivered"),900),setTimeout(()=>It(n,y.id,"read"),2e3),U.current.idleTimer&&(window.clearTimeout(U.current.idleTimer),U.current.idleTimer=null),U.current.lastValue=!1,xe(!1,{force:!0})},ya=()=>{if(!f&&!(b!=null&&b.id)){d("Select a chat to add emojis.");return}W(t=>!t)},Na=()=>{W(!1)},ka=t=>{var r,o;const n=(t==null?void 0:t.native)??((o=(r=t==null?void 0:t.skins)==null?void 0:r[0])==null?void 0:o.native)??"";n&&ne(c=>{const{nextValue:p,caret:y}=rn(c,n,Ee.current);return requestAnimationFrame(()=>{Ee.current&&(Ee.current.focus(),Ee.current.setSelectionRange(y,y))}),p})},Ca=()=>{if(!f&&!(b!=null&&b.id)){d("Select a chat first.");return}if(!I){d("Session missing or expired. Please log in again.");return}if(ee(_)){d(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}We.current&&We.current.click()},Sa=async t=>{var g;const n=t.target,r=(g=n==null?void 0:n.files)==null?void 0:g[0];if(n&&(n.value=""),!r)return;if(!f&&!(b!=null&&b.id)){d("Select a chat first.");return}if(!I){d("Session missing or expired. Please log in again.");return}if(ee(_)){d(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const o=f||"",c=o?"":(b==null?void 0:b.id)||"",p=(N==null?void 0:N.name)||(b==null?void 0:b.name)||v.recipientName||"Business",y=(N==null?void 0:N.color)||"#3b82f6";try{const k=await ja({sessionId:P,sessionCsrf:R,conversationId:o||void 0,recipientId:c||void 0,file:r}),w=Dt(k==null?void 0:k.data,$),C=(typeof w.chatId=="string"?w.chatId.trim():"")||o;if(!C)throw new Error("Failed to resolve conversation ID.");F(T=>({...T,[C]:[...T[C]||[],w]})),A(T=>{const ue=w.timestamp||new Date().toISOString();if(!T.find(Z=>Z.id===C))return[{id:C,name:p,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:w.text||r.name,lastTime:ue,unread:0,online:!1,presence:"offline",color:y,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:c||(b==null?void 0:b.id)||""},...T];const K=T.map(Z=>Z.id===C?{...Z,lastMessage:w.text||r.name,lastTime:w.timestamp||ue,unread:0}:Z),Be=K.find(Z=>Z.id===C),H=K.filter(Z=>Z.id!==C);return Be?[Be,...H]:K}),B(C),J(null),d("Attachment sent.")}catch(k){d((k==null?void 0:k.message)||"Failed to send attachment.")}},Qe=t=>{if(!Array.isArray(t)||t.length===0)return;const n=new Set(t.filter(Boolean));n.size&&(A(r=>r.filter(o=>!n.has(o.id))),F(r=>{const o={...r};return n.forEach(c=>{delete o[c]}),o}),f&&n.has(f)&&B(null))},Ge=async(t,n={})=>{const r=typeof t=="string"?t.trim():"";if(!r)return!1;const o=n.toast!==!1;if(I)try{await Mt({sessionId:P,sessionCsrf:R,conversationId:r})}catch(c){return d((c==null?void 0:c.message)||"Failed to delete chat."),!1}return Qe([r]),o&&d("Chat deleted."),!0},Tt=async()=>{const t=S.map(o=>o.id).filter(Boolean);if(t.length===0)return d("No chats to delete."),!1;if(!I)return Qe(t),d("All chats deleted."),!0;const n=[];for(const o of t)try{await Mt({sessionId:P,sessionCsrf:R,conversationId:o}),n.push(o)}catch{}n.length>0&&Qe(n);const r=t.length-n.length;return n.length===0?(d("Failed to delete chats."),!1):r===0?(d("All chats deleted."),!0):(d(`Deleted ${n.length} chat${n.length===1?"":"s"}. ${r} failed.`),!1)},wa=t=>{F(n=>({...n,[t]:[]})),A(n=>n.map(r=>r.id===t?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},Ia=()=>{if(f){wa(f),d("Cleared current chat.");return}const t={};S.forEach(n=>{t[n.id]=[]}),F(t),A(n=>n.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),d("Cleared all chats.")},Ta=t=>{if(t==="profile"){N&&ia(N);return}if(t==="close"){B(null),J(null),Le(!0),re(!1),ae(""),d("Chat closed.");return}if(t==="block"){if(!N)return;kt(N.id);return}if(t==="delete"){de(N?{title:`Delete chat with ${fe(N)}?`,message:"This removes the chat from your list.",onConfirm:()=>{X(),Ge(N.id)}}:{title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),Tt()}});return}if(t==="clear"){const n=N?`Clear chat with ${N.name}?`:"Clear all chats?";va({title:n,message:N?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{Je(),Ia()}});return}t==="report"&&N&&Ze(N)},Aa=()=>{re(t=>{const n=!t;return n||ae(""),n})},xa=async(t,n)=>{if(n==="archive"){await fa(t,{clearActive:!0,toast:!0});return}if(n==="unarchive"){await Ct(t,{clearActive:z,toast:!0});return}if(n==="delete"){const r=S.find(o=>o.id===t);de({title:r?`Delete chat with ${fe(r)}?`:"Delete chat?",message:"This removes the chat from your list.",onConfirm:()=>{X(),Ge(t)}});return}if(n==="report"){const r=S.find(o=>o.id===t);Ze(r)}},Ba=t=>{ua(t)},z=u==="archive",At=u==="block",xt=u==="profile",Bt=u==="reports",Xe=!!j,Pt=Xe||xt||At||Bt,Pa=je;return m.useEffect(()=>{if(!z||rt)return;if(ye.length===0){B(null);return}const t=S.find(n=>n.id===f);t&&!t.archived&&B(null)},[z,ye,S,f,rt]),m.useEffect(()=>{if(z)return;const t=S.find(n=>n.id===f);t&&t.archived&&B(null)},[z,S,f,Te]),m.useEffect(()=>{if(!I||u!=="block")return;let t=!1;return(async()=>{try{const n=await La({sessionId:P,sessionCsrf:R});t||Ne(n)}catch{}})(),()=>{t=!0}},[I,u,P,R]),m.useEffect(()=>{if(!I||u!=="reports")return;let t=!1;return(async()=>{try{const n=await Rt({sessionId:P,sessionCsrf:R});t||Oe(n)}catch{}})(),()=>{t=!0}},[I,u,P,R]),m.useEffect(()=>{if(!Ue||!(Q!=null&&Q.id))return;const t=Me.find(n=>n.id===Q.id);if(!t){St();return}$e(t)},[Ue,Q==null?void 0:Q.id,Me]),e.createElement("div",{className:"desktop-stage"},e.createElement("div",{className:"desktop-window"},e.createElement("div",{className:`desktop-content chp-desktop${Xe?" preview-only":Pt?" section-only":""}`},Xe?null:e.createElement("aside",{className:"icon-rail"},e.createElement("nav",{className:"rail-nav","aria-label":"Primary"},[{key:"home",label:"Home",icon:vn},{key:"chats",label:"Chats",icon:mn},{key:"archive",label:"Archive",icon:gn},{key:"block",label:"Block",icon:pe},{key:"reports",label:"Reports",icon:zt},{key:"profile",label:"Profile",icon:En}].map(t=>{const n=t.icon;return e.createElement("button",{key:t.key,className:`rail-btn ${u===t.key?"active":""}`,type:"button",onClick:()=>{if(x(t.key),t.key==="home"){window.location.href="homepage.html";return}},"aria-label":t.label},e.createElement("span",{className:"rail-icon"},e.createElement(n,null)),e.createElement("span",null,t.label))})),e.createElement("div",{className:"rail-footer"},e.createElement("button",{className:`rail-btn danger ${u==="logout"?"active":""}`,type:"button",onClick:()=>{x("logout"),de({title:"Log out?",message:"Are you sure you want to log out?",confirmLabel:"Log out",onConfirm:()=>{X(),Ut(),He({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),pt({...le,...i}),d("Logged out.")}})},"aria-label":"Logout"},e.createElement("span",{className:"rail-icon"},e.createElement(bn,null)),e.createElement("span",null,"Logout")))),Pt?null:e.createElement("aside",{className:"sidebar"},z?e.createElement(e.Fragment,null,e.createElement("div",{className:"archive-heading"},e.createElement("h2",null,"Achieved Chats")),e.createElement("div",{className:"archive-description muted"},"Archived conversations stored here.")):e.createElement("div",{className:"sidebar-header"},e.createElement("div",{className:"sidebar-title"},e.createElement("div",{className:"sidebar-brand"},e.createElement("img",{src:Ma,alt:"CompareHubPrices"}))),e.createElement("div",{className:"sidebar-actions-row"},e.createElement("button",{className:"icon-btn",type:"button","aria-label":"Delete all chats",onClick:()=>{de({title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),Tt()}})}},e.createElement(Yt,null)))),e.createElement(Pn,{chats:z?ta:aa,searchValue:V,onSearchChange:ve,activeChatId:f,onOpenChat:t=>Ea(t,{keepSection:z}),onMenuAction:xa,emptyTitle:z?"No archived chats":void 0,emptySubtitle:z?"Archived conversations will appear here.":void 0,showSearch:!z})),e.createElement("section",{className:"chat-panel"},xt?e.createElement(In,{currentUser:ft}):At?e.createElement(Tn,{chats:ea,onUnblock:Ba}):Bt?e.createElement(An,{reports:Me,onOpenReport:pa}):e.createElement($n,{chat:_,groupedMessages:na,searchValue:te,showSearch:Re,onToggleSearch:Aa,onSearchChange:ae,onSend:ba,composerValue:oe,onComposerChange:ne,onEmoji:ya,onAttach:Ca,emojiOpen:De,onEmojiSelect:ka,onEmojiClose:Na,composerRef:Ee,typing:st,conversationLoading:sa,messageListRef:gt,matchCount:qe.length,onMenuAction:Ta,attachmentPreview:j,onOpenAttachmentPreview:la,onCloseAttachmentPreview:ra,onSaveAttachmentPreview:oa,onReportAttachmentPreview:ca})))),Pa?e.createElement(wn,null):null,e.createElement(Cn,{open:Kt,onClose:()=>Zt(!1),currentUser:ft}),e.createElement(Sn,{open:Jt,onClose:Ke,chat:Y,onDelete:()=>{Y&&de({title:`Delete chat with ${fe(Y)}?`,message:"This removes the chat from your list.",onConfirm:async()=>{X(),await Ge(Y.id)&&Ke()}})},onBlock:()=>{(async()=>{if(!Y)return;(Y.blocked?await da(Y.id):await kt(Y.id))&&Ke()})()},onReport:()=>{Y&&Ze(Y)}}),e.createElement(xn,{open:Ue,report:Q,onClose:St}),e.createElement(Bn,{open:Qt,onClose:wt,reasons:Ot,value:ke,onChange:Ce,details:dt,onDetailsChange:Se,onSubmit:ha,targetName:ce==null?void 0:ce.name}),e.createElement(kn,{open:ie.open,title:ie.title,message:ie.message,confirmLabel:ie.confirmLabel,onConfirm:()=>{ie.onConfirm?ie.onConfirm():X()},onCancel:X}),e.createElement(Nn,{open:me.open,title:me.title,message:me.message,confirmLabel:me.confirmLabel,onConfirm:()=>{me.onConfirm?me.onConfirm():Je()},onCancel:Je}),e.createElement("input",{ref:We,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:Sa,style:{display:"none"}}))}const _n=Ka(document.getElementById("root"));_n.render(e.createElement(e.StrictMode,null,e.createElement(Fn,null)));
