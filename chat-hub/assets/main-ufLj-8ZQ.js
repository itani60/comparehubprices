import{r as m,f as Tn,a as wt,R as e,l as Bn,g as An,b as xn,m as Mn,s as Dn,c as St,d as Rn,e as Pn,h as Ln,i as jn,u as On,j as It,k as $n,n as Un,o as Fn,p as Tt,q as _n}from"./emojiSearch-D0DrxmU_.js";const he={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Vn=[],Hn={},Bt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}],At="chp_recent_emojis",De=[{id:"recent",name:"Recent",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',emojis:["ğŸ˜‚","â¤ï¸","ğŸ‘","ğŸ”¥","ğŸ˜Š","ğŸ™","ğŸ¥º","ğŸ¤£"]},{id:"smileys",name:"Smileys & Emotion",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',emojis:["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ˜‰","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ˜","ğŸ˜’","ğŸ˜”","ğŸ™","ğŸ˜¢","ğŸ˜­","ğŸ˜ ","ğŸ˜¡","ğŸ˜³","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ¤—","ğŸ¤”","ğŸ™„","ğŸ¤­","ğŸ¤¯","ğŸ¥´","ğŸ¤ "]},{id:"people",name:"People & Body",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v10"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>',emojis:["ğŸ‘‹","ğŸ¤š","âœ‹","ğŸ‘Œ","âœŒï¸","ğŸ¤Ÿ","ğŸ¤˜","ğŸ¤™","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","ğŸ‘","ğŸ‘","ğŸ‘Š","ğŸ‘","ğŸ™Œ","ğŸ™","âœï¸","ğŸ’ª","ğŸ§ ","ğŸ‘€","ğŸ‘¶","ğŸ‘¦","ğŸ‘§","ğŸ‘¨","ğŸ‘©","ğŸ‘´","ğŸ‘µ","ğŸ‘®"]},{id:"nature",name:"Animals & Nature",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>',emojis:["ğŸ¶","ğŸ±","ğŸ­","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ§","ğŸ¦†","ğŸŠ","ğŸ¢","ğŸ³","ğŸŸ","ğŸ™","ğŸ’","ğŸŒ¸","ğŸŒ¹","ğŸŒº","ğŸŒ»","ğŸŒ·","ğŸŒ±","ğŸŒ²","ğŸŒ´","ğŸ"]},{id:"food",name:"Food & Drink",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20"></path><path d="M15 3v10"></path><path d="M15 17v5"></path><path d="M15 3c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M15 17c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M9 3v10"></path><path d="M9 17v5"></path><path d="M9 3c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path><path d="M9 17c-1.1 0-2 .9-2 2h0c0 1.1.9 2 2 2h0c1.1 0 2-.9 2-2h0c0-1.1-.9-2-2-2Z"></path></svg>',emojis:["ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥•","ğŸ„","ğŸ","ğŸ¥–","ğŸ§€","ğŸ”","ğŸŸ","ğŸ•","ğŸŒ­","ğŸŒ®","ğŸŒ¯","ğŸ³","ğŸš","ğŸ","ğŸ£","ğŸ¦","ğŸ©","â˜•"]},{id:"travel",name:"Travel & Places",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',emojis:["ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš“","ğŸš‘","ğŸš’","ğŸšš","ğŸš²","âœˆï¸","ğŸš€","â›µ","ğŸš¢","â›½","ğŸš§","ğŸ—ºï¸","ğŸ—½","ğŸ°","ğŸ¡","ğŸ–ï¸","ğŸ ","ğŸ¢","ğŸ¥","ğŸª","ğŸ­","ğŸŒ†","ğŸŒƒ","ğŸŒ","ğŸŒŒ","ğŸŒˆ"]},{id:"symbols",name:"Symbols",icon:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 12h2"></path><path d="M12 11v2"></path><circle cx="12" cy="12" r="10"></circle></svg>',emojis:["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’—","ğŸ’–","âœï¸","â˜ªï¸","ğŸ”¯","â™ˆ","â™‰","â™“","âŒ","â­•","â›”","ğŸ’¯","â—","â“","â€¼ï¸","âš ï¸","âœ…","â™»ï¸","ğŸ’¤","â™¿"]}];function zn(){if(typeof document>"u")return null;const t=xt("standard_session_id"),s=xt("standard_csrf_token");return!t||!s?null:{sessionId:t,sessionCsrf:s}}function Kn(){typeof document>"u"||(Mt("standard_session_id"),Mt("standard_csrf_token"))}function xt(t){var s,l;if(!t||typeof document>"u")return"";try{const v=`; ${document.cookie}`.split(`; ${t}=`);if(v.length!==2)return"";const E=((l=(s=v.pop())==null?void 0:s.split(";").shift())==null?void 0:l.trim())||"";if(!E)return"";try{return decodeURIComponent(E).trim()}catch{return E}}catch{return""}}function Mt(t){var l;const s=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Lax${s}`}function Yn(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||"");return{conversationId:(t.get("conversationId")||"").trim(),recipientId:(t.get("recipientId")||"").trim(),recipientName:(t.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function Zn(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function pe(t){if(!t)return"";const s=t.split(" ").filter(Boolean),l=s[0]?s[0][0]:"",i=s.length>1?s[s.length-1][0]:"";return(l+i).toUpperCase()}function ne(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function Q(t){return!!(t&&(t.blocked||t.blockedByOther))}function Rt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Pt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Je(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Lt(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function jt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function Dt(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function Wn(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const l=new Date,i=new Date;return i.setDate(l.getDate()-1),Dt(s,l)?"Today":Dt(s,i)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function qn(t){const s=[];let l="";return t.forEach(i=>{const v=i.timestamp.slice(0,10);v!==l&&(s.push({type:"day",id:`day-${v}`,label:Wn(i.timestamp)}),l=v),s.push({type:"message",id:i.id,message:i})}),s}function Jn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Qn(t,s){if(!s)return t;const l=Jn(s);return t.split(new RegExp(`(${l})`,"ig")).map((v,E)=>v.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:E,className:"msg-highlight"},v):e.createElement("span",{key:E},v))}function Gn(t,s,l){const i=(l==null?void 0:l.selectionStart)??t.length,v=(l==null?void 0:l.selectionEnd)??i;return{nextValue:t.slice(0,i)+s+t.slice(v),caret:i+s.length}}function Ge(t,s,l){m.useEffect(()=>{if(!l)return;const i=v=>{!t.current||t.current.contains(v.target)||s()};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[t,s,l])}function j({children:t,size:s=20,className:l}){return e.createElement("svg",{className:l,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const Xn=t=>e.createElement(j,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Xe=t=>e.createElement(j,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Ot=t=>e.createElement(j,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),ea=t=>e.createElement(j,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),ta=t=>e.createElement(j,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),na=t=>e.createElement(j,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),aa=t=>e.createElement(j,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),sa=t=>e.createElement(j,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),ra=t=>e.createElement(j,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),la=t=>e.createElement(j,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),oa=t=>e.createElement(j,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),ca=t=>e.createElement(j,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),oe=t=>e.createElement(j,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),ia=t=>e.createElement(j,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),ma=t=>e.createElement(j,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),$t=t=>e.createElement(j,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function et({ariaLabel:t,items:s}){const[l,i]=m.useState(!1),v=m.useRef(null);return Ge(v,()=>i(!1),l),e.createElement("div",{className:"menu-wrap",ref:v},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>i(E=>!E),type:"button"},e.createElement(Xn,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},s.map(E=>e.createElement("button",{key:E.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{i(!1),E.onSelect()}},E.label))):null)}function da({status:t}){if(!t)return null;if(t==="sent")return e.createElement(aa,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(sa,{className:s})}function ua({open:t,title:s,message:l,confirmLabel:i,onConfirm:v,onCancel:E}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:E},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:v},i)))):null}function fa({open:t,onClose:s,reasons:l,value:i,onChange:v,details:E,onDetailsChange:f,onSubmit:x,targetName:g}){const[k,y]=m.useState(!1),O=m.useRef(null),R=l.find(d=>d.value===i);return Ge(O,()=>y(!1),k),m.useEffect(()=>{t||y(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",g||"this chat","."),e.createElement("div",{className:`report-select${k?" active":""}`,ref:O},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>y(d=>!d),"aria-haspopup":"listbox","aria-expanded":k},e.createElement("span",null,R?R.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(d=>e.createElement("button",{key:d.value,type:"button",className:`report-select__option${i===d.value?" selected":""}`,onClick:()=>{v(d.value),y(!1)},role:"option","aria-selected":i===d.value},d.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:E,onChange:d=>f(d.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:x,disabled:!i},"Report")))):null}function ha({chat:t,onClose:s,onDelete:l,onBlock:i,onReport:v}){if(!t)return null;const E=!!t.blockedByOther,f=ne(t),x=t.name?t.name.split(" ").filter(Boolean):[],g=x[0]||"",k=x.slice(1).join(" "),y=E?"-":t.firstName||g||"-",O=E?"-":t.lastName||k||"-",R=E?"-":t.suburb||"-",d=E?"-":t.city||"-",P=E?"-":t.province||"-",u=E?"-":t.accountSince||"-",N=E?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(Ot,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:t.color}},Q(t)?e.createElement(oe,{className:"avatar-blocked-icon",size:18}):pe(f)),e.createElement("div",null,e.createElement("h3",null,f))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",y),e.createElement("p",null,"Family name: ",O),e.createElement("p",null,"Suburb: ",R),e.createElement("p",null,"City: ",d),e.createElement("p",null,"Province: ",P),e.createElement("p",null,"Account since: ",u),e.createElement("p",null,"Account type: ",N)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:l},e.createElement(ma,null),"Delete"),E?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:i},e.createElement(oe,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:v},e.createElement(ca,null),"Report"))))))}function Re({title:t,subtitle:s,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},l))}function pa({currentUser:t}){const s={...he,...t&&typeof t=="object"?t:{}},l=s.name||"User";return e.createElement(Re,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},pe(l)),e.createElement("div",null,e.createElement("h3",null,l),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function va({chats:t,onOpenChat:s,onUnarchive:l}){return e.createElement(Re,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(i=>{const v=ne(i);return e.createElement("div",{key:i.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:i.color}},Q(i)?e.createElement(oe,{className:"avatar-blocked-icon",size:16}):pe(i.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},v),e.createElement("div",{className:"section-item-sub"},i.lastMessage?i.lastMessage:"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,Pt(i.archivedAt||i.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(i.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>l(i.id)},"Unarchive"))))})))}function Ea({chats:t,onUnblock:s}){return e.createElement(Re,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(oe,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,Pt(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l.id)},"Unblock"))))))}function ga({reports:t,onOpenReport:s}){return e.createElement(Re,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b82f6"}},pe(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${jt(l.status)}`},Lt(l.status)),e.createElement("span",null,Je(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(l)},"View report"))))))}function ba({open:t,report:s,onClose:l}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement($t,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${jt(s.status)}`},Lt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Je(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Je(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Qe({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function ya(){const t=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((l,i)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((l,i)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function Na({chats:t,searchValue:s,onSearchChange:l,activeChatId:i,onOpenChat:v,onChatAction:E}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(Xe,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:f=>l(f.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Qe,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(f=>{const x=ne(f);return e.createElement("div",{key:f.id,className:`chat-item ${i===f.id?"active":""}`,onClick:()=>v(f.id),onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),v(f.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${x}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:f.color}},Q(f)?e.createElement(oe,{className:"avatar-blocked-icon",size:16}):pe(f.name)),f.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},x),e.createElement("span",{className:"chat-time"},Rt(f.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},f.lastMessage?f.lastMessage:"No messages yet"),f.unread>0?e.createElement("span",{className:"chat-unread"},f.unread):null)),e.createElement("div",{className:"chat-actions",onClick:g=>g.stopPropagation(),onKeyDown:g=>g.stopPropagation()},e.createElement(et,{ariaLabel:`More options for ${x}`,items:[{label:"Delete chat",onSelect:()=>E(f.id,"delete")},{label:"Report",onSelect:()=>E(f.id,"report")},{label:"Archive",onSelect:()=>E(f.id,"archive")}]})))})))}function ka({message:t,query:s,onPreviewImage:l}){const i=t.sender==="me",v=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",E=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",f=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",x=!!t.attachmentIsImage||E.startsWith("image/"),g=!!t.attachmentIsVideo||E.startsWith("video/"),k=typeof t.text=="string"&&t.text.trim().length>0,y={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:k?"8px":"0"};return e.createElement("div",{className:`message-row ${i?"me":"them"}`},e.createElement("div",{className:`message-bubble ${i?"outgoing":"incoming"}`},v?e.createElement("div",{className:"message-attachment"},x?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${f}`},e.createElement("img",{src:v,alt:f,loading:"lazy",style:y})):g?e.createElement("video",{controls:!0,preload:"metadata",style:y},e.createElement("source",{src:v,type:E||void 0})):e.createElement("a",{href:v,target:"_blank",rel:"noreferrer"},"Open attachment")):null,k?e.createElement("div",{className:"message-text"},Qn(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Rt(t.timestamp)),i?e.createElement(da,{status:t.status}):null)))}function Ca({preview:t,onClose:s,onSave:l,onReport:i}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement($t,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:i},"Report Photo"))):null}function wa(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function Sa(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function Ia({value:t,onChange:s,onSend:l,onEmoji:i,onAttach:v,inputRef:E,disabled:f=!1}){m.useEffect(()=>{const g=E==null?void 0:E.current;g&&(g.style.height="auto",g.style.height=`${Math.min(g.scrollHeight,120)}px`)},[t,E]);const x=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),!f&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("div",{className:"composer-actions"},e.createElement("button",{className:"icon-btn",type:"button",onClick:i,"aria-label":"Emoji",disabled:f},e.createElement(ta,null)),e.createElement("button",{className:"icon-btn",type:"button",onClick:v,"aria-label":"Attach",disabled:f},e.createElement(na,null))),e.createElement("textarea",{ref:E,rows:1,value:t,onChange:g=>s(g.target.value),onKeyDown:x,placeholder:f?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:f}),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:f||!t.trim(),"aria-label":"Send message"},e.createElement(ea,null)))}function Ta({open:t,recents:s,onSelect:l,onClose:i}){const[v,E]=m.useState(""),[f,x]=m.useState("recent"),g=m.useRef(null),k=m.useRef(null),y=m.useRef({});Ge(k,i,t);const O=m.useMemo(()=>{const u=De.map(N=>N.id==="recent"?{...N,emojis:s}:N);return Un(u,v)},[s,v]);m.useEffect(()=>{var N;if(!t)return;const u=((N=O[0])==null?void 0:N.id)||"recent";x(u),g.current&&(g.current.scrollTop=0)},[t,v,O]);const R=()=>{const u=g.current;if(!u)return;let N=f;O.forEach(H=>{const q=y.current[H.id];q&&u.scrollTop>=q.offsetTop-40&&(N=H.id)}),N!==f&&x(N)},d=u=>{const N=y.current[u];N&&(N.scrollIntoView({behavior:"smooth",block:"start"}),x(u))},P=u=>{l(u)};return t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker fade-in",ref:k},e.createElement("div",{className:"picker-header"},e.createElement("div",{className:"search-container"},e.createElement(Xe,{className:"search-icon"}),e.createElement("input",{type:"search",className:"search-input",placeholder:"Search emojis...",value:v,onChange:u=>E(u.target.value),"aria-label":"Search emojis"})),e.createElement("div",{className:"category-tabs",role:"tablist"},O.map(u=>e.createElement("button",{key:u.id,type:"button",className:`category-tab ${f===u.id?"active":""}`,onClick:()=>d(u.id),"aria-label":u.name,"aria-pressed":f===u.id,dangerouslySetInnerHTML:{__html:u.icon}})))),e.createElement("div",{className:"emoji-list",onScroll:R,ref:g},O.length===0?e.createElement("div",{className:"emoji-empty"},"No emojis found."):O.map(u=>e.createElement("div",{key:u.id,className:"category-section",ref:N=>{y.current[u.id]=N}},e.createElement("div",{className:"category-title"},u.name),e.createElement("div",{className:"emoji-grid"},u.emojis.map((N,H)=>e.createElement("button",{key:`${u.id}-${H}`,type:"button",className:"emoji-item",onClick:()=>P(N),"aria-label":"Emoji"},N)))))))):null}function Ba({chat:t,groupedMessages:s,searchValue:l,showSearch:i,onToggleSearch:v,onSearchChange:E,onBack:f,onSend:x,composerValue:g,onComposerChange:k,onEmoji:y,onAttach:O,emojiOpen:R,emojiRecents:d,onEmojiSelect:P,onEmojiClose:u,composerRef:N,typing:H,conversationLoading:q,messageListRef:ae,matchCount:G,onMenuAction:X,attachmentPreview:se,onOpenAttachmentPreview:ce,onCloseAttachmentPreview:ie,onSaveAttachmentPreview:Pe,onReportAttachmentPreview:me}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Qe,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(se)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(Ca,{preview:se,onClose:ie,onSave:Pe,onReport:me}));const ve=ne(t),ye=!!t.launchPending,Ne=ye?[{label:"Close chat",onSelect:()=>X("close")}]:[{label:"View profile",onSelect:()=>X("profile")},{label:"Close chat",onSelect:()=>X("close")},{label:"Delete chat",onSelect:()=>X("delete")},{label:"Block",onSelect:()=>X("block")},{label:"Report",onSelect:()=>X("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:f,"aria-label":"Back to chats"},e.createElement(Ot,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},Q(t)?e.createElement(oe,{className:"avatar-blocked-icon",size:16}):pe(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},ve),e.createElement("div",{className:"conversation-status"},ye?e.createElement("span",null,"Start conversation"):H?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(et,{ariaLabel:"Conversation menu",items:Ne}))),i?e.createElement("div",{className:"conversation-search"},e.createElement(Xe,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:U=>E(U.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},G," match",G===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:ae},q?e.createElement(Sa,null):s.length===0?e.createElement(Qe,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):s.map(U=>U.type==="day"?e.createElement("div",{key:U.id,className:"day-separator"},U.label):e.createElement(ka,{key:U.id,message:U.message,query:l.trim(),onPreviewImage:ce})),H&&!l&&!q?e.createElement(wa,null):null,!q&&Q(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(Ia,{value:g,onChange:k,onSend:x,onEmoji:y,onAttach:O,inputRef:N,disabled:Q(t)}),e.createElement(Ta,{open:R,recents:d,onSelect:P,onClose:u}))}function Aa({activeKey:t,onSelect:s}){const l=[{key:"home",label:"Home",icon:ra},{key:"archive",label:"Archive",icon:oa},{key:"chats",label:"Chats",icon:la},{key:"block",label:"Block",icon:oe},{key:"profile",label:"My Profile",icon:ia}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},l.map(i=>{const v=i.icon;return e.createElement("button",{key:i.key,className:`nav-btn ${t===i.key?"active":""}`,type:"button",onClick:()=>s(i.key),"aria-label":i.label},e.createElement("span",{className:"icon-box"},e.createElement(v,null)),e.createElement("span",null,i.label))}))}function xa({currentUser:t=he,initialChats:s=Vn,initialMessages:l=Hn}){const i={...he,...t&&typeof t=="object"?t:{}},v=Array.isArray(s)?s:[],E=l&&typeof l=="object"?l:{},f=m.useMemo(()=>Yn(),[]),x=!!(f.conversationId||f.recipientId),g=m.useRef(!x),[k,y]=m.useState(v),[O,R]=m.useState(E),[d,P]=m.useState(null),[u,N]=m.useState(f.recipientId?{id:f.recipientId,name:f.recipientName||"Business"}:null),[H,q]=m.useState(""),[ae,G]=m.useState(""),[X,se]=m.useState(!1),[ce,ie]=m.useState(""),[Pe,me]=m.useState(!1),[ve,ye]=m.useState(()=>{var n,a,r;if(typeof window>"u")return((n=De[0])==null?void 0:n.emojis)||[];try{const o=window.localStorage.getItem(At);return o?JSON.parse(o):((a=De[0])==null?void 0:a.emojis)||[]}catch{return((r=De[0])==null?void 0:r.emojis)||[]}}),[Ne,U]=m.useState(!1),[tt,nt]=m.useState(!1),[K,at]=m.useState(null),[st,ke]=m.useState([]),[Le,je]=m.useState([]),[Oe,rt]=m.useState(!1),[ee,$e]=m.useState(null),[Ut,Ue]=m.useState(!1),[Ce,we]=m.useState(""),[lt,Se]=m.useState(""),[de,Fe]=m.useState(null),[z,_e]=m.useState(null),[Da,ot]=m.useState(null),[ct,it]=m.useState(!1),[Ft,Ie]=m.useState(null),[Te,mt]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[_t,dt]=m.useState(i),[ue,ut]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[F,Be]=m.useState("chats"),ft=m.useRef(null),Ee=m.useRef(null),Ve=m.useRef(null),ge=m.useRef(null),re=m.useRef(null),te=m.useRef(null),L=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),M=Te.sessionId,D=Te.sessionCsrf,$=Te.userId,He=Te.realtimeToken,I=!!(M&&D&&$),T=k.find(n=>n.id===d)||null,Vt=m.useMemo(()=>Zn(u),[u]),_=T||Vt,Ht=m.useMemo(()=>k.filter(n=>n.archived),[k]),zt=m.useMemo(()=>{const n=new Map;return st.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[st]),ze=m.useMemo(()=>k.filter(n=>!n.archived),[k]),Kt=m.useMemo(()=>{const n=H.trim().toLowerCase();return n?ze.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):ze},[ze,H]),Ae=d?O[d]||[]:[],Ke=m.useMemo(()=>{const n=ae.trim().toLowerCase();return n?Ae.filter(a=>a.text.toLowerCase().includes(n)):Ae},[Ae,ae]),Yt=m.useMemo(()=>qn(Ke),[Ke]),Zt=!!(d&&Ft===d),ht=()=>{te.current&&(window.clearTimeout(te.current),te.current=null),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null)},xe=async(n,{force:a=!1}={})=>{const r=re.current;if(!r||!$)return;const o=!!n,c=Date.now(),p=L.current;if(!(!a&&p.lastValue===o&&c-p.lastSentAt<600)){p.lastValue=o,p.lastSentAt=c;try{await r.send({type:"broadcast",event:"typing",payload:{isTyping:o,userId:String($)}})}catch{}}};m.useEffect(()=>{let n=!1;return(async()=>{if(!d||!$||!He||!I){U(!1);return}try{const r=await An();if(!r||n)return;r.realtime.setAuth(He);const o=re.current;if(o)try{await o.unsubscribe()}catch{}re.current=null,ht(),L.current.lastValue=!1;const c=r.channel(`conversation:${d}`,{config:{presence:{key:`chat:${String($)}`}}});c.on("broadcast",{event:"typing"},({payload:p})=>{const w=String((p==null?void 0:p.userId)||"");if(!w||w===String($))return;const b=!!(p!=null&&p.isTyping);U(b),te.current&&(window.clearTimeout(te.current),te.current=null),b&&(te.current=window.setTimeout(()=>{U(!1),te.current=null},3e3))}),c.subscribe(async p=>{if(!(n||p!=="SUBSCRIBED"))try{await c.track({userId:String($),at:new Date().toISOString()})}catch{}}),re.current=c}catch{n||U(!1)}})(),()=>{n=!0;const r=re.current;if(re.current=null,r)try{r.unsubscribe()}catch{}ht(),L.current.lastValue=!1,U(!1)}},[d,I,$,He]),m.useEffect(()=>{if(!d||!$||!re.current)return;const n=ce.trim().length>0,a=Date.now(),r=L.current;n!==r.lastValue&&a-r.lastSentAt>600&&xe(n,{force:!0}),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{L.current.idleTimer=null,xe(!1,{force:!0})},2e3))},[ce,d,$]),m.useEffect(()=>{if(!d||ae.trim())return;const n=ft.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[d,Ae.length,Ne,ae]),m.useEffect(()=>{d||me(!1)},[d]),m.useEffect(()=>{_e(null)},[d]),m.useEffect(()=>()=>{ge.current&&clearTimeout(ge.current)},[]),m.useEffect(()=>{if(!(typeof window>"u"))try{window.localStorage.setItem(At,JSON.stringify(ve))}catch{}},[ve]),m.useEffect(()=>{(!d||!I)&&Ie(null)},[d,I]);const h=n=>{ot(n),ge.current&&clearTimeout(ge.current),ge.current=setTimeout(()=>ot(null),2400)},Wt=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",o=!!n.attachmentIsImage||r.startsWith("image/");if(!a||!o)return;const c=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";_e({url:a,name:c,messageId:typeof n.id=="string"?n.id:""})},qt=()=>{_e(null)},Jt=async()=>{if(!(z!=null&&z.url))return;const n=z.name||"photo";try{const a=await fetch(z.url);if(!a.ok)throw new Error("download_failed");const r=await a.blob(),o=window.URL.createObjectURL(r),c=document.createElement("a");c.href=o,c.download=n,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(o),h("Image saved.")}catch{const a=document.createElement("a");a.href=z.url,a.target="_blank",a.rel="noreferrer",a.click(),h("Could not save directly. Opened image in a new tab.")}},Qt=()=>{if(!T){h("No chat selected.");return}Fe(T),we(""),Se(z!=null&&z.name?`Photo attachment: ${z.name}`:"Photo attachment"),Ue(!0)},Gt=()=>{if(!d&&!(u!=null&&u.id)){h("Select a chat to add emojis.");return}me(n=>!n)},Xt=()=>me(!1),en=n=>{n&&(ye(a=>[n,...a.filter(r=>r!==n)].slice(0,24)),ie(a=>{const{nextValue:r,caret:o}=Gn(a,n,Ee.current);return requestAnimationFrame(()=>{Ee.current&&(Ee.current.focus(),Ee.current.setSelectionRange(o,o))}),r}))};m.useEffect(()=>{if(!d||!I)return;let n=!1;Ie(d);const a=async({silent:o=!1}={})=>{try{const{messages:c,chatPatch:p}=await xn({sessionId:M,sessionCsrf:D,conversationId:d,currentUserId:$});if(n)return;R(w=>({...w,[d]:c})),y(w=>w.map(b=>b.id===d?{...b,...p||{},unread:0}:b));try{await Mn({sessionId:M,sessionCsrf:D,conversationId:d})}catch{}}catch(c){!n&&!o&&h((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{n||Ie(c=>c===d?null:c)}};a();const r=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[d,I,M,D,$]);const tn=n=>{n&&($e(n),rt(!0))},pt=()=>{rt(!1),$e(null)},Ye=n=>{n&&(Fe(n),we(""),Se(""),Ue(!0))},vt=()=>{Ue(!1),Fe(null),we(""),Se("")},nn=async()=>{var o;if(!de||!Ce)return;if(!I){h("Session missing or expired. Please log in again.");return}const n=((o=Bt.find(c=>c.value===Ce))==null?void 0:o.label)||Ce,a=lt.trim(),r=a?`${n} - ${a}`:n;try{await Rn({sessionId:M,sessionCsrf:D,conversationId:de.id,recipientId:de.otherPartyId,reason:r});try{const c=await wt({sessionId:M,sessionCsrf:D});je(c)}catch{}vt(),h("Report sent.")}catch(c){h((c==null?void 0:c.message)||"Failed to submit report.")}},le=({title:n,message:a,confirmLabel:r,onConfirm:o})=>{ut({open:!0,title:n,message:a,confirmLabel:r,onConfirm:o})},J=()=>{ut(n=>({...n,open:!1}))},an=async(n,a,r={})=>{const o=!!(r!=null&&r.silent);if(ct)return!1;const c=n.trim(),p=a.trim();if(!c||!p)return o||h("Session credentials missing. Please log in again."),!1;it(!0);try{const w=await Ln({sessionId:c,sessionCsrf:p}),{chats:b,blockedAccounts:C,reports:S,currentUser:A}=await jn({sessionId:c,sessionCsrf:p});mt({sessionId:c,sessionCsrf:p,userId:w.userId,realtimeToken:w.token||""}),dt(A?{...he,...A}:{...he,...i}),y(b),ke(C),R({}),je(S);let B=null,fe=null;if(!g.current){if(f.conversationId){const Y=b.find(Z=>Z.id===f.conversationId);Y&&(B=Y.id)}if(!B&&f.recipientId){const Y=b.find(Z=>Z.otherPartyId===f.recipientId);Y?B=Y.id:fe={id:f.recipientId,name:f.recipientName||"Business"}}g.current=!0}return N(fe),P(B),q(""),G(""),se(!1),Be("chats"),!o&&b.length===0?h("Connected. No chats found."):o||h(`Connected. Loaded ${b.length} chat${b.length===1?"":"s"}.`),!0}catch(w){return o||h((w==null?void 0:w.message)||"Failed to restore your session."),!1}finally{it(!1)}};m.useEffect(()=>{let n=!1;return(async()=>{if(I)return;const r=zn();if(!r){n||h("Session missing or expired. Please log in again.");return}await an(r.sessionId,r.sessionCsrf,{silent:!0})||n||h("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const Et=async(n,a={})=>{a.unarchive&&!await Nt(n,{clearActive:!1,toast:!0})||(P(n),N(null),me(!1),I&&Ie(n),y(r=>r.map(o=>o.id===n?{...o,unread:0}:o)),se(!1),G(""))},gt=(n,a,r)=>{R(o=>{const c=o[n]||[];return{...o,[n]:c.map(p=>p.id===a?{...p,status:r}:p)}})},sn=async()=>{const n=ce.trim(),a=d||"",r=a?"":(u==null?void 0:u.id)||"",o=(T==null?void 0:T.name)||(u==null?void 0:u.name)||f.recipientName||"Business",c=(T==null?void 0:T.color)||"#3b82f6";if(!n||!!!(a||r))return;if(Q(_)){h(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(I){try{const b=await Dn({sessionId:M,sessionCsrf:D,conversationId:a||void 0,recipientId:r||void 0,content:n}),C=St(b==null?void 0:b.data,$),S=(typeof C.chatId=="string"?C.chatId.trim():"")||a;if(!S)throw new Error("Failed to resolve conversation ID.");R(A=>({...A,[S]:[...A[S]||[],C]})),ie(""),y(A=>{const B=C.timestamp||new Date().toISOString();if(!A.find(V=>V.id===S))return[{id:S,name:o,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:C.text||n,lastTime:B,unread:0,online:!1,presence:"offline",color:c,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:r||(u==null?void 0:u.id)||""},...A];const Y=A.map(V=>V.id===S?{...V,lastMessage:C.text||n,lastTime:C.timestamp||B,unread:0}:V),Z=Y.find(V=>V.id===S),Me=Y.filter(V=>V.id!==S);return Z?[Z,...Me]:Y}),P(S),N(null),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null),L.current.lastValue=!1,xe(!1,{force:!0})}catch(b){h((b==null?void 0:b.message)||"Failed to send message.")}return}if(!a){h("Session missing or expired. Please log in again.");return}const w={id:`m-${Date.now()}`,chatId:a,sender:"me",text:n,timestamp:new Date().toISOString(),status:"sent"};R(b=>({...b,[a]:[...b[a]||[],w]})),ie(""),y(b=>{const C=b.map(B=>B.id===a?{...B,lastMessage:n,lastTime:w.timestamp,unread:0}:B),S=C.find(B=>B.id===a),A=C.filter(B=>B.id!==a);return S?[S,...A]:C}),setTimeout(()=>gt(a,w.id,"delivered"),900),setTimeout(()=>gt(a,w.id,"read"),2e3),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null),L.current.lastValue=!1,xe(!1,{force:!0})},rn=()=>{if(!d&&!(u!=null&&u.id)){h("Select a chat first.");return}if(!I){h("Session missing or expired. Please log in again.");return}if(Q(_)){h(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}Ve.current&&Ve.current.click()},ln=async n=>{var b;const a=n.target,r=(b=a==null?void 0:a.files)==null?void 0:b[0];if(a&&(a.value=""),!r)return;if(!d&&!(u!=null&&u.id)){h("Select a chat first.");return}if(!I){h("Session missing or expired. Please log in again.");return}if(Q(_)){h(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const o=d||"",c=o?"":(u==null?void 0:u.id)||"",p=(T==null?void 0:T.name)||(u==null?void 0:u.name)||f.recipientName||"Business",w=(T==null?void 0:T.color)||"#3b82f6";try{const C=await Pn({sessionId:M,sessionCsrf:D,conversationId:o||void 0,recipientId:c||void 0,file:r}),S=St(C==null?void 0:C.data,$),A=(typeof S.chatId=="string"?S.chatId.trim():"")||o;if(!A)throw new Error("Failed to resolve conversation ID.");R(B=>({...B,[A]:[...B[A]||[],S]})),y(B=>{const fe=S.timestamp||new Date().toISOString();if(!B.find(W=>W.id===A))return[{id:A,name:p,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:S.text||r.name,lastTime:fe,unread:0,online:!1,presence:"offline",color:w,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:c||(u==null?void 0:u.id)||""},...B];const Z=B.map(W=>W.id===A?{...W,lastMessage:S.text||r.name,lastTime:S.timestamp||fe,unread:0}:W),Me=Z.find(W=>W.id===A),V=Z.filter(W=>W.id!==A);return Me?[Me,...V]:Z}),P(A),N(null),h("Attachment sent.")}catch(C){h((C==null?void 0:C.message)||"Failed to send attachment.")}},on=n=>{R(a=>({...a,[n]:[]})),y(a=>a.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},cn=()=>{if(d){on(d),h("Cleared current chat.");return}const n={};k.forEach(a=>{n[a.id]=[]}),R(n),y(a=>a.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),h("Cleared all chats.")},Ze=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(y(r=>r.filter(o=>!a.has(o.id))),R(r=>{const o={...r};return a.forEach(c=>{delete o[c]}),o}),d&&a.has(d)&&P(null))},We=async(n,a={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const o=a.toast!==!1;if(I)try{await Tt({sessionId:M,sessionCsrf:D,conversationId:r})}catch(c){return h((c==null?void 0:c.message)||"Failed to delete chat."),!1}return Ze([r]),o&&h("Chat deleted."),!0},mn=async()=>{const n=k.map(o=>o.id).filter(Boolean);if(n.length===0)return h("No chats to delete."),!1;if(!I)return Ze(n),h("All chats deleted."),!0;const a=[];for(const o of n)try{await Tt({sessionId:M,sessionCsrf:D,conversationId:o}),a.push(o)}catch{}a.length>0&&Ze(a);const r=n.length-a.length;return a.length===0?(h("Failed to delete chats."),!1):r===0?(h("All chats deleted."),!0):(h(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${r} failed.`),!1)},dn=async()=>{if(d){await We(d);return}await mn()},un=(n,a)=>{const r=k.find(b=>b.id===n),o=(r==null?void 0:r.otherPartyId)||n;if(!o)return;const c=a||new Date().toISOString(),p=(r==null?void 0:r.name)||"Unknown",w=(r==null?void 0:r.color)||"#3b82f6";ke(b=>{const C=b.filter(S=>S.id!==o);return[{id:o,name:p,blockedAt:c,color:w},...C]})},bt=({accountId:n,conversationId:a=""})=>{const r=typeof n=="string"?n.trim():"",o=typeof a=="string"?a.trim():"";y(c=>c.map(p=>{const w=!!o&&p.id===o,b=!!r&&p.otherPartyId===r;if(!w&&!b)return p;const C=!!p.blockedByOther;return{...p,blocked:!1,blockedByMe:!1,hasBlockingRelationship:C,blockedAt:void 0}})),r&&ke(c=>c.filter(p=>p.id!==r))},yt=async n=>{if(!n)return!1;if(I)try{await Fn({sessionId:M,sessionCsrf:D,conversationId:n})}catch(r){return h((r==null?void 0:r.message)||"Failed to block account."),!1}const a=new Date().toISOString();return y(r=>r.map(o=>o.id===n?{...o,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:o)),un(n,a),d===n&&P(null),h("Chat blocked."),!0},fn=async n=>{if(!n)return!1;const a=k.find(o=>o.id===n),r=(a==null?void 0:a.otherPartyId)||"";if(I)try{await It({sessionId:M,sessionCsrf:D,conversationId:n||void 0,recipientId:r||void 0})}catch(o){return h((o==null?void 0:o.message)||"Failed to unblock account."),!1}return bt({accountId:r,conversationId:n}),h("Account unblocked."),!0},hn=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const r=k.find(c=>c.otherPartyId===a),o=(r==null?void 0:r.id)||"";if(I)try{await It({sessionId:M,sessionCsrf:D,conversationId:o||void 0,recipientId:a})}catch(c){return h((c==null?void 0:c.message)||"Failed to unblock account."),!1}return bt({accountId:a,conversationId:o}),h("Account unblocked."),!0},pn=async(n,a={})=>{if(!n)return!1;const r=a.clearActive!==!1,o=a.toast!==!1;if(I)try{await $n({sessionId:M,sessionCsrf:D,conversationId:n})}catch(c){return h((c==null?void 0:c.message)||"Failed to archive chat."),!1}return y(c=>c.map(p=>p.id===n?{...p,archived:!0,archivedAt:new Date().toISOString()}:p)),r&&d===n&&P(null),o&&h("Chat archived."),!0},Nt=async(n,a={})=>{if(!n)return!1;const r=a.clearActive===!0,o=a.toast!==!1;if(I)try{await On({sessionId:M,sessionCsrf:D,conversationId:n})}catch(c){return h((c==null?void 0:c.message)||"Failed to restore chat."),!1}return y(c=>c.map(p=>p.id===n?{...p,archived:!1,archivedAt:void 0}:p)),r&&d===n&&P(null),o&&h("Chat restored from archive."),!0},kt=n=>{if(n==="profile"){if(!d){h("No chat selected.");return}const a=k.find(r=>r.id===d)||null;at(a),nt(!0);return}if(n==="close"){P(null),N(null),se(!1),G(""),h("Chat closed.");return}if(n==="block"){if(!d)return;const a=k.find(o=>o.id===d),r=(a==null?void 0:a.id)||d;le({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{J(),await yt(r)}});return}if(n==="delete"){const a=T?`Delete chat with ${ne(T)}?`:"Delete all chats?";le({title:a,message:T?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{J(),dn()}});return}if(n==="clear"){const a=T?`Clear chat with ${T.name}?`:"Clear all chats?";le({title:a,message:T?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{J(),cn()}});return}n==="report"&&Ye(T)},vn=n=>{kt(n)},En=(n,a)=>{const r=k.find(o=>o.id===n);if(r){if(a==="delete"){le({title:`Delete chat with ${ne(r)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{J(),We(n)}});return}if(a==="report"){Ye(r);return}if(a==="archive"){pn(n,{clearActive:!0,toast:!0});return}}},gn=()=>{se(n=>{const a=!n;return a||G(""),a})},qe=()=>{nt(!1),at(null)},bn=()=>{K&&le({title:`Delete chat with ${ne(K)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{J(),(async()=>await We(K.id)&&qe())()}})},yn=()=>{if(!K)return;const n=K.id,a=!!K.blocked,r=ne(K);le({title:a?`Unblock ${r}?`:`Block ${r}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{J(),(a?await fn(n):await yt(n))&&qe()}})},Nn=()=>{K&&Ye(K)},kn=n=>{if(n==="home"){Be(n),window.location.href="homepage.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&P(null),Be(n);const a=n.charAt(0).toUpperCase()+n.slice(1);h(`${a} selected.`)},Cn=n=>{Nt(n,{clearActive:!1,toast:!0})},wn=n=>{hn(n)},Sn=[{label:"Delete chats",onSelect:()=>kt("delete")},{label:"Reports",onSelect:()=>Be("reports")},{label:"Logout",onSelect:()=>le({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{J(),Kn(),mt({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),dt({...he,...i}),h("Logged out.")}})}],be=!!(d||u!=null&&u.id||tt),Ct=be||F==="archive"||F==="block"||F==="profile"||F==="reports",In=ct;return m.useEffect(()=>{if(!I||F!=="block")return;let n=!1;return(async()=>{try{const a=await Tn({sessionId:M,sessionCsrf:D});n||ke(a)}catch{}})(),()=>{n=!0}},[I,F,M,D]),m.useEffect(()=>{if(!I||F!=="reports")return;let n=!1;return(async()=>{try{const a=await wt({sessionId:M,sessionCsrf:D});n||je(a)}catch{}})(),()=>{n=!0}},[I,F,M,D]),m.useEffect(()=>{if(!Oe||!(ee!=null&&ee.id))return;const n=Le.find(a=>a.id===ee.id);if(!n){pt();return}$e(n)},[Oe,ee==null?void 0:ee.id,Le]),e.createElement("div",{className:`chp-app${be?" chat-only":""}${Ct&&!be?" no-header":""}`},Ct?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:Bn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(et,{ariaLabel:"App menu",items:Sn}))),e.createElement("main",{className:"chp-main","data-view":be?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},F==="archive"?e.createElement(va,{chats:Ht,onOpenChat:Et,onUnarchive:Cn}):F==="block"?e.createElement(Ea,{chats:zt,onUnblock:wn}):F==="profile"?e.createElement(pa,{currentUser:_t}):F==="reports"?e.createElement(ga,{reports:Le,onOpenReport:tn}):e.createElement(Na,{chats:Kt,searchValue:H,onSearchChange:q,activeChatId:d,onOpenChat:Et,onChatAction:En})),e.createElement("section",{className:"chp-pane chp-convo-pane"},tt?e.createElement(ha,{chat:K,onClose:qe,onDelete:bn,onBlock:yn,onReport:Nn}):e.createElement(Ba,{chat:_,groupedMessages:Yt,searchValue:ae,showSearch:X,onToggleSearch:gn,onSearchChange:G,onBack:()=>{P(null),N(null)},onSend:sn,composerValue:ce,onComposerChange:ie,onEmoji:Gt,onAttach:rn,emojiOpen:Pe,emojiRecents:ve,onEmojiSelect:en,onEmojiClose:Xt,composerRef:Ee,typing:Ne,conversationLoading:Zt,messageListRef:ft,matchCount:Ke.length,onMenuAction:vn,attachmentPreview:z,onOpenAttachmentPreview:Wt,onCloseAttachmentPreview:qt,onSaveAttachmentPreview:Jt,onReportAttachmentPreview:Qt}))),be?null:e.createElement(Aa,{activeKey:F,onSelect:kn}),In?e.createElement(ya,null):null,e.createElement(ba,{open:Oe,report:ee,onClose:pt}),e.createElement(fa,{open:Ut,onClose:vt,reasons:Bt,value:Ce,onChange:we,details:lt,onDetailsChange:Se,onSubmit:nn,targetName:de==null?void 0:de.name}),e.createElement(ua,{open:ue.open,title:ue.title,message:ue.message,confirmLabel:ue.confirmLabel,onConfirm:()=>{ue.onConfirm?ue.onConfirm():J()},onCancel:J}),e.createElement("input",{ref:Ve,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:ln,style:{display:"none"}}))}const Ma=_n(document.getElementById("root"));Ma.render(e.createElement(e.StrictMode,null,e.createElement(xa,null)));
