import{$ as $n,r as m,h as On,i as Un,f as Fn,a as Dt,R as e,l as _n,g as jn,b as Vn,m as zn,s as Hn,c as Lt,j as Mt,q as Wn,d as Yn,e as qn,k as Kn,u as Gn,t as $t,n as Zn,o as Jn,p as zt,v as Qn}from"./64-Cp3-mV5r.js";typeof window<"u"&&!window.__comparehubEmojiMartInit&&($n({data:zt}),window.__comparehubEmojiMartInit=!0);const le={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Xn=[],ea={},Ot=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function ta(){if(typeof document>"u")return null;const t=Ft("business_session_id"),s=Ft("business_csrf_token");return console.log("[ChatDebug] readPersistedChatSession:",{hasSessionId:!!t,sessionIdPreview:t?t.slice(0,8)+"...":"(empty)",hasCsrf:!!s,csrfPreview:s?s.slice(0,8)+"...":"(empty)",allCookies:document.cookie?document.cookie.split(";").map(l=>l.trim().split("=")[0]):[]}),!t||!s?null:{sessionId:t,sessionCsrf:s}}function na(t,s){var h,g;if(console.log("[ChatDebug] persistChatSession called:",{hasSessionId:!!t,hasCsrf:!!s,protocol:typeof window<"u"?(h=window.location)==null?void 0:h.protocol:"unknown"}),typeof document>"u"||!t||!s)return;const l=typeof window<"u"&&((g=window.location)==null?void 0:g.protocol)==="https:"?"; Secure":"",i=12*60*60;document.cookie=`business_session_id=${encodeURIComponent(t)}; path=/; max-age=${i}; SameSite=Lax${l}`,document.cookie=`business_csrf_token=${encodeURIComponent(s)}; path=/; max-age=${i}; SameSite=Lax${l}`,console.log("[ChatDebug] persistChatSession done. Cookie names now:",document.cookie.split(";").map(v=>v.trim().split("=")[0]))}function Ut(){typeof document>"u"||(_t("business_session_id"),_t("business_csrf_token"))}function Ft(t){if(!t||typeof document>"u")return"";try{const s=String(document.cookie||"");if(!s)return"";const l=s.split(";");let i="";for(const h of l){const g=h.indexOf("=");if(g<=0||h.slice(0,g).trim()!==t)continue;const D=h.slice(g+1).trim();if(D)try{i=decodeURIComponent(D).trim()}catch{i=D.trim()}}return i}catch{return""}}function _t(t){var l;const s=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Lax${s}`}function aa(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||"");return{conversationId:(t.get("conversationId")||"").trim(),recipientId:(t.get("recipientId")||"").trim(),recipientName:(t.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function sa(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function he(t){if(!t)return"";const s=t.split(" ").filter(Boolean),l=s[0]?s[0][0]:"",i=s.length>1?s[s.length-1][0]:"";return(l+i).toUpperCase()}function fe(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function ee(t){return!!(t&&(t.blocked||t.blockedByOther))}function Ht(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function la(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function tt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Wt(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Yt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function jt(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function ra(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const l=new Date,i=new Date;return i.setDate(l.getDate()-1),jt(s,l)?"Today":jt(s,i)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function oa(t){const s=[];let l="";return t.forEach(i=>{const h=i.timestamp.slice(0,10);h!==l&&(s.push({type:"day",id:`day-${h}`,label:ra(i.timestamp)}),l=h),s.push({type:"message",id:i.id,message:i})}),s}function ca(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const Vt=typeof Intl<"u"&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"grapheme"}):null;function ia(t){return t?Vt?Array.from(Vt.segment(t),({segment:s})=>s):Array.from(t):[]}function ma(t){return t?new RegExp("^\\p{Regional_Indicator}{2}$","u").test(t)||/[0-9#*]\uFE0F?\u20E3/u.test(t)?!0:new RegExp("\\p{Extended_Pictographic}","u").test(t):!1}function Ne(t,s){return ia(t).map((l,i)=>ma(l)?e.createElement("em-emoji",{key:`${s}-emoji-${i}`,native:l,set:"apple",size:"1.05em"}):e.createElement(e.Fragment,{key:`${s}-text-${i}`},l))}function da(t,s){if(!s)return Ne(t,"msg");const l=ca(s);return t.split(new RegExp(`(${l})`,"ig")).map((h,g)=>h.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:g,className:"msg-highlight"},Ne(h,`mark-${g}`)):e.createElement(e.Fragment,{key:g},Ne(h,`part-${g}`)))}function ua(t,s,l){const i=(l==null?void 0:l.selectionStart)??t.length,h=(l==null?void 0:l.selectionEnd)??i;return{nextValue:t.slice(0,i)+s+t.slice(h),caret:i+s.length}}function at(t,s,l){m.useEffect(()=>{if(!l)return;const i=h=>{!t.current||t.current.contains(h.target)||s()};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[t,s,l])}function M({children:t,size:s=20,className:l}){return e.createElement("svg",{className:l,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const fa=t=>e.createElement(M,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),qt=t=>e.createElement(M,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),pa=t=>e.createElement(M,{...t},e.createElement("rect",{x:"5",y:"11",width:"14",height:"9",rx:"2"}),e.createElement("path",{d:"M8 11V8a4 4 0 0 1 8 0v3"})),ha=t=>e.createElement(M,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),va=t=>e.createElement(M,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),ga=t=>e.createElement(M,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),Ea=t=>e.createElement(M,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),ba=t=>e.createElement(M,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),ya=t=>e.createElement(M,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),Na=t=>e.createElement(M,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),ka=t=>e.createElement(M,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),Kt=t=>e.createElement(M,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),pe=t=>e.createElement(M,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Ca=t=>e.createElement(M,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),Gt=t=>e.createElement(M,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),Sa=t=>e.createElement(M,{...t},e.createElement("path",{d:"M9 4h-4v16h4"}),e.createElement("path",{d:"M16 12H7"}),e.createElement("path",{d:"M13 9l3 3-3 3"})),Pe=t=>e.createElement(M,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function Zt({ariaLabel:t,items:s}){const[l,i]=m.useState(!1),h=m.useRef(null);return at(h,()=>i(!1),l),e.createElement("div",{className:"menu-wrap",ref:h},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>i(g=>!g),type:"button"},e.createElement(fa,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},s.map(g=>e.createElement("button",{key:g.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{i(!1),g.onSelect()}},g.label))):null)}function wa({status:t}){if(!t)return null;if(t==="sent")return e.createElement(ba,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(ya,{className:s})}function Ia({open:t,title:s,message:l,confirmLabel:i,onConfirm:h,onCancel:g}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:g},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},i)))):null}function Ta({open:t,title:s,message:l,confirmLabel:i="Delete",onConfirm:h,onCancel:g}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:g},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},i)))):null}function Aa({open:t,onClose:s,currentUser:l}){if(!t)return null;const i={...le,...l&&typeof l=="object"?l:{}},h=i.name||"User";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Profile panel"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Pe,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#2f9e8f"}},he(h)),e.createElement("div",null,e.createElement("h3",null,h))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",i.firstName||"-"),e.createElement("p",null,"Family name: ",i.lastName||"-"),e.createElement("p",null,"Suburb: ",i.suburb||"-"),e.createElement("p",null,"City: ",i.city||"-"),e.createElement("p",null,"Province: ",i.province||"-"),e.createElement("p",null,"Account since: ",i.accountSince||"-"))))}function Ba({open:t,onClose:s,chat:l,onDelete:i,onBlock:h,onReport:g}){if(!t||!l)return null;const v=!!l.blockedByOther,D=fe(l),$=l.name?l.name.split(" ").filter(Boolean):[],f=$[0]||"",I=$.slice(1).join(" "),w=v?"-":l.firstName||f||"-",B=v?"-":l.lastName||I||"-",L=v?"-":l.suburb||"-",F=v?"-":l.city||"-",d=v?"-":l.province||"-",x=v?"-":l.accountSince||"-",C=v?"-":l.accountType||"Standard";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Chat profile"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Chat Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:s,type:"button"},e.createElement(Pe,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:l.color}},ee(l)?e.createElement(pe,{className:"avatar-blocked-icon",size:18}):he(D)),e.createElement("div",null,e.createElement("h3",null,D))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",w),e.createElement("p",null,"Family name: ",B),e.createElement("p",null,"Suburb: ",L),e.createElement("p",null,"City: ",F),e.createElement("p",null,"Province: ",d),e.createElement("p",null,"Account since: ",x),e.createElement("p",null,"Account type: ",C)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:i},e.createElement(Gt,null),"Delete"),v?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:h},e.createElement(pe,null),l.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:g},e.createElement(Kt,null),"Report"))))))}function nt({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function xa(){const t=Array.from({length:7}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay desktop",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-desktop-shell"},e.createElement("aside",{className:"chat-loading-desktop-sidebar"},e.createElement("div",{className:"chat-loading-desktop-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})),e.createElement("div",{className:"chat-loading-desktop-search"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-search-box"})),e.createElement("div",{className:"chat-loading-desktop-list"},t.map((l,i)=>e.createElement("div",{className:"chat-loading-desktop-thread",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-time"}))))),e.createElement("section",{className:"chat-loading-desktop-chat"},e.createElement("div",{className:"chat-loading-desktop-chat-header"},e.createElement("div",{className:"chat-loading-desktop-chat-user"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}))),e.createElement("div",{className:"chat-loading-desktop-chat-actions"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}))),e.createElement("div",{className:"chat-loading-desktop-messages"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-day"}),s.map((l,i)=>e.createElement("div",{className:`chat-loading-desktop-bubble-row ${i%2?"me":"them"}`,key:i},e.createElement("div",{className:"chat-loading-desktop-bubble"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-meta"}))))),e.createElement("div",{className:"chat-loading-desktop-composer"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-input"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})))))}function st({title:t,subtitle:s,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},l))}function Ra({currentUser:t}){const s={...le,...t&&typeof t=="object"?t:{}},l=s.name||"User";return e.createElement(st,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-card"},e.createElement("div",{className:"profile-card-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#0f766e"}},he(l)),e.createElement("div",null,e.createElement("h3",null,l))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function Pa({chats:t,onUnblock:s}){return e.createElement(st,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(pe,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,la(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l.id)},"Unblock"))))))}function Da({reports:t,onOpenReport:s}){return e.createElement(st,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b5bdb"}},he(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Yt(l.status)}`},Wt(l.status)),e.createElement("span",null,tt(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l)},"View report"))))))}function La({open:t,report:s,onClose:l}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(Pe,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Yt(s.status)}`},Wt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},tt(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},tt(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Ma({open:t,onClose:s,reasons:l,value:i,onChange:h,details:g,onDetailsChange:v,onSubmit:D,targetName:$}){const[f,I]=m.useState(!1),w=m.useRef(null),B=l.find(L=>L.value===i);return at(w,()=>I(!1),f),m.useEffect(()=>{t||I(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",$||"this chat","."),e.createElement("div",{className:`report-select${f?" active":""}`,ref:w},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>I(L=>!L),"aria-haspopup":"listbox","aria-expanded":f},e.createElement("span",null,B?B.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(L=>e.createElement("button",{key:L.value,type:"button",className:`report-select__option${i===L.value?" selected":""}`,onClick:()=>{h(L.value),I(!1)},role:"option","aria-selected":i===L.value},L.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:g,onChange:L=>v(L.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:D,disabled:!i},"Report")))):null}function $a({chats:t,searchValue:s,onSearchChange:l,activeChatId:i,onOpenChat:h,onMenuAction:g,emptyTitle:v="No chats yet",emptySubtitle:D="Start a new chat to compare prices.",showSearch:$=!0}){return e.createElement("div",{className:"chat-list-screen"},$?e.createElement("div",{className:"search-bar"},e.createElement(qt,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:f=>l(f.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})):null,e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(nt,{title:v,subtitle:D}):t.map(f=>{const I=fe(f),w=[{label:f.archived?"Unarchive chat":"Archive chat",onSelect:()=>g(f.id,f.archived?"unarchive":"archive")},{label:"Delete chat",onSelect:()=>g(f.id,"delete")},{label:"Report",onSelect:()=>g(f.id,"report")}];return e.createElement("div",{key:f.id,className:`chat-item ${i===f.id?"active":""}`,role:"listitem"},e.createElement("button",{className:"chat-open",onClick:()=>h(f.id),type:"button","aria-label":`Open chat with ${I}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:f.color}},ee(f)?e.createElement(pe,{className:"avatar-blocked-icon",size:16}):he(f.name)),f.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},I),e.createElement("span",{className:"chat-time"},Ht(f.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},f.lastMessage?Ne(f.lastMessage,`chat-last-${f.id}`):"No messages yet"),e.createElement("span",{className:"chat-flags"},f.unread>0?e.createElement("span",{className:"chat-unread"},f.unread):null)))),e.createElement(Zt,{ariaLabel:"Chat options",items:w}))})))}function Oa({message:t,query:s,onPreviewImage:l}){const i=t.sender==="me",h=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",g=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",v=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",D=!!t.attachmentIsImage||g.startsWith("image/"),$=!!t.attachmentIsVideo||g.startsWith("video/"),f=typeof t.text=="string"&&t.text.trim().length>0,I={width:"100%",maxWidth:"260px",borderRadius:"10px",display:"block",marginBottom:f?"8px":"0"};return e.createElement("div",{className:`message-row ${i?"me":"them"}`},e.createElement("div",{className:`message-bubble ${i?"outgoing":"incoming"}`},h?e.createElement("div",{className:"message-attachment"},D?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${v}`},e.createElement("img",{src:h,alt:v,loading:"lazy",style:I})):$?e.createElement("video",{controls:!0,preload:"metadata",style:I},e.createElement("source",{src:h,type:g||void 0})):e.createElement("a",{href:h,target:"_blank",rel:"noreferrer"},"Open attachment")):null,f?e.createElement("div",{className:"message-text"},da(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Ht(t.timestamp)),i?e.createElement(wa,{status:t.status}):null)))}function Ua({preview:t,onClose:s,onSave:l,onReport:i}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Pe,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:i},"Report Photo"))):null}function Fa(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function _a(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function ja({value:t,onChange:s,onSend:l,onEmoji:i,onAttach:h,inputRef:g,disabled:v=!1,emojiActive:D=!1}){const $=v?"Unblock to send messages":"Type a message",f=I=>{I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),!v&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${D?" emoji-toggle-active":""}`,type:"button",onClick:i,"aria-label":"Emoji",disabled:v},e.createElement(ga,null)),e.createElement("div",{className:"composer-input-wrap"},e.createElement("div",{className:`composer-render ${t?"has-value":""}`,"aria-hidden":"true"},t?Ne(t,"composer-input"):null),e.createElement("textarea",{ref:g,className:`composer-input-native ${t?"has-value":""}`,rows:1,value:t,onChange:I=>s(I.target.value),onKeyDown:f,placeholder:$,"aria-label":"Message input",disabled:v})),e.createElement("button",{className:"icon-btn",type:"button",onClick:h,"aria-label":"Attach",disabled:v},e.createElement(Ea,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:v||!t.trim(),"aria-label":"Send message"},e.createElement(va,null)))}function Va({open:t,onSelect:s,onClose:l}){const i=m.useRef(null);return at(i,l,t),t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:i},e.createElement(Zn,{data:zt,onEmojiSelect:s,theme:"light",set:"apple",getSpritesheetURL:()=>Jn,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiButtonRadius:"8px"}))):null}function za({chat:t,groupedMessages:s,searchValue:l,showSearch:i,onToggleSearch:h,onSearchChange:g,onSend:v,composerValue:D,onComposerChange:$,onEmoji:f,onAttach:I,emojiOpen:w,onEmojiSelect:B,onEmojiClose:L,composerRef:F,typing:d,conversationLoading:x,messageListRef:C,matchCount:Z,onMenuAction:j,attachmentPreview:ve,onOpenAttachmentPreview:te,onCloseAttachmentPreview:ne,onSaveAttachmentPreview:De,onReportAttachmentPreview:re}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(nt,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(ve)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(Ua,{preview:ve,onClose:ne,onSave:De,onReport:re}));const oe=fe(t),ae=!!t.launchPending,Le=ae?[{label:"Close chat",onSelect:()=>j("close")}]:[{label:"View profile",onSelect:()=>j("profile")},{label:"Close chat",onSelect:()=>j("close")},{label:"Delete chat",onSelect:()=>j("delete")},{label:"Block",onSelect:()=>j("block")},{label:"Report",onSelect:()=>j("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},ee(t)?e.createElement(pe,{className:"avatar-blocked-icon",size:16}):he(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},oe),e.createElement("div",{className:"conversation-status"},ae?e.createElement("span",null,"Start conversation"):d?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(Zt,{ariaLabel:"Conversation menu",items:Le}))),i?e.createElement("div",{className:"conversation-search"},e.createElement(qt,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:H=>g(H.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},Z," match",Z===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:C},e.createElement("div",{className:"security-banner"},e.createElement(pa,null),e.createElement("div",null,"Messages are end-to-end encrypted. No one outside of this chat can read or listen to them.")),x?e.createElement(_a,null):s.length===0?e.createElement(nt,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):s.map(H=>H.type==="day"?e.createElement("div",{key:H.id,className:"day-separator"},H.label):e.createElement(Oa,{key:H.id,message:H.message,query:l.trim(),onPreviewImage:te})),d&&!l&&!x?e.createElement(Fa,null):null,!x&&ee(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(ja,{value:D,onChange:$,onSend:v,onEmoji:f,onAttach:I,inputRef:F,disabled:ee(t),emojiActive:w}),e.createElement(Va,{open:w,onSelect:B,onClose:L}))}function Ha({currentUser:t=le,initialChats:s=Xn,initialMessages:l=ea}){const i={...le,...t&&typeof t=="object"?t:{}},h=Array.isArray(s)?s:[],g=l&&typeof l=="object"?l:{},v=m.useMemo(()=>aa(),[]),D=!!(v.conversationId||v.recipientId),$=m.useRef(!D),[f,I]=m.useState("chats"),[w,B]=m.useState(h),[L,F]=m.useState(g),[d,x]=m.useState(null),[C,Z]=m.useState(v.recipientId?{id:v.recipientId,name:v.recipientName||"Business"}:null),[j,ve]=m.useState(""),[te,ne]=m.useState(""),[De,re]=m.useState(!1),[oe,ae]=m.useState(""),[Le,H]=m.useState(!1),[lt,ge]=m.useState(!1),[Jt,Qt]=m.useState(!1),[Ya,rt]=m.useState(null),[ot,Me]=m.useState(!1),[Xt,ct]=m.useState(!1),[Y,it]=m.useState(null),[mt,ke]=m.useState([]),[$e,Oe]=m.useState([]),[Ue,dt]=m.useState(!1),[J,Fe]=m.useState(null),[en,_e]=m.useState(!1),[Ce,Se]=m.useState(""),[ut,we]=m.useState(""),[ce,je]=m.useState(null),[V,Ve]=m.useState(null),[ze,ft]=m.useState(!1),[tn,Ie]=m.useState(null),[Te,He]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[pt,ht]=m.useState(i),[ie,vt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Delete",onConfirm:null}),[me,gt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),Et=m.useRef(null),Ee=m.useRef(null),We=m.useRef(null),be=m.useRef(null),se=m.useRef(null),Q=m.useRef(null),O=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),Ye=m.useRef(!1),bt=m.useRef(null),R=Te.sessionId,P=Te.sessionCsrf,U=Te.userId,qe=Te.realtimeToken,A=!!(R&&P&&U),S=w.find(n=>n.id===d)||null,nn=m.useMemo(()=>sa(C),[C]),_=S||nn,Ae=m.useMemo(()=>w.filter(n=>!n.archived),[w]),ye=m.useMemo(()=>w.filter(n=>n.archived),[w]),an=m.useMemo(()=>{const n=new Map;return mt.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[mt]),sn=m.useMemo(()=>{const n=j.trim().toLowerCase();return n?ye.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):ye},[ye,j]),ln=m.useMemo(()=>{const n=j.trim().toLowerCase();return n?Ae.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):Ae},[Ae,j]),Be=d?L[d]||[]:[],Ke=m.useMemo(()=>{const n=te.trim().toLowerCase();return n?Be.filter(a=>a.text.toLowerCase().includes(n)):Be},[Be,te]),rn=m.useMemo(()=>oa(Ke),[Ke]),on=!!(d&&tn===d),yt=()=>{Q.current&&(window.clearTimeout(Q.current),Q.current=null),O.current.idleTimer&&(window.clearTimeout(O.current.idleTimer),O.current.idleTimer=null)},xe=async n=>{const a=se.current;if(!a||!U)return;const r=!!n,c=Date.now(),o=O.current;if(!(o.lastValue===r&&c-o.lastSentAt<600)){o.lastValue=r,o.lastSentAt=c;try{await a.send({type:"broadcast",event:"typing",payload:{isTyping:r,userId:String(U)}})}catch{}}};m.useEffect(()=>{let n=!1;return(async()=>{if(!d||!U||!qe||!A){ge(!1);return}try{const r=await jn();if(!r||n)return;r.realtime.setAuth(qe);const c=se.current;if(c)try{await c.unsubscribe()}catch{}se.current=null,yt(),O.current.lastValue=!1;const o=r.channel(`conversation:${d}`,{config:{presence:{key:`chat:${String(U)}`}}}),E=()=>{try{const b=typeof o.presenceState=="function"?o.presenceState():{};let p=!1;for(const y of Object.values(b||{})){const N=Array.isArray(y)?y:[y];for(const k of N){const T=String((k==null?void 0:k.userId)||(k==null?void 0:k.user_id)||"");if(T&&T!==String(U)){p=!0;break}}if(p)break}B(y=>y.map(N=>N.id!==d||N.hasBlockingRelationship||N.blockedByOther?N:p?{...N,online:!0,presence:"online"}:{...N,online:!1}))}catch{}};o.on("presence",{event:"sync"},E),o.on("presence",{event:"join"},E),o.on("presence",{event:"leave"},E),o.on("broadcast",{event:"typing"},({payload:b})=>{const p=String((b==null?void 0:b.userId)||"");if(!p||p===String(U))return;const y=!!(b!=null&&b.isTyping);ge(y),Q.current&&(window.clearTimeout(Q.current),Q.current=null),y&&(Q.current=window.setTimeout(()=>{ge(!1),Q.current=null},3e3))}),se.current=o,o.subscribe(async(b,p)=>{if(!n){if(b!=="SUBSCRIBED"){console.warn(`[ChatRealtime] Subscription status: ${b}`,p);return}console.log(`[ChatRealtime] Subscribed to conversation:${d}`);try{await o.track({userId:String(U),at:new Date().toISOString()}),E()}catch(y){console.error("[ChatRealtime] Presence track failed:",y)}}})}catch(r){console.error("[ChatRealtime] Setup failed:",r),n||ge(!1)}})(),()=>{n=!0;const r=se.current;if(se.current=null,r)try{r.unsubscribe()}catch{}yt(),O.current.lastValue=!1,ge(!1)}},[d,A,U,qe]),m.useEffect(()=>{if(!d||!U||!se.current)return;const n=oe.trim().length>0,a=Date.now(),r=O.current;n!==r.lastValue&&a-r.lastSentAt>600&&xe(n),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{O.current.idleTimer=null,xe(!1)},2e3))},[oe,d,U]),m.useEffect(()=>{if(!d||te.trim())return;const n=Et.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[d,Be.length,lt,te]),m.useEffect(()=>{d||H(!1)},[d]),m.useEffect(()=>{Ve(null)},[d]),m.useEffect(()=>{(!d||!A)&&Ie(null)},[d,A]),m.useEffect(()=>()=>{be.current&&clearTimeout(be.current)},[]);const u=n=>{rt(n),be.current&&clearTimeout(be.current),be.current=setTimeout(()=>rt(null),2400)},Nt=(n,a={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const r=!!(a!=null&&a.silent);return Ut(),He({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),x(null),Z(null),r||u("Session missing or expired. Please log in again."),!0},cn=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",c=!!n.attachmentIsImage||r.startsWith("image/");if(!a||!c)return;const o=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";Ve({url:a,name:o,messageId:typeof n.id=="string"?n.id:""})},mn=()=>{Ve(null)},dn=async()=>{if(!(V!=null&&V.url))return;const n=V.name||"photo";try{const a=await fetch(V.url);if(!a.ok)throw new Error("download_failed");const r=await a.blob(),c=window.URL.createObjectURL(r),o=document.createElement("a");o.href=c,o.download=n,document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(c),u("Image saved.")}catch{const a=document.createElement("a");a.href=V.url,a.target="_blank",a.rel="noreferrer",a.click(),u("Could not save directly. Opened image in a new tab.")}},un=()=>{if(!S){u("No chat selected.");return}je(S),Se(""),we(V!=null&&V.name?`Photo attachment: ${V.name}`:"Photo attachment"),_e(!0)};m.useEffect(()=>{if(!d||!A)return;let n=!1;Ie(d);const a=async({silent:c=!1}={})=>{try{const{messages:o,chatPatch:E}=await Vn({sessionId:R,sessionCsrf:P,conversationId:d,currentUserId:U});if(n)return;F(b=>{const p=b[d]||[],y=new Set(o.map(k=>k.id)),N=p.filter(k=>k.id&&k.id.startsWith("m-")&&!y.has(k.id));return{...b,[d]:[...o,...N]}}),B(b=>b.map(p=>p.id===d?{...p,...E||{},unread:0}:p));try{await zn({sessionId:R,sessionCsrf:P,conversationId:d})}catch{}}catch(o){if(!n&&Nt(o))return;!n&&!c&&u((o==null?void 0:o.message)||"Failed to load chat messages.")}finally{n||Ie(o=>o===d?null:o)}};a();const r=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[d,A,R,P,U]);const fn=n=>{if(!n){u("No chat selected.");return}it(n),ct(!0)},Ge=()=>{ct(!1),it(null)},pn=(n,a)=>{const r=w.find(p=>p.id===n),c=(r==null?void 0:r.otherPartyId)||n;if(!c)return;const o=a||new Date().toISOString(),E=(r==null?void 0:r.name)||"Unknown",b=(r==null?void 0:r.color)||"#3b82f6";ke(p=>{const y=p.filter(N=>N.id!==c);return[{id:c,name:E,blockedAt:o,color:b},...y]})},kt=({accountId:n,conversationId:a=""})=>{const r=typeof n=="string"?n.trim():"",c=typeof a=="string"?a.trim():"";B(o=>o.map(E=>{const b=!!c&&E.id===c,p=!!r&&E.otherPartyId===r;if(!b&&!p)return E;const y=!!E.blockedByOther;return{...E,blocked:!1,blockedByMe:!1,hasBlockingRelationship:y,blockedAt:void 0}})),r&&ke(o=>o.filter(E=>E.id!==r))},Ct=async n=>{if(!n)return!1;if(A)try{await Wn({sessionId:R,sessionCsrf:P,conversationId:n})}catch(r){return u((r==null?void 0:r.message)||"Failed to block account."),!1}const a=new Date().toISOString();return B(r=>r.map(c=>c.id===n?{...c,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:c)),pn(n,a),d===n&&x(null),u("Chat blocked."),!0},hn=async n=>{if(!n)return!1;const a=w.find(c=>c.id===n),r=(a==null?void 0:a.otherPartyId)||"";if(A)try{await Mt({sessionId:R,sessionCsrf:P,conversationId:n||void 0,recipientId:r||void 0})}catch(c){return u((c==null?void 0:c.message)||"Failed to unblock account."),!1}return kt({accountId:r,conversationId:n}),u("Account unblocked."),!0},vn=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const r=w.find(o=>o.otherPartyId===a),c=(r==null?void 0:r.id)||"";if(A)try{await Mt({sessionId:R,sessionCsrf:P,conversationId:c||void 0,recipientId:a})}catch(o){return u((o==null?void 0:o.message)||"Failed to unblock account."),!1}return kt({accountId:a,conversationId:c}),u("Account unblocked."),!0},gn=async(n,a={})=>{if(!n)return!1;const r=a.clearActive!==!1,c=a.toast!==!1;if(A)try{await Kn({sessionId:R,sessionCsrf:P,conversationId:n})}catch(o){return u((o==null?void 0:o.message)||"Failed to archive chat."),!1}return B(o=>o.map(E=>E.id===n?{...E,archived:!0,archivedAt:new Date().toISOString()}:E)),r&&d===n&&x(null),c&&u("Chat archived."),!0},St=async(n,a={})=>{if(!n)return!1;const r=a.clearActive===!0,c=a.toast!==!1;if(A)try{await Gn({sessionId:R,sessionCsrf:P,conversationId:n})}catch(o){return u((o==null?void 0:o.message)||"Failed to restore chat."),!1}return B(o=>o.map(E=>E.id===n?{...E,archived:!1,archivedAt:void 0}:E)),r&&d===n&&x(null),c&&u("Chat restored from archive."),!0},En=n=>{n&&(Fe(n),dt(!0))},wt=()=>{dt(!1),Fe(null)},Ze=n=>{n&&(je(n),Se(""),we(""),_e(!0))},It=()=>{_e(!1),je(null),Se(""),we("")},bn=async()=>{var c;if(!ce||!Ce)return;if(!A){u("Session missing or expired. Please log in again.");return}const n=((c=Ot.find(o=>o.value===Ce))==null?void 0:c.label)||Ce,a=ut.trim(),r=a?`${n} - ${a}`:n;try{await Yn({sessionId:R,sessionCsrf:P,conversationId:ce.id,recipientId:ce.otherPartyId,reason:r});try{const o=await Dt({sessionId:R,sessionCsrf:P});Oe(o)}catch{}It(),u("Report sent.")}catch(o){u((o==null?void 0:o.message)||"Failed to submit report.")}},yn=({title:n,message:a,confirmLabel:r,onConfirm:c})=>{gt({open:!0,title:n,message:a,confirmLabel:r,onConfirm:c})},Je=()=>{gt(n=>({...n,open:!1}))},Nn=m.useCallback(async(n,a,r={})=>{const c=!!(r!=null&&r.silent);if(ze)return!1;const o=n.trim(),E=a.trim();if(!o||!E)return c||u("Session credentials missing. Please log in again."),!1;ft(!0);try{const b=await On({sessionId:o,sessionCsrf:E}),{chats:p,blockedAccounts:y,reports:N,currentUser:k}=await Un({sessionId:o,sessionCsrf:E});He({sessionId:o,sessionCsrf:E,userId:b.userId,realtimeToken:b.token||""}),ht(k?{...le,...k}:{...le,...i}),na(o,E),B(p),ke(y),F({}),Oe(N);let T=null,ue=null;if(!$.current){if(v.conversationId){const q=p.find(K=>K.id===v.conversationId);q&&(T=q.id)}if(!T&&v.recipientId){const q=p.find(K=>K.otherPartyId===v.recipientId);q?T=q.id:ue={id:v.recipientId,name:v.recipientName||"Business"}}$.current=!0}return Z(ue),x(T),Me(!1),ve(""),ne(""),re(!1),I("chats"),!c&&p.length===0?u("Connected. No chats found."):c||u(`Connected. Loaded ${p.length} chat${p.length===1?"":"s"}.`),!0}catch(b){const p=Nt(b,{silent:c});return!c&&!p&&u((b==null?void 0:b.message)||"Failed to restore your session."),!1}finally{ft(!1)}},[ze,i,v]);bt.current=Nn,m.useEffect(()=>{let n=!1;return console.log("[ChatDebug] Session restore effect running..."),(async()=>{const r=ta();if(console.log("[ChatDebug] Session restore - persisted result:",r?"FOUND":"NOT FOUND"),!r){console.warn("[ChatDebug] No session cookies found. Possible causes:",`
  1. User never logged in`,`
  2. Cookies were cleared`,`
  3. Cookies set on different domain/path`,`
  4. Cookies are HttpOnly (can't read via JS)`),n||u("Session missing or expired. Please log in again.");return}console.log("[ChatDebug] Attempting connectWithSession...");const c=bt.current;if(!c)return;const o=await c(r.sessionId,r.sessionCsrf,{silent:!0});console.log("[ChatDebug] connectWithSession result:",o?"SUCCESS":"FAILED"),o||n||u("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const de=({title:n,message:a,confirmLabel:r="Delete",onConfirm:c})=>{vt({open:!0,title:n,message:a,confirmLabel:r,onConfirm:c})},X=()=>{vt(n=>({...n,open:!1}))},kn=async(n,a={})=>{a.unarchive&&!await St(n,{clearActive:!1,toast:!0})||(x(n),Z(null),A&&Ie(n),Me(!1),a.keepSection||I("chats"),B(r=>r.map(c=>c.id===n?{...c,unread:0}:c)),re(!1),ne(""))},Tt=(n,a,r)=>{F(c=>{const o=c[n]||[];return{...c,[n]:o.map(E=>E.id===a?{...E,status:r}:E)}})},Cn=async()=>{const n=oe.trim(),a=d||"",r=a?"":(C==null?void 0:C.id)||"",c=(S==null?void 0:S.name)||(C==null?void 0:C.name)||v.recipientName||"Business",o=(S==null?void 0:S.color)||"#3b82f6";if(!n||!!!(a||r))return;if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(!a&&Ye.current){u("Please wait, sending previous message...");return}if(A){a||(Ye.current=!0);try{const p=await Hn({sessionId:R,sessionCsrf:P,conversationId:a||void 0,recipientId:r||void 0,content:n}),y=Lt(p==null?void 0:p.data,U),N=(typeof y.chatId=="string"?y.chatId.trim():"")||a;if(!N)throw new Error("Failed to resolve conversation ID.");F(k=>({...k,[N]:[...k[N]||[],y]})),ae(""),B(k=>{const T=y.timestamp||new Date().toISOString();if(!k.find(z=>z.id===N))return[{id:N,name:c,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:y.text||n,lastTime:T,unread:0,online:!1,presence:"",color:o,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:r||(C==null?void 0:C.id)||""},...k];const q=k.map(z=>z.id===N?{...z,lastMessage:y.text||n,lastTime:y.timestamp||T,unread:0}:z),K=q.find(z=>z.id===N),Re=q.filter(z=>z.id!==N);return K?[K,...Re]:q}),x(N),Z(null),O.current.idleTimer&&(window.clearTimeout(O.current.idleTimer),O.current.idleTimer=null),O.current.lastValue=!1,xe(!1)}catch(p){u((p==null?void 0:p.message)||"Failed to send message.")}finally{Ye.current=!1}return}if(!a){u("Session missing or expired. Please log in again.");return}const b={id:`m-${Date.now()}`,chatId:a,sender:"me",text:n,timestamp:new Date().toISOString(),status:"sent"};F(p=>({...p,[a]:[...p[a]||[],b]})),ae(""),B(p=>{const y=p.map(T=>T.id===a?{...T,lastMessage:n,lastTime:b.timestamp,unread:0}:T),N=y.find(T=>T.id===a),k=y.filter(T=>T.id!==a);return N?[N,...k]:y}),setTimeout(()=>Tt(a,b.id,"delivered"),900),setTimeout(()=>Tt(a,b.id,"read"),2e3),O.current.idleTimer&&(window.clearTimeout(O.current.idleTimer),O.current.idleTimer=null),O.current.lastValue=!1,xe(!1)},Sn=()=>{if(!d&&!(C!=null&&C.id)){u("Select a chat to add emojis.");return}H(n=>!n)},wn=()=>{H(!1)},In=n=>{var r,c;const a=(n==null?void 0:n.native)??((c=(r=n==null?void 0:n.skins)==null?void 0:r[0])==null?void 0:c.native)??"";a&&ae(o=>{const{nextValue:E,caret:b}=ua(o,a,Ee.current);return requestAnimationFrame(()=>{Ee.current&&(Ee.current.focus(),Ee.current.setSelectionRange(b,b))}),E})},Tn=()=>{if(!d&&!(C!=null&&C.id)){u("Select a chat first.");return}if(!A){u("Session missing or expired. Please log in again.");return}if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}We.current&&We.current.click()},An=async n=>{var p;const a=n.target,r=(p=a==null?void 0:a.files)==null?void 0:p[0];if(a&&(a.value=""),!r)return;if(!d&&!(C!=null&&C.id)){u("Select a chat first.");return}if(!A){u("Session missing or expired. Please log in again.");return}if(ee(_)){u(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const c=d||"",o=c?"":(C==null?void 0:C.id)||"",E=(S==null?void 0:S.name)||(C==null?void 0:C.name)||v.recipientName||"Business",b=(S==null?void 0:S.color)||"#3b82f6";try{const y=await qn({sessionId:R,sessionCsrf:P,conversationId:c||void 0,recipientId:o||void 0,file:r}),N=Lt(y==null?void 0:y.data,U),k=(typeof N.chatId=="string"?N.chatId.trim():"")||c;if(!k)throw new Error("Failed to resolve conversation ID.");F(T=>({...T,[k]:[...T[k]||[],N]})),B(T=>{const ue=N.timestamp||new Date().toISOString();if(!T.find(G=>G.id===k))return[{id:k,name:E,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:N.text||r.name,lastTime:ue,unread:0,online:!1,presence:"",color:b,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:o||(C==null?void 0:C.id)||""},...T];const K=T.map(G=>G.id===k?{...G,lastMessage:N.text||r.name,lastTime:N.timestamp||ue,unread:0}:G),Re=K.find(G=>G.id===k),z=K.filter(G=>G.id!==k);return Re?[Re,...z]:K}),x(k),Z(null),u("Attachment sent.")}catch(y){u((y==null?void 0:y.message)||"Failed to send attachment.")}},Qe=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(B(r=>r.filter(c=>!a.has(c.id))),F(r=>{const c={...r};return a.forEach(o=>{delete c[o]}),c}),d&&a.has(d)&&x(null))},Xe=async(n,a={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const c=a.toast!==!1;if(A)try{await $t({sessionId:R,sessionCsrf:P,conversationId:r})}catch(o){return u((o==null?void 0:o.message)||"Failed to delete chat."),!1}return Qe([r]),c&&u("Chat deleted."),!0},At=async()=>{const n=w.map(c=>c.id).filter(Boolean);if(n.length===0)return u("No chats to delete."),!1;if(!A)return Qe(n),u("All chats deleted."),!0;const a=[];for(const c of n)try{await $t({sessionId:R,sessionCsrf:P,conversationId:c}),a.push(c)}catch{}a.length>0&&Qe(a);const r=n.length-a.length;return a.length===0?(u("Failed to delete chats."),!1):r===0?(u("All chats deleted."),!0):(u(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${r} failed.`),!1)},Bn=n=>{F(a=>({...a,[n]:[]})),B(a=>a.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},xn=()=>{if(d){Bn(d),u("Cleared current chat.");return}const n={};w.forEach(a=>{n[a.id]=[]}),F(n),B(a=>a.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),u("Cleared all chats.")},Rn=n=>{if(n==="profile"){S&&fn(S);return}if(n==="close"){x(null),Z(null),Me(!0),re(!1),ne(""),u("Chat closed.");return}if(n==="block"){if(!S)return;Ct(S.id);return}if(n==="delete"){de(S?{title:`Delete chat with ${fe(S)}?`,message:"This removes the chat from your list.",onConfirm:()=>{X(),Xe(S.id)}}:{title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),At()}});return}if(n==="clear"){const a=S?`Clear chat with ${S.name}?`:"Clear all chats?";yn({title:a,message:S?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{Je(),xn()}});return}n==="report"&&S&&Ze(S)},Pn=()=>{re(n=>{const a=!n;return a||ne(""),a})},Dn=async(n,a)=>{if(a==="archive"){await gn(n,{clearActive:!0,toast:!0});return}if(a==="unarchive"){await St(n,{clearActive:W,toast:!0});return}if(a==="delete"){const r=w.find(c=>c.id===n);de({title:r?`Delete chat with ${fe(r)}?`:"Delete chat?",message:"This removes the chat from your list.",onConfirm:()=>{X(),Xe(n)}});return}if(a==="report"){const r=w.find(c=>c.id===n);Ze(r)}},Ln=n=>{vn(n)},W=f==="archive",Bt=f==="block",xt=f==="profile",Rt=f==="reports",et=!!V,Pt=et||xt||Bt||Rt,Mn=ze;return m.useEffect(()=>{if(!W||ot)return;if(ye.length===0){x(null);return}const n=w.find(a=>a.id===d);n&&!n.archived&&x(null)},[W,ye,w,d,ot]),m.useEffect(()=>{if(W)return;const n=w.find(a=>a.id===d);n&&n.archived&&x(null)},[W,w,d,Ae]),m.useEffect(()=>{if(!A||f!=="block")return;let n=!1;return(async()=>{try{const a=await Fn({sessionId:R,sessionCsrf:P});n||ke(a)}catch{}})(),()=>{n=!0}},[A,f,R,P]),m.useEffect(()=>{if(!A||f!=="reports")return;let n=!1;return(async()=>{try{const a=await Dt({sessionId:R,sessionCsrf:P});n||Oe(a)}catch{}})(),()=>{n=!0}},[A,f,R,P]),m.useEffect(()=>{if(!Ue||!(J!=null&&J.id))return;const n=$e.find(a=>a.id===J.id);if(!n){wt();return}Fe(n)},[Ue,J==null?void 0:J.id,$e]),e.createElement("div",{className:"desktop-stage"},e.createElement("div",{className:"desktop-window"},e.createElement("div",{className:`desktop-content chp-desktop${et?" preview-only":Pt?" section-only":""}`},et?null:e.createElement("aside",{className:"icon-rail"},e.createElement("nav",{className:"rail-nav","aria-label":"Primary"},[{key:"home",label:"Home",icon:Na},{key:"chats",label:"Chats",icon:ha},{key:"archive",label:"Archive",icon:ka},{key:"block",label:"Block",icon:pe},{key:"reports",label:"Reports",icon:Kt},{key:"profile",label:"Profile",icon:Ca}].map(n=>{const a=n.icon;return e.createElement("button",{key:n.key,className:`rail-btn ${f===n.key?"active":""}`,type:"button",onClick:()=>{if(I(n.key),n.key==="home"){window.location.href="homepage.html";return}},"aria-label":n.label},e.createElement("span",{className:"rail-icon"},e.createElement(a,null)),e.createElement("span",null,n.label))})),e.createElement("div",{className:"rail-footer"},e.createElement("button",{className:`rail-btn danger ${f==="logout"?"active":""}`,type:"button",onClick:()=>{I("logout"),de({title:"Log out?",message:"Are you sure you want to log out?",confirmLabel:"Log out",onConfirm:()=>{X(),Ut(),He({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),ht({...le,...i}),u("Logged out.")}})},"aria-label":"Logout"},e.createElement("span",{className:"rail-icon"},e.createElement(Sa,null)),e.createElement("span",null,"Logout")))),Pt?null:e.createElement("aside",{className:"sidebar"},W?e.createElement(e.Fragment,null,e.createElement("div",{className:"archive-heading"},e.createElement("h2",null,"Achieved Chats")),e.createElement("div",{className:"archive-description muted"},"Archived conversations stored here.")):e.createElement("div",{className:"sidebar-header"},e.createElement("div",{className:"sidebar-title"},e.createElement("div",{className:"sidebar-brand"},e.createElement("img",{src:_n,alt:"CompareHubPrices"}))),e.createElement("div",{className:"sidebar-actions-row"},e.createElement("button",{className:"icon-btn",type:"button","aria-label":"Delete all chats",onClick:()=>{de({title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{X(),At()}})}},e.createElement(Gt,null)))),e.createElement($a,{chats:W?sn:ln,searchValue:j,onSearchChange:ve,activeChatId:d,onOpenChat:n=>kn(n,{keepSection:W}),onMenuAction:Dn,emptyTitle:W?"No archived chats":void 0,emptySubtitle:W?"Archived conversations will appear here.":void 0,showSearch:!W})),e.createElement("section",{className:"chat-panel"},xt?e.createElement(Ra,{currentUser:pt}):Bt?e.createElement(Pa,{chats:an,onUnblock:Ln}):Rt?e.createElement(Da,{reports:$e,onOpenReport:En}):e.createElement(za,{chat:_,groupedMessages:rn,searchValue:te,showSearch:De,onToggleSearch:Pn,onSearchChange:ne,onSend:Cn,composerValue:oe,onComposerChange:ae,onEmoji:Sn,onAttach:Tn,emojiOpen:Le,onEmojiSelect:In,onEmojiClose:wn,composerRef:Ee,typing:lt,conversationLoading:on,messageListRef:Et,matchCount:Ke.length,onMenuAction:Rn,attachmentPreview:V,onOpenAttachmentPreview:cn,onCloseAttachmentPreview:mn,onSaveAttachmentPreview:dn,onReportAttachmentPreview:un})))),Mn?e.createElement(xa,null):null,e.createElement(Aa,{open:Jt,onClose:()=>Qt(!1),currentUser:pt}),e.createElement(Ba,{open:Xt,onClose:Ge,chat:Y,onDelete:()=>{Y&&de({title:`Delete chat with ${fe(Y)}?`,message:"This removes the chat from your list.",onConfirm:async()=>{X(),await Xe(Y.id)&&Ge()}})},onBlock:()=>{(async()=>{if(!Y)return;(Y.blocked?await hn(Y.id):await Ct(Y.id))&&Ge()})()},onReport:()=>{Y&&Ze(Y)}}),e.createElement(La,{open:Ue,report:J,onClose:wt}),e.createElement(Ma,{open:en,onClose:It,reasons:Ot,value:Ce,onChange:Se,details:ut,onDetailsChange:we,onSubmit:bn,targetName:ce==null?void 0:ce.name}),e.createElement(Ta,{open:ie.open,title:ie.title,message:ie.message,confirmLabel:ie.confirmLabel,onConfirm:()=>{ie.onConfirm?ie.onConfirm():X()},onCancel:X}),e.createElement(Ia,{open:me.open,title:me.title,message:me.message,confirmLabel:me.confirmLabel,onConfirm:()=>{me.onConfirm?me.onConfirm():Je()},onCancel:Je}),e.createElement("input",{ref:We,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:An,style:{display:"none"}}))}const Wa=Qn(document.getElementById("root"));Wa.render(e.createElement(e.StrictMode,null,e.createElement(Ha,null)));
