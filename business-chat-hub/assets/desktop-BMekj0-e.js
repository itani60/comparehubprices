import{$ as Kn,r as m,h as Xn,i as Zn,f as Jn,a as _t,R as e,l as Qn,g as ea,b as ta,m as na,s as aa,c as Ut,j as Ft,t as sa,d as ra,e as la,p as Kt,k as oa,u as ca,v as jt,n as ia,o as ma,q as Xt,w as da}from"./64-B3toqydJ.js";typeof window<"u"&&!window.__comparehubEmojiMartInit&&(Kn({data:Xt}),window.__comparehubEmojiMartInit=!0);const le={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",village:"",town:"",province:"",accountSince:""},ua=[],fa={},Vt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function pa(){if(typeof document>"u")return null;const t=zt("business_session_id"),a=zt("business_csrf_token");return!t||!a?null:{sessionId:t,sessionCsrf:a}}function ha(t,a){var f;if(typeof document>"u"||!t||!a)return;const l=typeof window<"u"&&((f=window.location)==null?void 0:f.protocol)==="https:"?"; Secure":"",i=12*60*60;document.cookie=`business_session_id=${encodeURIComponent(t)}; path=/; max-age=${i}; SameSite=Strict${l}`,document.cookie=`business_csrf_token=${encodeURIComponent(a)}; path=/; max-age=${i}; SameSite=Strict${l}`}function Wt(){typeof document>"u"||(Yt("business_session_id"),Yt("business_csrf_token"))}function zt(t){if(!t||typeof document>"u")return"";try{const a=String(document.cookie||"");if(!a)return"";const l=a.split(";");let i="";for(const f of l){const E=f.indexOf("=");if(E<=0||f.slice(0,E).trim()!==t)continue;const M=f.slice(E+1).trim();if(M)try{i=decodeURIComponent(M).trim()}catch{i=M.trim()}}return i}catch{return""}}function Yt(t){var l;const a=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Strict${a}`}function nt(t){try{return new URL(`../${t}`,window.location.href).toString()}catch{return`../${t}`}}const va=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,Ea=200;function Ht(t){return typeof t=="string"&&va.test(t)}function ga(t){if(typeof t!="string")return"";const a=t.trim().slice(0,Ea);return Kt.sanitize(a,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function ba(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||""),a=(t.get("conversationId")||"").trim(),l=(t.get("recipientId")||"").trim(),i=(t.get("recipientName")||"").trim();return{conversationId:a&&Ht(a)?a:"",recipientId:l&&Ht(l)?l:"",recipientName:ga(i)}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function ya(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function ve(t){if(!t)return"";const a=t.split(" ").filter(Boolean),l=a[0]?a[0][0]:"",i=a.length>1?a[a.length-1][0]:"";return(l+i).toUpperCase()}function pe(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function rt(t){const a=String((t==null?void 0:t.suburb)||"").trim(),l=String((t==null?void 0:t.village)||"").trim();return a?{label:"Suburb",value:a}:l?{label:"Village",value:l}:{label:"Suburb/Village",value:"-"}}function te(t){return!!(t&&(t.blocked||t.blockedByOther))}function Zt(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Na(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleDateString([],{month:"short",day:"numeric"})}function at(t){if(!t)return"";const a=new Date(t);return Number.isNaN(a.getTime())?"":a.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Jt(t){const a=String(t||"").trim();return a?a.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Qt(t){const a=String(t||"").trim().toLowerCase();return a==="resolved"||a==="closed"||a==="complete"||a==="completed"||a==="done"?"success":a==="rejected"||a==="dismissed"||a==="denied"?"danger":a==="open"||a==="pending"||a==="in_review"||a==="in review"||a==="under_review"||a==="under review"?"warning":""}function Gt(t,a){return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}function ka(t){const a=new Date(t);if(Number.isNaN(a.getTime()))return"";const l=new Date,i=new Date;return i.setDate(l.getDate()-1),Gt(a,l)?"Today":Gt(a,i)?"Yesterday":a.toLocaleDateString([],{month:"short",day:"numeric"})}function Ca(t){const a=[];let l="";return t.forEach(i=>{const f=i.timestamp.slice(0,10);f!==l&&(a.push({type:"day",id:`day-${f}`,label:ka(i.timestamp)}),l=f),a.push({type:"message",id:i.id,message:i})}),a}function wa(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const qt=typeof Intl<"u"&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"grapheme"}):null;function Sa(t){return t?qt?Array.from(qt.segment(t),({segment:a})=>a):Array.from(t):[]}function Ia(t){return t?new RegExp("^\\p{Regional_Indicator}{2}$","u").test(t)||/[0-9#*]\uFE0F?\u20E3/u.test(t)?!0:new RegExp("\\p{Extended_Pictographic}","u").test(t):!1}function Ta(t){return typeof t!="string"?"":Kt.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function ke(t,a){const l=Ta(t);return Sa(l).map((i,f)=>Ia(i)?e.createElement("em-emoji",{key:`${a}-emoji-${f}`,native:i,set:"apple",size:"1.05em"}):e.createElement(e.Fragment,{key:`${a}-text-${f}`},i))}function Aa(t,a){if(!a)return ke(t,"msg");const l=wa(a);return t.split(new RegExp(`(${l})`,"ig")).map((f,E)=>f.toLowerCase()===a.toLowerCase()?e.createElement("mark",{key:E,className:"msg-highlight"},ke(f,`mark-${E}`)):e.createElement(e.Fragment,{key:E},ke(f,`part-${E}`)))}function Ba(t,a,l){const i=(l==null?void 0:l.selectionStart)??t.length,f=(l==null?void 0:l.selectionEnd)??i;return{nextValue:t.slice(0,i)+a+t.slice(f),caret:i+a.length}}function lt(t,a,l){m.useEffect(()=>{if(!l)return;const i=f=>{!t.current||t.current.contains(f.target)||a()};return document.addEventListener("mousedown",i),document.addEventListener("touchstart",i),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("touchstart",i)}},[t,a,l])}function $({children:t,size:a=20,className:l}){return e.createElement("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const xa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),en=t=>e.createElement($,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Ra=t=>e.createElement($,{...t},e.createElement("rect",{x:"5",y:"11",width:"14",height:"9",rx:"2"}),e.createElement("path",{d:"M8 11V8a4 4 0 0 1 8 0v3"})),Pa=t=>e.createElement($,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),La=t=>e.createElement($,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),Ma=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),Da=t=>e.createElement($,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),$a=t=>e.createElement($,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),Oa=t=>e.createElement($,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),_a=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),Ua=t=>e.createElement($,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),tn=t=>e.createElement($,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),he=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Fa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),nn=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),ja=t=>e.createElement($,{...t},e.createElement("path",{d:"M9 4h-4v16h4"}),e.createElement("path",{d:"M16 12H7"}),e.createElement("path",{d:"M13 9l3 3-3 3"})),Le=t=>e.createElement($,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function an({ariaLabel:t,items:a}){const[l,i]=m.useState(!1),f=m.useRef(null);return lt(f,()=>i(!1),l),e.createElement("div",{className:"menu-wrap",ref:f},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>i(E=>!E),type:"button"},e.createElement(xa,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},a.map(E=>e.createElement("button",{key:E.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{i(!1),E.onSelect()}},E.label))):null)}function Va({status:t}){if(!t)return null;if(t==="sent")return e.createElement($a,{className:"status-icon"});const a=t==="read"?"status-icon read":"status-icon";return e.createElement(Oa,{className:a})}function Wa({open:t,title:a,message:l,confirmLabel:i,onConfirm:f,onCancel:E}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":a},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,a),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:E},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:f},i)))):null}function za({open:t,title:a,message:l,confirmLabel:i="Delete",onConfirm:f,onCancel:E}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":a},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,a),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:E},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:f},i)))):null}function Ya({open:t,onClose:a,currentUser:l}){if(!t)return null;const i={...le,...l&&typeof l=="object"?l:{}},f=i.name||"User",E=rt(i),h=String(i.town||i.city||"").trim()||"-";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Profile panel"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:a,type:"button"},e.createElement(Le,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#2f9e8f"}},ve(f)),e.createElement("div",null,e.createElement("h3",null,f))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",i.firstName||"-"),e.createElement("p",null,"Family name: ",i.lastName||"-"),e.createElement("p",null,E.label,": ",E.value),e.createElement("p",null,"Town: ",h),e.createElement("p",null,"Province: ",i.province||"-"),e.createElement("p",null,"Account since: ",i.accountSince||"-"))))}function Ha({open:t,onClose:a,chat:l,onDelete:i,onBlock:f,onReport:E}){if(!t||!l)return null;const h=!!l.blockedByOther,M=pe(l),O=l.name?l.name.split(" ").filter(Boolean):[],p=O[0]||"",T=O.slice(1).join(" "),S=h?"-":l.firstName||p||"-",B=h?"-":l.lastName||T||"-",D=h?"":l.suburb||"",j=h?"":l.village||"",u=rt({suburb:D,village:j}),R=h?"-":l.town||l.city||"-",N=h?"-":l.province||"-",Y=h?"-":l.accountSince||"-",F=h?"-":l.accountType||"Standard";return e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Chat profile"},e.createElement("div",{className:"profile-panel"},e.createElement("div",{className:"panel-header"},e.createElement("h2",null,"Chat Profile"),e.createElement("button",{className:"icon-btn","aria-label":"Close profile",onClick:a,type:"button"},e.createElement(Le,null))),e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:l.color}},te(l)?e.createElement(he,{className:"avatar-blocked-icon",size:18}):ve(M)),e.createElement("div",null,e.createElement("h3",null,M))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",S),e.createElement("p",null,"Family name: ",B),e.createElement("p",null,u.label,": ",u.value),e.createElement("p",null,"Town: ",R),e.createElement("p",null,"Province: ",N),e.createElement("p",null,"Account since: ",Y),e.createElement("p",null,"Account type: ",F)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:i},e.createElement(nn,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:f},e.createElement(he,null),l.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:E},e.createElement(tn,null),"Report"))))))}function st({title:t,subtitle:a}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,a))}function Ga(){const t=Array.from({length:7}),a=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay desktop",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-desktop-shell"},e.createElement("aside",{className:"chat-loading-desktop-sidebar"},e.createElement("div",{className:"chat-loading-desktop-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})),e.createElement("div",{className:"chat-loading-desktop-search"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-search-box"})),e.createElement("div",{className:"chat-loading-desktop-list"},t.map((l,i)=>e.createElement("div",{className:"chat-loading-desktop-thread",key:i},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-time"}))))),e.createElement("section",{className:"chat-loading-desktop-chat"},e.createElement("div",{className:"chat-loading-desktop-chat-header"},e.createElement("div",{className:"chat-loading-desktop-chat-user"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-avatar"}),e.createElement("div",{className:"chat-loading-desktop-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}))),e.createElement("div",{className:"chat-loading-desktop-chat-actions"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}))),e.createElement("div",{className:"chat-loading-desktop-messages"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-day"}),a.map((l,i)=>e.createElement("div",{className:`chat-loading-desktop-bubble-row ${i%2?"me":"them"}`,key:i},e.createElement("div",{className:"chat-loading-desktop-bubble"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-line sm"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-meta"}))))),e.createElement("div",{className:"chat-loading-desktop-composer"},e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-input"}),e.createElement("div",{className:"chat-loading-sk chat-loading-desktop-circle"})))))}function ot({title:t,subtitle:a,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),a?e.createElement("p",{className:"muted"},a):null)),e.createElement("div",{className:"section-card"},l))}function qa({currentUser:t}){const a={...le,...t&&typeof t=="object"?t:{}},l=a.name||"User",i=rt(a),f=String(a.town||a.city||"").trim()||"-";return e.createElement(ot,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-card"},e.createElement("div",{className:"profile-card-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#0f766e"}},ve(l)),e.createElement("div",null,e.createElement("h3",null,l))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",a.firstName||"-"),e.createElement("p",null,"Family name: ",a.lastName||"-"),e.createElement("p",null,i.label,": ",i.value),e.createElement("p",null,"Town: ",f),e.createElement("p",null,"Province: ",a.province||"-"),e.createElement("p",null,"Account since: ",a.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile",onClick:()=>{window.location.href=nt("business_account_information.html")}},"Manage Profile"))))}function Ka({chats:t,onUnblock:a}){return e.createElement(ot,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(he,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,Na(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>a(l.id)},"Unblock"))))))}function Xa({reports:t,onOpenReport:a}){return e.createElement(ot,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b5bdb"}},ve(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Qt(l.status)}`},Jt(l.status)),e.createElement("span",null,at(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action",type:"button",onClick:()=>a(l)},"View report"))))))}function Za({open:t,report:a,onClose:l}){return!t||!a?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(Le,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},a.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Qt(a.status)}`},Jt(a.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},at(a.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},at(a.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},a.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},a.adminReply||"No admin reply yet."))))}function Ja({open:t,onClose:a,reasons:l,value:i,onChange:f,details:E,onDetailsChange:h,onSubmit:M,targetName:O}){const[p,T]=m.useState(!1),S=m.useRef(null),B=l.find(D=>D.value===i);return lt(S,()=>T(!1),p),m.useEffect(()=>{t||T(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",O||"this chat","."),e.createElement("div",{className:`report-select${p?" active":""}`,ref:S},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>T(D=>!D),"aria-haspopup":"listbox","aria-expanded":p},e.createElement("span",null,B?B.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(D=>e.createElement("button",{key:D.value,type:"button",className:`report-select__option${i===D.value?" selected":""}`,onClick:()=>{f(D.value),T(!1)},role:"option","aria-selected":i===D.value},D.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:E,onChange:D=>h(D.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:a},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:M,disabled:!i},"Report")))):null}function Qa({chats:t,searchValue:a,onSearchChange:l,activeChatId:i,onOpenChat:f,onMenuAction:E,emptyTitle:h="No chats yet",emptySubtitle:M="Start a new chat to compare prices.",showSearch:O=!0}){return e.createElement("div",{className:"chat-list-screen"},O?e.createElement("div",{className:"search-bar"},e.createElement(en,{className:"search-icon"}),e.createElement("input",{type:"search",value:a,onChange:p=>l(p.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})):null,e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(st,{title:h,subtitle:M}):t.map(p=>{const T=pe(p),S=[{label:p.archived?"Unarchive chat":"Archive chat",onSelect:()=>E(p.id,p.archived?"unarchive":"archive")},{label:"Delete chat",onSelect:()=>E(p.id,"delete")},{label:"Report",onSelect:()=>E(p.id,"report")}];return e.createElement("div",{key:p.id,className:`chat-item ${i===p.id?"active":""}`,role:"listitem"},e.createElement("button",{className:"chat-open",onClick:()=>f(p.id),type:"button","aria-label":`Open chat with ${T}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:p.color}},te(p)?e.createElement(he,{className:"avatar-blocked-icon",size:16}):ve(p.name)),p.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},T),e.createElement("span",{className:"chat-time"},Zt(p.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},p.lastMessage?ke(p.lastMessage,`chat-last-${p.id}`):"No messages yet"),e.createElement("span",{className:"chat-flags"},p.unread>0?e.createElement("span",{className:"chat-unread"},p.unread):null)))),e.createElement(an,{ariaLabel:"Chat options",items:S}))})))}function es({message:t,query:a,onPreviewImage:l}){const i=t.sender==="me",f=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",E=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",h=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",M=!!t.attachmentIsImage||E.startsWith("image/"),O=!!t.attachmentIsVideo||E.startsWith("video/"),p=typeof t.text=="string"&&t.text.trim().length>0,T={width:"100%",maxWidth:"260px",borderRadius:"10px",display:"block",marginBottom:p?"8px":"0"};return e.createElement("div",{className:`message-row ${i?"me":"them"}`},e.createElement("div",{className:`message-bubble ${i?"outgoing":"incoming"}`},f?e.createElement("div",{className:"message-attachment"},M?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${h}`},e.createElement("img",{src:f,alt:h,loading:"lazy",style:T})):O?e.createElement("video",{controls:!0,preload:"metadata",style:T},e.createElement("source",{src:f,type:E||void 0})):e.createElement("a",{href:f,target:"_blank",rel:"noreferrer"},"Open attachment")):null,p?e.createElement("div",{className:"message-text"},Aa(t.text,a)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Zt(t.timestamp)),i?e.createElement(Va,{status:t.status}):null)))}function ts({preview:t,onClose:a,onSave:l,onReport:i}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:a,"aria-label":"Close preview"},e.createElement(Le,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:i},"Report Photo"))):null}function ns(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function as(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((a,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${a?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function ss({value:t,onChange:a,onSend:l,onEmoji:i,onAttach:f,inputRef:E,disabled:h=!1,emojiActive:M=!1}){const O=h?"Unblock to send messages":"Type a message",p=T=>{T.key==="Enter"&&!T.shiftKey&&(T.preventDefault(),!h&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${M?" emoji-toggle-active":""}`,type:"button",onClick:i,"aria-label":"Emoji",disabled:h},e.createElement(Ma,null)),e.createElement("div",{className:"composer-input-wrap"},e.createElement("div",{className:`composer-render ${t?"has-value":""}`,"aria-hidden":"true"},t?ke(t,"composer-input"):null),e.createElement("textarea",{ref:E,className:`composer-input-native ${t?"has-value":""}`,rows:1,value:t,onChange:T=>a(T.target.value),onKeyDown:p,placeholder:O,"aria-label":"Message input",disabled:h})),e.createElement("button",{className:"icon-btn",type:"button",onClick:f,"aria-label":"Attach",disabled:h},e.createElement(Da,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:h||!t.trim(),"aria-label":"Send message"},e.createElement(La,null)))}function rs({open:t,onSelect:a,onClose:l}){const i=m.useRef(null);return lt(i,l,t),t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:i},e.createElement(ia,{data:Xt,onEmojiSelect:a,theme:"light",set:"apple",getSpritesheetURL:()=>ma,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiButtonRadius:"8px"}))):null}function ls({chat:t,groupedMessages:a,searchValue:l,showSearch:i,onToggleSearch:f,onSearchChange:E,onSend:h,composerValue:M,onComposerChange:O,onEmoji:p,onAttach:T,emojiOpen:S,onEmojiSelect:B,onEmojiClose:D,composerRef:j,typing:u,conversationLoading:R,messageListRef:N,matchCount:Y,onMenuAction:F,attachmentPreview:Ee,onOpenAttachmentPreview:ne,onCloseAttachmentPreview:ae,onSaveAttachmentPreview:Me,onReportAttachmentPreview:oe}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(st,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(Ee)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(ts,{preview:Ee,onClose:ae,onSave:Me,onReport:oe}));const ce=pe(t),se=!!t.launchPending,De=se?[{label:"Close chat",onSelect:()=>F("close")}]:[{label:"View profile",onSelect:()=>F("profile")},{label:"Close chat",onSelect:()=>F("close")},{label:"Delete chat",onSelect:()=>F("delete")},{label:"Block",onSelect:()=>F("block")},{label:"Report",onSelect:()=>F("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},te(t)?e.createElement(he,{className:"avatar-blocked-icon",size:16}):ve(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},ce),e.createElement("div",{className:"conversation-status"},se?e.createElement("span",null,"Start conversation"):u?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(an,{ariaLabel:"Conversation menu",items:De}))),i?e.createElement("div",{className:"conversation-search"},e.createElement(en,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:H=>E(H.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},Y," match",Y===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:N},e.createElement("div",{className:"security-banner"},e.createElement(Ra,null),e.createElement("div",null,"Messages are end-to-end encrypted. No one outside of this chat can read or listen to them.")),R?e.createElement(as,null):a.length===0?e.createElement(st,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):a.map(H=>H.type==="day"?e.createElement("div",{key:H.id,className:"day-separator"},H.label):e.createElement(es,{key:H.id,message:H.message,query:l.trim(),onPreviewImage:ne})),u&&!l&&!R?e.createElement(ns,null):null,!R&&te(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(ss,{value:M,onChange:O,onSend:h,onEmoji:p,onAttach:T,inputRef:j,disabled:te(t),emojiActive:S}),e.createElement(rs,{open:S,onSelect:B,onClose:D}))}function os({currentUser:t=le,initialChats:a=ua,initialMessages:l=fa}){const i={...le,...t&&typeof t=="object"?t:{}},f=Array.isArray(a)?a:[],E=l&&typeof l=="object"?l:{},h=m.useMemo(()=>ba(),[]),M=!!(h.conversationId||h.recipientId),O=m.useRef(!M),[p,T]=m.useState("chats"),[S,B]=m.useState(f),[D,j]=m.useState(E),[u,R]=m.useState(null),[N,Y]=m.useState(h.recipientId?{id:h.recipientId,name:h.recipientName||"Business"}:null),[F,Ee]=m.useState(""),[ne,ae]=m.useState(""),[Me,oe]=m.useState(!1),[ce,se]=m.useState(""),[De,H]=m.useState(!1),[ct,ge]=m.useState(!1),[sn,rn]=m.useState(!1),[is,it]=m.useState(null),[mt,$e]=m.useState(!1),[ln,dt]=m.useState(!1),[q,ut]=m.useState(null),[ft,Ce]=m.useState([]),[Oe,_e]=m.useState([]),[Ue,pt]=m.useState(!1),[Z,Fe]=m.useState(null),[on,je]=m.useState(!1),[we,Se]=m.useState(""),[ht,Ie]=m.useState(""),[ie,Ve]=m.useState(null),[W,We]=m.useState(null),[ze,vt]=m.useState(!1),[cn,Te]=m.useState(null),[Ae,Ye]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[Et,gt]=m.useState(i),[me,bt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Delete",onConfirm:null}),[de,yt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),Nt=m.useRef(null),be=m.useRef(null),He=m.useRef(null),ye=m.useRef(null),re=m.useRef(null),J=m.useRef(null),_=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),Ge=m.useRef(!1),kt=m.useRef(0),Ct=m.useRef(null),P=Ae.sessionId,L=Ae.sessionCsrf,U=Ae.userId,qe=Ae.realtimeToken,A=!!(P&&L&&U),w=S.find(n=>n.id===u)||null,mn=m.useMemo(()=>ya(N),[N]),V=w||mn,Be=m.useMemo(()=>S.filter(n=>!n.archived),[S]),Ne=m.useMemo(()=>S.filter(n=>n.archived),[S]),dn=m.useMemo(()=>{const n=new Map;return ft.forEach(s=>{s!=null&&s.id&&n.set(s.id,{id:s.id,name:s.name||"Unknown",blockedAt:s.blockedAt||"",color:s.color||"#3b82f6"})}),Array.from(n.values())},[ft]),un=m.useMemo(()=>{const n=F.trim().toLowerCase();return n?Ne.filter(s=>s.name.toLowerCase().includes(n)||(s.lastMessage||"").toLowerCase().includes(n)):Ne},[Ne,F]),fn=m.useMemo(()=>{const n=F.trim().toLowerCase();return n?Be.filter(s=>s.name.toLowerCase().includes(n)||(s.lastMessage||"").toLowerCase().includes(n)):Be},[Be,F]),xe=u?D[u]||[]:[],Ke=m.useMemo(()=>{const n=ne.trim().toLowerCase();return n?xe.filter(s=>s.text.toLowerCase().includes(n)):xe},[xe,ne]),pn=m.useMemo(()=>Ca(Ke),[Ke]),hn=!!(u&&cn===u),wt=()=>{J.current&&(window.clearTimeout(J.current),J.current=null),_.current.idleTimer&&(window.clearTimeout(_.current.idleTimer),_.current.idleTimer=null)},Re=async n=>{const s=re.current;if(!s||!U)return;const r=!!n,c=Date.now(),o=_.current;if(!(o.lastValue===r&&c-o.lastSentAt<600)){o.lastValue=r,o.lastSentAt=c;try{await s.send({type:"broadcast",event:"typing",payload:{isTyping:r,userId:String(U)}})}catch{}}};m.useEffect(()=>{let n=!1;return(async()=>{if(!u||!U||!qe||!A){ge(!1);return}try{const r=await ea();if(!r||n)return;r.realtime.setAuth(qe);const c=re.current;if(c)try{await c.unsubscribe()}catch{}re.current=null,wt(),_.current.lastValue=!1;const o=r.channel(`conversation:${u}`,{config:{presence:{key:`chat:${String(U)}`}}}),v=()=>{try{const k=typeof o.presenceState=="function"?o.presenceState():{};let y=!1;for(const C of Object.values(k||{})){const g=Array.isArray(C)?C:[C];for(const b of g){const I=String((b==null?void 0:b.userId)||(b==null?void 0:b.user_id)||"");if(I&&I!==String(U)){y=!0;break}}if(y)break}B(C=>C.map(g=>g.id!==u||g.hasBlockingRelationship||g.blockedByOther?g:y?{...g,online:!0,presence:"online"}:{...g,online:!1}))}catch{}};o.on("presence",{event:"sync"},v),o.on("presence",{event:"join"},v),o.on("presence",{event:"leave"},v),o.on("broadcast",{event:"typing"},({payload:k})=>{const y=String((k==null?void 0:k.userId)||"");if(!y||y===String(U))return;const C=!!(k!=null&&k.isTyping);ge(C),J.current&&(window.clearTimeout(J.current),J.current=null),C&&(J.current=window.setTimeout(()=>{ge(!1),J.current=null},3e3))}),re.current=o,o.subscribe(async(k,y)=>{if(!n&&k==="SUBSCRIBED")try{await o.track({userId:String(U),at:new Date().toISOString()}),v()}catch{}})}catch{n||ge(!1)}})(),()=>{n=!0;const r=re.current;if(re.current=null,r)try{r.unsubscribe()}catch{}wt(),_.current.lastValue=!1,ge(!1)}},[u,A,U,qe]),m.useEffect(()=>{if(!u||!U||!re.current)return;const n=ce.trim().length>0,s=Date.now(),r=_.current;n!==r.lastValue&&s-r.lastSentAt>600&&Re(n),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{_.current.idleTimer=null,Re(!1)},2e3))},[ce,u,U]),m.useEffect(()=>{if(!u||ne.trim())return;const n=Nt.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[u,xe.length,ct,ne]),m.useEffect(()=>{u||H(!1)},[u]),m.useEffect(()=>{We(null)},[u]),m.useEffect(()=>{(!u||!A)&&Te(null)},[u,A]),m.useEffect(()=>()=>{ye.current&&clearTimeout(ye.current)},[]);const d=n=>{it(n),ye.current&&clearTimeout(ye.current),ye.current=setTimeout(()=>it(null),2400)},St=(n,s={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const r=!!(s!=null&&s.silent);return Wt(),Ye({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),R(null),Y(null),r||d("Session missing or expired. Please log in again."),!0},vn=n=>{if(!n||typeof n!="object")return;const s=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",c=!!n.attachmentIsImage||r.startsWith("image/");if(!s||!c)return;const o=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";We({url:s,name:o,messageId:typeof n.id=="string"?n.id:""})},En=()=>{We(null)},gn=async()=>{if(!(W!=null&&W.url))return;const n=W.name||"photo";try{const s=await fetch(W.url);if(!s.ok)throw new Error("download_failed");const r=await s.blob(),c=window.URL.createObjectURL(r),o=document.createElement("a");o.href=c,o.download=n,document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(c),d("Image saved.")}catch{const s=document.createElement("a");s.href=W.url,s.target="_blank",s.rel="noreferrer",s.click(),d("Could not save directly. Opened image in a new tab.")}},bn=()=>{if(!w){d("No chat selected.");return}Ve(w),Se(""),Ie(W!=null&&W.name?`Photo attachment: ${W.name}`:"Photo attachment"),je(!0)};m.useEffect(()=>{if(!u||!A)return;let n=!1;Te(u);const s=async({silent:c=!1}={})=>{try{const{messages:o,chatPatch:v}=await ta({sessionId:P,sessionCsrf:L,conversationId:u,currentUserId:U});if(n)return;j(k=>{const y=k[u]||[],C=new Set(o.map(b=>b.id)),g=y.filter(b=>b.id&&b.id.startsWith("m-")&&!C.has(b.id));return{...k,[u]:[...o,...g]}}),B(k=>k.map(y=>y.id===u?{...y,...v||{},unread:0}:y));try{await na({sessionId:P,sessionCsrf:L,conversationId:u})}catch{}}catch(o){if(!n&&St(o))return;!n&&!c&&d((o==null?void 0:o.message)||"Failed to load chat messages.")}finally{n||Te(o=>o===u?null:o)}};s();const r=window.setInterval(()=>{s({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[u,A,P,L,U]);const yn=n=>{if(!n){d("No chat selected.");return}ut(n),dt(!0)},Xe=()=>{dt(!1),ut(null)},Nn=(n,s)=>{const r=S.find(y=>y.id===n),c=(r==null?void 0:r.otherPartyId)||n;if(!c)return;const o=s||new Date().toISOString(),v=(r==null?void 0:r.name)||"Unknown",k=(r==null?void 0:r.color)||"#3b82f6";Ce(y=>{const C=y.filter(g=>g.id!==c);return[{id:c,name:v,blockedAt:o,color:k},...C]})},It=({accountId:n,conversationId:s=""})=>{const r=typeof n=="string"?n.trim():"",c=typeof s=="string"?s.trim():"";B(o=>o.map(v=>{const k=!!c&&v.id===c,y=!!r&&v.otherPartyId===r;if(!k&&!y)return v;const C=!!v.blockedByOther;return{...v,blocked:!1,blockedByMe:!1,hasBlockingRelationship:C,blockedAt:void 0}})),r&&Ce(o=>o.filter(v=>v.id!==r))},Tt=async n=>{if(!n)return!1;if(A)try{await sa({sessionId:P,sessionCsrf:L,conversationId:n})}catch(r){return d((r==null?void 0:r.message)||"Failed to block account."),!1}const s=new Date().toISOString();return B(r=>r.map(c=>c.id===n?{...c,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:s}:c)),Nn(n,s),u===n&&R(null),d("Chat blocked."),!0},kn=async n=>{if(!n)return!1;const s=S.find(c=>c.id===n),r=(s==null?void 0:s.otherPartyId)||"";if(A)try{await Ft({sessionId:P,sessionCsrf:L,conversationId:n||void 0,recipientId:r||void 0})}catch(c){return d((c==null?void 0:c.message)||"Failed to unblock account."),!1}return It({accountId:r,conversationId:n}),d("Account unblocked."),!0},Cn=async n=>{const s=typeof n=="string"?n.trim():"";if(!s)return!1;const r=S.find(o=>o.otherPartyId===s),c=(r==null?void 0:r.id)||"";if(A)try{await Ft({sessionId:P,sessionCsrf:L,conversationId:c||void 0,recipientId:s})}catch(o){return d((o==null?void 0:o.message)||"Failed to unblock account."),!1}return It({accountId:s,conversationId:c}),d("Account unblocked."),!0},wn=async(n,s={})=>{if(!n)return!1;const r=s.clearActive!==!1,c=s.toast!==!1;if(A)try{await oa({sessionId:P,sessionCsrf:L,conversationId:n})}catch(o){return d((o==null?void 0:o.message)||"Failed to archive chat."),!1}return B(o=>o.map(v=>v.id===n?{...v,archived:!0,archivedAt:new Date().toISOString()}:v)),r&&u===n&&R(null),c&&d("Chat archived."),!0},At=async(n,s={})=>{if(!n)return!1;const r=s.clearActive===!0,c=s.toast!==!1;if(A)try{await ca({sessionId:P,sessionCsrf:L,conversationId:n})}catch(o){return d((o==null?void 0:o.message)||"Failed to restore chat."),!1}return B(o=>o.map(v=>v.id===n?{...v,archived:!1,archivedAt:void 0}:v)),r&&u===n&&R(null),c&&d("Chat restored from archive."),!0},Sn=n=>{n&&(Fe(n),pt(!0))},Bt=()=>{pt(!1),Fe(null)},Ze=n=>{n&&(Ve(n),Se(""),Ie(""),je(!0))},xt=()=>{je(!1),Ve(null),Se(""),Ie("")},In=async()=>{var c;if(!ie||!we)return;if(!A){d("Session missing or expired. Please log in again.");return}const n=((c=Vt.find(o=>o.value===we))==null?void 0:c.label)||we,s=ht.trim(),r=s?`${n} - ${s}`:n;try{await ra({sessionId:P,sessionCsrf:L,conversationId:ie.id,recipientId:ie.otherPartyId,reason:r});try{const o=await _t({sessionId:P,sessionCsrf:L});_e(o)}catch{}xt(),d("Report sent.")}catch(o){d((o==null?void 0:o.message)||"Failed to submit report.")}},Tn=({title:n,message:s,confirmLabel:r,onConfirm:c})=>{yt({open:!0,title:n,message:s,confirmLabel:r,onConfirm:c})},Je=()=>{yt(n=>({...n,open:!1}))},An=m.useCallback(async(n,s,r={})=>{const c=!!(r!=null&&r.silent);if(ze)return!1;const o=n.trim(),v=s.trim();if(!o||!v)return c||d("Session credentials missing. Please log in again."),!1;vt(!0);try{const k=await Xn({sessionId:o,sessionCsrf:v}),{chats:y,blockedAccounts:C,reports:g,currentUser:b}=await Zn({sessionId:o,sessionCsrf:v});Ye({sessionId:o,sessionCsrf:v,userId:k.userId,realtimeToken:k.token||""}),gt(b?{...le,...b}:{...le,...i}),ha(o,v),B(y),Ce(C),j({}),_e(g);let I=null,x=null;if(!O.current){if(h.conversationId){const X=y.find(ee=>ee.id===h.conversationId);X&&(I=X.id)}if(!I&&h.recipientId){const X=y.find(ee=>ee.otherPartyId===h.recipientId);X?I=X.id:x={id:h.recipientId,name:h.recipientName||"Business"}}O.current=!0}return Y(x),R(I),$e(!1),Ee(""),ae(""),oe(!1),T("chats"),!c&&y.length===0?d("Connected. No chats found."):c||d(`Connected. Loaded ${y.length} chat${y.length===1?"":"s"}.`),!0}catch(k){const y=St(k,{silent:c});return!c&&!y&&d((k==null?void 0:k.message)||"Failed to restore your session."),!1}finally{vt(!1)}},[ze,i,h]);Ct.current=An,m.useEffect(()=>{let n=!1;return(async()=>{const r=pa();if(!r){n||d("Session missing or expired. Please log in again.");return}const c=Ct.current;if(!c)return;await c(r.sessionId,r.sessionCsrf,{silent:!0})||n||d("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const ue=({title:n,message:s,confirmLabel:r="Delete",onConfirm:c})=>{bt({open:!0,title:n,message:s,confirmLabel:r,onConfirm:c})},Q=()=>{bt(n=>({...n,open:!1}))},Bn=async(n,s={})=>{s.unarchive&&!await At(n,{clearActive:!1,toast:!0})||(R(n),Y(null),A&&Te(n),$e(!1),s.keepSection||T("chats"),B(r=>r.map(c=>c.id===n?{...c,unread:0}:c)),oe(!1),ae(""))},Rt=(n,s,r)=>{j(c=>{const o=c[n]||[];return{...c,[n]:o.map(v=>v.id===s?{...v,status:r}:v)}})},xn=1e3,Rn=async()=>{const n=Date.now();if(n-kt.current<xn){d("Please wait before sending another message.");return}const s=ce.trim(),r=u||"",c=r?"":(N==null?void 0:N.id)||"",o=(w==null?void 0:w.name)||(N==null?void 0:N.name)||h.recipientName||"Business",v=(w==null?void 0:w.color)||"#3b82f6";if(!s||!!!(r||c))return;if(kt.current=n,te(V)){d(V!=null&&V.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(!r&&Ge.current){d("Please wait, sending previous message...");return}if(A){r||(Ge.current=!0);try{const C=await aa({sessionId:P,sessionCsrf:L,conversationId:r||void 0,recipientId:c||void 0,content:s}),g=Ut(C==null?void 0:C.data,U),b=(typeof g.chatId=="string"?g.chatId.trim():"")||r;if(!b)throw new Error("Failed to resolve conversation ID.");j(I=>({...I,[b]:[...I[b]||[],g]})),se(""),B(I=>{const x=g.timestamp||new Date().toISOString();if(!I.find(z=>z.id===b))return[{id:b,name:o,firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:g.text||s,lastTime:x,unread:0,online:!1,presence:"",color:v,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:c||(N==null?void 0:N.id)||""},...I];const ee=I.map(z=>z.id===b?{...z,lastMessage:g.text||s,lastTime:g.timestamp||x,unread:0}:z),fe=ee.find(z=>z.id===b),Pe=ee.filter(z=>z.id!==b);return fe?[fe,...Pe]:ee}),R(b),Y(null),_.current.idleTimer&&(window.clearTimeout(_.current.idleTimer),_.current.idleTimer=null),_.current.lastValue=!1,Re(!1)}catch(C){d((C==null?void 0:C.message)||"Failed to send message.")}finally{Ge.current=!1}return}if(!r){d("Session missing or expired. Please log in again.");return}const y={id:`m-${Date.now()}`,chatId:r,sender:"me",text:s,timestamp:new Date().toISOString(),status:"sent"};j(C=>({...C,[r]:[...C[r]||[],y]})),se(""),B(C=>{const g=C.map(x=>x.id===r?{...x,lastMessage:s,lastTime:y.timestamp,unread:0}:x),b=g.find(x=>x.id===r),I=g.filter(x=>x.id!==r);return b?[b,...I]:g}),setTimeout(()=>Rt(r,y.id,"delivered"),900),setTimeout(()=>Rt(r,y.id,"read"),2e3),_.current.idleTimer&&(window.clearTimeout(_.current.idleTimer),_.current.idleTimer=null),_.current.lastValue=!1,Re(!1)},Pn=()=>{if(!u&&!(N!=null&&N.id)){d("Select a chat to add emojis.");return}H(n=>!n)},Ln=()=>{H(!1)},Mn=n=>{var r,c;const s=(n==null?void 0:n.native)??((c=(r=n==null?void 0:n.skins)==null?void 0:r[0])==null?void 0:c.native)??"";s&&se(o=>{const{nextValue:v,caret:k}=Ba(o,s,be.current);return requestAnimationFrame(()=>{be.current&&(be.current.focus(),be.current.setSelectionRange(k,k))}),v})},Dn=()=>{if(!u&&!(N!=null&&N.id)){d("Select a chat first.");return}if(!A){d("Session missing or expired. Please log in again.");return}if(te(V)){d(V!=null&&V.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}He.current&&He.current.click()},$n=new Set(["image/png","image/jpeg","image/webp"]),On=new Set(["video/mp4","video/webm","video/quicktime","video/x-m4v"]),_n=new Set(["application/pdf"]),Pt=10*1024*1024,Un=15*1024*1024;function Fn(n){const s=(n.type||"").toLowerCase(),r=(n.name||"").toLowerCase();return $n.has(s)||/\.(png|jpe?g|webp)$/.test(r)?{ok:!0,maxBytes:Pt,label:"images"}:On.has(s)||/\.(mp4|webm|mov|m4v)$/.test(r)?{ok:!0,maxBytes:Un,label:"videos"}:_n.has(s)||r.endsWith(".pdf")?{ok:!0,maxBytes:Pt,label:"documents"}:{ok:!1,maxBytes:0,label:""}}const jn=async n=>{var C;const s=n.target,r=(C=s==null?void 0:s.files)==null?void 0:C[0];if(s&&(s.value=""),!r)return;const c=Fn(r);if(!c.ok){d("Unsupported file type. Allowed: PNG, JPEG, WEBP, PDF, MP4, WEBM, MOV.");return}if(r.size>c.maxBytes){const g=Math.round(c.maxBytes/1048576);d(`File too large. Maximum ${g}MB for ${c.label}.`);return}if(!u&&!(N!=null&&N.id)){d("Select a chat first.");return}if(!A){d("Session missing or expired. Please log in again.");return}if(te(V)){d(V!=null&&V.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const o=u||"",v=o?"":(N==null?void 0:N.id)||"",k=(w==null?void 0:w.name)||(N==null?void 0:N.name)||h.recipientName||"Business",y=(w==null?void 0:w.color)||"#3b82f6";try{const g=await la({sessionId:P,sessionCsrf:L,conversationId:o||void 0,recipientId:v||void 0,file:r}),b=Ut(g==null?void 0:g.data,U),I=(typeof b.chatId=="string"?b.chatId.trim():"")||o;if(!I)throw new Error("Failed to resolve conversation ID.");j(x=>({...x,[I]:[...x[I]||[],b]})),B(x=>{const X=b.timestamp||new Date().toISOString();if(!x.find(K=>K.id===I))return[{id:I,name:k,firstName:"",lastName:"",suburb:"",village:"",town:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:b.text||r.name,lastTime:X,unread:0,online:!1,presence:"",color:y,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:v||(N==null?void 0:N.id)||""},...x];const fe=x.map(K=>K.id===I?{...K,lastMessage:b.text||r.name,lastTime:b.timestamp||X,unread:0}:K),Pe=fe.find(K=>K.id===I),z=fe.filter(K=>K.id!==I);return Pe?[Pe,...z]:fe}),R(I),Y(null),d("Attachment sent.")}catch(g){d((g==null?void 0:g.message)||"Failed to send attachment.")}},Qe=n=>{if(!Array.isArray(n)||n.length===0)return;const s=new Set(n.filter(Boolean));s.size&&(B(r=>r.filter(c=>!s.has(c.id))),j(r=>{const c={...r};return s.forEach(o=>{delete c[o]}),c}),u&&s.has(u)&&R(null))},et=async(n,s={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const c=s.toast!==!1;if(A)try{await jt({sessionId:P,sessionCsrf:L,conversationId:r})}catch(o){return d((o==null?void 0:o.message)||"Failed to delete chat."),!1}return Qe([r]),c&&d("Chat deleted."),!0},Lt=async()=>{const n=S.map(c=>c.id).filter(Boolean);if(n.length===0)return d("No chats to delete."),!1;if(!A)return Qe(n),d("All chats deleted."),!0;const s=[];for(const c of n)try{await jt({sessionId:P,sessionCsrf:L,conversationId:c}),s.push(c)}catch{}s.length>0&&Qe(s);const r=n.length-s.length;return s.length===0?(d("Failed to delete chats."),!1):r===0?(d("All chats deleted."),!0):(d(`Deleted ${s.length} chat${s.length===1?"":"s"}. ${r} failed.`),!1)},Vn=n=>{j(s=>({...s,[n]:[]})),B(s=>s.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},Wn=()=>{if(u){Vn(u),d("Cleared current chat.");return}const n={};S.forEach(s=>{n[s.id]=[]}),j(n),B(s=>s.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),d("Cleared all chats.")},zn=n=>{if(n==="profile"){w&&yn(w);return}if(n==="close"){R(null),Y(null),$e(!0),oe(!1),ae(""),d("Chat closed.");return}if(n==="block"){if(!w)return;Tt(w.id);return}if(n==="delete"){ue(w?{title:`Delete chat with ${pe(w)}?`,message:"This removes the chat from your list.",onConfirm:()=>{Q(),et(w.id)}}:{title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{Q(),Lt()}});return}if(n==="clear"){const s=w?`Clear chat with ${w.name}?`:"Clear all chats?";Tn({title:s,message:w?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{Je(),Wn()}});return}n==="report"&&w&&Ze(w)},Yn=()=>{oe(n=>{const s=!n;return s||ae(""),s})},Hn=async(n,s)=>{if(s==="archive"){await wn(n,{clearActive:!0,toast:!0});return}if(s==="unarchive"){await At(n,{clearActive:G,toast:!0});return}if(s==="delete"){const r=S.find(c=>c.id===n);ue({title:r?`Delete chat with ${pe(r)}?`:"Delete chat?",message:"This removes the chat from your list.",onConfirm:()=>{Q(),et(n)}});return}if(s==="report"){const r=S.find(c=>c.id===n);Ze(r)}},Gn=n=>{Cn(n)},G=p==="archive",Mt=p==="block",Dt=p==="profile",$t=p==="reports",tt=!!W,Ot=tt||Dt||Mt||$t,qn=ze;return m.useEffect(()=>{if(!G||mt)return;if(Ne.length===0){R(null);return}const n=S.find(s=>s.id===u);n&&!n.archived&&R(null)},[G,Ne,S,u,mt]),m.useEffect(()=>{if(G)return;const n=S.find(s=>s.id===u);n&&n.archived&&R(null)},[G,S,u,Be]),m.useEffect(()=>{if(!A||p!=="block")return;let n=!1;return(async()=>{try{const s=await Jn({sessionId:P,sessionCsrf:L});n||Ce(s)}catch{}})(),()=>{n=!0}},[A,p,P,L]),m.useEffect(()=>{if(!A||p!=="reports")return;let n=!1;return(async()=>{try{const s=await _t({sessionId:P,sessionCsrf:L});n||_e(s)}catch{}})(),()=>{n=!0}},[A,p,P,L]),m.useEffect(()=>{if(!Ue||!(Z!=null&&Z.id))return;const n=Oe.find(s=>s.id===Z.id);if(!n){Bt();return}Fe(n)},[Ue,Z==null?void 0:Z.id,Oe]),e.createElement("div",{className:"desktop-stage"},e.createElement("div",{className:"desktop-window"},e.createElement("div",{className:`desktop-content chp-desktop${tt?" preview-only":Ot?" section-only":""}`},tt?null:e.createElement("aside",{className:"icon-rail"},e.createElement("nav",{className:"rail-nav","aria-label":"Primary"},[{key:"home",label:"Home",icon:_a},{key:"chats",label:"Chats",icon:Pa},{key:"archive",label:"Archive",icon:Ua},{key:"block",label:"Block",icon:he},{key:"reports",label:"Reports",icon:tn},{key:"profile",label:"Profile",icon:Fa}].map(n=>{const s=n.icon;return e.createElement("button",{key:n.key,className:`rail-btn ${p===n.key?"active":""}`,type:"button",onClick:()=>{if(T(n.key),n.key==="home"){window.location.href=nt("home.html");return}},"aria-label":n.label},e.createElement("span",{className:"rail-icon"},e.createElement(s,null)),e.createElement("span",null,n.label))})),e.createElement("div",{className:"rail-footer"},e.createElement("button",{className:`rail-btn danger ${p==="logout"?"active":""}`,type:"button",onClick:()=>{T("logout"),ue({title:"Log out?",message:"Are you sure you want to log out?",confirmLabel:"Log out",onConfirm:()=>{Q(),Wt(),Ye({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),gt({...le,...i}),d("Logged out."),window.location.href=nt("home.html")}})},"aria-label":"Logout"},e.createElement("span",{className:"rail-icon"},e.createElement(ja,null)),e.createElement("span",null,"Logout")))),Ot?null:e.createElement("aside",{className:"sidebar"},G?e.createElement(e.Fragment,null,e.createElement("div",{className:"archive-heading"},e.createElement("h2",null,"Achieved Chats")),e.createElement("div",{className:"archive-description muted"},"Archived conversations stored here.")):e.createElement("div",{className:"sidebar-header"},e.createElement("div",{className:"sidebar-title"},e.createElement("div",{className:"sidebar-brand"},e.createElement("img",{src:Qn,alt:"CompareHubPrices"}))),e.createElement("div",{className:"sidebar-actions-row"},e.createElement("button",{className:"icon-btn",type:"button","aria-label":"Delete all chats",onClick:()=>{ue({title:"Delete all chats?",message:"This removes every chat from your list.",onConfirm:()=>{Q(),Lt()}})}},e.createElement(nn,null)))),e.createElement(Qa,{chats:G?un:fn,searchValue:F,onSearchChange:Ee,activeChatId:u,onOpenChat:n=>Bn(n,{keepSection:G}),onMenuAction:Hn,emptyTitle:G?"No archived chats":void 0,emptySubtitle:G?"Archived conversations will appear here.":void 0,showSearch:!G})),e.createElement("section",{className:"chat-panel"},Dt?e.createElement(qa,{currentUser:Et}):Mt?e.createElement(Ka,{chats:dn,onUnblock:Gn}):$t?e.createElement(Xa,{reports:Oe,onOpenReport:Sn}):e.createElement(ls,{chat:V,groupedMessages:pn,searchValue:ne,showSearch:Me,onToggleSearch:Yn,onSearchChange:ae,onSend:Rn,composerValue:ce,onComposerChange:se,onEmoji:Pn,onAttach:Dn,emojiOpen:De,onEmojiSelect:Mn,onEmojiClose:Ln,composerRef:be,typing:ct,conversationLoading:hn,messageListRef:Nt,matchCount:Ke.length,onMenuAction:zn,attachmentPreview:W,onOpenAttachmentPreview:vn,onCloseAttachmentPreview:En,onSaveAttachmentPreview:gn,onReportAttachmentPreview:bn})))),qn?e.createElement(Ga,null):null,e.createElement(Ya,{open:sn,onClose:()=>rn(!1),currentUser:Et}),e.createElement(Ha,{open:ln,onClose:Xe,chat:q,onDelete:()=>{q&&ue({title:`Delete chat with ${pe(q)}?`,message:"This removes the chat from your list.",onConfirm:async()=>{Q(),await et(q.id)&&Xe()}})},onBlock:()=>{(async()=>{if(!q)return;(q.blocked?await kn(q.id):await Tt(q.id))&&Xe()})()},onReport:()=>{q&&Ze(q)}}),e.createElement(Za,{open:Ue,report:Z,onClose:Bt}),e.createElement(Ja,{open:on,onClose:xt,reasons:Vt,value:we,onChange:Se,details:ht,onDetailsChange:Ie,onSubmit:In,targetName:ie==null?void 0:ie.name}),e.createElement(za,{open:me.open,title:me.title,message:me.message,confirmLabel:me.confirmLabel,onConfirm:()=>{me.onConfirm?me.onConfirm():Q()},onCancel:Q}),e.createElement(Wa,{open:de.open,title:de.title,message:de.message,confirmLabel:de.confirmLabel,onConfirm:()=>{de.onConfirm?de.onConfirm():Je()},onCancel:Je}),e.createElement("input",{ref:He,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:jn,style:{display:"none"}}))}const cs=da(document.getElementById("root"));cs.render(e.createElement(e.StrictMode,null,e.createElement(os,null)));
