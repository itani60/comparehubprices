import{$ as An,r as u,f as Bn,a as kt,R as e,l as xn,g as Pn,b as Rn,m as Mn,s as Ln,c as Ct,d as $n,e as Dn,h as Un,i as On,u as _n,j as wt,k as jn,n as Fn,o as Vn,p as Rt,q as zn,t as St,v as Hn}from"./64-oqneRwkO.js";typeof window<"u"&&!window.__comparehubEmojiMartInit&&(An({data:Rt}),window.__comparehubEmojiMartInit=!0);const de={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},Kn=[],Wn={},It=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function Yn(){if(typeof document>"u")return null;const t=At("business_session_id"),s=At("business_csrf_token");return!t||!s?null:{sessionId:t,sessionCsrf:s}}function qn(t,s){var h;if(typeof document>"u"||!t||!s)return;const l=typeof window<"u"&&((h=window.location)==null?void 0:h.protocol)==="https:"?"; Secure":"",c=12*60*60;document.cookie=`business_session_id=${encodeURIComponent(t)}; path=/; max-age=${c}; SameSite=Lax${l}`,document.cookie=`business_csrf_token=${encodeURIComponent(s)}; path=/; max-age=${c}; SameSite=Lax${l}`}function Tt(){typeof document>"u"||(Bt("business_session_id"),Bt("business_csrf_token"))}function At(t){if(!t||typeof document>"u")return"";try{const s=String(document.cookie||"");if(!s)return"";const l=s.split(";");let c="";for(const h of l){const p=h.indexOf("=");if(p<=0||h.slice(0,p).trim()!==t)continue;const B=h.slice(p+1).trim();if(B)try{c=decodeURIComponent(B).trim()}catch{c=B.trim()}}return c}catch{return""}}function Bt(t){var l;const s=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Lax${s}`}function Gn(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||"");return{conversationId:(t.get("conversationId")||"").trim(),recipientId:(t.get("recipientId")||"").trim(),recipientName:(t.get("recipientName")||"").trim()}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function Zn(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function pe(t){if(!t)return"";const s=t.split(" ").filter(Boolean),l=s[0]?s[0][0]:"",c=s.length>1?s[s.length-1][0]:"";return(l+c).toUpperCase()}function ee(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function G(t){return!!(t&&(t.blocked||t.blockedByOther))}function Mt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Lt(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Ze(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function $t(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function Dt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function xt(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function Qn(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const l=new Date,c=new Date;return c.setDate(l.getDate()-1),xt(s,l)?"Today":xt(s,c)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Jn(t){const s=[];let l="";return t.forEach(c=>{const h=c.timestamp.slice(0,10);h!==l&&(s.push({type:"day",id:`day-${h}`,label:Qn(c.timestamp)}),l=h),s.push({type:"message",id:c.id,message:c})}),s}function Xn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const Pt=typeof Intl<"u"&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"grapheme"}):null;function ea(t){return t?Pt?Array.from(Pt.segment(t),({segment:s})=>s):Array.from(t):[]}function ta(t){return t?new RegExp("^\\p{Regional_Indicator}{2}$","u").test(t)||/[0-9#*]\uFE0F?\u20E3/u.test(t)?!0:new RegExp("\\p{Extended_Pictographic}","u").test(t):!1}function fe(t,s){return ea(t).map((l,c)=>ta(l)?e.createElement("em-emoji",{key:`${s}-emoji-${c}`,native:l,set:"apple",size:"1.05em"}):e.createElement(e.Fragment,{key:`${s}-text-${c}`},l))}function na(t,s){if(!s)return fe(t,"msg");const l=Xn(s);return t.split(new RegExp(`(${l})`,"ig")).map((h,p)=>h.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:p,className:"msg-highlight"},fe(h,`mark-${p}`)):e.createElement(e.Fragment,{key:p},fe(h,`part-${p}`)))}function aa(t,s,l){const c=(l==null?void 0:l.selectionStart)??t.length,h=(l==null?void 0:l.selectionEnd)??c;return{nextValue:t.slice(0,c)+s+t.slice(h),caret:c+s.length}}function Je(t,s,l){u.useEffect(()=>{if(!l)return;const c=h=>{!t.current||t.current.contains(h.target)||s()};return document.addEventListener("mousedown",c),document.addEventListener("touchstart",c),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("touchstart",c)}},[t,s,l])}function $({children:t,size:s=20,className:l}){return e.createElement("svg",{className:l,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const sa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Ut=t=>e.createElement($,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),Ot=t=>e.createElement($,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),ra=t=>e.createElement($,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),la=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),oa=t=>e.createElement($,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),ca=t=>e.createElement($,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),ia=t=>e.createElement($,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),ma=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),ua=t=>e.createElement($,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),da=t=>e.createElement($,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),fa=t=>e.createElement($,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),re=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),pa=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),ha=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),_t=t=>e.createElement($,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function Xe({ariaLabel:t,items:s}){const[l,c]=u.useState(!1),h=u.useRef(null);return Je(h,()=>c(!1),l),e.createElement("div",{className:"menu-wrap",ref:h},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>c(p=>!p),type:"button"},e.createElement(sa,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},s.map(p=>e.createElement("button",{key:p.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{c(!1),p.onSelect()}},p.label))):null)}function va({status:t}){if(!t)return null;if(t==="sent")return e.createElement(ca,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(ia,{className:s})}function Ea({open:t,title:s,message:l,confirmLabel:c,onConfirm:h,onCancel:p}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:p},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:h},c)))):null}function ga({open:t,onClose:s,reasons:l,value:c,onChange:h,details:p,onDetailsChange:d,onSubmit:B,targetName:A}){const[w,b]=u.useState(!1),Z=u.useRef(null),R=l.find(m=>m.value===c);return Je(Z,()=>b(!1),w),u.useEffect(()=>{t||b(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",A||"this chat","."),e.createElement("div",{className:`report-select${w?" active":""}`,ref:Z},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>b(m=>!m),"aria-haspopup":"listbox","aria-expanded":w},e.createElement("span",null,R?R.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(m=>e.createElement("button",{key:m.value,type:"button",className:`report-select__option${c===m.value?" selected":""}`,onClick:()=>{h(m.value),b(!1)},role:"option","aria-selected":c===m.value},m.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:p,onChange:m=>d(m.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:B,disabled:!c},"Report")))):null}function ba({chat:t,onClose:s,onDelete:l,onBlock:c,onReport:h}){if(!t)return null;const p=!!t.blockedByOther,d=ee(t),B=t.name?t.name.split(" ").filter(Boolean):[],A=B[0]||"",w=B.slice(1).join(" "),b=p?"-":t.firstName||A||"-",Z=p?"-":t.lastName||w||"-",R=p?"-":t.suburb||"-",m=p?"-":t.city||"-",M=p?"-":t.province||"-",y=p?"-":t.accountSince||"-",_=p?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(Ot,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:t.color}},G(t)?e.createElement(re,{className:"avatar-blocked-icon",size:18}):pe(d)),e.createElement("div",null,e.createElement("h3",null,d))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",b),e.createElement("p",null,"Family name: ",Z),e.createElement("p",null,"Suburb: ",R),e.createElement("p",null,"City: ",m),e.createElement("p",null,"Province: ",M),e.createElement("p",null,"Account since: ",y),e.createElement("p",null,"Account type: ",_)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:l},e.createElement(ha,null),"Delete"),p?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:c},e.createElement(re,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:h},e.createElement(fa,null),"Report"))))))}function Re({title:t,subtitle:s,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},l))}function ya({currentUser:t}){const s={...de,...t&&typeof t=="object"?t:{}},l=s.name||"User";return e.createElement(Re,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},pe(l)),e.createElement("div",null,e.createElement("h3",null,l),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function Na({chats:t,onOpenChat:s,onUnarchive:l}){return e.createElement(Re,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(c=>{const h=ee(c);return e.createElement("div",{key:c.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:c.color}},G(c)?e.createElement(re,{className:"avatar-blocked-icon",size:16}):pe(c.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},h),e.createElement("div",{className:"section-item-sub"},c.lastMessage?fe(c.lastMessage,`archived-last-${c.id}`):"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,Lt(c.archivedAt||c.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(c.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>l(c.id)},"Unarchive"))))})))}function ka({chats:t,onUnblock:s}){return e.createElement(Re,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(re,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,Lt(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l.id)},"Unblock"))))))}function Ca({reports:t,onOpenReport:s}){return e.createElement(Re,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b82f6"}},pe(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${Dt(l.status)}`},$t(l.status)),e.createElement("span",null,Ze(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(l)},"View report"))))))}function wa({open:t,report:s,onClose:l}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(_t,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${Dt(s.status)}`},$t(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Ze(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Ze(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Qe({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function Sa(){const t=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((l,c)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:c},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((l,c)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:c},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function Ia({chats:t,searchValue:s,onSearchChange:l,activeChatId:c,onOpenChat:h,onChatAction:p}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(Ut,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:d=>l(d.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Qe,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(d=>{const B=ee(d);return e.createElement("div",{key:d.id,className:`chat-item ${c===d.id?"active":""}`,onClick:()=>h(d.id),onKeyDown:A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),h(d.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${B}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:d.color}},G(d)?e.createElement(re,{className:"avatar-blocked-icon",size:16}):pe(d.name)),d.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},B),e.createElement("span",{className:"chat-time"},Mt(d.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},d.lastMessage?fe(d.lastMessage,`chat-last-${d.id}`):"No messages yet"),d.unread>0?e.createElement("span",{className:"chat-unread"},d.unread):null)),e.createElement("div",{className:"chat-actions",onClick:A=>A.stopPropagation(),onKeyDown:A=>A.stopPropagation()},e.createElement(Xe,{ariaLabel:`More options for ${B}`,items:[{label:"Delete chat",onSelect:()=>p(d.id,"delete")},{label:"Report",onSelect:()=>p(d.id,"report")},{label:"Archive",onSelect:()=>p(d.id,"archive")}]})))})))}function Ta({message:t,query:s,onPreviewImage:l}){const c=t.sender==="me",h=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",p=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",d=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",B=!!t.attachmentIsImage||p.startsWith("image/"),A=!!t.attachmentIsVideo||p.startsWith("video/"),w=typeof t.text=="string"&&t.text.trim().length>0,b={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:w?"8px":"0"};return e.createElement("div",{className:`message-row ${c?"me":"them"}`},e.createElement("div",{className:`message-bubble ${c?"outgoing":"incoming"}`},h?e.createElement("div",{className:"message-attachment"},B?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${d}`},e.createElement("img",{src:h,alt:d,loading:"lazy",style:b})):A?e.createElement("video",{controls:!0,preload:"metadata",style:b},e.createElement("source",{src:h,type:p||void 0})):e.createElement("a",{href:h,target:"_blank",rel:"noreferrer"},"Open attachment")):null,w?e.createElement("div",{className:"message-text"},na(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Mt(t.timestamp)),c?e.createElement(va,{status:t.status}):null)))}function Aa({preview:t,onClose:s,onSave:l,onReport:c}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(_t,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:c},"Report Photo"))):null}function Ba(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function xa(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function Pa({value:t,onChange:s,onSend:l,onEmoji:c,onAttach:h,inputRef:p,disabled:d=!1,emojiActive:B=!1}){const A=d?"Unblock to send messages":"Type a message";u.useEffect(()=>{const b=p==null?void 0:p.current;b&&(b.style.height="auto",b.style.height=`${Math.min(b.scrollHeight,120)}px`)},[t,p]);const w=b=>{b.key==="Enter"&&!b.shiftKey&&(b.preventDefault(),!d&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${B?" emoji-toggle-active":""}`,type:"button",onClick:c,"aria-label":"Emoji",disabled:d},e.createElement(la,null)),e.createElement("div",{className:"composer-input-wrap"},e.createElement("div",{className:`composer-render ${t?"has-value":""}`,"aria-hidden":"true"},t?fe(t,"composer-input"):null),e.createElement("textarea",{ref:p,className:`composer-input-native ${t?"has-value":""}`,rows:1,value:t,onChange:b=>s(b.target.value),onKeyDown:w,placeholder:A,"aria-label":"Message input",disabled:d})),e.createElement("button",{className:"icon-btn",type:"button",onClick:h,"aria-label":"Attach",disabled:d},e.createElement(oa,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:d||!t.trim(),"aria-label":"Send message"},e.createElement(ra,null)))}function Ra({open:t,onSelect:s,onClose:l}){const c=u.useRef(null);return Je(c,l,t),t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:c},e.createElement(Fn,{data:Rt,onEmojiSelect:s,theme:"light",set:"apple",getSpritesheetURL:()=>Vn,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiSize:30,emojiButtonSize:46,emojiButtonRadius:"8px"}))):null}function Ma({chat:t,groupedMessages:s,searchValue:l,showSearch:c,onToggleSearch:h,onSearchChange:p,onBack:d,onSend:B,composerValue:A,onComposerChange:w,onEmoji:b,onAttach:Z,emojiOpen:R,onEmojiSelect:m,onEmojiClose:M,composerRef:y,typing:_,conversationLoading:te,messageListRef:ye,matchCount:Q,onMenuAction:j,attachmentPreview:Ne,onOpenAttachmentPreview:le,onCloseAttachmentPreview:oe,onSaveAttachmentPreview:ce,onReportAttachmentPreview:Me}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Qe,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(Ne)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(Aa,{preview:Ne,onClose:oe,onSave:ce,onReport:Me}));const he=ee(t),ve=!!t.launchPending,ne=ve?[{label:"Close chat",onSelect:()=>j("close")}]:[{label:"View profile",onSelect:()=>j("profile")},{label:"Close chat",onSelect:()=>j("close")},{label:"Delete chat",onSelect:()=>j("delete")},{label:"Block",onSelect:()=>j("block")},{label:"Report",onSelect:()=>j("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:d,"aria-label":"Back to chats"},e.createElement(Ot,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},G(t)?e.createElement(re,{className:"avatar-blocked-icon",size:16}):pe(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},he),e.createElement("div",{className:"conversation-status"},ve?e.createElement("span",null,"Start conversation"):_?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(Xe,{ariaLabel:"Conversation menu",items:ne}))),c?e.createElement("div",{className:"conversation-search"},e.createElement(Ut,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:z=>p(z.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},Q," match",Q===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:ye},te?e.createElement(xa,null):s.length===0?e.createElement(Qe,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):s.map(z=>z.type==="day"?e.createElement("div",{key:z.id,className:"day-separator"},z.label):e.createElement(Ta,{key:z.id,message:z.message,query:l.trim(),onPreviewImage:le})),_&&!l&&!te?e.createElement(Ba,null):null,!te&&G(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(Pa,{value:A,onChange:w,onSend:B,onEmoji:b,onAttach:Z,inputRef:y,disabled:G(t),emojiActive:R}),e.createElement(Ra,{open:R,onSelect:m,onClose:M}))}function La({activeKey:t,onSelect:s}){const l=[{key:"home",label:"Home",icon:ma},{key:"archive",label:"Archive",icon:da},{key:"chats",label:"Chats",icon:ua},{key:"block",label:"Block",icon:re},{key:"profile",label:"My Profile",icon:pa}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},l.map(c=>{const h=c.icon;return e.createElement("button",{key:c.key,className:`nav-btn ${t===c.key?"active":""}`,type:"button",onClick:()=>s(c.key),"aria-label":c.label},e.createElement("span",{className:"icon-box"},e.createElement(h,null)),e.createElement("span",null,c.label))}))}function $a({currentUser:t=de,initialChats:s=Kn,initialMessages:l=Wn}){const c={...de,...t&&typeof t=="object"?t:{}},h=Array.isArray(s)?s:[],p=l&&typeof l=="object"?l:{},d=u.useMemo(()=>Gn(),[]),B=!!(d.conversationId||d.recipientId),A=u.useRef(!B),[w,b]=u.useState(h),[Z,R]=u.useState(p),[m,M]=u.useState(null),[y,_]=u.useState(d.recipientId?{id:d.recipientId,name:d.recipientName||"Business"}:null),[te,ye]=u.useState(""),[Q,j]=u.useState(""),[Ne,le]=u.useState(!1),[oe,ce]=u.useState(""),[Me,he]=u.useState(!1),[ve,ne]=u.useState(!1),[z,et]=u.useState(!1),[H,tt]=u.useState(null),[nt,ke]=u.useState([]),[Le,$e]=u.useState([]),[De,at]=u.useState(!1),[J,Ue]=u.useState(null),[jt,Oe]=u.useState(!1),[Ce,we]=u.useState(""),[st,Se]=u.useState(""),[ie,_e]=u.useState(null),[V,je]=u.useState(null),[Ua,rt]=u.useState(null),[lt,ot]=u.useState(!1),[Ft,Ie]=u.useState(null),[Te,Fe]=u.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[Vt,ct]=u.useState(c),[me,it]=u.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[U,Ae]=u.useState("chats"),mt=u.useRef(null),Ee=u.useRef(null),Ve=u.useRef(null),ge=u.useRef(null),ae=u.useRef(null),X=u.useRef(null),L=u.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),x=Te.sessionId,P=Te.sessionCsrf,D=Te.userId,ze=Te.realtimeToken,I=!!(x&&P&&D),T=w.find(n=>n.id===m)||null,zt=u.useMemo(()=>Zn(y),[y]),O=T||zt,Ht=u.useMemo(()=>w.filter(n=>n.archived),[w]),Kt=u.useMemo(()=>{const n=new Map;return nt.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[nt]),He=u.useMemo(()=>w.filter(n=>!n.archived),[w]),Wt=u.useMemo(()=>{const n=te.trim().toLowerCase();return n?He.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):He},[He,te]),Be=m?Z[m]||[]:[],Ke=u.useMemo(()=>{const n=Q.trim().toLowerCase();return n?Be.filter(a=>a.text.toLowerCase().includes(n)):Be},[Be,Q]),Yt=u.useMemo(()=>Jn(Ke),[Ke]),qt=!!(m&&Ft===m),ut=()=>{X.current&&(window.clearTimeout(X.current),X.current=null),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null)},xe=async n=>{const a=ae.current;if(!a||!D)return;const r=!!n,i=Date.now(),o=L.current;if(!(o.lastValue===r&&i-o.lastSentAt<600)){o.lastValue=r,o.lastSentAt=i;try{await a.send({type:"broadcast",event:"typing",payload:{isTyping:r,userId:String(D)}})}catch{}}};u.useEffect(()=>{let n=!1;return(async()=>{if(!m||!D||!ze||!I){ne(!1);return}try{const r=await Pn();if(!r||n)return;r.realtime.setAuth(ze);const i=ae.current;if(i)try{await i.unsubscribe()}catch{}ae.current=null,ut(),L.current.lastValue=!1;const o=r.channel(`conversation:${m}`,{config:{presence:{key:`chat:${String(D)}`}}}),E=()=>{try{const g=typeof o.presenceState=="function"?o.presenceState():{};let v=!1;for(const N of Object.values(g||{})){const k=Array.isArray(N)?N:[N];for(const C of k){const S=String((C==null?void 0:C.userId)||(C==null?void 0:C.user_id)||"");if(S&&S!==String(D)){v=!0;break}}if(v)break}b(N=>N.map(k=>k.id!==m||k.hasBlockingRelationship||k.blockedByOther?k:v?{...k,online:!0,presence:"online"}:{...k,online:!1,presence:"offline"}))}catch{}};o.on("presence",{event:"sync"},E),o.on("presence",{event:"join"},E),o.on("presence",{event:"leave"},E),o.on("broadcast",{event:"typing"},({payload:g})=>{const v=String((g==null?void 0:g.userId)||"");if(!v||v===String(D))return;const N=!!(g!=null&&g.isTyping);ne(N),X.current&&(window.clearTimeout(X.current),X.current=null),N&&(X.current=window.setTimeout(()=>{ne(!1),X.current=null},3e3))}),o.subscribe(async g=>{if(!n){if(g!=="SUBSCRIBED"){console.warn("Realtime channel status",g,o.topic);return}try{await o.track({userId:String(D),at:new Date().toISOString()}),E()}catch{}}}),ae.current=o}catch{n||ne(!1)}})(),()=>{n=!0;const r=ae.current;if(ae.current=null,r)try{r.unsubscribe()}catch{}ut(),L.current.lastValue=!1,ne(!1)}},[m,I,D,ze]),u.useEffect(()=>{if(!m||!D||!ae.current)return;const n=oe.trim().length>0,a=Date.now(),r=L.current;n!==r.lastValue&&a-r.lastSentAt>600&&xe(n),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{L.current.idleTimer=null,xe(!1)},2e3))},[oe,m,D]),u.useEffect(()=>{if(!m||Q.trim())return;const n=mt.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[m,Be.length,ve,Q]),u.useEffect(()=>{m||he(!1)},[m]),u.useEffect(()=>{je(null)},[m]),u.useEffect(()=>()=>{ge.current&&clearTimeout(ge.current)},[]),u.useEffect(()=>{(!m||!I)&&Ie(null)},[m,I]);const f=n=>{rt(n),ge.current&&clearTimeout(ge.current),ge.current=setTimeout(()=>rt(null),2400)},dt=(n,a={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const r=!!(a!=null&&a.silent);return Tt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),M(null),_(null),r||f("Session missing or expired. Please log in again."),!0},Gt=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",i=!!n.attachmentIsImage||r.startsWith("image/");if(!a||!i)return;const o=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";je({url:a,name:o,messageId:typeof n.id=="string"?n.id:""})},Zt=()=>{je(null)},Qt=async()=>{if(!(V!=null&&V.url))return;const n=V.name||"photo";try{const a=await fetch(V.url);if(!a.ok)throw new Error("download_failed");const r=await a.blob(),i=window.URL.createObjectURL(r),o=document.createElement("a");o.href=i,o.download=n,document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(i),f("Image saved.")}catch{const a=document.createElement("a");a.href=V.url,a.target="_blank",a.rel="noreferrer",a.click(),f("Could not save directly. Opened image in a new tab.")}},Jt=()=>{if(!T){f("No chat selected.");return}_e(T),we(""),Se(V!=null&&V.name?`Photo attachment: ${V.name}`:"Photo attachment"),Oe(!0)};u.useEffect(()=>{if(!m||!I)return;let n=!1;Ie(m);const a=async({silent:i=!1}={})=>{try{const{messages:o,chatPatch:E}=await Rn({sessionId:x,sessionCsrf:P,conversationId:m,currentUserId:D});if(n)return;R(g=>{const v=g[m]||[],N=new Set(o.map(C=>C.id)),k=v.filter(C=>C.id&&C.id.startsWith("m-")&&!N.has(C.id));return{...g,[m]:[...o,...k]}}),b(g=>g.map(v=>v.id===m?{...v,...E||{},unread:0}:v));try{await Mn({sessionId:x,sessionCsrf:P,conversationId:m})}catch{}}catch(o){if(!n&&dt(o))return;!n&&!i&&f((o==null?void 0:o.message)||"Failed to load chat messages.")}finally{n||Ie(o=>o===m?null:o)}};a();const r=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[m,I,x,P,D]);const Xt=n=>{n&&(Ue(n),at(!0))},ft=()=>{at(!1),Ue(null)},We=n=>{n&&(_e(n),we(""),Se(""),Oe(!0))},pt=()=>{Oe(!1),_e(null),we(""),Se("")},en=async()=>{var i;if(!ie||!Ce)return;if(!I){f("Session missing or expired. Please log in again.");return}const n=((i=It.find(o=>o.value===Ce))==null?void 0:i.label)||Ce,a=st.trim(),r=a?`${n} - ${a}`:n;try{await $n({sessionId:x,sessionCsrf:P,conversationId:ie.id,recipientId:ie.otherPartyId,reason:r});try{const o=await kt({sessionId:x,sessionCsrf:P});$e(o)}catch{}pt(),f("Report sent.")}catch(o){f((o==null?void 0:o.message)||"Failed to submit report.")}},se=({title:n,message:a,confirmLabel:r,onConfirm:i})=>{it({open:!0,title:n,message:a,confirmLabel:r,onConfirm:i})},q=()=>{it(n=>({...n,open:!1}))},tn=async(n,a,r={})=>{const i=!!(r!=null&&r.silent);if(lt)return!1;const o=n.trim(),E=a.trim();if(!o||!E)return i||f("Session credentials missing. Please log in again."),!1;ot(!0);try{const g=await Un({sessionId:o,sessionCsrf:E}),{chats:v,blockedAccounts:N,reports:k,currentUser:C}=await On({sessionId:o,sessionCsrf:E});Fe({sessionId:o,sessionCsrf:E,userId:g.userId,realtimeToken:g.token||""}),ct(C?{...de,...C}:{...de,...c}),qn(o,E),b(v),ke(N),R({}),$e(k);let S=null,ue=null;if(!A.current){if(d.conversationId){const K=v.find(W=>W.id===d.conversationId);K&&(S=K.id)}if(!S&&d.recipientId){const K=v.find(W=>W.otherPartyId===d.recipientId);K?S=K.id:ue={id:d.recipientId,name:d.recipientName||"Business"}}A.current=!0}return _(ue),M(S),ye(""),j(""),le(!1),Ae("chats"),!i&&v.length===0?f("Connected. No chats found."):i||f(`Connected. Loaded ${v.length} chat${v.length===1?"":"s"}.`),!0}catch(g){const v=dt(g,{silent:i});return!i&&!v&&f((g==null?void 0:g.message)||"Failed to restore your session."),!1}finally{ot(!1)}};u.useEffect(()=>{let n=!1;return(async()=>{if(I)return;const r=Yn();if(!r){n||f("Session missing or expired. Please log in again.");return}await tn(r.sessionId,r.sessionCsrf,{silent:!0})||n||f("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const ht=async(n,a={})=>{a.unarchive&&!await bt(n,{clearActive:!1,toast:!0})||(M(n),_(null),I&&Ie(n),b(r=>r.map(i=>i.id===n?{...i,unread:0}:i)),le(!1),j(""))},vt=(n,a,r)=>{R(i=>{const o=i[n]||[];return{...i,[n]:o.map(E=>E.id===a?{...E,status:r}:E)}})},nn=async()=>{const n=oe.trim(),a=m||"",r=a?"":(y==null?void 0:y.id)||"",i=(T==null?void 0:T.name)||(y==null?void 0:y.name)||d.recipientName||"Business",o=(T==null?void 0:T.color)||"#3b82f6";if(!n||!!!(a||r))return;if(G(O)){f(O!=null&&O.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(I){try{const v=await Ln({sessionId:x,sessionCsrf:P,conversationId:a||void 0,recipientId:r||void 0,content:n}),N=Ct(v==null?void 0:v.data,D),k=(typeof N.chatId=="string"?N.chatId.trim():"")||a;if(!k)throw new Error("Failed to resolve conversation ID.");R(C=>({...C,[k]:[...C[k]||[],N]})),ce(""),b(C=>{const S=N.timestamp||new Date().toISOString();if(!C.find(F=>F.id===k))return[{id:k,name:i,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:N.text||n,lastTime:S,unread:0,online:!1,presence:"",color:o,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:r||(y==null?void 0:y.id)||""},...C];const K=C.map(F=>F.id===k?{...F,lastMessage:N.text||n,lastTime:N.timestamp||S,unread:0}:F),W=K.find(F=>F.id===k),Pe=K.filter(F=>F.id!==k);return W?[W,...Pe]:K}),M(k),_(null),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null),L.current.lastValue=!1,xe(!1)}catch(v){f((v==null?void 0:v.message)||"Failed to send message.")}return}if(!a){f("Session missing or expired. Please log in again.");return}const g={id:`m-${Date.now()}`,chatId:a,sender:"me",text:n,timestamp:new Date().toISOString(),status:"sent"};R(v=>({...v,[a]:[...v[a]||[],g]})),ce(""),b(v=>{const N=v.map(S=>S.id===a?{...S,lastMessage:n,lastTime:g.timestamp,unread:0}:S),k=N.find(S=>S.id===a),C=N.filter(S=>S.id!==a);return k?[k,...C]:N}),setTimeout(()=>vt(a,g.id,"delivered"),900),setTimeout(()=>vt(a,g.id,"read"),2e3),L.current.idleTimer&&(window.clearTimeout(L.current.idleTimer),L.current.idleTimer=null),L.current.lastValue=!1,xe(!1)},an=()=>{if(!m&&!(y!=null&&y.id)){f("Select a chat to add emojis.");return}he(n=>!n)},sn=()=>{he(!1)},rn=n=>{var r,i;const a=(n==null?void 0:n.native)??((i=(r=n==null?void 0:n.skins)==null?void 0:r[0])==null?void 0:i.native)??"";a&&ce(o=>{const{nextValue:E,caret:g}=aa(o,a,Ee.current);return requestAnimationFrame(()=>{Ee.current&&document.activeElement===Ee.current&&Ee.current.setSelectionRange(g,g)}),E})},ln=()=>{if(!m&&!(y!=null&&y.id)){f("Select a chat first.");return}if(!I){f("Session missing or expired. Please log in again.");return}if(G(O)){f(O!=null&&O.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}Ve.current&&Ve.current.click()},on=async n=>{var v;const a=n.target,r=(v=a==null?void 0:a.files)==null?void 0:v[0];if(a&&(a.value=""),!r)return;if(!m&&!(y!=null&&y.id)){f("Select a chat first.");return}if(!I){f("Session missing or expired. Please log in again.");return}if(G(O)){f(O!=null&&O.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const i=m||"",o=i?"":(y==null?void 0:y.id)||"",E=(T==null?void 0:T.name)||(y==null?void 0:y.name)||d.recipientName||"Business",g=(T==null?void 0:T.color)||"#3b82f6";try{const N=await Dn({sessionId:x,sessionCsrf:P,conversationId:i||void 0,recipientId:o||void 0,file:r}),k=Ct(N==null?void 0:N.data,D),C=(typeof k.chatId=="string"?k.chatId.trim():"")||i;if(!C)throw new Error("Failed to resolve conversation ID.");R(S=>({...S,[C]:[...S[C]||[],k]})),b(S=>{const ue=k.timestamp||new Date().toISOString();if(!S.find(Y=>Y.id===C))return[{id:C,name:E,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:k.text||r.name,lastTime:ue,unread:0,online:!1,presence:"",color:g,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:o||(y==null?void 0:y.id)||""},...S];const W=S.map(Y=>Y.id===C?{...Y,lastMessage:k.text||r.name,lastTime:k.timestamp||ue,unread:0}:Y),Pe=W.find(Y=>Y.id===C),F=W.filter(Y=>Y.id!==C);return Pe?[Pe,...F]:W}),M(C),_(null),f("Attachment sent.")}catch(N){f((N==null?void 0:N.message)||"Failed to send attachment.")}},cn=n=>{R(a=>({...a,[n]:[]})),b(a=>a.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},mn=()=>{if(m){cn(m),f("Cleared current chat.");return}const n={};w.forEach(a=>{n[a.id]=[]}),R(n),b(a=>a.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),f("Cleared all chats.")},Ye=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(b(r=>r.filter(i=>!a.has(i.id))),R(r=>{const i={...r};return a.forEach(o=>{delete i[o]}),i}),m&&a.has(m)&&M(null))},qe=async(n,a={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const i=a.toast!==!1;if(I)try{await St({sessionId:x,sessionCsrf:P,conversationId:r})}catch(o){return f((o==null?void 0:o.message)||"Failed to delete chat."),!1}return Ye([r]),i&&f("Chat deleted."),!0},un=async()=>{const n=w.map(i=>i.id).filter(Boolean);if(n.length===0)return f("No chats to delete."),!1;if(!I)return Ye(n),f("All chats deleted."),!0;const a=[];for(const i of n)try{await St({sessionId:x,sessionCsrf:P,conversationId:i}),a.push(i)}catch{}a.length>0&&Ye(a);const r=n.length-a.length;return a.length===0?(f("Failed to delete chats."),!1):r===0?(f("All chats deleted."),!0):(f(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${r} failed.`),!1)},dn=async()=>{if(m){await qe(m);return}await un()},fn=(n,a)=>{const r=w.find(v=>v.id===n),i=(r==null?void 0:r.otherPartyId)||n;if(!i)return;const o=a||new Date().toISOString(),E=(r==null?void 0:r.name)||"Unknown",g=(r==null?void 0:r.color)||"#3b82f6";ke(v=>{const N=v.filter(k=>k.id!==i);return[{id:i,name:E,blockedAt:o,color:g},...N]})},Et=({accountId:n,conversationId:a=""})=>{const r=typeof n=="string"?n.trim():"",i=typeof a=="string"?a.trim():"";b(o=>o.map(E=>{const g=!!i&&E.id===i,v=!!r&&E.otherPartyId===r;if(!g&&!v)return E;const N=!!E.blockedByOther;return{...E,blocked:!1,blockedByMe:!1,hasBlockingRelationship:N,blockedAt:void 0}})),r&&ke(o=>o.filter(E=>E.id!==r))},gt=async n=>{if(!n)return!1;if(I)try{await zn({sessionId:x,sessionCsrf:P,conversationId:n})}catch(r){return f((r==null?void 0:r.message)||"Failed to block account."),!1}const a=new Date().toISOString();return b(r=>r.map(i=>i.id===n?{...i,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:i)),fn(n,a),m===n&&M(null),f("Chat blocked."),!0},pn=async n=>{if(!n)return!1;const a=w.find(i=>i.id===n),r=(a==null?void 0:a.otherPartyId)||"";if(I)try{await wt({sessionId:x,sessionCsrf:P,conversationId:n||void 0,recipientId:r||void 0})}catch(i){return f((i==null?void 0:i.message)||"Failed to unblock account."),!1}return Et({accountId:r,conversationId:n}),f("Account unblocked."),!0},hn=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const r=w.find(o=>o.otherPartyId===a),i=(r==null?void 0:r.id)||"";if(I)try{await wt({sessionId:x,sessionCsrf:P,conversationId:i||void 0,recipientId:a})}catch(o){return f((o==null?void 0:o.message)||"Failed to unblock account."),!1}return Et({accountId:a,conversationId:i}),f("Account unblocked."),!0},vn=async(n,a={})=>{if(!n)return!1;const r=a.clearActive!==!1,i=a.toast!==!1;if(I)try{await jn({sessionId:x,sessionCsrf:P,conversationId:n})}catch(o){return f((o==null?void 0:o.message)||"Failed to archive chat."),!1}return b(o=>o.map(E=>E.id===n?{...E,archived:!0,archivedAt:new Date().toISOString()}:E)),r&&m===n&&M(null),i&&f("Chat archived."),!0},bt=async(n,a={})=>{if(!n)return!1;const r=a.clearActive===!0,i=a.toast!==!1;if(I)try{await _n({sessionId:x,sessionCsrf:P,conversationId:n})}catch(o){return f((o==null?void 0:o.message)||"Failed to restore chat."),!1}return b(o=>o.map(E=>E.id===n?{...E,archived:!1,archivedAt:void 0}:E)),r&&m===n&&M(null),i&&f("Chat restored from archive."),!0},yt=n=>{if(n==="profile"){if(!m){f("No chat selected.");return}const a=w.find(r=>r.id===m)||null;tt(a),et(!0);return}if(n==="close"){M(null),_(null),le(!1),j(""),f("Chat closed.");return}if(n==="block"){if(!m)return;const a=w.find(i=>i.id===m),r=(a==null?void 0:a.id)||m;se({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{q(),await gt(r)}});return}if(n==="delete"){const a=T?`Delete chat with ${ee(T)}?`:"Delete all chats?";se({title:a,message:T?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),dn()}});return}if(n==="clear"){const a=T?`Clear chat with ${T.name}?`:"Clear all chats?";se({title:a,message:T?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{q(),mn()}});return}n==="report"&&We(T)},En=n=>{yt(n)},gn=(n,a)=>{const r=w.find(i=>i.id===n);if(r){if(a==="delete"){se({title:`Delete chat with ${ee(r)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),qe(n)}});return}if(a==="report"){We(r);return}if(a==="archive"){vn(n,{clearActive:!0,toast:!0});return}}},bn=()=>{le(n=>{const a=!n;return a||j(""),a})},Ge=()=>{et(!1),tt(null)},yn=()=>{H&&se({title:`Delete chat with ${ee(H)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{q(),(async()=>await qe(H.id)&&Ge())()}})},Nn=()=>{if(!H)return;const n=H.id,a=!!H.blocked,r=ee(H);se({title:a?`Unblock ${r}?`:`Block ${r}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{q(),(a?await pn(n):await gt(n))&&Ge()}})},kn=()=>{H&&We(H)},Cn=n=>{if(n==="home"){Ae(n),window.location.href="homepage.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&M(null),Ae(n);const a=n.charAt(0).toUpperCase()+n.slice(1);f(`${a} selected.`)},wn=n=>{bt(n,{clearActive:!1,toast:!0})},Sn=n=>{hn(n)},In=[{label:"Delete chats",onSelect:()=>yt("delete")},{label:"Reports",onSelect:()=>Ae("reports")},{label:"Logout",onSelect:()=>se({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{q(),Tt(),Fe({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),ct({...de,...c}),f("Logged out.")}})}],be=!!(m||y!=null&&y.id||z),Nt=be||U==="archive"||U==="block"||U==="profile"||U==="reports",Tn=lt;return u.useEffect(()=>{if(!I||U!=="block")return;let n=!1;return(async()=>{try{const a=await Bn({sessionId:x,sessionCsrf:P});n||ke(a)}catch{}})(),()=>{n=!0}},[I,U,x,P]),u.useEffect(()=>{if(!I||U!=="reports")return;let n=!1;return(async()=>{try{const a=await kt({sessionId:x,sessionCsrf:P});n||$e(a)}catch{}})(),()=>{n=!0}},[I,U,x,P]),u.useEffect(()=>{if(!De||!(J!=null&&J.id))return;const n=Le.find(a=>a.id===J.id);if(!n){ft();return}Ue(n)},[De,J==null?void 0:J.id,Le]),e.createElement("div",{className:`chp-app${be?" chat-only":""}${Nt&&!be?" no-header":""}`},Nt?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:xn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(Xe,{ariaLabel:"App menu",items:In}))),e.createElement("main",{className:"chp-main","data-view":be?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},U==="archive"?e.createElement(Na,{chats:Ht,onOpenChat:ht,onUnarchive:wn}):U==="block"?e.createElement(ka,{chats:Kt,onUnblock:Sn}):U==="profile"?e.createElement(ya,{currentUser:Vt}):U==="reports"?e.createElement(Ca,{reports:Le,onOpenReport:Xt}):e.createElement(Ia,{chats:Wt,searchValue:te,onSearchChange:ye,activeChatId:m,onOpenChat:ht,onChatAction:gn})),e.createElement("section",{className:"chp-pane chp-convo-pane"},z?e.createElement(ba,{chat:H,onClose:Ge,onDelete:yn,onBlock:Nn,onReport:kn}):e.createElement(Ma,{chat:O,groupedMessages:Yt,searchValue:Q,showSearch:Ne,onToggleSearch:bn,onSearchChange:j,onBack:()=>{M(null),_(null)},onSend:nn,composerValue:oe,onComposerChange:ce,onEmoji:an,onAttach:ln,emojiOpen:Me,onEmojiSelect:rn,onEmojiClose:sn,composerRef:Ee,typing:ve,conversationLoading:qt,messageListRef:mt,matchCount:Ke.length,onMenuAction:En,attachmentPreview:V,onOpenAttachmentPreview:Gt,onCloseAttachmentPreview:Zt,onSaveAttachmentPreview:Qt,onReportAttachmentPreview:Jt}))),be?null:e.createElement(La,{activeKey:U,onSelect:Cn}),Tn?e.createElement(Sa,null):null,e.createElement(wa,{open:De,report:J,onClose:ft}),e.createElement(ga,{open:jt,onClose:pt,reasons:It,value:Ce,onChange:we,details:st,onDetailsChange:Se,onSubmit:en,targetName:ie==null?void 0:ie.name}),e.createElement(Ea,{open:me.open,title:me.title,message:me.message,confirmLabel:me.confirmLabel,onConfirm:()=>{me.onConfirm?me.onConfirm():q()},onCancel:q}),e.createElement("input",{ref:Ve,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:on,style:{display:"none"}}))}const Da=Hn(document.getElementById("root"));Da.render(e.createElement(e.StrictMode,null,e.createElement($a,null)));
