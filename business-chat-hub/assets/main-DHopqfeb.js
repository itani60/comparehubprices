import{r as u,f as dn,a as mt,R as e,l as fn,g as pn,b as hn,m as En,c as vn,d as gn,s as bn,e as ut,h as yn,i as Nn,u as Cn,j as dt,k as kn,n as wn,o as ft,p as Sn}from"./realtimeClient-DHQhtgbp.js";const Ue={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},In=[],Tn={},_e="chp_chat_session",pt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function ve(){if(typeof window>"u")return null;try{const n=window.localStorage.getItem(_e);if(!n)return null;const s=JSON.parse(n),r=typeof(s==null?void 0:s.sessionId)=="string"?s.sessionId.trim():"",m=typeof(s==null?void 0:s.sessionCsrf)=="string"?s.sessionCsrf.trim():"";return!r||!m?null:{sessionId:r,sessionCsrf:m}}catch{return null}}function An(n,s){if(!(typeof window>"u"))try{window.localStorage.setItem(_e,JSON.stringify({sessionId:n,sessionCsrf:s}))}catch{}}function ht(){if(!(typeof window>"u"))try{window.localStorage.removeItem(_e)}catch{}}function X(n){if(!n)return"";const s=n.split(" ").filter(Boolean),r=s[0]?s[0][0]:"",m=s.length>1?s[s.length-1][0]:"";return(r+m).toUpperCase()}function H(n){return!n||typeof n!="object"||n.blockedByOther?"User unavailable":n.name||"Unknown"}function _(n){return!!(n&&(n.blocked||n.blockedByOther))}function vt(n){if(!n)return"";const s=new Date(n);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function gt(n){if(!n)return"";const s=new Date(n);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function $e(n){if(!n)return"";const s=new Date(n);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function bt(n){const s=String(n||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "):"Status unavailable"}function yt(n){const s=String(n||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function Et(n,s){return n.getFullYear()===s.getFullYear()&&n.getMonth()===s.getMonth()&&n.getDate()===s.getDate()}function Rn(n){const s=new Date(n);if(Number.isNaN(s.getTime()))return"";const r=new Date,m=new Date;return m.setDate(r.getDate()-1),Et(s,r)?"Today":Et(s,m)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Bn(n){const s=[];let r="";return n.forEach(m=>{const E=m.timestamp.slice(0,10);E!==r&&(s.push({type:"day",id:`day-${E}`,label:Rn(m.timestamp)}),r=E),s.push({type:"message",id:m.id,message:m})}),s}function Dn(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function xn(n,s){if(!s)return n;const r=Dn(s);return n.split(new RegExp(`(${r})`,"ig")).map((E,h)=>E.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:h,className:"msg-highlight"},E):e.createElement("span",{key:h},E))}function Nt(n,s,r){u.useEffect(()=>{if(!r)return;const m=E=>{!n.current||n.current.contains(E.target)||s()};return document.addEventListener("mousedown",m),document.addEventListener("touchstart",m),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("touchstart",m)}},[n,s,r])}function D({children:n,size:s=20,className:r}){return e.createElement("svg",{className:r,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},n)}const Ln=n=>e.createElement(D,{...n},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Ct=n=>e.createElement(D,{...n},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),kt=n=>e.createElement(D,{...n},e.createElement("polyline",{points:"15 6 9 12 15 18"})),Mn=n=>e.createElement(D,{...n},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),On=n=>e.createElement(D,{...n},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),Pn=n=>e.createElement(D,{...n},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),Un=n=>e.createElement(D,{...n},e.createElement("polyline",{points:"5 12 9 16 19 6"})),$n=n=>e.createElement(D,{...n},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),Fn=n=>e.createElement(D,{...n},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),_n=n=>e.createElement(D,{...n},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),jn=n=>e.createElement(D,{...n},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),Vn=n=>e.createElement(D,{...n},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),J=n=>e.createElement(D,{...n},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Hn=n=>e.createElement(D,{...n},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),zn=n=>e.createElement(D,{...n},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),wt=n=>e.createElement(D,{...n},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function je({ariaLabel:n,items:s}){const[r,m]=u.useState(!1),E=u.useRef(null);return Nt(E,()=>m(!1),r),e.createElement("div",{className:"menu-wrap",ref:E},e.createElement("button",{className:"icon-btn","aria-label":n,"aria-haspopup":"menu","aria-expanded":r,onClick:()=>m(h=>!h),type:"button"},e.createElement(Ln,null)),r?e.createElement("div",{className:"dropdown",role:"menu"},s.map(h=>e.createElement("button",{key:h.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{m(!1),h.onSelect()}},h.label))):null)}function Kn({status:n}){if(!n)return null;if(n==="sent")return e.createElement(Un,{className:"status-icon"});const s=n==="read"?"status-icon read":"status-icon";return e.createElement($n,{className:s})}function Yn({open:n,title:s,message:r,confirmLabel:m,onConfirm:E,onCancel:h}){return n?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,r),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:h},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:E},m)))):null}function Wn({open:n,sessionId:s,sessionCsrf:r,error:m,busy:E=!1,onSessionIdChange:h,onSessionCsrfChange:f,onConnect:b,onCancel:g}){return n?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Connect session"},e.createElement("div",{className:"connect-dialog"},e.createElement("h3",null,"Connect Session"),e.createElement("p",null,"Enter your session credentials to connect."),e.createElement("div",{className:"connect-form"},e.createElement("label",{className:"connect-field"},e.createElement("span",null,"Session ID"),e.createElement("input",{className:"connect-input",type:"text",value:s,onChange:y=>h(y.target.value),placeholder:"Enter session id",autoComplete:"off"})),e.createElement("label",{className:"connect-field"},e.createElement("span",null,"Session CSRF"),e.createElement("input",{className:"connect-input",type:"text",value:r,onChange:y=>f(y.target.value),placeholder:"Enter session csrf",autoComplete:"off"}))),m?e.createElement("p",{className:"connect-error"},m):null,e.createElement("div",{className:"connect-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:g},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:b,disabled:E},E?"Connecting...":"Connect")))):null}function qn({open:n,onClose:s,reasons:r,value:m,onChange:E,details:h,onDetailsChange:f,onSubmit:b,targetName:g}){const[y,i]=u.useState(!1),A=u.useRef(null),M=r.find(I=>I.value===m);return Nt(A,()=>i(!1),y),u.useEffect(()=>{n||i(!1)},[n]),n?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",g||"this chat","."),e.createElement("div",{className:`report-select${y?" active":""}`,ref:A},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>i(I=>!I),"aria-haspopup":"listbox","aria-expanded":y},e.createElement("span",null,M?M.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},r.map(I=>e.createElement("button",{key:I.value,type:"button",className:`report-select__option${m===I.value?" selected":""}`,onClick:()=>{E(I.value),i(!1)},role:"option","aria-selected":m===I.value},I.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:h,onChange:I=>f(I.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:b,disabled:!m},"Report")))):null}function Jn({chat:n,onClose:s,onDelete:r,onBlock:m,onReport:E}){if(!n)return null;const h=!!n.blockedByOther,f=H(n),b=n.name?n.name.split(" ").filter(Boolean):[],g=b[0]||"",y=b.slice(1).join(" "),i=h?"-":n.firstName||g||"-",A=h?"-":n.lastName||y||"-",M=h?"-":n.suburb||"-",I=h?"-":n.city||"-",U=h?"-":n.province||"-",P=h?"-":n.accountSince||"-",$=h?"-":n.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(kt,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:n.color}},_(n)?e.createElement(J,{className:"avatar-blocked-icon",size:18}):X(f)),e.createElement("div",null,e.createElement("h3",null,f))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",i),e.createElement("p",null,"Family name: ",A),e.createElement("p",null,"Suburb: ",M),e.createElement("p",null,"City: ",I),e.createElement("p",null,"Province: ",U),e.createElement("p",null,"Account since: ",P),e.createElement("p",null,"Account type: ",$)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:r},e.createElement(zn,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:m},e.createElement(J,null),n.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:E},e.createElement(Vn,null),"Report"))))))}function ge({title:n,subtitle:s,children:r}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,n),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},r))}function Zn({currentUser:n}){const s={...Ue,...n&&typeof n=="object"?n:{}},r=s.name||"User";return e.createElement(ge,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},X(r)),e.createElement("div",null,e.createElement("h3",null,r),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function Qn({chats:n,onOpenChat:s,onUnarchive:r}){return e.createElement(ge,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},n.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},n.map(m=>{const E=H(m);return e.createElement("div",{key:m.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:m.color}},_(m)?e.createElement(J,{className:"avatar-blocked-icon",size:16}):X(m.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},E),e.createElement("div",{className:"section-item-sub"},m.lastMessage?m.lastMessage:"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,gt(m.archivedAt||m.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(m.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>r(m.id)},"Unarchive"))))})))}function Gn({chats:n,onUnblock:s}){return e.createElement(ge,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},n.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},n.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color}},e.createElement(J,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,gt(r.blockedAt||r.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(r.id)},"Unblock"))))))}function Xn({reports:n,onOpenReport:s}){return e.createElement(ge,{title:"Reports",subtitle:"Reports you submitted."},n.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},n.map(r=>e.createElement("div",{key:r.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:r.color||"#3b82f6"}},X(r.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},r.name),e.createElement("div",{className:"section-item-sub"},r.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${yt(r.status)}`},bt(r.status)),e.createElement("span",null,$e(r.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(r)},"View report"))))))}function ea({open:n,report:s,onClose:r}){return!n||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:r,"aria-label":"Close report details"},e.createElement(wt,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${yt(s.status)}`},bt(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},$e(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},$e(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Fe({title:n,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,n),e.createElement("p",null,s))}function ta(){const n=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},n.map((r,m)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:m},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((r,m)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:m},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function na({chats:n,searchValue:s,onSearchChange:r,activeChatId:m,onOpenChat:E,onChatAction:h}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(Ct,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:f=>r(f.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},n.length===0?e.createElement(Fe,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):n.map(f=>{const b=H(f);return e.createElement("div",{key:f.id,className:`chat-item ${m===f.id?"active":""}`,onClick:()=>E(f.id),onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),E(f.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${b}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:f.color}},_(f)?e.createElement(J,{className:"avatar-blocked-icon",size:16}):X(f.name)),f.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},b),e.createElement("span",{className:"chat-time"},vt(f.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},f.lastMessage?f.lastMessage:"No messages yet"),f.unread>0?e.createElement("span",{className:"chat-unread"},f.unread):null)),e.createElement("div",{className:"chat-actions",onClick:g=>g.stopPropagation(),onKeyDown:g=>g.stopPropagation()},e.createElement(je,{ariaLabel:`More options for ${b}`,items:[{label:"Delete chat",onSelect:()=>h(f.id,"delete")},{label:"Report",onSelect:()=>h(f.id,"report")},{label:"Archive",onSelect:()=>h(f.id,"archive")}]})))})))}function aa({message:n,query:s,onPreviewImage:r}){const m=n.sender==="me",E=typeof n.attachmentUrl=="string"?n.attachmentUrl:"",h=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",f=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"Attachment",b=!!n.attachmentIsImage||h.startsWith("image/"),g=!!n.attachmentIsVideo||h.startsWith("video/"),y=typeof n.text=="string"&&n.text.trim().length>0,i={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:y?"8px":"0"};return e.createElement("div",{className:`message-row ${m?"me":"them"}`},e.createElement("div",{className:`message-bubble ${m?"outgoing":"incoming"}`},E?e.createElement("div",{className:"message-attachment"},b?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{r&&r(n)},"aria-label":`Preview ${f}`},e.createElement("img",{src:E,alt:f,loading:"lazy",style:i})):g?e.createElement("video",{controls:!0,preload:"metadata",style:i},e.createElement("source",{src:E,type:h||void 0})):e.createElement("a",{href:E,target:"_blank",rel:"noreferrer"},"Open attachment")):null,y?e.createElement("div",{className:"message-text"},xn(n.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,vt(n.timestamp)),m?e.createElement(Kn,{status:n.status}):null)))}function sa({preview:n,onClose:s,onSave:r,onReport:m}){return n?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(wt,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:n.url,alt:n.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},n.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:r},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:m},"Report Photo"))):null}function la(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function ra(){const n=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},n.map((s,r)=>e.createElement("div",{key:r,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function ca({value:n,onChange:s,onSend:r,onEmoji:m,onAttach:E,disabled:h=!1}){const f=u.useRef(null);u.useEffect(()=>{const g=f.current;g&&(g.style.height="auto",g.style.height=`${Math.min(g.scrollHeight,120)}px`)},[n]);const b=g=>{g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),!h&&n.trim()&&r())};return e.createElement("div",{className:"composer"},e.createElement("div",{className:"composer-actions"},e.createElement("button",{className:"icon-btn",type:"button",onClick:m,"aria-label":"Emoji",disabled:h},e.createElement(On,null)),e.createElement("button",{className:"icon-btn",type:"button",onClick:E,"aria-label":"Attach",disabled:h},e.createElement(Pn,null))),e.createElement("textarea",{ref:f,rows:1,value:n,onChange:g=>s(g.target.value),onKeyDown:b,placeholder:h?"Unblock to send messages":"Type a message","aria-label":"Message input",disabled:h}),e.createElement("button",{className:"send-btn",type:"button",onClick:r,disabled:h||!n.trim(),"aria-label":"Send message"},e.createElement(Mn,null)))}function oa({chat:n,groupedMessages:s,searchValue:r,showSearch:m,onToggleSearch:E,onSearchChange:h,onBack:f,onSend:b,composerValue:g,onComposerChange:y,onEmoji:i,onAttach:A,typing:M,conversationLoading:I,messageListRef:U,matchCount:P,onMenuAction:$,attachmentPreview:z,onOpenAttachmentPreview:Z,onCloseAttachmentPreview:ee,onSaveAttachmentPreview:se,onReportAttachmentPreview:K}){if(!n)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Fe,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(z)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(sa,{preview:z,onClose:ee,onSave:se,onReport:K}));const be=H(n),le=[{label:"View profile",onSelect:()=>$("profile")},{label:"Close chat",onSelect:()=>$("close")},{label:"Delete chat",onSelect:()=>$("delete")},{label:"Block",onSelect:()=>$("block")},{label:"Report",onSelect:()=>$("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:f,"aria-label":"Back to chats"},e.createElement(kt,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:n.color}},_(n)?e.createElement(J,{className:"avatar-blocked-icon",size:16}):X(n.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},be),e.createElement("div",{className:"conversation-status"},M?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,n.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,n.online?"online":n.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(je,{ariaLabel:"Conversation menu",items:le}))),m?e.createElement("div",{className:"conversation-search"},e.createElement(Ct,{className:"search-icon"}),e.createElement("input",{type:"search",value:r,onChange:T=>h(T.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),r?e.createElement("span",{className:"search-count"},P," match",P===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:U},I?e.createElement(ra,null):s.length===0?e.createElement(Fe,{title:r?"No matches":"No messages yet",subtitle:r?"Try a different phrase.":"Send a message to start the chat."}):s.map(T=>T.type==="day"?e.createElement("div",{key:T.id,className:"day-separator"},T.label):e.createElement(aa,{key:T.id,message:T.message,query:r.trim(),onPreviewImage:Z})),M&&!r&&!I?e.createElement(la,null):null,!I&&_(n)?e.createElement("div",{className:"blocked-notice",role:"note"},n.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(ca,{value:g,onChange:y,onSend:b,onEmoji:i,onAttach:A,disabled:_(n)}))}function ia({activeKey:n,onSelect:s}){const r=[{key:"home",label:"Home",icon:Fn},{key:"archive",label:"Archive",icon:jn},{key:"chats",label:"Chats",icon:_n},{key:"block",label:"Block",icon:J},{key:"profile",label:"My Profile",icon:Hn}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},r.map(m=>{const E=m.icon;return e.createElement("button",{key:m.key,className:`nav-btn ${n===m.key?"active":""}`,type:"button",onClick:()=>s(m.key),"aria-label":m.label},e.createElement("span",{className:"icon-box"},e.createElement(E,null)),e.createElement("span",null,m.label))}))}function ma({currentUser:n=Ue,initialChats:s=In,initialMessages:r=Tn}){const m={...Ue,...n&&typeof n=="object"?n:{}},E=Array.isArray(s)?s:[],h=r&&typeof r=="object"?r:{},[f,b]=u.useState(E),[g,y]=u.useState(h),[i,A]=u.useState(null),[M,I]=u.useState(""),[U,P]=u.useState(""),[$,z]=u.useState(!1),[Z,ee]=u.useState(""),[se,K]=u.useState(!1),[be,le]=u.useState(!1),[T,Ve]=u.useState(null),[He,re]=u.useState([]),[ye,Ne]=u.useState([]),[Ce,ze]=u.useState(!1),[j,ke]=u.useState(null),[St,we]=u.useState(!1),[ce,oe]=u.useState(""),[Ke,ie]=u.useState(""),[Q,Se]=u.useState(null),[O,Ie]=u.useState(null),[da,Ye]=u.useState(null),[It,Te]=u.useState(!1),[We,me]=u.useState(()=>{var t;return((t=ve())==null?void 0:t.sessionId)||""}),[qe,ue]=u.useState(()=>{var t;return((t=ve())==null?void 0:t.sessionCsrf)||""}),[Tt,te]=u.useState(""),[Ae,Je]=u.useState(!1),[At,de]=u.useState(null),[fe,Ze]=u.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[G,Qe]=u.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[L,pe]=u.useState("chats"),Ge=u.useRef(null),Re=u.useRef(null),ne=u.useRef(null),Y=u.useRef(null),V=u.useRef(null),R=u.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),w=fe.sessionId,S=fe.sessionCsrf,x=fe.userId,Be=fe.realtimeToken,N=!!(w&&S&&x),C=f.find(t=>t.id===i)||null,Rt=u.useMemo(()=>f.filter(t=>t.archived),[f]),Bt=u.useMemo(()=>{const t=new Map;return He.forEach(a=>{a!=null&&a.id&&t.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(t.values())},[He]),De=u.useMemo(()=>f.filter(t=>!t.archived),[f]),Dt=u.useMemo(()=>{const t=M.trim().toLowerCase();return t?De.filter(a=>a.name.toLowerCase().includes(t)||(a.lastMessage||"").toLowerCase().includes(t)):De},[De,M]),he=C?g[i]||[]:[],xe=u.useMemo(()=>{const t=U.trim().toLowerCase();return t?he.filter(a=>a.text.toLowerCase().includes(t)):he},[he,U]),xt=u.useMemo(()=>Bn(xe),[xe]),Lt=!!(i&&At===i),Xe=()=>{V.current&&(window.clearTimeout(V.current),V.current=null),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null)},Ee=async(t,{force:a=!1}={})=>{const l=Y.current;if(!l||!x)return;const o=!!t,c=Date.now(),d=R.current;if(!(!a&&d.lastValue===o&&c-d.lastSentAt<600)){d.lastValue=o,d.lastSentAt=c;try{await l.send({type:"broadcast",event:"typing",payload:{isTyping:o,userId:String(x)}})}catch{}}};u.useEffect(()=>{let t=!1;return(async()=>{if(!i||!x||!Be||!N){K(!1);return}try{const l=await pn();if(!l||t)return;l.realtime.setAuth(Be);const o=Y.current;if(o)try{await o.unsubscribe()}catch{}Y.current=null,Xe(),R.current.lastValue=!1;const c=l.channel(`conversation:${i}`,{config:{presence:{key:`chat:${String(x)}`}}});c.on("broadcast",{event:"typing"},({payload:d})=>{const v=String((d==null?void 0:d.userId)||"");if(!v||v===String(x))return;const k=!!(d!=null&&d.isTyping);K(k),V.current&&(window.clearTimeout(V.current),V.current=null),k&&(V.current=window.setTimeout(()=>{K(!1),V.current=null},3e3))}),c.subscribe(async d=>{if(!(t||d!=="SUBSCRIBED"))try{await c.track({userId:String(x),at:new Date().toISOString()})}catch{}}),Y.current=c}catch{t||K(!1)}})(),()=>{t=!0;const l=Y.current;if(Y.current=null,l)try{l.unsubscribe()}catch{}Xe(),R.current.lastValue=!1,K(!1)}},[i,N,x,Be]),u.useEffect(()=>{if(!i||!x||!Y.current)return;const t=Z.trim().length>0,a=Date.now(),l=R.current;t!==l.lastValue&&a-l.lastSentAt>600&&Ee(t,{force:!0}),l.idleTimer&&(window.clearTimeout(l.idleTimer),l.idleTimer=null),t&&(l.idleTimer=window.setTimeout(()=>{R.current.idleTimer=null,Ee(!1,{force:!0})},2e3))},[Z,i,x]),u.useEffect(()=>{if(!i||U.trim())return;const t=Ge.current;t&&requestAnimationFrame(()=>{t.scrollTo({top:t.scrollHeight,behavior:"smooth"})})},[i,he.length,se,U]),u.useEffect(()=>()=>{ne.current&&clearTimeout(ne.current)},[]),u.useEffect(()=>{(!i||!N)&&de(null)},[i,N]),u.useEffect(()=>{Ie(null)},[i]);const p=t=>{Ye(t),ne.current&&clearTimeout(ne.current),ne.current=setTimeout(()=>Ye(null),2400)},Mt=t=>{if(!t||typeof t!="object")return;const a=typeof t.attachmentUrl=="string"?t.attachmentUrl.trim():"",l=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",o=!!t.attachmentIsImage||l.startsWith("image/");if(!a||!o)return;const c=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"photo";Ie({url:a,name:c,messageId:typeof t.id=="string"?t.id:""})},Ot=()=>{Ie(null)},Pt=async()=>{if(!(O!=null&&O.url))return;const t=O.name||"photo";try{const a=await fetch(O.url);if(!a.ok)throw new Error("download_failed");const l=await a.blob(),o=window.URL.createObjectURL(l),c=document.createElement("a");c.href=o,c.download=t,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(o),p("Image saved.")}catch{const a=document.createElement("a");a.href=O.url,a.target="_blank",a.rel="noreferrer",a.click(),p("Could not save directly. Opened image in a new tab.")}},Ut=()=>{if(!C){p("No chat selected.");return}Se(C),oe(""),ie(O!=null&&O.name?`Photo attachment: ${O.name}`:"Photo attachment"),we(!0)};u.useEffect(()=>{if(!i||!N)return;let t=!1;de(i);const a=async({silent:o=!1}={})=>{try{const{messages:c,chatPatch:d}=await hn({sessionId:w,sessionCsrf:S,conversationId:i,currentUserId:x});if(t)return;y(v=>({...v,[i]:c})),b(v=>v.map(k=>k.id===i?{...k,...d||{},unread:0}:k));try{await En({sessionId:w,sessionCsrf:S,conversationId:i})}catch{}}catch(c){!t&&!o&&p((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{t||de(c=>c===i?null:c)}};a();const l=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{t=!0,window.clearInterval(l)}},[i,N,w,S,x]);const $t=t=>{t&&(ke(t),ze(!0))},et=()=>{ze(!1),ke(null)},Le=t=>{t&&(Se(t),oe(""),ie(""),we(!0))},tt=()=>{we(!1),Se(null),oe(""),ie("")},Ft=async()=>{var o;if(!Q||!ce)return;if(!N){p("Connect first to submit reports.");return}const t=((o=pt.find(c=>c.value===ce))==null?void 0:o.label)||ce,a=Ke.trim(),l=a?`${t} - ${a}`:t;try{await yn({sessionId:w,sessionCsrf:S,conversationId:Q.id,recipientId:Q.otherPartyId,reason:l});try{const c=await mt({sessionId:w,sessionCsrf:S});Ne(c)}catch{}tt(),p("Report sent.")}catch(c){p((c==null?void 0:c.message)||"Failed to submit report.")}},W=({title:t,message:a,confirmLabel:l,onConfirm:o})=>{Qe({open:!0,title:t,message:a,confirmLabel:l,onConfirm:o})},F=()=>{Qe(t=>({...t,open:!1}))},_t=()=>{if(te(""),w&&S)me(w),ue(S);else{const t=ve();t&&(me(t.sessionId),ue(t.sessionCsrf))}Te(!0)},jt=()=>{te(""),Te(!1)},nt=async(t,a,l={})=>{const o=!!(l!=null&&l.silent);if(Ae)return!1;const c=t.trim(),d=a.trim();if(!c||!d)return o||te("Session ID and Session CSRF are required."),!1;Je(!0),o||te("");try{const v=await vn({sessionId:c,sessionCsrf:d}),{chats:k,blockedAccounts:B,reports:ae}=await gn({sessionId:c,sessionCsrf:d});return Ze({sessionId:c,sessionCsrf:d,userId:v.userId,realtimeToken:v.token||""}),An(c,d),b(k),re(B),y({}),Ne(ae),A(null),I(""),P(""),z(!1),pe("chats"),Te(!1),!o&&k.length===0?p("Connected. No chats found."):o||p(`Connected. Loaded ${k.length} chat${k.length===1?"":"s"}.`),!0}catch(v){return o?ht():te((v==null?void 0:v.message)||"Failed to connect session."),!1}finally{Je(!1)}};u.useEffect(()=>{const t=ve();!t||N||(me(a=>a||t.sessionId),ue(a=>a||t.sessionCsrf),nt(t.sessionId,t.sessionCsrf,{silent:!0}))},[]);const Vt=async()=>{await nt(We,qe)},at=async(t,a={})=>{a.unarchive&&!await ct(t,{clearActive:!1,toast:!0})||(A(t),N&&de(t),b(l=>l.map(o=>o.id===t?{...o,unread:0}:o)),z(!1),P(""))},st=(t,a,l)=>{y(o=>{const c=o[t]||[];return{...o,[t]:c.map(d=>d.id===a?{...d,status:l}:d)}})},Ht=async()=>{const t=Z.trim();if(!t||!i)return;if(_(C)){p(C!=null&&C.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(N){try{const l=await bn({sessionId:w,sessionCsrf:S,conversationId:i,content:t}),o=ut(l==null?void 0:l.data,x);y(c=>({...c,[i]:[...c[i]||[],o]})),ee(""),b(c=>{const d=c.map(B=>B.id===i?{...B,lastMessage:o.text||t,lastTime:o.timestamp||new Date().toISOString(),unread:0}:B),v=d.find(B=>B.id===i),k=d.filter(B=>B.id!==i);return v?[v,...k]:d}),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null),R.current.lastValue=!1,Ee(!1,{force:!0})}catch(l){p((l==null?void 0:l.message)||"Failed to send message.")}return}const a={id:`m-${Date.now()}`,chatId:i,sender:"me",text:t,timestamp:new Date().toISOString(),status:"sent"};y(l=>({...l,[i]:[...l[i]||[],a]})),ee(""),b(l=>{const o=l.map(v=>v.id===i?{...v,lastMessage:t,lastTime:a.timestamp,unread:0}:v),c=o.find(v=>v.id===i),d=o.filter(v=>v.id!==i);return c?[c,...d]:o}),setTimeout(()=>st(i,a.id,"delivered"),900),setTimeout(()=>st(i,a.id,"read"),2e3),R.current.idleTimer&&(window.clearTimeout(R.current.idleTimer),R.current.idleTimer=null),R.current.lastValue=!1,Ee(!1,{force:!0})},zt=()=>{if(!i){p("Select a chat first.");return}if(!N){p("Connect your session first.");return}if(_(C)){p(C!=null&&C.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}Re.current&&Re.current.click()},Kt=async t=>{var o;const a=t.target,l=(o=a==null?void 0:a.files)==null?void 0:o[0];if(a&&(a.value=""),!!l){if(!i){p("Select a chat first.");return}if(!N){p("Connect your session first.");return}if(_(C)){p(C!=null&&C.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}try{const c=await Nn({sessionId:w,sessionCsrf:S,conversationId:i,file:l}),d=ut(c==null?void 0:c.data,x);y(v=>({...v,[i]:[...v[i]||[],d]})),b(v=>{const k=v.map(q=>q.id===i?{...q,lastMessage:d.text||l.name,lastTime:d.timestamp||new Date().toISOString(),unread:0}:q),B=k.find(q=>q.id===i),ae=k.filter(q=>q.id!==i);return B?[B,...ae]:k}),p("Attachment sent.")}catch(c){p((c==null?void 0:c.message)||"Failed to send attachment.")}}},Yt=t=>{y(a=>({...a,[t]:[]})),b(a=>a.map(l=>l.id===t?{...l,lastMessage:"No messages yet",lastTime:"",unread:0}:l))},Wt=()=>{if(i){Yt(i),p("Cleared current chat.");return}const t={};f.forEach(a=>{t[a.id]=[]}),y(t),b(a=>a.map(l=>({...l,lastMessage:"No messages yet",lastTime:"",unread:0}))),p("Cleared all chats.")},Me=t=>{if(!Array.isArray(t)||t.length===0)return;const a=new Set(t.filter(Boolean));a.size&&(b(l=>l.filter(o=>!a.has(o.id))),y(l=>{const o={...l};return a.forEach(c=>{delete o[c]}),o}),i&&a.has(i)&&A(null))},Oe=async(t,a={})=>{const l=typeof t=="string"?t.trim():"";if(!l)return!1;const o=a.toast!==!1;if(N)try{await ft({sessionId:w,sessionCsrf:S,conversationId:l})}catch(c){return p((c==null?void 0:c.message)||"Failed to delete chat."),!1}return Me([l]),o&&p("Chat deleted."),!0},qt=async()=>{const t=f.map(o=>o.id).filter(Boolean);if(t.length===0)return p("No chats to delete."),!1;if(!N)return Me(t),p("All chats deleted."),!0;const a=[];for(const o of t)try{await ft({sessionId:w,sessionCsrf:S,conversationId:o}),a.push(o)}catch{}a.length>0&&Me(a);const l=t.length-a.length;return a.length===0?(p("Failed to delete chats."),!1):l===0?(p("All chats deleted."),!0):(p(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${l} failed.`),!1)},Jt=async()=>{if(i){await Oe(i);return}await qt()},Zt=(t,a)=>{const l=f.find(k=>k.id===t),o=(l==null?void 0:l.otherPartyId)||t;if(!o)return;const c=a||new Date().toISOString(),d=(l==null?void 0:l.name)||"Unknown",v=(l==null?void 0:l.color)||"#3b82f6";re(k=>{const B=k.filter(ae=>ae.id!==o);return[{id:o,name:d,blockedAt:c,color:v},...B]})},lt=({accountId:t,conversationId:a=""})=>{const l=typeof t=="string"?t.trim():"",o=typeof a=="string"?a.trim():"";b(c=>c.map(d=>{const v=!!o&&d.id===o,k=!!l&&d.otherPartyId===l;if(!v&&!k)return d;const B=!!d.blockedByOther;return{...d,blocked:!1,blockedByMe:!1,hasBlockingRelationship:B,blockedAt:void 0}})),l&&re(c=>c.filter(d=>d.id!==l))},rt=async t=>{if(!t)return!1;if(N)try{await wn({sessionId:w,sessionCsrf:S,conversationId:t})}catch(l){return p((l==null?void 0:l.message)||"Failed to block account."),!1}const a=new Date().toISOString();return b(l=>l.map(o=>o.id===t?{...o,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:o)),Zt(t,a),i===t&&A(null),p("Chat blocked."),!0},Qt=async t=>{if(!t)return!1;const a=f.find(o=>o.id===t),l=(a==null?void 0:a.otherPartyId)||"";if(N)try{await dt({sessionId:w,sessionCsrf:S,conversationId:t||void 0,recipientId:l||void 0})}catch(o){return p((o==null?void 0:o.message)||"Failed to unblock account."),!1}return lt({accountId:l,conversationId:t}),p("Account unblocked."),!0},Gt=async t=>{const a=typeof t=="string"?t.trim():"";if(!a)return!1;const l=f.find(c=>c.otherPartyId===a),o=(l==null?void 0:l.id)||"";if(N)try{await dt({sessionId:w,sessionCsrf:S,conversationId:o||void 0,recipientId:a})}catch(c){return p((c==null?void 0:c.message)||"Failed to unblock account."),!1}return lt({accountId:a,conversationId:o}),p("Account unblocked."),!0},Xt=async(t,a={})=>{if(!t)return!1;const l=a.clearActive!==!1,o=a.toast!==!1;if(N)try{await kn({sessionId:w,sessionCsrf:S,conversationId:t})}catch(c){return p((c==null?void 0:c.message)||"Failed to archive chat."),!1}return b(c=>c.map(d=>d.id===t?{...d,archived:!0,archivedAt:new Date().toISOString()}:d)),l&&i===t&&A(null),o&&p("Chat archived."),!0},ct=async(t,a={})=>{if(!t)return!1;const l=a.clearActive===!0,o=a.toast!==!1;if(N)try{await Cn({sessionId:w,sessionCsrf:S,conversationId:t})}catch(c){return p((c==null?void 0:c.message)||"Failed to restore chat."),!1}return b(c=>c.map(d=>d.id===t?{...d,archived:!1,archivedAt:void 0}:d)),l&&i===t&&A(null),o&&p("Chat restored from archive."),!0},ot=t=>{if(t==="profile"){if(!i){p("No chat selected.");return}const a=f.find(l=>l.id===i)||null;Ve(a),le(!0);return}if(t==="close"){A(null),z(!1),P(""),p("Chat closed.");return}if(t==="block"){if(!i)return;const a=f.find(o=>o.id===i),l=(a==null?void 0:a.id)||i;W({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{F(),await rt(l)}});return}if(t==="delete"){const a=C?`Delete chat with ${H(C)}?`:"Delete all chats?";W({title:a,message:C?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{F(),Jt()}});return}if(t==="clear"){const a=C?`Clear chat with ${C.name}?`:"Clear all chats?";W({title:a,message:C?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{F(),Wt()}});return}t==="report"&&Le(C)},en=t=>{ot(t)},tn=(t,a)=>{const l=f.find(o=>o.id===t);if(l){if(a==="delete"){W({title:`Delete chat with ${H(l)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{F(),Oe(t)}});return}if(a==="report"){Le(l);return}if(a==="archive"){Xt(t,{clearActive:!0,toast:!0});return}}},nn=()=>{z(t=>{const a=!t;return a||P(""),a})},Pe=()=>{le(!1),Ve(null)},an=()=>{T&&W({title:`Delete chat with ${H(T)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{F(),(async()=>await Oe(T.id)&&Pe())()}})},sn=()=>{if(!T)return;const t=T.id,a=!!T.blocked,l=H(T);W({title:a?`Unblock ${l}?`:`Block ${l}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{F(),(a?await Qt(t):await rt(t))&&Pe()}})},ln=()=>{T&&Le(T)},rn=t=>{if(t==="home"){pe(t),window.location.href="homepage.html";return}(t==="chats"||t==="archive"||t==="block"||t==="profile"||t==="reports")&&A(null),pe(t);const a=t.charAt(0).toUpperCase()+t.slice(1);p(`${a} selected.`)},cn=t=>{ct(t,{clearActive:!1,toast:!0})},on=t=>{Gt(t)},mn=[{label:"Connect",onSelect:_t},{label:"Delete chats",onSelect:()=>ot("delete")},{label:"Reports",onSelect:()=>pe("reports")},{label:"Logout",onSelect:()=>W({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{F(),ht(),Ze({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),p("Logged out.")}})}],it=i||L==="archive"||L==="block"||L==="profile"||L==="reports",un=Ae;return u.useEffect(()=>{if(!N||L!=="block")return;let t=!1;return(async()=>{try{const a=await dn({sessionId:w,sessionCsrf:S});t||re(a)}catch{}})(),()=>{t=!0}},[N,L,w,S]),u.useEffect(()=>{if(!N||L!=="reports")return;let t=!1;return(async()=>{try{const a=await mt({sessionId:w,sessionCsrf:S});t||Ne(a)}catch{}})(),()=>{t=!0}},[N,L,w,S]),u.useEffect(()=>{if(!Ce||!(j!=null&&j.id))return;const t=ye.find(a=>a.id===j.id);if(!t){et();return}ke(t)},[Ce,j==null?void 0:j.id,ye]),e.createElement("div",{className:`chp-app${i?" chat-only":""}${it&&!i?" no-header":""}`},it?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:fn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(je,{ariaLabel:"App menu",items:mn}))),e.createElement("main",{className:"chp-main","data-view":i?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},L==="archive"?e.createElement(Qn,{chats:Rt,onOpenChat:at,onUnarchive:cn}):L==="block"?e.createElement(Gn,{chats:Bt,onUnblock:on}):L==="profile"?e.createElement(Zn,{currentUser:m}):L==="reports"?e.createElement(Xn,{reports:ye,onOpenReport:$t}):e.createElement(na,{chats:Dt,searchValue:M,onSearchChange:I,activeChatId:i,onOpenChat:at,onChatAction:tn})),e.createElement("section",{className:"chp-pane chp-convo-pane"},be?e.createElement(Jn,{chat:T,onClose:Pe,onDelete:an,onBlock:sn,onReport:ln}):e.createElement(oa,{chat:C,groupedMessages:xt,searchValue:U,showSearch:$,onToggleSearch:nn,onSearchChange:P,onBack:()=>A(null),onSend:Ht,composerValue:Z,onComposerChange:ee,onEmoji:()=>p("Emoji picker"),onAttach:zt,typing:se,conversationLoading:Lt,messageListRef:Ge,matchCount:xe.length,onMenuAction:en,attachmentPreview:O,onOpenAttachmentPreview:Mt,onCloseAttachmentPreview:Ot,onSaveAttachmentPreview:Pt,onReportAttachmentPreview:Ut}))),i?null:e.createElement(ia,{activeKey:L,onSelect:rn}),un?e.createElement(ta,null):null,e.createElement(ea,{open:Ce,report:j,onClose:et}),e.createElement(qn,{open:St,onClose:tt,reasons:pt,value:ce,onChange:oe,details:Ke,onDetailsChange:ie,onSubmit:Ft,targetName:Q==null?void 0:Q.name}),e.createElement(Wn,{open:It,sessionId:We,sessionCsrf:qe,error:Tt,busy:Ae,onSessionIdChange:me,onSessionCsrfChange:ue,onConnect:Vt,onCancel:jt}),e.createElement(Yn,{open:G.open,title:G.title,message:G.message,confirmLabel:G.confirmLabel,onConfirm:()=>{G.onConfirm?G.onConfirm():F()},onCancel:F}),e.createElement("input",{ref:Re,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:Kt,style:{display:"none"}}))}const ua=Sn(document.getElementById("root"));ua.render(e.createElement(e.StrictMode,null,e.createElement(ma,null)));
