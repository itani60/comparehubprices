import{$ as _n,r as m,f as Fn,a as St,R as e,l as jn,g as Vn,b as zn,m as Wn,s as Hn,c as It,d as Yn,e as Gn,p as $t,h as Kn,i as qn,u as Xn,j as Tt,k as Zn,n as Jn,o as Qn,q as Ot,t as ea,v as At,w as ta}from"./64-CWBe4p3u.js";typeof window<"u"&&!window.__comparehubEmojiMartInit&&(_n({data:Ot}),window.__comparehubEmojiMartInit=!0);const fe={name:"",firstName:"",lastName:"",status:"",about:"",email:"",phone:"",suburb:"",city:"",province:"",accountSince:""},na=[],aa={},Bt=[{value:"spam",label:"Spam"},{value:"harassment",label:"Harassment"},{value:"scam",label:"Scam"},{value:"other",label:"Other"}];function sa(){if(typeof document>"u")return null;const t=Pt("business_session_id"),s=Pt("business_csrf_token");return!t||!s?null:{sessionId:t,sessionCsrf:s}}function ra(t,s){var p;if(typeof document>"u"||!t||!s)return;const l=typeof window<"u"&&((p=window.location)==null?void 0:p.protocol)==="https:"?"; Secure":"",o=12*60*60;document.cookie=`business_session_id=${encodeURIComponent(t)}; path=/; max-age=${o}; SameSite=Strict${l}`,document.cookie=`business_csrf_token=${encodeURIComponent(s)}; path=/; max-age=${o}; SameSite=Strict${l}`}function xt(){typeof document>"u"||(Lt("business_session_id"),Lt("business_csrf_token"))}function Pt(t){if(!t||typeof document>"u")return"";try{const s=String(document.cookie||"");if(!s)return"";const l=s.split(";");let o="";for(const p of l){const h=p.indexOf("=");if(h<=0||p.slice(0,h).trim()!==t)continue;const B=p.slice(h+1).trim();if(B)try{o=decodeURIComponent(B).trim()}catch{o=B.trim()}}return o}catch{return""}}function Lt(t){var l;const s=typeof window<"u"&&((l=window.location)==null?void 0:l.protocol)==="https:"?"; Secure":"";document.cookie=`${t}=; path=/; max-age=0; SameSite=Strict${s}`}const la=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,oa=200;function Mt(t){return typeof t=="string"&&la.test(t)}function ca(t){if(typeof t!="string")return"";const s=t.trim().slice(0,oa);return $t.sanitize(s,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function ia(){if(typeof window>"u")return{conversationId:"",recipientId:"",recipientName:""};try{const t=new URLSearchParams(window.location.search||""),s=(t.get("conversationId")||"").trim(),l=(t.get("recipientId")||"").trim(),o=(t.get("recipientName")||"").trim();return{conversationId:s&&Mt(s)?s:"",recipientId:l&&Mt(l)?l:"",recipientName:ca(o)}}catch{return{conversationId:"",recipientId:"",recipientName:""}}}function ma(t){return t!=null&&t.id?{id:"",name:String(t.name||"").trim()||"Business",firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:"No messages yet",lastTime:"",unread:0,online:!1,presence:"Start conversation",color:"#3b82f6",archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:t.id,launchPending:!0}:null}function he(t){if(!t)return"";const s=t.split(" ").filter(Boolean),l=s[0]?s[0][0]:"",o=s.length>1?s[s.length-1][0]:"";return(l+o).toUpperCase()}function te(t){return!t||typeof t!="object"||t.blockedByOther?"User unavailable":t.name||"Unknown"}function q(t){return!!(t&&(t.blocked||t.blockedByOther))}function Ut(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function _t(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleDateString([],{month:"short",day:"numeric"})}function Ze(t){if(!t)return"";const s=new Date(t);return Number.isNaN(s.getTime())?"":s.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Ft(t){const s=String(t||"").trim();return s?s.split(/[_\s-]+/).filter(Boolean).map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" "):"Status unavailable"}function jt(t){const s=String(t||"").trim().toLowerCase();return s==="resolved"||s==="closed"||s==="complete"||s==="completed"||s==="done"?"success":s==="rejected"||s==="dismissed"||s==="denied"?"danger":s==="open"||s==="pending"||s==="in_review"||s==="in review"||s==="under_review"||s==="under review"?"warning":""}function Rt(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function ua(t){const s=new Date(t);if(Number.isNaN(s.getTime()))return"";const l=new Date,o=new Date;return o.setDate(l.getDate()-1),Rt(s,l)?"Today":Rt(s,o)?"Yesterday":s.toLocaleDateString([],{month:"short",day:"numeric"})}function da(t){const s=[];let l="";return t.forEach(o=>{const p=o.timestamp.slice(0,10);p!==l&&(s.push({type:"day",id:`day-${p}`,label:ua(o.timestamp)}),l=p),s.push({type:"message",id:o.id,message:o})}),s}function fa(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const Dt=typeof Intl<"u"&&Intl.Segmenter?new Intl.Segmenter(void 0,{granularity:"grapheme"}):null;function pa(t){return t?Dt?Array.from(Dt.segment(t),({segment:s})=>s):Array.from(t):[]}function ha(t){return t?new RegExp("^\\p{Regional_Indicator}{2}$","u").test(t)||/[0-9#*]\uFE0F?\u20E3/u.test(t)?!0:new RegExp("\\p{Extended_Pictographic}","u").test(t):!1}function va(t){return typeof t!="string"?"":$t.sanitize(t,{ALLOWED_TAGS:[],ALLOWED_ATTR:[]})}function pe(t,s){const l=va(t);return pa(l).map((o,p)=>ha(o)?e.createElement("em-emoji",{key:`${s}-emoji-${p}`,native:o,set:"apple",size:"1.05em"}):e.createElement(e.Fragment,{key:`${s}-text-${p}`},o))}function Ea(t,s){if(!s)return pe(t,"msg");const l=fa(s);return t.split(new RegExp(`(${l})`,"ig")).map((p,h)=>p.toLowerCase()===s.toLowerCase()?e.createElement("mark",{key:h,className:"msg-highlight"},pe(p,`mark-${h}`)):e.createElement(e.Fragment,{key:h},pe(p,`part-${h}`)))}function ga(t,s,l){const o=(l==null?void 0:l.selectionStart)??t.length,p=(l==null?void 0:l.selectionEnd)??o;return{nextValue:t.slice(0,o)+s+t.slice(p),caret:o+s.length}}function Qe(t,s,l){m.useEffect(()=>{if(!l)return;const o=p=>{!t.current||t.current.contains(p.target)||s()};return document.addEventListener("mousedown",o),document.addEventListener("touchstart",o),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("touchstart",o)}},[t,s,l])}function $({children:t,size:s=20,className:l}){return e.createElement("svg",{className:l,width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true"},t)}const ba=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"5",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"12",r:"1.6",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"12",cy:"19",r:"1.6",fill:"currentColor",stroke:"none"})),Vt=t=>e.createElement($,{...t},e.createElement("circle",{cx:"11",cy:"11",r:"6.5"}),e.createElement("line",{x1:"16.5",y1:"16.5",x2:"21",y2:"21"})),zt=t=>e.createElement($,{...t},e.createElement("polyline",{points:"15 6 9 12 15 18"})),ya=t=>e.createElement($,{...t},e.createElement("path",{d:"M3 12l17-7-7 17-2-6-8-4Z"})),Na=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("circle",{cx:"9",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("circle",{cx:"15",cy:"10",r:"1",fill:"currentColor",stroke:"none"}),e.createElement("path",{d:"M8 15c1.2 1.3 2.6 2 4 2s2.8-.7 4-2"})),ka=t=>e.createElement($,{...t},e.createElement("path",{d:"M7.5 12.5l6.8-6.8a3 3 0 0 1 4.3 4.3l-7.5 7.5a4.5 4.5 0 0 1-6.4-6.4l7.2-7.2"})),Ca=t=>e.createElement($,{...t},e.createElement("polyline",{points:"5 12 9 16 19 6"})),wa=t=>e.createElement($,{...t},e.createElement("polyline",{points:"2 12 6 16 12 10"}),e.createElement("polyline",{points:"8 12 12 16 22 6"})),Sa=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 11.5 12 4l8 7.5"}),e.createElement("path",{d:"M6 10.5V20h12v-9.5"})),Ia=t=>e.createElement($,{...t},e.createElement("path",{d:"M6 18l-2.5 3.5V6.5A2.5 2.5 0 0 1 6 4h12a2.5 2.5 0 0 1 2.5 2.5V14A2.5 2.5 0 0 1 18 16.5H7.8L6 18Z"})),Ta=t=>e.createElement($,{...t},e.createElement("rect",{x:"4",y:"4",width:"16",height:"5"}),e.createElement("rect",{x:"5",y:"9",width:"14",height:"11"}),e.createElement("line",{x1:"9",y1:"13",x2:"15",y2:"13"})),Aa=t=>e.createElement($,{...t},e.createElement("path",{d:"M5 4v16"}),e.createElement("path",{d:"M5 4h12l-2.2 4L17 12H5"})),le=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"12",r:"9"}),e.createElement("line",{x1:"7",y1:"17",x2:"17",y2:"7"})),Ba=t=>e.createElement($,{...t},e.createElement("circle",{cx:"12",cy:"8",r:"3.2"}),e.createElement("path",{d:"M4.5 19.5c1.9-3 4.5-4.5 7.5-4.5s5.6 1.5 7.5 4.5"})),xa=t=>e.createElement($,{...t},e.createElement("path",{d:"M4 7h16"}),e.createElement("path",{d:"M9 7V5h6v2"}),e.createElement("path",{d:"M7 7l1 12h8l1-12"}),e.createElement("path",{d:"M10 11v6"}),e.createElement("path",{d:"M14 11v6"})),Wt=t=>e.createElement($,{...t},e.createElement("line",{x1:"5",y1:"5",x2:"19",y2:"19"}),e.createElement("line",{x1:"19",y1:"5",x2:"5",y2:"19"}));function et({ariaLabel:t,items:s}){const[l,o]=m.useState(!1),p=m.useRef(null);return Qe(p,()=>o(!1),l),e.createElement("div",{className:"menu-wrap",ref:p},e.createElement("button",{className:"icon-btn","aria-label":t,"aria-haspopup":"menu","aria-expanded":l,onClick:()=>o(h=>!h),type:"button"},e.createElement(ba,null)),l?e.createElement("div",{className:"dropdown",role:"menu"},s.map(h=>e.createElement("button",{key:h.label,className:"dropdown-item",role:"menuitem",type:"button",onClick:()=>{o(!1),h.onSelect()}},h.label))):null)}function Pa({status:t}){if(!t)return null;if(t==="sent")return e.createElement(Ca,{className:"status-icon"});const s=t==="read"?"status-icon read":"status-icon";return e.createElement(wa,{className:s})}function La({open:t,title:s,message:l,confirmLabel:o,onConfirm:p,onCancel:h}){return t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":s},e.createElement("div",{className:"confirm-dialog"},e.createElement("h3",null,s),e.createElement("p",null,l),e.createElement("div",{className:"confirm-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:h},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:p},o)))):null}function Ma({open:t,onClose:s,reasons:l,value:o,onChange:p,details:h,onDetailsChange:d,onSubmit:B,targetName:A}){const[w,E]=m.useState(!1),X=m.useRef(null),M=l.find(u=>u.value===o);return Qe(X,()=>E(!1),w),m.useEffect(()=>{t||E(!1)},[t]),t?e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report"},e.createElement("div",{className:"report-dialog"},e.createElement("div",{className:"report-title"},"Quick report"),e.createElement("div",{className:"report-sub"},"Select a reason for reporting ",A||"this chat","."),e.createElement("div",{className:`report-select${w?" active":""}`,ref:X},e.createElement("button",{className:"report-select__trigger",type:"button",onClick:()=>E(u=>!u),"aria-haspopup":"listbox","aria-expanded":w},e.createElement("span",null,M?M.label:"Choose a reason"),e.createElement("span",{className:"report-select__caret"},"â–¾")),e.createElement("div",{className:"report-select__options",role:"listbox"},l.map(u=>e.createElement("button",{key:u.value,type:"button",className:`report-select__option${o===u.value?" selected":""}`,onClick:()=>{p(u.value),E(!1)},role:"option","aria-selected":o===u.value},u.label)))),e.createElement("textarea",{className:"report-textarea",placeholder:"Optional details",value:h,onChange:u=>d(u.target.value)}),e.createElement("div",{className:"report-actions"},e.createElement("button",{className:"ghost-btn",type:"button",onClick:s},"Cancel"),e.createElement("button",{className:"primary-btn",type:"button",onClick:B,disabled:!o},"Report")))):null}function Ra({chat:t,onClose:s,onDelete:l,onBlock:o,onReport:p}){if(!t)return null;const h=!!t.blockedByOther,d=te(t),B=t.name?t.name.split(" ").filter(Boolean):[],A=B[0]||"",w=B.slice(1).join(" "),E=h?"-":t.firstName||A||"-",X=h?"-":t.lastName||w||"-",M=h?"-":t.suburb||"-",u=h?"-":t.city||"-",R=h?"-":t.province||"-",b=h?"-":t.accountSince||"-",F=h?"-":t.accountType||"-";return e.createElement("div",{className:"profile-section-view","aria-label":"Contact profile"},e.createElement("div",{className:"profile-section-header"},e.createElement("button",{className:"icon-btn","aria-label":"Back",onClick:s,type:"button"},e.createElement(zt,null)),e.createElement("h2",null,"Chat Profile")),e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:t.color}},q(t)?e.createElement(le,{className:"avatar-blocked-icon",size:18}):he(d)),e.createElement("div",null,e.createElement("h3",null,d))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",E),e.createElement("p",null,"Family name: ",X),e.createElement("p",null,"Suburb: ",M),e.createElement("p",null,"City: ",u),e.createElement("p",null,"Province: ",R),e.createElement("p",null,"Account since: ",b),e.createElement("p",null,"Account type: ",F)),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Actions"),e.createElement("div",{className:"profile-action-row"},e.createElement("button",{className:"profile-btn danger",type:"button",onClick:l},e.createElement(xa,null),"Delete"),h?null:e.createElement(e.Fragment,null,e.createElement("button",{className:"profile-btn warn",type:"button",onClick:o},e.createElement(le,null),t.blocked?"Unblock":"Block"),e.createElement("button",{className:"profile-btn",type:"button",onClick:p},e.createElement(Aa,null),"Report"))))))}function Me({title:t,subtitle:s,children:l}){return e.createElement("div",{className:"section-panel"},e.createElement("div",{className:"section-header"},e.createElement("div",null,e.createElement("h2",null,t),s?e.createElement("p",{className:"muted"},s):null)),e.createElement("div",{className:"section-card"},l))}function Da({currentUser:t}){const s={...fe,...t&&typeof t=="object"?t:{}},l=s.name||"User";return e.createElement(Me,{title:"My Profile",subtitle:""},e.createElement("div",{className:"profile-panel profile-panel-inline"},e.createElement("div",{className:"profile-hero"},e.createElement("div",{className:"avatar large",style:{backgroundColor:"#3b82f6"}},he(l)),e.createElement("div",null,e.createElement("h3",null,l),e.createElement("p",{className:"muted"},s.status||"-"))),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"About"),e.createElement("p",null,s.about||"-")),e.createElement("div",{className:"profile-section"},e.createElement("h4",null,"Details"),e.createElement("p",null,"First name: ",s.firstName||"-"),e.createElement("p",null,"Family name: ",s.lastName||"-"),e.createElement("p",null,"Suburb: ",s.suburb||"-"),e.createElement("p",null,"City: ",s.city||"-"),e.createElement("p",null,"Province: ",s.province||"-"),e.createElement("p",null,"Account since: ",s.accountSince||"-")),e.createElement("div",{className:"profile-actions"},e.createElement("button",{className:"manage-profile-btn",type:"button","data-link":"manage-profile"},"Manage Profile"))))}function $a({chats:t,onOpenChat:s,onUnarchive:l}){return e.createElement(Me,{title:"Achieved Chats",subtitle:"Archived conversations stored here."},t.length===0?e.createElement("div",{className:"section-empty"},"No archived chats yet."):e.createElement("div",{className:"section-list"},t.map(o=>{const p=te(o);return e.createElement("div",{key:o.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:o.color}},q(o)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(o.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},p),e.createElement("div",{className:"section-item-sub"},o.lastMessage?pe(o.lastMessage,`archived-last-${o.id}`):"No messages yet"))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag"},"Archived"),e.createElement("span",null,_t(o.archivedAt||o.lastTime)),e.createElement("div",{className:"section-item-actions"},e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(o.id,{unarchive:!0})},"Open"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>l(o.id)},"Unarchive"))))})))}function Oa({chats:t,onUnblock:s}){return e.createElement(Me,{title:"Blocked Accounts",subtitle:"People and businesses you blocked."},t.length===0?e.createElement("div",{className:"section-empty"},"No blocked accounts."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color}},e.createElement(le,{className:"avatar-blocked-icon",size:16})),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:"section-tag danger"},"Blocked"),e.createElement("span",null,_t(l.blockedAt||l.lastTime)),e.createElement("button",{className:"section-action",type:"button",onClick:()=>s(l.id)},"Unblock"))))))}function Ua({reports:t,onOpenReport:s}){return e.createElement(Me,{title:"Reports",subtitle:"Reports you submitted."},t.length===0?e.createElement("div",{className:"section-empty"},"No reports found."):e.createElement("div",{className:"section-list"},t.map(l=>e.createElement("div",{key:l.id,className:"section-item"},e.createElement("div",{className:"section-item-info"},e.createElement("div",{className:"avatar",style:{backgroundColor:l.color||"#3b82f6"}},he(l.name)),e.createElement("div",{className:"section-item-text"},e.createElement("div",{className:"section-item-name"},l.name),e.createElement("div",{className:"section-item-sub"},l.context||"No reason provided."))),e.createElement("div",{className:"section-item-meta"},e.createElement("span",{className:`section-tag ${jt(l.status)}`},Ft(l.status)),e.createElement("span",null,Ze(l.createdAt)||"Date unavailable"),e.createElement("button",{className:"section-action ghost",type:"button",onClick:()=>s(l)},"View report"))))))}function _a({open:t,report:s,onClose:l}){return!t||!s?null:e.createElement("div",{className:"panel-backdrop",role:"dialog","aria-modal":"true","aria-label":"Report details"},e.createElement("div",{className:"report-details-dialog"},e.createElement("div",{className:"report-details-header"},e.createElement("div",null,e.createElement("div",{className:"report-details-title"},"Report details"),e.createElement("div",{className:"report-sub"},"Submitted information from your report.")),e.createElement("button",{type:"button",className:"report-details-close",onClick:l,"aria-label":"Close report details"},e.createElement(Wt,{size:18}))),e.createElement("div",{className:"report-details-grid"},e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reported account"),e.createElement("div",{className:"report-details-value"},s.name||"Unknown")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Status"),e.createElement("div",{className:`section-tag ${jt(s.status)}`},Ft(s.status))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Sent"),e.createElement("div",{className:"report-details-value"},Ze(s.createdAt)||"Not available")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply time"),e.createElement("div",{className:"report-details-value"},Ze(s.adminReplyAt)||"Not available"))),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Reason"),e.createElement("div",{className:"report-details-value report-details-reason"},s.context||"No reason provided.")),e.createElement("div",{className:"report-details-field"},e.createElement("div",{className:"report-details-label"},"Admin reply"),e.createElement("div",{className:"report-details-value report-details-reason"},s.adminReply||"No admin reply yet."))))}function Je({title:t,subtitle:s}){return e.createElement("div",{className:"empty-state"},e.createElement("h3",null,t),e.createElement("p",null,s))}function Fa(){const t=Array.from({length:6}),s=Array.from({length:5});return e.createElement("div",{className:"chat-loading-overlay mobile",role:"status","aria-live":"polite"},e.createElement("div",{className:"chat-loading-mobile"},e.createElement("div",{className:"chat-loading-mobile-header"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-logo"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-icon"})),e.createElement("div",{className:"chat-loading-mobile-search-wrap"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-search"})),e.createElement("div",{className:"chat-loading-mobile-list"},t.map((l,o)=>e.createElement("div",{className:"chat-loading-mobile-thread",key:o},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-avatar"}),e.createElement("div",{className:"chat-loading-mobile-thread-meta"},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line lg"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-line sm"})),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-time"})))),e.createElement("div",{className:"chat-loading-mobile-nav"},s.map((l,o)=>e.createElement("div",{className:"chat-loading-mobile-nav-item",key:o},e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-icon"}),e.createElement("div",{className:"chat-loading-sk chat-loading-mobile-nav-label"}))))))}function ja({chats:t,searchValue:s,onSearchChange:l,activeChatId:o,onOpenChat:p,onChatAction:h}){return e.createElement("div",{className:"chat-list-screen"},e.createElement("div",{className:"search-bar"},e.createElement(Vt,{className:"search-icon"}),e.createElement("input",{type:"search",value:s,onChange:d=>l(d.target.value),placeholder:"Search chats or messages","aria-label":"Search chats"})),e.createElement("div",{className:"chat-list",role:"list"},t.length===0?e.createElement(Je,{title:"No chats yet",subtitle:"Start a new chat to compare prices."}):t.map(d=>{const B=te(d);return e.createElement("div",{key:d.id,className:`chat-item ${o===d.id?"active":""}`,onClick:()=>p(d.id),onKeyDown:A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),p(d.id))},role:"button",tabIndex:0,"aria-label":`Open chat with ${B}`},e.createElement("div",{className:"chat-avatar"},e.createElement("div",{className:"avatar",style:{backgroundColor:d.color}},q(d)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(d.name)),d.online?e.createElement("span",{className:"status-dot","aria-hidden":"true"}):null),e.createElement("div",{className:"chat-body"},e.createElement("div",{className:"chat-row"},e.createElement("span",{className:"chat-name"},B),e.createElement("span",{className:"chat-time"},Ut(d.lastTime))),e.createElement("div",{className:"chat-row chat-preview"},e.createElement("span",{className:"chat-message"},d.lastMessage?pe(d.lastMessage,`chat-last-${d.id}`):"No messages yet"),d.unread>0?e.createElement("span",{className:"chat-unread"},d.unread):null)),e.createElement("div",{className:"chat-actions",onClick:A=>A.stopPropagation(),onKeyDown:A=>A.stopPropagation()},e.createElement(et,{ariaLabel:`More options for ${B}`,items:[{label:"Delete chat",onSelect:()=>h(d.id,"delete")},{label:"Report",onSelect:()=>h(d.id,"report")},{label:"Archive",onSelect:()=>h(d.id,"archive")}]})))})))}function Va({message:t,query:s,onPreviewImage:l}){const o=t.sender==="me",p=typeof t.attachmentUrl=="string"?t.attachmentUrl:"",h=typeof t.attachmentType=="string"?t.attachmentType.toLowerCase():"",d=typeof t.attachmentName=="string"&&t.attachmentName?t.attachmentName:"Attachment",B=!!t.attachmentIsImage||h.startsWith("image/"),A=!!t.attachmentIsVideo||h.startsWith("video/"),w=typeof t.text=="string"&&t.text.trim().length>0,E={width:"100%",maxWidth:"220px",borderRadius:"10px",display:"block",marginBottom:w?"8px":"0"};return e.createElement("div",{className:`message-row ${o?"me":"them"}`},e.createElement("div",{className:`message-bubble ${o?"outgoing":"incoming"}`},p?e.createElement("div",{className:"message-attachment"},B?e.createElement("button",{className:"message-image-trigger",type:"button",onClick:()=>{l&&l(t)},"aria-label":`Preview ${d}`},e.createElement("img",{src:p,alt:d,loading:"lazy",style:E})):A?e.createElement("video",{controls:!0,preload:"metadata",style:E},e.createElement("source",{src:p,type:h||void 0})):e.createElement("a",{href:p,target:"_blank",rel:"noreferrer"},"Open attachment")):null,w?e.createElement("div",{className:"message-text"},Ea(t.text,s)):null,e.createElement("div",{className:"message-meta"},e.createElement("span",null,Ut(t.timestamp)),o?e.createElement(Pa,{status:t.status}):null)))}function za({preview:t,onClose:s,onSave:l,onReport:o}){return t?e.createElement("div",{className:"attachment-preview-panel",role:"region","aria-label":"Photo preview"},e.createElement("div",{className:"attachment-preview-head"},e.createElement("div",{className:"attachment-preview-title"},"Photo preview"),e.createElement("button",{className:"icon-btn",type:"button",onClick:s,"aria-label":"Close preview"},e.createElement(Wt,null))),e.createElement("div",{className:"attachment-preview-stage"},e.createElement("img",{src:t.url,alt:t.name||"Image preview",loading:"eager"})),e.createElement("div",{className:"attachment-preview-meta"},t.name||"Image"),e.createElement("div",{className:"attachment-preview-actions"},e.createElement("button",{className:"primary-btn",type:"button",onClick:l},"Save"),e.createElement("button",{className:"ghost-btn",type:"button",onClick:o},"Report Photo"))):null}function Wa(){return e.createElement("div",{className:"message-row them"},e.createElement("div",{className:"typing-bubble"},e.createElement("span",{className:"typing-label"},"typing"),e.createElement("div",{className:"typing-dots","aria-hidden":"true"},e.createElement("span",null),e.createElement("span",null),e.createElement("span",null))))}function Ha(){const t=[!1,!0,!1,!0,!1];return e.createElement("div",{className:"conversation-loading",role:"status","aria-live":"polite","aria-label":"Loading messages"},t.map((s,l)=>e.createElement("div",{key:l,className:`conversation-loading-row ${s?"me":"them"}`},e.createElement("div",{className:"conversation-loading-bubble"},e.createElement("div",{className:"chat-loading-sk conversation-loading-line lg"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line md"}),e.createElement("div",{className:"chat-loading-sk conversation-loading-line sm"})))))}function Ya({value:t,onChange:s,onSend:l,onEmoji:o,onAttach:p,inputRef:h,disabled:d=!1,emojiActive:B=!1}){const A=d?"Unblock to send messages":"Type a message";m.useEffect(()=>{const E=h==null?void 0:h.current;E&&(E.style.height="auto",E.style.height=`${Math.min(E.scrollHeight,120)}px`)},[t,h]);const w=E=>{E.key==="Enter"&&!E.shiftKey&&(E.preventDefault(),!d&&t.trim()&&l())};return e.createElement("div",{className:"composer"},e.createElement("button",{className:`icon-btn${B?" emoji-toggle-active":""}`,type:"button",onClick:o,"aria-label":"Emoji",disabled:d},e.createElement(Na,null)),e.createElement("div",{className:"composer-input-wrap"},e.createElement("div",{className:`composer-render ${t?"has-value":""}`,"aria-hidden":"true"},t?pe(t,"composer-input"):null),e.createElement("textarea",{ref:h,className:`composer-input-native ${t?"has-value":""}`,rows:1,value:t,onChange:E=>s(E.target.value),onKeyDown:w,placeholder:A,"aria-label":"Message input",disabled:d})),e.createElement("button",{className:"icon-btn",type:"button",onClick:p,"aria-label":"Attach",disabled:d},e.createElement(ka,null)),e.createElement("button",{className:"send-btn",type:"button",onClick:l,disabled:d||!t.trim(),"aria-label":"Send message"},e.createElement(ya,null)))}function Ga({open:t,onSelect:s,onClose:l}){const o=m.useRef(null);return Qe(o,l,t),t?e.createElement("div",{className:"emoji-popover","aria-live":"polite"},e.createElement("div",{className:"emoji-picker-d3",ref:o},e.createElement(Jn,{data:Ot,onEmojiSelect:s,theme:"light",set:"apple",getSpritesheetURL:()=>Qn,noCountryFlags:!1,dynamicWidth:!0,previewPosition:"none",skinTonePosition:"none",navPosition:"bottom",searchPosition:"sticky",emojiSize:30,emojiButtonSize:46,emojiButtonRadius:"8px"}))):null}function Ka({chat:t,groupedMessages:s,searchValue:l,showSearch:o,onToggleSearch:p,onSearchChange:h,onBack:d,onSend:B,composerValue:A,onComposerChange:w,onEmoji:E,onAttach:X,emojiOpen:M,onEmojiSelect:u,onEmojiClose:R,composerRef:b,typing:F,conversationLoading:ne,messageListRef:Ne,matchCount:Z,onMenuAction:j,attachmentPreview:ke,onOpenAttachmentPreview:oe,onCloseAttachmentPreview:ce,onSaveAttachmentPreview:ie,onReportAttachmentPreview:Re}){if(!t)return e.createElement("div",{className:"conversation empty-view"},e.createElement(Je,{title:"Select a chat",subtitle:"Choose a conversation to see messages and compare prices."}));if(ke)return e.createElement("div",{className:"conversation attachment-only-view"},e.createElement(za,{preview:ke,onClose:ce,onSave:ie,onReport:Re}));const ve=te(t),Ee=!!t.launchPending,ae=Ee?[{label:"Close chat",onSelect:()=>j("close")}]:[{label:"View profile",onSelect:()=>j("profile")},{label:"Close chat",onSelect:()=>j("close")},{label:"Delete chat",onSelect:()=>j("delete")},{label:"Block",onSelect:()=>j("block")},{label:"Report",onSelect:()=>j("report")}];return e.createElement("div",{className:"conversation"},e.createElement("div",{className:"conversation-header"},e.createElement("button",{className:"icon-btn",type:"button",onClick:d,"aria-label":"Back to chats"},e.createElement(zt,null)),e.createElement("div",{className:"conversation-title"},e.createElement("div",{className:"avatar",style:{backgroundColor:t.color}},q(t)?e.createElement(le,{className:"avatar-blocked-icon",size:16}):he(t.name)),e.createElement("div",{className:"conversation-title-text"},e.createElement("div",{className:"conversation-name"},ve),e.createElement("div",{className:"conversation-status"},Ee?e.createElement("span",null,"Start conversation"):F?e.createElement("span",null,"Typing..."):e.createElement(e.Fragment,null,t.online?e.createElement("span",{className:"presence-dot"}):null,e.createElement("span",null,t.online?"online":t.presence))))),e.createElement("div",{className:"conversation-actions"},e.createElement(et,{ariaLabel:"Conversation menu",items:ae}))),o?e.createElement("div",{className:"conversation-search"},e.createElement(Vt,{className:"search-icon"}),e.createElement("input",{type:"search",value:l,onChange:W=>h(W.target.value),placeholder:"Search in conversation","aria-label":"Search within conversation"}),l?e.createElement("span",{className:"search-count"},Z," match",Z===1?"":"es"):null):null,e.createElement("div",{className:"conversation-scroll",ref:Ne},ne?e.createElement(Ha,null):s.length===0?e.createElement(Je,{title:l?"No matches":"No messages yet",subtitle:l?"Try a different phrase.":"Send a message to start the chat."}):s.map(W=>W.type==="day"?e.createElement("div",{key:W.id,className:"day-separator"},W.label):e.createElement(Va,{key:W.id,message:W.message,query:l.trim(),onPreviewImage:oe})),F&&!l&&!ne?e.createElement(Wa,null):null,!ne&&q(t)?e.createElement("div",{className:"blocked-notice",role:"note"},t.blockedByOther?"You cannot message this account.":"You blocked this account. Unblock to send messages."):null),e.createElement(Ya,{value:A,onChange:w,onSend:B,onEmoji:E,onAttach:X,inputRef:b,disabled:q(t),emojiActive:M}),e.createElement(Ga,{open:M,onSelect:u,onClose:R}))}function qa({activeKey:t,onSelect:s}){const l=[{key:"home",label:"Home",icon:Sa},{key:"archive",label:"Archive",icon:Ta},{key:"chats",label:"Chats",icon:Ia},{key:"block",label:"Block",icon:le},{key:"profile",label:"My Profile",icon:Ba}];return e.createElement("nav",{className:"bottom-nav","aria-label":"Primary"},l.map(o=>{const p=o.icon;return e.createElement("button",{key:o.key,className:`nav-btn ${t===o.key?"active":""}`,type:"button",onClick:()=>s(o.key),"aria-label":o.label},e.createElement("span",{className:"icon-box"},e.createElement(p,null)),e.createElement("span",null,o.label))}))}function Xa({currentUser:t=fe,initialChats:s=na,initialMessages:l=aa}){const o={...fe,...t&&typeof t=="object"?t:{}},p=Array.isArray(s)?s:[],h=l&&typeof l=="object"?l:{},d=m.useMemo(()=>ia(),[]),B=!!(d.conversationId||d.recipientId),A=m.useRef(!B),[w,E]=m.useState(p),[X,M]=m.useState(h),[u,R]=m.useState(null),[b,F]=m.useState(d.recipientId?{id:d.recipientId,name:d.recipientName||"Business"}:null),[ne,Ne]=m.useState(""),[Z,j]=m.useState(""),[ke,oe]=m.useState(!1),[ce,ie]=m.useState(""),[Re,ve]=m.useState(!1),[Ee,ae]=m.useState(!1),[W,tt]=m.useState(!1),[H,nt]=m.useState(null),[at,Ce]=m.useState([]),[De,$e]=m.useState([]),[Oe,st]=m.useState(!1),[J,Ue]=m.useState(null),[Ht,_e]=m.useState(!1),[we,Se]=m.useState(""),[rt,Ie]=m.useState(""),[me,Fe]=m.useState(null),[z,je]=m.useState(null),[Ja,lt]=m.useState(null),[ot,ct]=m.useState(!1),[Yt,Te]=m.useState(null),[Ae,Ve]=m.useState({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),[Gt,it]=m.useState(o),[ue,mt]=m.useState({open:!1,title:"",message:"",confirmLabel:"Confirm",onConfirm:null}),[U,Be]=m.useState("chats"),ut=m.useRef(null),ge=m.useRef(null),ze=m.useRef(null),be=m.useRef(null),se=m.useRef(null),Q=m.useRef(null),D=m.useRef({lastSentAt:0,lastValue:!1,idleTimer:null}),dt=m.useRef(0),P=Ae.sessionId,L=Ae.sessionCsrf,O=Ae.userId,We=Ae.realtimeToken,I=!!(P&&L&&O),T=w.find(n=>n.id===u)||null,Kt=m.useMemo(()=>ma(b),[b]),_=T||Kt,qt=m.useMemo(()=>w.filter(n=>n.archived),[w]),Xt=m.useMemo(()=>{const n=new Map;return at.forEach(a=>{a!=null&&a.id&&n.set(a.id,{id:a.id,name:a.name||"Unknown",blockedAt:a.blockedAt||"",color:a.color||"#3b82f6"})}),Array.from(n.values())},[at]),He=m.useMemo(()=>w.filter(n=>!n.archived),[w]),Zt=m.useMemo(()=>{const n=ne.trim().toLowerCase();return n?He.filter(a=>a.name.toLowerCase().includes(n)||(a.lastMessage||"").toLowerCase().includes(n)):He},[He,ne]),xe=u?X[u]||[]:[],Ye=m.useMemo(()=>{const n=Z.trim().toLowerCase();return n?xe.filter(a=>a.text.toLowerCase().includes(n)):xe},[xe,Z]),Jt=m.useMemo(()=>da(Ye),[Ye]),Qt=!!(u&&Yt===u),ft=()=>{Q.current&&(window.clearTimeout(Q.current),Q.current=null),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null)},Pe=async n=>{const a=se.current;if(!a||!O)return;const r=!!n,i=Date.now(),c=D.current;if(!(c.lastValue===r&&i-c.lastSentAt<600)){c.lastValue=r,c.lastSentAt=i;try{await a.send({type:"broadcast",event:"typing",payload:{isTyping:r,userId:String(O)}})}catch{}}};m.useEffect(()=>{let n=!1;return(async()=>{if(!u||!O||!We||!I){ae(!1);return}try{const r=await Vn();if(!r||n)return;r.realtime.setAuth(We);const i=se.current;if(i)try{await i.unsubscribe()}catch{}se.current=null,ft(),D.current.lastValue=!1;const c=r.channel(`conversation:${u}`,{config:{presence:{key:`chat:${String(O)}`}}}),v=()=>{try{const k=typeof c.presenceState=="function"?c.presenceState():{};let N=!1;for(const C of Object.values(k||{})){const g=Array.isArray(C)?C:[C];for(const y of g){const S=String((y==null?void 0:y.userId)||(y==null?void 0:y.user_id)||"");if(S&&S!==String(O)){N=!0;break}}if(N)break}E(C=>C.map(g=>g.id!==u||g.hasBlockingRelationship||g.blockedByOther?g:N?{...g,online:!0,presence:"online"}:{...g,online:!1}))}catch{}};c.on("presence",{event:"sync"},v),c.on("presence",{event:"join"},v),c.on("presence",{event:"leave"},v),c.on("broadcast",{event:"typing"},({payload:k})=>{const N=String((k==null?void 0:k.userId)||"");if(!N||N===String(O))return;const C=!!(k!=null&&k.isTyping);ae(C),Q.current&&(window.clearTimeout(Q.current),Q.current=null),C&&(Q.current=window.setTimeout(()=>{ae(!1),Q.current=null},3e3))}),se.current=c,c.subscribe(async(k,N)=>{if(!n&&k==="SUBSCRIBED")try{await c.track({userId:String(O),at:new Date().toISOString()}),v()}catch{}})}catch{n||ae(!1)}})(),()=>{n=!0;const r=se.current;if(se.current=null,r)try{r.unsubscribe()}catch{}ft(),D.current.lastValue=!1,ae(!1)}},[u,I,O,We]),m.useEffect(()=>{if(!u||!O||!se.current)return;const n=ce.trim().length>0,a=Date.now(),r=D.current;n!==r.lastValue&&a-r.lastSentAt>600&&Pe(n),r.idleTimer&&(window.clearTimeout(r.idleTimer),r.idleTimer=null),n&&(r.idleTimer=window.setTimeout(()=>{D.current.idleTimer=null,Pe(!1)},2e3))},[ce,u,O]),m.useEffect(()=>{if(!u||Z.trim())return;const n=ut.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:"smooth"})})},[u,xe.length,Ee,Z]),m.useEffect(()=>{u||ve(!1)},[u]),m.useEffect(()=>{je(null)},[u]),m.useEffect(()=>()=>{be.current&&clearTimeout(be.current)},[]),m.useEffect(()=>{(!u||!I)&&Te(null)},[u,I]);const f=n=>{lt(n),be.current&&clearTimeout(be.current),be.current=setTimeout(()=>lt(null),2400)},pt=(n,a={})=>{if(Number(n==null?void 0:n.status)!==401)return!1;const r=!!(a!=null&&a.silent);return xt(),Ve({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),R(null),F(null),r||f("Session missing or expired. Please log in again."),!0},en=n=>{if(!n||typeof n!="object")return;const a=typeof n.attachmentUrl=="string"?n.attachmentUrl.trim():"",r=typeof n.attachmentType=="string"?n.attachmentType.toLowerCase():"",i=!!n.attachmentIsImage||r.startsWith("image/");if(!a||!i)return;const c=typeof n.attachmentName=="string"&&n.attachmentName?n.attachmentName:"photo";je({url:a,name:c,messageId:typeof n.id=="string"?n.id:""})},tn=()=>{je(null)},nn=async()=>{if(!(z!=null&&z.url))return;const n=z.name||"photo";try{const a=await fetch(z.url);if(!a.ok)throw new Error("download_failed");const r=await a.blob(),i=window.URL.createObjectURL(r),c=document.createElement("a");c.href=i,c.download=n,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(i),f("Image saved.")}catch{const a=document.createElement("a");a.href=z.url,a.target="_blank",a.rel="noreferrer",a.click(),f("Could not save directly. Opened image in a new tab.")}},an=()=>{if(!T){f("No chat selected.");return}Fe(T),Se(""),Ie(z!=null&&z.name?`Photo attachment: ${z.name}`:"Photo attachment"),_e(!0)};m.useEffect(()=>{if(!u||!I)return;let n=!1;Te(u);const a=async({silent:i=!1}={})=>{try{const{messages:c,chatPatch:v}=await zn({sessionId:P,sessionCsrf:L,conversationId:u,currentUserId:O});if(n)return;M(k=>{const N=k[u]||[],C=new Set(c.map(y=>y.id)),g=N.filter(y=>y.id&&y.id.startsWith("m-")&&!C.has(y.id));return{...k,[u]:[...c,...g]}}),E(k=>k.map(N=>N.id===u?{...N,...v||{},unread:0}:N));try{await Wn({sessionId:P,sessionCsrf:L,conversationId:u})}catch{}}catch(c){if(!n&&pt(c))return;!n&&!i&&f((c==null?void 0:c.message)||"Failed to load chat messages.")}finally{n||Te(c=>c===u?null:c)}};a();const r=window.setInterval(()=>{a({silent:!0})},5e3);return()=>{n=!0,window.clearInterval(r)}},[u,I,P,L,O]);const sn=n=>{n&&(Ue(n),st(!0))},ht=()=>{st(!1),Ue(null)},Ge=n=>{n&&(Fe(n),Se(""),Ie(""),_e(!0))},vt=()=>{_e(!1),Fe(null),Se(""),Ie("")},rn=async()=>{var i;if(!me||!we)return;if(!I){f("Session missing or expired. Please log in again.");return}const n=((i=Bt.find(c=>c.value===we))==null?void 0:i.label)||we,a=rt.trim(),r=a?`${n} - ${a}`:n;try{await Yn({sessionId:P,sessionCsrf:L,conversationId:me.id,recipientId:me.otherPartyId,reason:r});try{const c=await St({sessionId:P,sessionCsrf:L});$e(c)}catch{}vt(),f("Report sent.")}catch(c){f((c==null?void 0:c.message)||"Failed to submit report.")}},re=({title:n,message:a,confirmLabel:r,onConfirm:i})=>{mt({open:!0,title:n,message:a,confirmLabel:r,onConfirm:i})},G=()=>{mt(n=>({...n,open:!1}))},ln=async(n,a,r={})=>{const i=!!(r!=null&&r.silent);if(ot)return!1;const c=n.trim(),v=a.trim();if(!c||!v)return i||f("Session credentials missing. Please log in again."),!1;ct(!0);try{const k=await Kn({sessionId:c,sessionCsrf:v}),{chats:N,blockedAccounts:C,reports:g,currentUser:y}=await qn({sessionId:c,sessionCsrf:v});Ve({sessionId:c,sessionCsrf:v,userId:k.userId,realtimeToken:k.token||""}),it(y?{...fe,...y}:{...fe,...o}),ra(c,v),E(N),Ce(C),M({}),$e(g);let S=null,x=null;if(!A.current){if(d.conversationId){const K=N.find(ee=>ee.id===d.conversationId);K&&(S=K.id)}if(!S&&d.recipientId){const K=N.find(ee=>ee.otherPartyId===d.recipientId);K?S=K.id:x={id:d.recipientId,name:d.recipientName||"Business"}}A.current=!0}return F(x),R(S),Ne(""),j(""),oe(!1),Be("chats"),!i&&N.length===0?f("Connected. No chats found."):i||f(`Connected. Loaded ${N.length} chat${N.length===1?"":"s"}.`),!0}catch(k){const N=pt(k,{silent:i});return!i&&!N&&f((k==null?void 0:k.message)||"Failed to restore your session."),!1}finally{ct(!1)}};m.useEffect(()=>{let n=!1;return(async()=>{if(I)return;const r=sa();if(!r){n||f("Session missing or expired. Please log in again.");return}await ln(r.sessionId,r.sessionCsrf,{silent:!0})||n||f("Session missing or expired. Please log in again.")})(),()=>{n=!0}},[]);const Et=async(n,a={})=>{a.unarchive&&!await kt(n,{clearActive:!1,toast:!0})||(R(n),F(null),I&&Te(n),E(r=>r.map(i=>i.id===n?{...i,unread:0}:i)),oe(!1),j(""))},gt=(n,a,r)=>{M(i=>{const c=i[n]||[];return{...i,[n]:c.map(v=>v.id===a?{...v,status:r}:v)}})},on=1e3,cn=async()=>{const n=Date.now();if(n-dt.current<on){f("Please wait before sending another message.");return}const a=ce.trim(),r=u||"",i=r?"":(b==null?void 0:b.id)||"",c=(T==null?void 0:T.name)||(b==null?void 0:b.name)||d.recipientName||"Business",v=(T==null?void 0:T.color)||"#3b82f6";if(!a||!!!(r||i))return;if(dt.current=n,q(_)){f(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}if(I){try{const C=await Hn({sessionId:P,sessionCsrf:L,conversationId:r||void 0,recipientId:i||void 0,content:a}),g=It(C==null?void 0:C.data,O),y=(typeof g.chatId=="string"?g.chatId.trim():"")||r;if(!y)throw new Error("Failed to resolve conversation ID.");M(S=>({...S,[y]:[...S[y]||[],g]})),ie(""),E(S=>{const x=g.timestamp||new Date().toISOString();if(!S.find(V=>V.id===y))return[{id:y,name:c,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:g.text||a,lastTime:x,unread:0,online:!1,presence:"",color:v,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:i||(b==null?void 0:b.id)||""},...S];const ee=S.map(V=>V.id===y?{...V,lastMessage:g.text||a,lastTime:g.timestamp||x,unread:0}:V),de=ee.find(V=>V.id===y),Le=ee.filter(V=>V.id!==y);return de?[de,...Le]:ee}),R(y),F(null),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null),D.current.lastValue=!1,Pe(!1)}catch(C){f((C==null?void 0:C.message)||"Failed to send message.")}return}if(!r){f("Session missing or expired. Please log in again.");return}const N={id:`m-${Date.now()}`,chatId:r,sender:"me",text:a,timestamp:new Date().toISOString(),status:"sent"};M(C=>({...C,[r]:[...C[r]||[],N]})),ie(""),E(C=>{const g=C.map(x=>x.id===r?{...x,lastMessage:a,lastTime:N.timestamp,unread:0}:x),y=g.find(x=>x.id===r),S=g.filter(x=>x.id!==r);return y?[y,...S]:g}),setTimeout(()=>gt(r,N.id,"delivered"),900),setTimeout(()=>gt(r,N.id,"read"),2e3),D.current.idleTimer&&(window.clearTimeout(D.current.idleTimer),D.current.idleTimer=null),D.current.lastValue=!1,Pe(!1)},mn=()=>{if(!u&&!(b!=null&&b.id)){f("Select a chat to add emojis.");return}ve(n=>!n)},un=()=>{ve(!1)},dn=n=>{var r,i;const a=(n==null?void 0:n.native)??((i=(r=n==null?void 0:n.skins)==null?void 0:r[0])==null?void 0:i.native)??"";a&&ie(c=>{const{nextValue:v,caret:k}=ga(c,a,ge.current);return requestAnimationFrame(()=>{ge.current&&document.activeElement===ge.current&&ge.current.setSelectionRange(k,k)}),v})},fn=()=>{if(!u&&!(b!=null&&b.id)){f("Select a chat first.");return}if(!I){f("Session missing or expired. Please log in again.");return}if(q(_)){f(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}ze.current&&ze.current.click()},pn=new Set(["image/png","image/jpeg","image/webp"]),hn=new Set(["video/mp4","video/webm","video/quicktime","video/x-m4v"]),vn=new Set(["application/pdf"]),bt=10*1024*1024,En=15*1024*1024;function gn(n){const a=(n.type||"").toLowerCase(),r=(n.name||"").toLowerCase();return pn.has(a)||/\.(png|jpe?g|webp)$/.test(r)?{ok:!0,maxBytes:bt,label:"images"}:hn.has(a)||/\.(mp4|webm|mov|m4v)$/.test(r)?{ok:!0,maxBytes:En,label:"videos"}:vn.has(a)||r.endsWith(".pdf")?{ok:!0,maxBytes:bt,label:"documents"}:{ok:!1,maxBytes:0,label:""}}const bn=async n=>{var C;const a=n.target,r=(C=a==null?void 0:a.files)==null?void 0:C[0];if(a&&(a.value=""),!r)return;const i=gn(r);if(!i.ok){f("Unsupported file type. Allowed: PNG, JPEG, WEBP, PDF, MP4, WEBM, MOV.");return}if(r.size>i.maxBytes){const g=Math.round(i.maxBytes/1048576);f(`File too large. Maximum ${g}MB for ${i.label}.`);return}if(!u&&!(b!=null&&b.id)){f("Select a chat first.");return}if(!I){f("Session missing or expired. Please log in again.");return}if(q(_)){f(_!=null&&_.blockedByOther?"You cannot message this account.":"Unblock this account to send messages.");return}const c=u||"",v=c?"":(b==null?void 0:b.id)||"",k=(T==null?void 0:T.name)||(b==null?void 0:b.name)||d.recipientName||"Business",N=(T==null?void 0:T.color)||"#3b82f6";try{const g=await Gn({sessionId:P,sessionCsrf:L,conversationId:c||void 0,recipientId:v||void 0,file:r}),y=It(g==null?void 0:g.data,O),S=(typeof y.chatId=="string"?y.chatId.trim():"")||c;if(!S)throw new Error("Failed to resolve conversation ID.");M(x=>({...x,[S]:[...x[S]||[],y]})),E(x=>{const K=y.timestamp||new Date().toISOString();if(!x.find(Y=>Y.id===S))return[{id:S,name:k,firstName:"",lastName:"",suburb:"",city:"",province:"",streetAddress:"",accountSince:"",accountType:"Business",lastMessage:y.text||r.name,lastTime:K,unread:0,online:!1,presence:"",color:N,archived:!1,blocked:!1,blockedByMe:!1,blockedByOther:!1,hasBlockingRelationship:!1,otherPartyId:v||(b==null?void 0:b.id)||""},...x];const de=x.map(Y=>Y.id===S?{...Y,lastMessage:y.text||r.name,lastTime:y.timestamp||K,unread:0}:Y),Le=de.find(Y=>Y.id===S),V=de.filter(Y=>Y.id!==S);return Le?[Le,...V]:de}),R(S),F(null),f("Attachment sent.")}catch(g){f((g==null?void 0:g.message)||"Failed to send attachment.")}},yn=n=>{M(a=>({...a,[n]:[]})),E(a=>a.map(r=>r.id===n?{...r,lastMessage:"No messages yet",lastTime:"",unread:0}:r))},Nn=()=>{if(u){yn(u),f("Cleared current chat.");return}const n={};w.forEach(a=>{n[a.id]=[]}),M(n),E(a=>a.map(r=>({...r,lastMessage:"No messages yet",lastTime:"",unread:0}))),f("Cleared all chats.")},Ke=n=>{if(!Array.isArray(n)||n.length===0)return;const a=new Set(n.filter(Boolean));a.size&&(E(r=>r.filter(i=>!a.has(i.id))),M(r=>{const i={...r};return a.forEach(c=>{delete i[c]}),i}),u&&a.has(u)&&R(null))},qe=async(n,a={})=>{const r=typeof n=="string"?n.trim():"";if(!r)return!1;const i=a.toast!==!1;if(I)try{await At({sessionId:P,sessionCsrf:L,conversationId:r})}catch(c){return f((c==null?void 0:c.message)||"Failed to delete chat."),!1}return Ke([r]),i&&f("Chat deleted."),!0},kn=async()=>{const n=w.map(i=>i.id).filter(Boolean);if(n.length===0)return f("No chats to delete."),!1;if(!I)return Ke(n),f("All chats deleted."),!0;const a=[];for(const i of n)try{await At({sessionId:P,sessionCsrf:L,conversationId:i}),a.push(i)}catch{}a.length>0&&Ke(a);const r=n.length-a.length;return a.length===0?(f("Failed to delete chats."),!1):r===0?(f("All chats deleted."),!0):(f(`Deleted ${a.length} chat${a.length===1?"":"s"}. ${r} failed.`),!1)},Cn=async()=>{if(u){await qe(u);return}await kn()},wn=(n,a)=>{const r=w.find(N=>N.id===n),i=(r==null?void 0:r.otherPartyId)||n;if(!i)return;const c=a||new Date().toISOString(),v=(r==null?void 0:r.name)||"Unknown",k=(r==null?void 0:r.color)||"#3b82f6";Ce(N=>{const C=N.filter(g=>g.id!==i);return[{id:i,name:v,blockedAt:c,color:k},...C]})},yt=({accountId:n,conversationId:a=""})=>{const r=typeof n=="string"?n.trim():"",i=typeof a=="string"?a.trim():"";E(c=>c.map(v=>{const k=!!i&&v.id===i,N=!!r&&v.otherPartyId===r;if(!k&&!N)return v;const C=!!v.blockedByOther;return{...v,blocked:!1,blockedByMe:!1,hasBlockingRelationship:C,blockedAt:void 0}})),r&&Ce(c=>c.filter(v=>v.id!==r))},Nt=async n=>{if(!n)return!1;if(I)try{await ea({sessionId:P,sessionCsrf:L,conversationId:n})}catch(r){return f((r==null?void 0:r.message)||"Failed to block account."),!1}const a=new Date().toISOString();return E(r=>r.map(i=>i.id===n?{...i,blocked:!0,blockedByMe:!0,hasBlockingRelationship:!0,blockedAt:a}:i)),wn(n,a),u===n&&R(null),f("Chat blocked."),!0},Sn=async n=>{if(!n)return!1;const a=w.find(i=>i.id===n),r=(a==null?void 0:a.otherPartyId)||"";if(I)try{await Tt({sessionId:P,sessionCsrf:L,conversationId:n||void 0,recipientId:r||void 0})}catch(i){return f((i==null?void 0:i.message)||"Failed to unblock account."),!1}return yt({accountId:r,conversationId:n}),f("Account unblocked."),!0},In=async n=>{const a=typeof n=="string"?n.trim():"";if(!a)return!1;const r=w.find(c=>c.otherPartyId===a),i=(r==null?void 0:r.id)||"";if(I)try{await Tt({sessionId:P,sessionCsrf:L,conversationId:i||void 0,recipientId:a})}catch(c){return f((c==null?void 0:c.message)||"Failed to unblock account."),!1}return yt({accountId:a,conversationId:i}),f("Account unblocked."),!0},Tn=async(n,a={})=>{if(!n)return!1;const r=a.clearActive!==!1,i=a.toast!==!1;if(I)try{await Zn({sessionId:P,sessionCsrf:L,conversationId:n})}catch(c){return f((c==null?void 0:c.message)||"Failed to archive chat."),!1}return E(c=>c.map(v=>v.id===n?{...v,archived:!0,archivedAt:new Date().toISOString()}:v)),r&&u===n&&R(null),i&&f("Chat archived."),!0},kt=async(n,a={})=>{if(!n)return!1;const r=a.clearActive===!0,i=a.toast!==!1;if(I)try{await Xn({sessionId:P,sessionCsrf:L,conversationId:n})}catch(c){return f((c==null?void 0:c.message)||"Failed to restore chat."),!1}return E(c=>c.map(v=>v.id===n?{...v,archived:!1,archivedAt:void 0}:v)),r&&u===n&&R(null),i&&f("Chat restored from archive."),!0},Ct=n=>{if(n==="profile"){if(!u){f("No chat selected.");return}const a=w.find(r=>r.id===u)||null;nt(a),tt(!0);return}if(n==="close"){R(null),F(null),oe(!1),j(""),f("Chat closed.");return}if(n==="block"){if(!u)return;const a=w.find(i=>i.id===u),r=(a==null?void 0:a.id)||u;re({title:a?`Block ${a.name}?`:"Block chat?",message:"They won't be able to message you.",confirmLabel:"Block",onConfirm:async()=>{G(),await Nt(r)}});return}if(n==="delete"){const a=T?`Delete chat with ${te(T)}?`:"Delete all chats?";re({title:a,message:T?"This removes the chat from your list.":"This removes every chat from your list.",confirmLabel:"Delete",onConfirm:()=>{G(),Cn()}});return}if(n==="clear"){const a=T?`Clear chat with ${T.name}?`:"Clear all chats?";re({title:a,message:T?"This clears the messages in this chat.":"This clears the messages in every chat.",confirmLabel:"Clear",onConfirm:()=>{G(),Nn()}});return}n==="report"&&Ge(T)},An=n=>{Ct(n)},Bn=(n,a)=>{const r=w.find(i=>i.id===n);if(r){if(a==="delete"){re({title:`Delete chat with ${te(r)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{G(),qe(n)}});return}if(a==="report"){Ge(r);return}if(a==="archive"){Tn(n,{clearActive:!0,toast:!0});return}}},xn=()=>{oe(n=>{const a=!n;return a||j(""),a})},Xe=()=>{tt(!1),nt(null)},Pn=()=>{H&&re({title:`Delete chat with ${te(H)}?`,message:"This removes the chat from your list.",confirmLabel:"Delete",onConfirm:()=>{G(),(async()=>await qe(H.id)&&Xe())()}})},Ln=()=>{if(!H)return;const n=H.id,a=!!H.blocked,r=te(H);re({title:a?`Unblock ${r}?`:`Block ${r}?`,message:a?"They will be able to message you again.":"They won't be able to message you.",confirmLabel:a?"Unblock":"Block",onConfirm:async()=>{G(),(a?await Sn(n):await Nt(n))&&Xe()}})},Mn=()=>{H&&Ge(H)},Rn=n=>{if(n==="home"){Be(n),window.location.href="homepage.html";return}(n==="chats"||n==="archive"||n==="block"||n==="profile"||n==="reports")&&R(null),Be(n);const a=n.charAt(0).toUpperCase()+n.slice(1);f(`${a} selected.`)},Dn=n=>{kt(n,{clearActive:!1,toast:!0})},$n=n=>{In(n)},On=[{label:"Delete chats",onSelect:()=>Ct("delete")},{label:"Reports",onSelect:()=>Be("reports")},{label:"Logout",onSelect:()=>re({title:"Log out?",message:"This will sign you out of CompareHubPrices Chat.",confirmLabel:"Log out",onConfirm:()=>{G(),xt(),Ve({sessionId:"",sessionCsrf:"",userId:"",realtimeToken:""}),it({...fe,...o}),f("Logged out.")}})}],ye=!!(u||b!=null&&b.id||W),wt=ye||U==="archive"||U==="block"||U==="profile"||U==="reports",Un=ot;return m.useEffect(()=>{if(!I||U!=="block")return;let n=!1;return(async()=>{try{const a=await Fn({sessionId:P,sessionCsrf:L});n||Ce(a)}catch{}})(),()=>{n=!0}},[I,U,P,L]),m.useEffect(()=>{if(!I||U!=="reports")return;let n=!1;return(async()=>{try{const a=await St({sessionId:P,sessionCsrf:L});n||$e(a)}catch{}})(),()=>{n=!0}},[I,U,P,L]),m.useEffect(()=>{if(!Oe||!(J!=null&&J.id))return;const n=De.find(a=>a.id===J.id);if(!n){ht();return}Ue(n)},[Oe,J==null?void 0:J.id,De]),e.createElement("div",{className:`chp-app${ye?" chat-only":""}${wt&&!ye?" no-header":""}`},wt?null:e.createElement("header",{className:"app-bar"},e.createElement("div",{className:"app-title"},e.createElement("img",{src:jn,alt:"CompareHubPrices",className:"app-logo"})),e.createElement("div",{className:"app-actions"},e.createElement(et,{ariaLabel:"App menu",items:On}))),e.createElement("main",{className:"chp-main","data-view":ye?"chat":"list"},e.createElement("section",{className:"chp-pane chp-list-pane"},U==="archive"?e.createElement($a,{chats:qt,onOpenChat:Et,onUnarchive:Dn}):U==="block"?e.createElement(Oa,{chats:Xt,onUnblock:$n}):U==="profile"?e.createElement(Da,{currentUser:Gt}):U==="reports"?e.createElement(Ua,{reports:De,onOpenReport:sn}):e.createElement(ja,{chats:Zt,searchValue:ne,onSearchChange:Ne,activeChatId:u,onOpenChat:Et,onChatAction:Bn})),e.createElement("section",{className:"chp-pane chp-convo-pane"},W?e.createElement(Ra,{chat:H,onClose:Xe,onDelete:Pn,onBlock:Ln,onReport:Mn}):e.createElement(Ka,{chat:_,groupedMessages:Jt,searchValue:Z,showSearch:ke,onToggleSearch:xn,onSearchChange:j,onBack:()=>{R(null),F(null)},onSend:cn,composerValue:ce,onComposerChange:ie,onEmoji:mn,onAttach:fn,emojiOpen:Re,onEmojiSelect:dn,onEmojiClose:un,composerRef:ge,typing:Ee,conversationLoading:Qt,messageListRef:ut,matchCount:Ye.length,onMenuAction:An,attachmentPreview:z,onOpenAttachmentPreview:en,onCloseAttachmentPreview:tn,onSaveAttachmentPreview:nn,onReportAttachmentPreview:an}))),ye?null:e.createElement(qa,{activeKey:U,onSelect:Rn}),Un?e.createElement(Fa,null):null,e.createElement(_a,{open:Oe,report:J,onClose:ht}),e.createElement(Ma,{open:Ht,onClose:vt,reasons:Bt,value:we,onChange:Se,details:rt,onDetailsChange:Ie,onSubmit:rn,targetName:me==null?void 0:me.name}),e.createElement(La,{open:ue.open,title:ue.title,message:ue.message,confirmLabel:ue.confirmLabel,onConfirm:()=>{ue.onConfirm?ue.onConfirm():G()},onCancel:G}),e.createElement("input",{ref:ze,type:"file",accept:".pdf,image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime,.mov,.m4v",onChange:bn,style:{display:"none"}}))}const Za=ta(document.getElementById("root"));Za.render(e.createElement(e.StrictMode,null,e.createElement(Xa,null)));
