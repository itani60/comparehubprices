<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports | CompareHubPrices</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #dc2626;
            --primary-hover: #b91c1c;
            --dark: #0f172a;
            --light: #f8fafc;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
        }

        h2 {
            font-weight: 800;
            color: #334155;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            display: inline-block;
        }

        /* --- Hero Section --- */
        .support-hero {
            background: linear-gradient(135deg, var(--primary) 0%, #991b1b 100%);
            color: white;
            padding: 80px 0 60px;
            margin-bottom: -40px;
            /* Overlap effect */
        }

        /* --- Cards --- */
        .card-d1 {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            cursor: pointer;
            height: 100%;
        }

        .card-d1:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .d1-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }

        .d1-ring::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 4px solid currentColor;
            opacity: 0.2;
        }

        .d1-ring::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 4px solid currentColor;
            border-right-color: transparent;
            border-bottom-color: transparent;
            transform: rotate(-45deg);
        }

        .d1-content h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 800;
            line-height: 1.2;
            color: #1e293b;
        }

        .d1-content p {
            margin: 4px 0 0 0;
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- Navbar Design 5 --- */
        .d5-navbar {
            background: white;
            border-bottom: 3px solid #dc2626;
            padding: 15px 0;
        }

        /* --- Table & Card --- */
        .ticket-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* --- Filters Design 2 --- */
        .filter-d2 {
            background: transparent;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            padding: 20px 0;
        }

        .custom-dropdown {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 50px;
            padding: 0 20px;
            height: 50px;
            display: flex;
            align-items: center;
            min-width: 220px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            flex: 1;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .custom-dropdown:hover,
        .custom-dropdown.active {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .trigger-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trigger-content label {
            color: #94a3b8;
            margin: 0;
            font-size: 0.9rem;
        }

        .selected-text {
            font-weight: 600;
            color: #0f172a;
            font-size: 0.95rem;
        }

        .dropdown-menu-list {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            z-index: 1050;
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
            padding: 8px;
        }

        .custom-dropdown.active .dropdown-menu-list {
            display: block;
        }

        .dropdown-item-custom {
            border-radius: 8px;
            font-weight: 500;
            padding: 10px 16px;
            cursor: pointer;
            color: #334155;
        }

        .dropdown-item-custom:hover {
            background: #f8fafc;
            color: var(--primary);
        }

        .btn-go {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
            flex-shrink: 0;
        }

        .btn-go:hover {
            transform: scale(1.1) rotate(90deg);
        }

        /* Badge Colors */
        .badge-soft-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-soft-warning {
            background: #fefce8;
            color: #854d0e;
        }

        .badge-soft-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-soft-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-soft-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        /* --- Mobile Responsive (Table to Cards) --- */
        @media (max-width: 768px) {
            .d5-navbar {
                padding: 10px 0;
            }

            .support-hero {
                padding: 40px 0;
            }

            .ticket-card {
                border: none;
                box-shadow: none;
                background: transparent;
            }

            .ticket-card table,
            .ticket-card thead,
            .ticket-card tbody,
            .ticket-card th,
            .ticket-card td,
            .ticket-card tr {
                display: block;
            }

            .ticket-card thead {
                display: none;
            }

            .ticket-card tbody tr {
                background: white;
                border-radius: 16px;
                margin-bottom: 16px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                border: 1px solid #e2e8f0;
                padding: 20px;
            }

            .ticket-card td {
                padding: 8px 0;
                border: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
            }

            /* Subject Row (First) */
            .ticket-card td:first-child {
                display: block;
                width: 100%;
                text-align: left;
                padding-bottom: 12px;
                margin-bottom: 12px;
                border-bottom: 1px solid #f1f5f9;
            }

            .ticket-card td:first-child .fw-bold {
                font-size: 1.1rem;
                color: var(--primary);
            }

            /* Labels */
            .ticket-card td:not(:first-child):not(:last-child)::before {
                content: attr(data-label);
                font-weight: 700;
                font-size: 0.8rem;
                color: #94a3b8;
                text-transform: uppercase;
                margin-right: 15px;
            }

            /* Action Button (Last) */
            .ticket-card td:last-child {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #f1f5f9;
                justify-content: center;
            }

            .ticket-card td:last-child button {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar (Design 5) -->
    <nav class="d5-navbar fixed-top shadow-sm">
        <div class="container-fluid px-3 d-flex align-items-center justify-content-between">
            <a class="navbar-brand" href="index.html">
                <img src="assets/logo.png" alt="CompareHub" height="30">
            </a>

            <div id="user-auth-display">
                <a href="login.html" class="btn btn-primary rounded-pill px-4">Login</a>
            </div>
        </div>
    </nav>

    <div class="container pt-5 mt-4">
        <div>
            <h2>My Feedback Reports</h2>
            <p class="text-muted mb-0">Track the status of your submitted reports and feedback.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5" style="margin-top: 40px;">

        <div class="row g-4 mb-5">
            <!-- Stats -->
            <div class="col-md-3">
                <div class="card-d1">
                    <div class="d1-ring text-primary">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="d1-content">
                        <h3>24</h3>
                        <p>Total Reports</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-d1">
                    <div class="d1-ring text-warning">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="d1-content">
                        <h3>5</h3>
                        <p>Pending Review</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-d1">
                    <div class="d1-ring text-info">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="d1-content">
                        <h3>1</h3>
                        <p>Under Review</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-d1">
                    <div class="d1-ring text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="d1-content">
                        <h3>18</h3>
                        <p>Resolved</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Design 2 (Minimalist Pill) -->
        <h4 class="fw-bold mb-3">Report History</h4>
        <div class="filter-d2">
            <div class="custom-dropdown" id="typeDropdown">
                <div class="dropdown-trigger">
                    <div class="trigger-content">
                        <label>Reason:</label>
                        <span class="selected-text" id="typeSelected">All Reasons</span>
                    </div>
                    <i class="fas fa-chevron-down text-secondary"></i>
                </div>
                <div class="dropdown-menu-list">
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'All Reasons')">All Reasons</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'Harassment')">Harassment</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'Fraud / Scam')">Fraud / Scam</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'Inappropriate Content')">
                        Inappropriate Content</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'Spam')">Spam</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('type', 'Fake Review')">Fake Review</div>
                </div>
            </div>

            <div class="custom-dropdown" id="statusDropdown">
                <div class="dropdown-trigger">
                    <div class="trigger-content">
                        <label>Status:</label>
                        <span class="selected-text" id="statusSelected">All Statuses</span>
                    </div>
                    <i class="fas fa-chevron-down text-secondary"></i>
                </div>
                <div class="dropdown-menu-list">
                    <div class="dropdown-item-custom" onclick="selectFilter('status', 'All Statuses')">All Statuses
                    </div>
                    <div class="dropdown-item-custom" onclick="selectFilter('status', 'Pending')">Pending</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('status', 'Reviewed')">Reviewed</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('status', 'Resolved')">Resolved</div>
                </div>
            </div>

            <div class="custom-dropdown" id="dateDropdown">
                <div class="dropdown-trigger">
                    <div class="trigger-content">
                        <label>Date:</label>
                        <span class="selected-text" id="dateSelected">30 Days</span>
                    </div>
                    <i class="fas fa-calendar-alt text-secondary"></i>
                </div>
                <div class="dropdown-menu-list">
                    <div class="dropdown-item-custom" onclick="selectFilter('date', '7 Days')">7 Days</div>
                    <div class="dropdown-item-custom" onclick="selectFilter('date', '30 Days')">30 Days</div>
                </div>
            </div>

            <button class="btn-go" onclick="resetFilters()"><i class="fas fa-sync-alt"></i></button>
        </div>

        <div class="ticket-card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3 text-secondary text-uppercase small" style="width: 40%;">Subject / ID
                            </th>
                            <th class="py-3 text-secondary text-uppercase small">Category</th>
                            <th class="py-3 text-secondary text-uppercase small">Date</th>
                            <th class="py-3 text-secondary text-uppercase small">Status</th>
                            <th class="pe-4 py-3 text-end text-secondary text-uppercase small">Action</th>
                        </tr>
                    </thead>
                    <tbody id="reports-body">
                        <!-- Loaded via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div class="modal fade" id="viewReportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-header border-bottom-0 p-4 pb-0 d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-light text-secondary border mb-2" id="view-report-id">ID: #RPT-8821</span>
                        <h4 class="fw-bold mb-0 text-dark" id="view-report-subject">Subject Here</h4>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex gap-2 mb-4">
                        <span class="badge border fw-normal text-dark bg-white px-3 py-2 rounded-pill"
                            id="view-report-category">Fraud</span>
                        <span class="badge border fw-normal text-dark bg-white px-3 py-2 rounded-pill"><i
                                class="far fa-calendar-alt me-2"></i><span id="view-report-date">Jan 16</span></span>
                        <span class="badge fw-medium px-3 py-2 rounded-pill" id="view-report-status">Pending</span>
                    </div>

                    <div class="p-3 bg-light rounded-3 mb-4">
                        <label class="small text-muted fw-bold text-uppercase mb-2">Description</label>
                        <p class="mb-0 text-dark" id="view-report-desc">
                            Lorem ipsum dolor sit amet...
                        </p>
                    </div>

                    <div class="border-top pt-3">
                        <label class="small text-muted fw-bold text-uppercase mb-2">Updates / Admin Notes</label>
                        <div class="d-flex align-items-start gap-3">
                            <div class="bg-primary rounded-circle p-2 text-white"
                                style="width: 32px; height: 32px; display: grid; place-items: center;"><i
                                    class="fas fa-headset small"></i></div>
                            <div>
                                <p class="mb-1 fw-bold text-dark">Support Team</p>
                                <p class="text-muted small mb-0">Your report has been received and is currently under
                                    review. We will notify you of any actions taken.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 px-4 pb-4">
                    <button type="button" class="btn btn-light fw-bold text-secondary px-4 rounded-pill"
                        data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
   <script src="assets/scripts/aws-auth-business.js"></script> 
   <script src="assets/scripts/aws-auth-user.js"></script>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dynamic Reports Data
        let reports = [];
        let API_BASE_URL = localStorage.getItem('comparehubprices_api_url') || 'https://hub.comparehubprices.co.za';
        if (API_BASE_URL.endsWith('/data')) API_BASE_URL = API_BASE_URL.replace(/\/data$/, '');

        // Determine Endpoint (Assuming single endpoint for User Reports logic)
        // User should verify the exact specific path for the 'report user and business' lambda.
        const REPORTS_ENDPOINT = `${API_BASE_URL}/user/reports`;

        async function fetchUserReports() {
            try {
                const token = localStorage.getItem('session_token') || localStorage.getItem('token');

                const response = await fetch(REPORTS_ENDPOINT, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    credentials: 'include' // Important for session cookies
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    reports = data.reports.map(r => ({
                        id: r.reportId || (r.reportedUserId ? r.reportedUserId.substring(0, 8) : 'N/A'),
                        subject: r.reporterType === 'USER'
                            ? `Report against ${r.targetName || r.reportedBusinessName || 'Business'}`
                            : `Report against ${r.reportedUserName || 'User'}`,
                        category: r.reason || 'General',
                        date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A',
                        status: capitalize(r.status || 'Pending'),
                        desc: r.description || r.notes || 'No description provided.'
                    }));

                    // Update UI
                    renderTable(reports);
                    updateStats();
                } else {
                    console.warn('Failed to fetch reports:', data.error);
                }
            } catch (e) {
                console.error('Error fetching user reports:', e);
                // Fallback to empty state or keep loading spinner
                document.getElementById('reports-body').innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted"> <i class="fas fa-exclamation-circle me-2"></i> Failed to load reports. Please try again.</td></tr>';
            }
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function updateStats() {
            // Recalculate stats based on fetched reports
            const total = reports.length;
            const pending = reports.filter(r => r.status.toLowerCase() === 'pending').length;
            const reviewed = reports.filter(r => r.status.toLowerCase() === 'reviewed' || r.status.toLowerCase() === 'under review').length;
            const resolved = reports.filter(r => r.status.toLowerCase() === 'resolved').length;

            // Update DOM (Assuming structure order: Total, Pending, Review, Resolved)
            const stats = document.querySelectorAll('.card-d1 h3');
            if (stats.length >= 4) {
                stats[0].textContent = total;
                stats[1].textContent = pending;
                stats[2].textContent = reviewed;
                stats[3].textContent = resolved;
            }
        }

        let currentFilters = {
            type: 'All Reasons',
            status: 'All Statuses',
            date: '30 Days'
        };

        function getStatusBadge(status) {
            const s = status.toLowerCase();
            if (s === 'pending') return 'badge-soft-warning';
            if (s === 'reviewed' || s === 'under review') return 'badge-soft-info';
            if (s === 'resolved') return 'badge-soft-success';
            return 'badge-soft-secondary';
        }

        function renderTable(data) {
            const tbody = document.getElementById('reports-body');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No reports found matching filters.</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(r => `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${r.subject}</div>
                        <div class="small text-muted">ID: #${r.id}</div>
                    </td>
                    <td data-label="Category"><span class="badge border text-dark fw-normal bg-white">${r.category}</span></td>
                    <td data-label="Date" class="text-muted small">${r.date}</td>
                    <td data-label="Status"><span class="badge ${getStatusBadge(r.status)} px-3 py-1 rounded-pill fw-medium">${r.status}</span></td>
                    <td class="pe-4 text-end">
                        <button class="btn btn-sm btn-light border fw-bold text-secondary" onclick="viewReport('${r.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewReport(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;

            document.getElementById('view-report-id').textContent = 'ID: #' + report.id;
            document.getElementById('view-report-subject').textContent = report.subject;
            document.getElementById('view-report-category').textContent = report.category;
            document.getElementById('view-report-date').textContent = report.date;
            document.getElementById('view-report-desc').textContent = report.desc;

            const statusEl = document.getElementById('view-report-status');
            statusEl.textContent = report.status;
            // Reset classes
            statusEl.className = 'badge fw-medium px-3 py-2 rounded-pill';
            statusEl.classList.add(getStatusBadge(report.status));

            const modal = new bootstrap.Modal(document.getElementById('viewReportModal'));
            modal.show();
        }

        // Dropdown Logic
        document.querySelectorAll('.custom-dropdown').forEach(dd => {
            dd.addEventListener('click', function (e) {
                e.stopPropagation();

                // Toggle active state
                const isActive = this.classList.contains('active');

                // Close all others
                document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));

                if (!isActive) {
                    this.classList.add('active');
                }
            });
        });

        // Close dropdowns on click outside
        window.addEventListener('click', () => {
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
        });

        function selectFilter(filterType, value) {
            currentFilters[filterType] = value;

            // Update UI Text
            if (filterType === 'type') document.getElementById('typeSelected').textContent = value;
            if (filterType === 'status') document.getElementById('statusSelected').textContent = value;
            if (filterType === 'date') document.getElementById('dateSelected').textContent = value;

            applyFilters();
        }

        function applyFilters() {
            let filtered = reports.filter(item => {
                let matchType = currentFilters.type === 'All Reasons' || item.category === currentFilters.type;
                let matchStatus = currentFilters.status === 'All Statuses' || item.status === currentFilters.status;
                // Date filtering ignored for demo simplicity
                return matchType && matchStatus;
            });
            renderTable(filtered);
        }

        function resetFilters() {
            currentFilters = { type: 'All Reasons', status: 'All Statuses', date: '30 Days' };
            document.getElementById('typeSelected').textContent = 'All Reasons';
            document.getElementById('statusSelected').textContent = 'All Statuses';
            document.getElementById('dateSelected').textContent = '30 Days';
            renderTable(reports);
        }

        // Initial Fetch
        fetchUserReports();
    </script>

</body>

</html>